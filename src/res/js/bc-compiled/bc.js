var BC=function(e){var d=e.Cell=e.Cell||{};d.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};d.make=function(a){function b(){var a=BC.Matrix.makeYRotation(t[1]),b=BC.Matrix.makeTranslation(p[0],p[1],p[2]);l.matrix=BC.Matrix.matrixMultiply(a,b)}var m=BC.Cell.CellState,k=BC.Constants.Direction,c=BC.Audio.Sound,g=a.metrics,h=a.rotationY,d=a.state,f=a.blockStyle,
e=a.audioPlayer,q=BC.Math.sliceRadians(g.numCells),s=[],w=!1,t=[0,h,0],p=[0,0,0],l={matrix:BC.Matrix.makeYRotation(t[1]),state:d,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){l.state=m.BLOCK_CLEARING_MARKED;0<s.length&&BC.Util.error("markBlock: pending animations: "+s.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){l.state=m.BLOCK_CLEARING_PREPARING},updateCallback:function(a){l.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){l.yellowBoost=
0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){l.blockStyle+=g.numBlockTypes},finishCallback:function(){l.state=m.BLOCK_CLEARING_READY}});s.push(a,b)},clearBlock:function(){l.state=m.BLOCK_CLEARING_IN_PROGRESS;0<s.length&&BC.Util.error("clearBlock: pending animations: "+s.length);var a=BC.Animation.make({duration:0.25,startCallback:function(){e.play(c.CELL_CLEAR)},updateCallback:function(a){l.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){l.state=m.EMPTY_NO_DROP;l.alpha=
1}});s.push(a)},sendBlock:function(a){var b=l.blockStyle;l.blockStyle=0;l.state=m.EMPTY_NO_SWAP;0<s.length&&BC.Util.error("sendBlock: pending animations: "+s.length);s.push(BC.Animation.make({duration:a,finishCallback:function(){l.state=m.EMPTY}}));return b},receiveBlock:function(a,c,f){l.blockStyle=f;l.state=m.BLOCK_RECEIVING;switch(c){case k.LEFT:t[1]-=q;break;case k.RIGHT:t[1]+=q;break;case k.UP:p[1]=g.ringHeight;w=!0;break;default:BC.Util.error("receiveBlock: unsupport direction: "+c)}b();0<s.length&&
BC.Util.error("receiveBlock: pending animations: "+s.length);s.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=q*a.deltaPercent;a=g.ringHeight*a.deltaPercent;switch(c){case k.LEFT:return t[1]+=b,!0;case k.RIGHT:return t[1]-=b,!0;case k.UP:return p[1]-=a,!0;default:return!1}},finishCallback:function(){l.state=m.BLOCK;w=!1}}))},isClearing:function(){return l.state===m.BLOCK_CLEARING_MARKED||l.state===m.BLOCK_CLEARING_PREPARING||l.state===m.BLOCK_CLEARING_READY||l.state===m.BLOCK_CLEARING_IN_PROGRESS},
isDrawable:function(){return l.state!==m.EMPTY&&l.state!==m.EMPTY_NO_SWAP&&l.state!==m.EMPTY_NO_DROP},isTransparent:function(){return l.state===m.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return w},update:function(a){BC.Animation.process(s,a)&&b()}};return l};return e}(BC||{});BC=function(e){(e.Ring=e.Ring||{}).make=function(d){var a=BC.Cell.CellState,b=d.metrics,m=d.translationY,k=d.selectable;d=d.audioPlayer;for(var c=BC.Math.sliceRadians(b.numCells),m=BC.Matrix.makeTranslation(0,m,0),a=k?a.BLOCK:a.BLOCK_INCOMING,g=[],h=0;h<b.numCells;h++){var n=h*c,f=BC.Math.randomInt(b.numBlockTypes);k||(f+=2*b.numBlockTypes);g[h]=BC.Cell.make({metrics:b,rotationY:n,state:a,blockStyle:f,audioPlayer:d})}return{matrix:m,cells:g,isEmpty:function(){for(var a=0;a<g.length;a++)if(g[a].state!==
BC.Cell.CellState.EMPTY)return!1;return!0},setSelectable:function(a){if(!k&&a)for(var c=0;c<g.length;c++)g[c].state===BC.Cell.CellState.BLOCK_INCOMING&&(g[c].state=BC.Cell.CellState.BLOCK,g[c].blockStyle-=2*b.numBlockTypes);k=a},isSelectable:function(){return k}}};return e}(BC||{});BC=function(e){var d=e.Board=e.Board||{};(d.View=d.View||{}).make=function(a){var b=a.board,m=a.gl,k=a.programLocations;a=a.resources;var c=k.boardRotationMatrixLocation,g=k.boardTranslationMatrixLocation,h=k.selectorMatrixLocation,d=k.ringMatrixLocation,f=k.cellMatrixLocation,e=BC.Cell.View.make(m,b.metrics,a.blockTextureTiles),q=BC.Selector.View.make(m,b.metrics,a.selectorTextureTile),s=BC.Stage.View.make(m,b.metrics,a.blackTextureTile),w=BC.Stat.View.make("#speed-level-stat"),t=BC.Stat.View.make("#elapsed-time-stat"),
p=BC.Stat.View.make("#score-stat");return{draw:function(){w.draw(b.speedLevel);t.draw(b.elapsedTime);p.draw(b.score);m.uniformMatrix4fv(c,!1,b.rotationMatrix);m.uniformMatrix4fv(g,!1,b.translationMatrix);m.uniformMatrix4fv(h,!1,BC.Matrix.identity);for(var a=b.rings,u=0;2>u;u++)for(var y=0;y<a.length;y++){m.uniformMatrix4fv(d,!1,a[y].matrix);for(var x=a[y].cells,z=0;z<x.length;z++)m.uniformMatrix4fv(f,!1,x[z].matrix),0==u?e.drawOpaque(x[z],k):e.drawTransparent(x[z],k)}m.uniformMatrix4fv(c,!1,BC.Matrix.identity);
m.uniformMatrix4fv(g,!1,BC.Matrix.identity);m.uniformMatrix4fv(h,!1,b.stage.matrix);m.uniformMatrix4fv(d,!1,BC.Matrix.identity);m.uniformMatrix4fv(f,!1,BC.Matrix.identity);s.draw(k);m.uniformMatrix4fv(c,!1,BC.Matrix.identity);m.uniformMatrix4fv(g,!1,b.translationMatrix);m.uniformMatrix4fv(h,!1,b.selector.matrix);m.uniformMatrix4fv(d,!1,BC.Matrix.identity);m.uniformMatrix4fv(f,!1,BC.Matrix.identity);q.draw(k)}}};return e}(BC||{});BC=function(e){var d=e.Math=e.Math||{};d.radians=function(a){return a*Math.PI/180};d.sliceRadians=function(a){return 2*Math.PI/a};d.randomInt=function(a){return Math.floor(Math.random()*a)};d.circlePoints=function(a,b,m){m=m||0;for(var k=2*Math.PI/b,c=[],g=0;g<b;g++)c[2*g]=a*Math.cos(m+g*k),c[2*g+1]=a*Math.sin(m+g*k);return c};d.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};d.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};d.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return e}(BC||{});BC=function(e){var d=e.GL=e.GL||{};d.loadShader=function(a,b,m,k){k=k||BC.Util.error;var c=document.getElementById(b);if(!c)return k("** Error getting script element:"+b),null;b=a.createShader(m);a.shaderSource(b,c.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),k("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};d.createProgram=function(a,b,m,k){for(var c=a.createProgram(),g=0;g<b.length;g++)a.attachShader(c,b[g]);
if(m)for(g=0;g<m.length;g++)a.bindAttribLocation(c,k?k[g]:g,m[g]);a.linkProgram(c);return a.getProgramParameter(c,a.LINK_STATUS)?c:(lastError=a.getProgramInfoLog(c),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(c),null)};d.textureTileSet=function(a,b,m){var k=1/a,c=1/b;return{tile:function(a,b){var d=k*b,f=c*a;return{textureCoord:function(a,b){return[d+m+(k-2*m)*a,f+m+(c-2*m)*b]}}}}};return e}(BC||{});BC=function(e){var d=e.Audio=e.Audio||{};(d.Player=d.Player||{}).make=function(){function a(a){var c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="arraybuffer";c.onload=function(){b.decodeAudioData(c.response,function(a){m=a},function(){BC.Util.error("error decoding data for "+a)})};c.send()}var b,m;window.AudioContext=window.AudioContext||window.webkitAudioContext;window.AudioContext&&(b=new AudioContext,a("audio/sounds.ogg"));return{play:function(a){if(m){var c=m,g=a.offset;a=a.duration;
var h=b.createBufferSource();h.buffer=c;h.connect(b.destination);h.start(0,g,a)}}}};return e}(BC||{});BC=function(e){function d(a,b){return{offset:a,duration:b}}(e.Audio=e.Audio||{}).Sound={BUTTON_HOVER:d(1,0.5),BUTTON_CLICK:d(0,0.75),SELECTOR_MOVEMENT:d(1,0.5),CELL_SWAP:d(2,0.5),CELL_CLEAR:d(3,0.5)};return e}(BC||{});BC=function(e){(e.Selector=e.Selector||{}).make=function(d){function a(a){f=a;0<v.length&&BC.Util.error("startMoving: pending animations: "+v.length);v.push(BC.Animation.make({duration:h,updateCallback:function(a){var k=b.ringHeight*a.deltaPercent;a=s*a.deltaPercent;switch(f){case c.UP:return q[1]+=k,!0;case c.DOWN:return q[1]-=k,!0;case c.LEFT:return m.rotate(a),!0;case c.RIGHT:return m.rotate(-a),!0;default:return!1}},finishCallback:function(){f=c.NONE;k.play(g.SELECTOR_MOVEMENT)}}))}var b=d.metrics,
m=d.board,k=d.audioPlayer,c=BC.Constants.Direction,g=BC.Audio.Sound,h=0.025,e={matrix:BC.Matrix.identity,move:function(b){switch(b){case c.LEFT:return f!==c.NONE?b=!1:(a(c.LEFT),b=!0),b;case c.RIGHT:return f!==c.NONE?b=!1:(a(c.RIGHT),b=!0),b;case c.UP:return f!==c.NONE?b=!1:(a(c.UP),b=!0),b;case c.DOWN:return f!==c.NONE?b=!1:(a(c.DOWN),b=!0),b;default:return BC.Util.error("move: unsupported direction: "+b),!1}},update:function(a){BC.Animation.process(v,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,
a,1);var b=BC.Matrix.makeTranslation(q[0],q[1],q[2]);e.matrix=BC.Matrix.matrixMultiply(a,b)}},f=c.NONE,v=[],q=[0,0,0],s=BC.Math.sliceRadians(b.numCells);return e};return e}(BC||{});BC=function(e){(e.Resources=e.Resources||{}).make=function(){var d=BC.GL.textureTileSet(8,8,0.002),a=[d.tile(0,0),d.tile(0,1),d.tile(0,2),d.tile(0,3),d.tile(0,4),d.tile(0,5),d.tile(2,0),d.tile(2,1),d.tile(2,2),d.tile(2,3),d.tile(2,4),d.tile(2,5),d.tile(1,0),d.tile(1,1),d.tile(1,2),d.tile(1,3),d.tile(1,4),d.tile(1,5)],b=d.tile(4,0),d=d.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:d}};return e}(BC||{});BC=function(e){(e.Game=e.Game||{}).run=function(){function d(a){return r.getUniformLocation(U,a)}function a(){return A.width!=A.clientWidth||A.height!=A.clientHeight?(A.width=A.clientWidth,A.height=A.clientHeight,!0):!1}function b(){var a=A.width/A.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function m(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function k(){t=!0;l=!1;B=BC.Board.make({metrics:N,audioPlayer:H});I=BC.Board.View.make({board:B,
gl:r,programLocations:W,resources:O});C.setMoveLeftListener(function(){B.move(s.LEFT)});C.setMoveRightListener(function(){B.move(s.RIGHT)});C.setMoveUpListener(function(){B.move(s.UP)});C.setMoveDownListener(function(){B.move(s.DOWN)});C.setPrimaryActionListener(function(){B.swap()});c()}function c(){p=!1;h(!1);J.reset();g()}function g(){r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);r.viewport(0,0,r.canvas.width,r.canvas.height);r.uniformMatrix4fv(W.projectionMatrixLocation,!1,X);var a=!p&&!l&&B;
a&&(J.tick(),l=B.update(J));I&&I.draw();a&&requestAnimationFrame(g);l&&(p=t=!1,h(!0))}function h(a){if(a){y.text(l?v:t&&p?f:e);if(a=t||l)P.draw(B.speedLevel),Q.draw(B.score),R.draw(B.elapsedTime);var b=x;a?b.show():b.hide();a=z;t?a.show():a.hide();u.fadeIn(q);D.fadeOut(q)}else u.fadeOut(q),D.fadeIn(q)}var e="b l o c k c i l l i n",f="P A U S E D",v="G A M E  O V E R",q="slow",s=BC.Constants.Direction,w=BC.Audio.Sound,t=!1,p=!1,l=!1,u=$("#main-menu"),y=$("#main-menu-title"),x=$("#main-menu-stats"),
z=$("#continue-button"),G=$("#new-game-button"),K=$("#options-button"),D=$("#game-menu"),E=$("#pause-button"),F=$(".button"),N={numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},O=BC.Resources.make(),J=BC.StopWatch.make(),H=BC.Audio.Player.make(),P=BC.Stat.View.make("#main-menu-speed-level-stat"),R=BC.Stat.View.make("#main-menu-elapsed-time-stat"),Q=BC.Stat.View.make("#main-menu-score-stat"),B,I,A=document.getElementById("canvas");if(A){var C=BC.Controller.make(A),
S=BC.Menu.Options.make({controller:C}),r=A.getContext("webgl")||A.getContext("experimental-webgl");if(r){var M=r.createTexture();r.bindTexture(r.TEXTURE_2D,M);r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var L=new Image;L.src="images/textures.png";$(L).load(function(){r.bindTexture(r.TEXTURE_2D,M);r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,L);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,
r.LINEAR_MIPMAP_NEAREST);r.generateMipmap(r.TEXTURE_2D)});r.enable(r.CULL_FACE);r.enable(r.DEPTH_TEST);r.enable(r.BLEND);r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);var T=BC.GL.loadShader(r,"vertex-shader",r.VERTEX_SHADER),V=BC.GL.loadShader(r,"fragment-shader",r.FRAGMENT_SHADER),U=BC.GL.createProgram(r,[T,V]);r.useProgram(U);var W={positionLocation:r.getAttribLocation(U,"a_position"),textureCoordLocation:r.getAttribLocation(U,"a_textureCoord"),projectionMatrixLocation:d("u_projectionMatrix"),
viewMatrixLocation:d("u_viewMatrix"),boardRotationMatrixLocation:d("u_boardRotationMatrix"),boardTranslationMatrixLocation:d("u_boardTranslationMatrix"),selectorMatrixLocation:d("u_selectorMatrix"),ringMatrixLocation:d("u_ringMatrix"),cellMatrixLocation:d("u_cellMatrix"),yellowBoostLocation:d("u_yellowBoost"),alphaLocation:d("u_alpha")};a();var X=b();$(window).resize(function(){a()&&(X=b(),g())});T=m();r.uniformMatrix4fv(W.viewMatrixLocation,!1,T);F.click(function(a){H.play(w.BUTTON_CLICK);$(a.target).fadeIn(20).fadeOut(20).fadeIn(20).fadeOut(20).fadeIn(20)});
F.mouseenter(function(){H.play(w.BUTTON_HOVER)});h(!0);G.click(function(){k()});z.click(function(){c()});E.click(function(){p=!0;h(!0)});K.click(function(){S.show()});C.setMenuActionListener(function(){p?c():(p=!0,h(!0))});document.addEventListener("visibilitychange",function(){document.hidden&&(p=!0,h(!0))})}}};return e}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(e){var d=e.Cell=e.Cell||{},d=d.Chain=d.Chain||{};d.find=function(a){function b(b,c){return a.rings[b].cells[c]}function m(){for(var c=a.rings.length,m=[],k=0;k<c;k++){var g;g=k;for(var e=0,p=b(g,e),l=0;l<d;l++){var u=b(g,e);if(p.state!==u.state||p.blockStyle!=u.blockStyle)break;e+=1;e=e===d?0:e}g=e;for(e=0;e<d;)if(l=(e+g)%d,u=b(k,l),u.state!==h.BLOCK)e++;else{for(var y=1,p=e+1;p<d;p++)if(l=(p+g)%d,l=b(k,l),u.state===l.state&&u.blockStyle==l.blockStyle)y++;else break;if(y>=f){for(u=[];e<
p;e++)l=(e+g)%d,y=b(k,l),u.push({cell:y,row:k,col:l});m.push(u)}e=p}}return m}function k(){for(var c=a.rings.length,m=[],k=0;k<d;k++)for(var g=0;g<c;){var e=b(g,k);if(e.state!==h.BLOCK)g++;else{for(var p=1,l=g+1;l<c;l++){var u=b(l,k);if(e.state===u.state&&e.blockStyle==u.blockStyle)p++;else break}if(p>=f){for(e=[];g<l;g++)p=b(g,k),e.push({cell:p,row:g,col:k});m.push(e)}g=l}}return m}function c(a,b){for(var c=0;c<a.length;c++)for(var k=a[c],m=0;m<b.length;m++){var g=b[m];if(k.blockStyle===g.blockStyle&&
k.row===g.row&&k.col===g.col)return!0}return!1}function g(a,b){for(var c=0;c<a.length;c++){var k=a[c];if(k.blockStyle===b.blockStyle&&k.row===b.row&&k.col===b.col)return!0}return!1}var h=BC.Cell.CellState,d=a.rings[0].cells.length,f=3;return function(){for(var a=[],b=m(),f=k();0<b.length;){var h=b.shift();for(a.push(h);;){for(var d=!1,e=0;e<f.length;e++)if(c(h,f[e])){for(d=0;d<f[e].length;d++)g(h,f[e][d])||h.push(f[e][d]);f.splice(e,1);d=!0}if(!d)break;d=!1;for(e=0;e<b.length;e++)if(c(h,b[e])){for(d=
0;d<b[e].length;d++)g(h,b[e][d])||h.push(b[e][d]);b.splice(e,1);d=!0}if(!d)break}}for(;0<f.length;)h=f.shift(),a.push(h);for(e=0;e<a.length;e++)a[e].sort(function(a,b){return a.row-b.row});return a}()};d.makeManager=function(){var a=BC.Cell.CellState,b=[],m=[];return{update:function(k){k=BC.Cell.Chain.find(k);for(var c=0;c<k.length;c++){var g=k[c];m.push(g);for(var d=0;d<g.length;d++){var e=g[d].cell;e.markBlock();b.push(e)}}if(0<b.length)switch(e=b[0],e.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:e.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<m.length){g=m[0];d=!0;for(c=0;c<g.length;c++)e=g[c].cell,d&=!e.isClearing();if(d){for(c=0;c<g.length;c++)e=g[c].cell,e.state===a.EMPTY_NO_DROP&&(e.state=a.EMPTY);m.shift()}}return{newChains:k,pendingChainCount:m.length}}}};return e}(BC||{});BC=function(e){(e.Stage=e.Stage||{}).make=function(d,a){a+=d.ringHeight/2-0.01;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return e}(BC||{});BC=function(e){var d=e.Util=e.Util||{};d.log=function(a){window.console&&window.console.log&&window.console.log(a)};d.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return e}(BC||{});BC=function(e){var d=e.Selector=e.Selector||{};(d.View=d.View||{}).make=function(a,b,d){var k=-b.ringHeight/2,c=-k;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var e=b.length-2,h=[],n=0;h[n++]=b[e]+0.001;h[n++]=k;h[n++]=-b[e+1]-0.001;h[n++]=b[0]+0.001;h[n++]=k;h[n++]=-b[1]-0.001;h[n++]=b[0]+0.001;h[n++]=c;h[n++]=-b[1]-0.001;h[n++]=b[e]+0.001;h[n++]=c;h[n++]=-b[e+1]-0.001;h[n++]=b[0]+0.001;h[n++]=k;h[n++]=-b[1]-0.001;h[n++]=b[2]+0.001;h[n++]=k;h[n++]=-b[3]-0.001;h[n++]=b[2]+
0.001;h[n++]=c;h[n++]=-b[3]-0.001;h[n++]=b[0]+0.001;h[n++]=c;h[n++]=-b[1]-0.001;var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);k=d.textureCoord(0,0);c=d.textureCoord(1,0);b=d.textureCoord(1,1);d=d.textureCoord(0,1);d=new Float32Array([].concat(k,c,b,d,k,c,b,d));var v=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);var q=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),s=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
s);a.bufferData(a.ELEMENT_ARRAY_BUFFER,q,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s);a.drawElements(a.TRIANGLES,q.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var d=e.Matrix=e.Matrix||{};d.makeLookAt=function(a,b,d){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));d=BC.Math.cross(d,b);var k=BC.Math.cross(b,d);return[d[0],d[1],d[2],0,k[0],k[1],k[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};d.makePerspective=function(a,b,d,k){a=Math.tan(0.5*Math.PI-0.5*a);var c=1/(d-k);return[a/b,0,0,0,0,a,0,0,0,0,(d+k)*c,-1,0,0,d*k*c*2,0]};d.makeTranslation=function(a,b,d){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,d,1]};d.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};d.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};d.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};d.makeScale=function(a,b,d){return[a,0,0,0,0,b,0,0,0,0,d,0,0,0,0,1]};d.identity=d.makeScale(1,1,1);d.makeInverse=function(a){var b=a[0],d=a[1],k=a[2],c=a[3],e=a[4],h=a[5],n=a[6],f=a[7],v=a[8],q=a[9],s=a[10],w=a[11],t=a[12],p=a[13],l=a[14];a=
a[15];var u=s*a,y=l*w,x=n*a,z=l*f,G=n*w,K=s*f,D=k*a,E=l*c,F=k*w,N=s*c,O=k*f,J=n*c,H=v*p,P=t*q,R=e*p,Q=t*h,B=e*q,I=v*h,A=b*p,C=t*d,S=b*q,r=v*d,M=b*h,L=e*d,T=u*h+z*q+G*p-(y*h+x*q+K*p),V=y*d+D*q+N*p-(u*d+E*q+F*p),p=x*d+E*h+O*p-(z*d+D*h+J*p),d=K*d+F*h+J*q-(G*d+N*h+O*q),h=1/(b*T+e*V+v*p+t*d);return[h*T,h*V,h*p,h*d,h*(y*e+x*v+K*t-(u*e+z*v+G*t)),h*(u*b+E*v+F*t-(y*b+D*v+N*t)),h*(z*b+D*e+J*t-(x*b+E*e+O*t)),h*(G*b+N*e+O*v-(K*b+F*e+J*v)),h*(H*f+Q*w+B*a-(P*f+R*w+I*a)),h*(P*c+A*w+r*a-(H*c+C*w+S*a)),h*(R*c+C*f+
M*a-(Q*c+A*f+L*a)),h*(I*c+S*f+L*w-(B*c+r*f+M*w)),h*(R*s+I*l+P*n-(B*l+H*n+Q*s)),h*(S*l+H*k+C*s-(A*s+r*l+P*k)),h*(A*n+L*l+Q*k-(M*l+R*k+C*n)),h*(M*s+B*k+r*n-(S*n+L*s+I*k))]};d.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return e}(BC||{});BC=function(e){var d=e.Cell=e.Cell||{};(d.Drop=d.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,d=BC.Constants.Direction,e=[];return{update:function(c){for(var g=0;g<c.rings.length;g++)for(var h=0;h<a.numCells;h++){var n=c,f=g,v=h,q=n.rings[f].cells[v];q.state===b.BLOCK&&(f+=1,f>=n.rings.length||(n=n.rings[f].cells[v],q.state===b.BLOCK&&n.state==b.EMPTY&&(q=q.sendBlock(0.05),n.receiveBlock(0.05,d.UP,q),e.push(n))))}a:{for(;0<e.length;){if(e[0].hasDroppingBlock()){c=!0;break a}e.shift()}c=
!1}return c}}};return e}(BC||{});BC=function(e){(e.Constants=e.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return e}(BC||{});BC=function(e){var d=e.Animation=e.Animation||{};d.make=function(a){var b=a.duration,d=a.startCallback||function(){},e=a.updateCallback||function(){return!1},c=a.finishCallback||function(){},g=0,h=!1,n=!1;return{update:function(a){h||(h=!0,d());var v=a.deltaTime;g+v>b&&(v=b-g);g+=v;a=e({now:a.now,deltaTime:v,elapsedPercent:g/b,deltaPercent:v/b});g>=b&&(n=!0,c());return a},isDone:function(){return n}}};d.process=function(a,b){var d=!1;if(0<a.length){var e=a[0],d=d|e.update(b);e.isDone()&&a.shift()}return d};
return e}(BC||{});BC=function(e){var d=e.Stage=e.Stage||{};(d.View=d.View||{}).make=function(a,b,d){b=[];var e=0;b[e++]=-1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=-1;b[e++]=0;b[e++]=1;var c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=d.textureCoord(0,0);var e=d.textureCoord(1,0),g=d.textureCoord(1,
1);d=d.textureCoord(0,1);d=new Float32Array([].concat(b,e,g,d,b,e,g,d));var h=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,h);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),f=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var d=b.positionLocation,e=b.textureCoordLocation,g=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,c);a.enableVertexAttribArray(d);
a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,h);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(g,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){(e.Board=e.Board||{}).make=function(d){function a(a){a=BC.Ring.make({metrics:k,translationY:-k.ringHeight*u,selectable:a,audioPlayer:c});l.push(a);u++}function b(){x.translationMatrix=BC.Matrix.makeTranslation(t[0],t[1],t[2])}function e(){var a=BC.Matrix.makeXRotation(p[0]),b=BC.Matrix.makeYRotation(p[1]),c=BC.Matrix.makeZRotation(p[2]),b=BC.Matrix.matrixMultiply(c,b),b=BC.Matrix.matrixMultiply(b,a);x.rotationMatrix=b}var k=d.metrics,c=d.audioPlayer,g=BC.Cell.CellState,h=BC.Constants.Direction,
n=BC.Audio.Sound,f=11*k.ringHeight,v=2*k.ringHeight,q=0,s=k.numCells-1;d=5.5*-k.ringHeight-k.ringHeight/2;for(var w=k.ringHeight*k.numRings,t=[0,d+w,0],p=[0,0,0],l=[],u=0,y=0;y<k.numRings;y++)a(!0);for(y=0;2>y;y++)a(!1);var x={metrics:k,rings:l,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case h.LEFT:z.move(h.LEFT)&&(s--,0>s&&(s=k.numCells-1));break;case h.RIGHT:z.move(h.RIGHT)&&(s++,s>=k.numCells&&(s=0));break;case h.UP:0<q&&z.move(h.UP)&&q--;
break;case h.DOWN:q+1<x.rings.length&&l[q+1].isSelectable()&&z.move(h.DOWN)&&q++}},rotate:function(a){p[1]+=a},swap:function(){var a=l[q].cells[s%k.numCells],b=l[q].cells[(s+1)%k.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var d=a.blockStyle,e=b.blockStyle;a.state!==g.EMPTY&&a.state!==g.EMPTY_NO_DROP||b.state!==g.BLOCK?a.state!==g.BLOCK||b.state!==g.EMPTY&&b.state!==g.EMPTY_NO_DROP?a.state===g.BLOCK&&b.state===g.BLOCK&&(a.receiveBlock(0.1,h.RIGHT,e),b.receiveBlock(0.1,h.LEFT,d),c.play(n.CELL_SWAP)):
(a.sendBlock(0.1,h.RIGHT),b.receiveBlock(0.1,h.LEFT,d),c.play(n.CELL_SWAP)):(b.sendBlock(0.1,h.LEFT),a.receiveBlock(0.1,h.RIGHT,e),c.play(n.CELL_SWAP))},update:function(c){for(var d=0;d<l.length;d++)for(var g=0;g<k.numCells;g++)l[d].cells[g%k.numCells].update(c);for(var d=0|K.update(x),g=G.update(x),h=0;h<g.newChains.length;h++)F.value+=100*g.newChains[h].length;d|=0<g.pendingChainCount;d||(d=(0.02+0.01*(D.value-1))*c.deltaTime,w+d>f&&(d=f-w),w+=d,t[1]+=d);E.value+=c.deltaTime;D.value=1+Math.floor(E.value/
30);z.update(c);b();for(e();0<l.length&&l[0].isEmpty();)l.shift(),w-=k.ringHeight,q--;for(c=w-k.ringHeight*l.length;c>-v;)a(!1),c-=k.ringHeight;for(c=l.length-1;0<=c&&!l[c].isSelectable();c--)0<=w-k.ringHeight*(c+1)&&l[c].setSelectable(!0);return w>=f}};b();e();var z=BC.Selector.make({metrics:k,board:x,audioPlayer:c});x.selector=z;d=BC.Stage.make(k,d);x.stage=d;var G=BC.Cell.Chain.makeManager(),K=BC.Cell.Drop.makeManager(k),D=BC.Stat.make({value:1,unit:BC.Stat.Unit.INTEGER});x.speedLevel=D;var E=
BC.Stat.make({value:0,unit:BC.Stat.Unit.SECONDS});x.elapsedTime=E;var F=BC.Stat.make({value:0,unit:BC.Stat.Unit.INTEGER});x.score=F;return x};return e}(BC||{});BC=function(e){var d=e.Menu=e.Menu||{};(d.Options=d.Options||{}).make=function(a){function b(a,b,c){var d=$(a,b);v[c]=d;d.click(function(){d.text(h);f.startKeyCodeAssignment(c)});return d}function d(a,b){var c=f.getKeyCode(b);a.text(g[c]||"#"+c)}function e(){f.cancelKeyCodeAssignment();q.fadeOut(n)}var c=BC.Controller.Key,g={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",
39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",
109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},h="PRESS KEY",n="slow",f=a.controller,v={},q=$("#options-menu"),s=b("#up-button",q,c.UP),w=b("#down-button",q,c.DOWN),t=b("#left-button",q,c.LEFT),p=b("#right-button",q,c.RIGHT),l=b("#swap-button",
q,c.PRIMARY_ACTION),u=b("#menu-button",q,c.MENU_ACTION);$("#close-button",q).click(function(){e()});f.setKeyCodeAssignmentListener(function(a,b){v[a].text(g[b]||"#"+b)});return{show:function(){d(s,c.UP);d(w,c.DOWN);d(t,c.LEFT);d(p,c.RIGHT);d(l,c.PRIMARY_ACTION);d(u,c.MENU_ACTION);q.fadeIn(n)},hide:e}};return e}(BC||{});BC=function(e){var d=e.Controller=e.Controller||{};d.Key={UP:"0",DOWN:"1",LEFT:"2",RIGHT:"3",PRIMARY_ACTION:"4",MENU_ACTION:"5"};d.make=function(a){function b(a,b){var c=parseInt(p[a],10)||b;return{storageKey:a,keyCode:c}}function d(a){return u[a].keyCode}function e(a,b){u[a].keyCode=b;p[u[a].storageKey]=b;s(a,b)}var c=BC.Controller.Key,g=function(){},h=function(){},n=function(){},f=function(){},v=function(){},q=function(){},s=function(){},w=0,t=0,p=localStorage||{},l,u={};u[c.UP]=b("bc.controller.up",
38);u[c.DOWN]=b("bc.controller.down",40);u[c.LEFT]=b("bc.controller.left",37);u[c.RIGHT]=b("bc.controller.right",39);u[c.PRIMARY_ACTION]=b("bc.controller.primaryAction",32);u[c.MENU_ACTION]=b("bc.controller.menuAction",27);$(document).keydown(function(a){if(null!=l){a=a.keyCode;var b=d(l),p;a:{var t=l;for(p in u)if(u.hasOwnProperty(p)&&p!==t&&u[p].keyCode===a)break a;p=null}p&&e(p,b);e(l,a);l=null;return!1}switch(a.keyCode){case d(c.LEFT):g.call();break;case d(c.RIGHT):h.call();break;case d(c.UP):n.call();
break;case d(c.DOWN):f.call();break;case d(c.PRIMARY_ACTION):v.call();break;case d(c.MENU_ACTION):q.call();break;default:console.log(a.keyCode)}return!1});$(a).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":w=b.pageX;t=b.pageY;break;case "touchend":var c=b.pageX-w,d=b.pageY-t,e=Math.abs(c),k=Math.abs(d);a=function(){return 20<k?(0<d?f.call():n.call(),!0):!1};b=function(){return 20<e?(0<c?g.call():h.call(),!0):!1};if(e>k){if(b()||
a())break}else if(a()||b())break;v.call()}return!1});return{setMoveLeftListener:function(a){g=a},setMoveRightListener:function(a){h=a},setMoveUpListener:function(a){n=a},setMoveDownListener:function(a){f=a},setPrimaryActionListener:function(a){v=a},setMenuActionListener:function(a){q=a},setKeyCodeAssignmentListener:function(a){s=a},startKeyCodeAssignment:function(a){l=a},cancelKeyCodeAssignment:function(){l=null},getKeyCode:d}};return e}(BC||{});BC=function(e){var d=e.Cell=e.Cell||{};(d.View=d.View||{}).make=function(a,b,d){function e(b,c){var d=c.positionLocation,g=c.textureCoordLocation,f=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,q[b.blockStyle]);a.enableVertexAttribArray(g);a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0);a.uniform1f(f,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s);a.drawElements(a.TRIANGLES,
w,a.UNSIGNED_SHORT,0)}var c=b.numCells,g=b.ringOuterRadius,h=b.ringHeight/2,n=-h,f=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,c,f);g=BC.Math.circlePoints(g,c,f);c=0;f=[];f[c++]=b[0];f[c++]=h;f[c++]=-b[1];f[c++]=g[0];f[c++]=h;f[c++]=-g[1];f[c++]=g[2];f[c++]=h;f[c++]=-g[3];f[c++]=b[2];f[c++]=h;f[c++]=-b[3];f[c++]=g[0];f[c++]=n;f[c++]=-g[1];f[c++]=b[0];f[c++]=n;f[c++]=-b[1];f[c++]=b[2];f[c++]=n;f[c++]=-b[3];f[c++]=g[2];f[c++]=n;f[c++]=-g[3];f[c++]=b[0];f[c++]=h;f[c++]=-b[1];f[c++]=b[0];f[c++]=
n;f[c++]=-b[1];f[c++]=g[0];f[c++]=n;f[c++]=-g[1];f[c++]=g[0];f[c++]=h;f[c++]=-g[1];f[c++]=g[2];f[c++]=h;f[c++]=-g[3];f[c++]=g[2];f[c++]=n;f[c++]=-g[3];f[c++]=b[2];f[c++]=n;f[c++]=-b[3];f[c++]=b[2];f[c++]=h;f[c++]=-b[3];f[c++]=g[0];f[c++]=h;f[c++]=-g[1];f[c++]=g[0];f[c++]=n;f[c++]=-g[1];f[c++]=g[2];f[c++]=n;f[c++]=-g[3];f[c++]=g[2];f[c++]=h;f[c++]=-g[3];f[c++]=b[2];f[c++]=h;f[c++]=-b[3];f[c++]=b[2];f[c++]=n;f[c++]=-b[3];f[c++]=b[0];f[c++]=n;f[c++]=-b[1];f[c++]=b[0];f[c++]=h;f[c++]=-b[1];var v=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);h=[];for(c=0;c<d.length;c++)for(n=d[c],h[c]=[],g=b=0;6>b;b++)f=n.textureCoord(0,0),h[c][g++]=f[0],h[c][g++]=f[1],f=n.textureCoord(0,1),h[c][g++]=f[0],h[c][g++]=f[1],f=n.textureCoord(1,1),h[c][g++]=f[0],h[c][g++]=f[1],f=n.textureCoord(1,0),h[c][g++]=f[0],h[c][g++]=f[1];for(var q=[],c=0;c<d.length;c++)q[c]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,q[c]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(h[c]),
a.STATIC_DRAW);d=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var s=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s);a.bufferData(a.ELEMENT_ARRAY_BUFFER,d,a.STATIC_DRAW);var w=d.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,c),a.enable(a.CULL_FACE))}}};return e}(BC||{});BC=function(e){var d=e.Stat=e.Stat||{};d.Unit={INTEGER:0,SECONDS:1};d.make=function(a){return{value:a.value,unit:a.unit}};return e}(BC||{});BC=function(e){var d=e.Stat=e.Stat||{},a;(d.View=d.View||{}).make=function(b){if(!a){var d=BC.Stat.Unit;a={};a[d.INTEGER]=function(a){return a};a[d.SECONDS]=function(a){var b=Math.floor(a/3600);a-=3600*b;var d=Math.floor(a/60);a=Math.floor(a-60*d);10>b&&(b="0"+b);10>d&&(d="0"+d);10>a&&(a="0"+a);return b+":"+d+":"+a}}var e=$(b);return{draw:function(b){e.text((0,a[b.unit])(b.value))}}};return e}(BC||{});BC=function(e){(e.StopWatch=e.StopWatch||{}).make=function(){function d(){a.then=0.001*Date.now()}var a={reset:d,tick:function(){a.now=0.001*Date.now();a.deltaTime=a.now-a.then;a.then=a.now}};d();return a};return e}(BC||{});
