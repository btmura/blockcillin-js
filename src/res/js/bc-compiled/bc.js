var BC=function(e){var c=e.Matrix=e.Matrix||{};c.makeLookAt=function(a,b,l){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));l=BC.Math.cross(l,b);var q=BC.Math.cross(b,l);return[l[0],l[1],l[2],0,q[0],q[1],q[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,l,q){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(l-q);return[a/b,0,0,0,0,a,0,0,0,0,(l+q)*d,-1,0,0,l*q*d*2,0]};c.makeTranslation=function(a,b,l){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,l,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,l){return[a,0,0,0,0,b,0,0,0,0,l,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],l=a[1],q=a[2],d=a[3],c=a[4],k=a[5],h=a[6],f=a[7],u=a[8],n=a[9],e=a[10],p=a[11],s=a[12],v=a[13],r=a[14];a=
a[15];var t=e*a,y=r*p,B=h*a,C=r*f,L=h*p,M=e*f,N=q*a,E=r*d,z=q*p,I=e*d,x=q*f,A=h*d,m=u*v,J=s*n,F=c*v,G=s*k,O=c*n,D=u*k,H=b*v,K=s*l,P=b*n,Q=u*l,R=b*k,S=c*l,T=t*k+C*n+L*v-(y*k+B*n+M*v),U=y*l+N*n+I*v-(t*l+E*n+z*v),v=B*l+E*k+x*v-(C*l+N*k+A*v),l=M*l+z*k+A*n-(L*l+I*k+x*n),k=1/(b*T+c*U+u*v+s*l);return[k*T,k*U,k*v,k*l,k*(y*c+B*u+M*s-(t*c+C*u+L*s)),k*(t*b+E*u+z*s-(y*b+N*u+I*s)),k*(C*b+N*c+A*s-(B*b+E*c+x*s)),k*(L*b+I*c+x*u-(M*b+z*c+A*u)),k*(m*f+G*p+O*a-(J*f+F*p+D*a)),k*(J*d+H*p+Q*a-(m*d+K*p+P*a)),k*(F*d+K*f+
R*a-(G*d+H*f+S*a)),k*(D*d+P*f+S*p-(O*d+Q*f+R*p)),k*(F*e+D*r+J*h-(O*r+m*h+G*e)),k*(P*r+m*q+K*e-(H*e+Q*r+J*q)),k*(H*h+S*r+G*q-(R*r+F*q+K*h)),k*(R*e+O*q+Q*h-(P*h+S*e+D*q))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return e}(BC||{});BC=function(e){(e.Resources=e.Resources||{}).make=function(){var c=BC.GL.textureTileSet(8,8,0.002),a=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(0,4),c.tile(0,5),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(2,4),c.tile(2,5),c.tile(1,0),c.tile(1,1),c.tile(1,2),c.tile(1,3),c.tile(1,4),c.tile(1,5)],b=c.tile(4,0),c=c.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:c}};return e}(BC||{});BC=function(e){var c=e.Animation=e.Animation||{};c.make=function(a){var b=a.duration,l=a.startCallback||function(){},c=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},g=0,k=!1,h=!1;return{update:function(a){k||(k=!0,l());var u=a.deltaTime;g+u>b&&(u=b-g);g+=u;a=c({now:a.now,deltaTime:u,elapsedPercent:g/b,deltaPercent:u/b});g>=b&&(h=!0,d());return a},isDone:function(){return h}}};c.process=function(a,b){var l=!1;if(0<a.length){var c=a[0],l=l|c.update(b);c.isDone()&&a.shift()}return l};
return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{},c=c.Chain=c.Chain||{};c.find=function(a){function b(b,d){return a.rings[b].cells[d]}function l(){for(var d=a.rings.length,l=[],c=0;c<d;c++){var q;q=c;for(var g=0,e=b(q,g),r=0;r<h;r++){var t=b(q,g);if(e.state!==t.state||e.blockStyle!=t.blockStyle)break;g+=1;g=g===h?0:g}q=g;for(g=0;g<h;)if(r=(g+q)%h,t=b(c,r),t.state!==k.BLOCK)g++;else{for(var y=1,e=g+1;e<h;e++)if(r=(e+q)%h,r=b(c,r),t.state===r.state&&t.blockStyle==r.blockStyle)y++;else break;if(y>=f){for(t=[];g<
e;g++)r=(g+q)%h,y=b(c,r),t.push({cell:y,row:c,col:r});l.push(t)}g=e}}return l}function c(){for(var d=a.rings.length,l=[],q=0;q<h;q++)for(var g=0;g<d;){var e=b(g,q);if(e.state!==k.BLOCK)g++;else{for(var v=1,r=g+1;r<d;r++){var t=b(r,q);if(e.state===t.state&&e.blockStyle==t.blockStyle)v++;else break}if(v>=f){for(e=[];g<r;g++)v=b(g,q),e.push({cell:v,row:g,col:q});l.push(e)}g=r}}return l}function d(a,b){for(var d=0;d<a.length;d++)for(var f=a[d],l=0;l<b.length;l++){var c=b[l];if(f.blockStyle===c.blockStyle&&
f.row===c.row&&f.col===c.col)return!0}return!1}function g(a,b){for(var d=0;d<a.length;d++){var f=a[d];if(f.blockStyle===b.blockStyle&&f.row===b.row&&f.col===b.col)return!0}return!1}var k=BC.Cell.CellState,h=a.rings[0].cells.length,f=3;return function(){for(var a=[],b=l(),f=c();0<b.length;){var h=b.shift();for(a.push(h);;){for(var k=!1,e=0;e<f.length;e++)if(d(h,f[e])){for(k=0;k<f[e].length;k++)g(h,f[e][k])||h.push(f[e][k]);f.splice(e,1);k=!0}if(!k)break;k=!1;for(e=0;e<b.length;e++)if(d(h,b[e])){for(k=
0;k<b[e].length;k++)g(h,b[e][k])||h.push(b[e][k]);b.splice(e,1);k=!0}if(!k)break}}for(;0<f.length;)h=f.shift(),a.push(h);for(e=0;e<a.length;e++)a[e].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(c){var d=BC.Cell.Chain.find(c);for(c=0;c<d.length;c++){var g=d[c];l.push(g);for(var k=0;k<g.length;k++){var h=g[k].cell;h.markBlock();b.push(h)}}if(0<b.length)switch(h=b[0],h.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:h.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){g=l[0];d=!0;for(c=0;c<g.length;c++)h=g[c].cell,d&=!h.isClearing();if(d){for(c=0;c<g.length;c++)h=g[c].cell,h.state===a.EMPTY_NO_DROP&&(h.state=a.EMPTY);l.shift()}}return 0<l.length}}};return e}(BC||{});BC=function(e){(e.Constants=e.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return e}(BC||{});BC=function(e){(e.Board=e.Board||{}).make=function(c){function a(a){a=BC.Ring.make({metrics:c,translationY:-c.ringHeight*v,selectable:a});s.push(a);v++}function b(){t.translationMatrix=BC.Matrix.makeTranslation(w[0],w[1],w[2])}function l(){var a=BC.Matrix.makeXRotation(p[0]),b=BC.Matrix.makeYRotation(p[1]),d=BC.Matrix.makeZRotation(p[2]),b=BC.Matrix.matrixMultiply(d,b),b=BC.Matrix.matrixMultiply(b,a);t.rotationMatrix=b}for(var q=BC.Cell.CellState,d=BC.Constants.Direction,g=11*c.ringHeight,k=2*c.ringHeight,
h=0,f=c.numCells-1,e=5.5*-c.ringHeight-c.ringHeight/2,n=c.ringHeight*c.numRings,w=[0,e+n,0],p=[0,0,0],s=[],v=0,r=0;r<c.numRings;r++)a(!0);for(r=0;2>r;r++)a(!1);var t={metrics:c,rings:s,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case d.LEFT:y.move(d.LEFT)&&(f--,0>f&&(f=c.numCells-1));break;case d.RIGHT:y.move(d.RIGHT)&&(f++,f>=c.numCells&&(f=0));break;case d.UP:0<h&&y.move(d.UP)&&h--;break;case d.DOWN:h+1<t.rings.length&&s[h+1].isSelectable()&&
y.move(d.DOWN)&&h++}},rotate:function(a){p[1]+=a},swap:function(){var a=s[h].cells[f%c.numCells],b=s[h].cells[(f+1)%c.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var l=a.blockStyle,g=b.blockStyle;a.state!==q.EMPTY&&a.state!==q.EMPTY_NO_DROP||b.state!==q.BLOCK?a.state!==q.BLOCK||b.state!==q.EMPTY&&b.state!==q.EMPTY_NO_DROP?a.state===q.BLOCK&&b.state===q.BLOCK&&(a.receiveBlock(0.1,d.RIGHT,g),b.receiveBlock(0.1,d.LEFT,l)):(a.sendBlock(0.1,d.RIGHT),b.receiveBlock(0.1,d.LEFT,l)):(b.sendBlock(0.1,
d.LEFT),a.receiveBlock(0.1,d.RIGHT,g))},update:function(d){for(var f=0;f<s.length;f++)for(var e=0;e<c.numCells;e++)s[f].cells[e%c.numCells].update(d);f=0|C.update(t);f|=B.update(t);f||(f=0.02*d.deltaTime,n+f>g&&(f=g-n),n+=f,w[1]+=f);y.update(d);b();for(l();0<s.length&&s[0].isEmpty();)s.shift(),n-=c.ringHeight,h--;for(d=n-c.ringHeight*s.length;d>-k;)a(!1),d-=c.ringHeight;for(d=s.length-1;0<=d&&!s[d].isSelectable();d--)0<=n-c.ringHeight*(d+1)&&s[d].setSelectable(!0);return n>=g}};b();l();var y=BC.Selector.make(c,
t);t.selector=y;e=BC.Stage.make(c,e);t.stage=e;var B=BC.Cell.Chain.makeManager(),C=BC.Cell.Drop.makeManager(c);return t};return e}(BC||{});BC=function(e){(e.Ring=e.Ring||{}).make=function(c){var a=BC.Cell.CellState,b=c.metrics,l=c.translationY,e=c.selectable;c=BC.Math.sliceRadians(b.numCells);for(var l=BC.Matrix.makeTranslation(0,l,0),a=e?a.BLOCK:a.BLOCK_INCOMING,d=[],g=0;g<b.numCells;g++){var k=g*c,h=BC.Math.randomInt(b.numBlockTypes);e||(h+=2*b.numBlockTypes);d[g]=BC.Cell.make({metrics:b,rotationY:k,state:a,blockStyle:h})}return{matrix:l,cells:d,isEmpty:function(){for(var a=0;a<d.length;a++)if(d[a].state!==BC.Cell.CellState.EMPTY)return!1;
return!0},setSelectable:function(a){if(!e&&a)for(var c=0;c<d.length;c++)d[c].state===BC.Cell.CellState.BLOCK_INCOMING&&(d[c].state=BC.Cell.CellState.BLOCK,d[c].blockStyle-=2*b.numBlockTypes);e=a},isSelectable:function(){return e}}};return e}(BC||{});BC=function(e){(e.Stage=e.Stage||{}).make=function(c,a){a+=c.ringHeight/2-0.01;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return e}(BC||{});BC=function(e){(e.Selector=e.Selector||{}).make=function(c,a){function b(b){g=b;0<k.length&&BC.Util.error("startMoving: pending animations: "+k.length);k.push(BC.Animation.make({duration:e,updateCallback:function(b){var d=c.ringHeight*b.deltaPercent;b=f*b.deltaPercent;switch(g){case l.UP:return h[1]+=d,!0;case l.DOWN:return h[1]-=d,!0;case l.LEFT:return a.rotate(b),!0;case l.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){g=l.NONE}}))}var l=BC.Constants.Direction,e=0.025,
d={matrix:BC.Matrix.identity,move:function(a){switch(a){case l.LEFT:return g!==l.NONE?a=!1:(b(l.LEFT),a=!0),a;case l.RIGHT:return g!==l.NONE?a=!1:(b(l.RIGHT),a=!0),a;case l.UP:return g!==l.NONE?a=!1:(b(l.UP),a=!0),a;case l.DOWN:return g!==l.NONE?a=!1:(b(l.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(k,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);d.matrix=
BC.Matrix.matrixMultiply(a,b)}},g=l.NONE,k=[],h=[0,0,0],f=BC.Math.sliceRadians(c.numCells);return d};return e}(BC||{});BC=function(e){(e.Game=e.Game||{}).run=function(){function c(a){return m.getUniformLocation(D,a)}function a(){return x.width!=x.clientWidth||x.height!=x.clientHeight?(x.width=x.clientWidth,x.height=x.clientHeight,!0):!1}function b(){var a=x.width/x.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function e(){p=!0;v=!1;z=BC.Board.make(M);I=BC.Board.View.make({board:z,gl:m,programLocations:H,
resources:N});A.setMoveLeftListener(function(){z.move(w.LEFT)});A.setMoveRightListener(function(){z.move(w.RIGHT)});A.setMoveUpListener(function(){z.move(w.UP)});A.setMoveDownListener(function(){z.move(w.DOWN)});A.setPrimaryActionListener(function(){z.swap()});d()}function d(){s=!1;k(!1);E.reset();g()}function g(){m.clear(m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT);m.viewport(0,0,m.canvas.width,m.canvas.height);m.uniformMatrix4fv(H.projectionMatrixLocation,!1,K);E.tick();v=z.update(E);I.draw();s||v||requestAnimationFrame(g);
v&&(paushed=p=!1,k(!0))}function k(a){a?(t.text(v?u:s?f:h),a=B,p?a.show():a.hide(),r.fadeIn(n),C.fadeOut(n)):(r.fadeOut(n),C.fadeIn(n))}var h="b l o c k c i l l i n",f="P A U S E D",u="G A M E  O V E R",n="fast",w=BC.Constants.Direction,p=!1,s=!1,v=!1,r=$("#main-menu"),t=$("#main-menu-title"),y=$("#new-game-button"),B=$("#continue-game-button"),C=$("#game-menu"),L=$("#menu-button"),M={numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},N=BC.Resources.make(),
E=BC.StopWatch.make(),z,I,x=document.getElementById("canvas");if(x){var A=BC.Controller.make(x),m=x.getContext("webgl")||x.getContext("experimental-webgl");if(m){var J=m.createTexture();m.bindTexture(m.TEXTURE_2D,J);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,1,1,0,m.RGBA,m.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var F=new Image;F.src="images/textures.png";$(F).load(function(){m.bindTexture(m.TEXTURE_2D,J);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,F);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,
m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR_MIPMAP_NEAREST);m.generateMipmap(m.TEXTURE_2D)});m.enable(m.CULL_FACE);m.enable(m.DEPTH_TEST);m.enable(m.BLEND);m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA);var G=BC.GL.loadShader(m,"vertex-shader",m.VERTEX_SHADER),O=BC.GL.loadShader(m,"fragment-shader",m.FRAGMENT_SHADER),D=BC.GL.createProgram(m,[G,O]);m.useProgram(D);var H={positionLocation:m.getAttribLocation(D,"a_position"),textureCoordLocation:m.getAttribLocation(D,"a_textureCoord"),
projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardRotationMatrixLocation:c("u_boardRotationMatrix"),boardTranslationMatrixLocation:c("u_boardTranslationMatrix"),selectorMatrixLocation:c("u_selectorMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};a();var K=b();$(window).resize(function(){a()&&(K=b())});G=l();m.uniformMatrix4fv(H.viewMatrixLocation,!1,G);k(!0);
y.click(function(){e()});B.click(function(){d()});L.click(function(){s=!0;k(!0)});A.setMenuActionListener(function(){s?d():(s=!0,k(!0))})}}};return e}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(e){var c=e.Math=e.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var e=2*Math.PI/b,d=[],g=0;g<b;g++)d[2*g]=a*Math.cos(c+g*e),d[2*g+1]=a*Math.sin(c+g*e);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return e}(BC||{});BC=function(e){var c=e.Board=e.Board||{};(c.View=c.View||{}).make=function(a){var b=a.board,c=a.gl,e=a.programLocations;a=a.resources;var d=e.boardRotationMatrixLocation,g=e.boardTranslationMatrixLocation,k=e.selectorMatrixLocation,h=e.ringMatrixLocation,f=e.cellMatrixLocation,u=BC.Cell.View.make(c,b.metrics,a.blockTextureTiles),n=BC.Selector.View.make(c,b.metrics,a.selectorTextureTile),w=BC.Stage.View.make(c,b.metrics,a.blackTextureTile);return{draw:function(){c.uniformMatrix4fv(d,!1,b.rotationMatrix);
c.uniformMatrix4fv(g,!1,b.translationMatrix);c.uniformMatrix4fv(k,!1,BC.Matrix.identity);for(var a=b.rings,s=0;2>s;s++)for(var v=0;v<a.length;v++){c.uniformMatrix4fv(h,!1,a[v].matrix);for(var r=a[v].cells,t=0;t<r.length;t++)c.uniformMatrix4fv(f,!1,r[t].matrix),0==s?u.drawOpaque(r[t],e):u.drawTransparent(r[t],e)}c.uniformMatrix4fv(d,!1,BC.Matrix.identity);c.uniformMatrix4fv(g,!1,BC.Matrix.identity);c.uniformMatrix4fv(k,!1,b.stage.matrix);c.uniformMatrix4fv(h,!1,BC.Matrix.identity);c.uniformMatrix4fv(f,
!1,BC.Matrix.identity);w.draw(e);c.uniformMatrix4fv(d,!1,BC.Matrix.identity);c.uniformMatrix4fv(g,!1,b.translationMatrix);c.uniformMatrix4fv(k,!1,b.selector.matrix);c.uniformMatrix4fv(h,!1,BC.Matrix.identity);c.uniformMatrix4fv(f,!1,BC.Matrix.identity);n.draw(e)}}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};c.make=function(a){function b(){var a=BC.Matrix.makeYRotation(n[1]),b=BC.Matrix.makeTranslation(w[0],w[1],w[2]);p.matrix=BC.Matrix.matrixMultiply(a,b)}var c=BC.Cell.CellState,e=BC.Constants.Direction,d=a.metrics,g=a.rotationY,k=a.state;a=a.blockStyle;var h=BC.Math.sliceRadians(d.numCells),
f=[],u=!1,n=[0,g,0],w=[0,0,0],p={matrix:BC.Matrix.makeYRotation(n[1]),state:k,blockStyle:a,yellowBoost:0,alpha:1,markBlock:function(){p.state=c.BLOCK_CLEARING_MARKED;0<f.length&&BC.Util.error("markBlock: pending animations: "+f.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){p.state=c.BLOCK_CLEARING_PREPARING},updateCallback:function(a){p.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){p.yellowBoost=0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){p.blockStyle+=
d.numBlockTypes},finishCallback:function(){p.state=c.BLOCK_CLEARING_READY}});f.push(a,b)},clearBlock:function(){p.state=c.BLOCK_CLEARING_IN_PROGRESS;0<f.length&&BC.Util.error("clearBlock: pending animations: "+f.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){p.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){p.state=c.EMPTY_NO_DROP;p.alpha=1}});f.push(a)},sendBlock:function(a){var b=p.blockStyle;p.blockStyle=0;p.state=c.EMPTY_NO_SWAP;0<f.length&&BC.Util.error("sendBlock: pending animations: "+
f.length);f.push(BC.Animation.make({duration:a,finishCallback:function(){p.state=c.EMPTY}}));return b},receiveBlock:function(a,g,k){p.blockStyle=k;p.state=c.BLOCK_RECEIVING;switch(g){case e.LEFT:n[1]-=h;break;case e.RIGHT:n[1]+=h;break;case e.UP:w[1]=d.ringHeight;u=!0;break;default:BC.Util.error("receiveBlock: unsupport direction: "+g)}b();0<f.length&&BC.Util.error("receiveBlock: pending animations: "+f.length);f.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=h*a.deltaPercent;
a=d.ringHeight*a.deltaPercent;switch(g){case e.LEFT:return n[1]+=b,!0;case e.RIGHT:return n[1]-=b,!0;case e.UP:return w[1]-=a,!0;default:return!1}},finishCallback:function(){p.state=c.BLOCK;u=!1}}))},isClearing:function(){return p.state===c.BLOCK_CLEARING_MARKED||p.state===c.BLOCK_CLEARING_PREPARING||p.state===c.BLOCK_CLEARING_READY||p.state===c.BLOCK_CLEARING_IN_PROGRESS},isDrawable:function(){return p.state!==c.EMPTY&&p.state!==c.EMPTY_NO_SWAP&&p.state!==c.EMPTY_NO_DROP},isTransparent:function(){return p.state===
c.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return u},update:function(a){BC.Animation.process(f,a)&&b()}};return p};return e}(BC||{});BC=function(e){var c=e.Stage=e.Stage||{};(c.View=c.View||{}).make=function(a,b,c){b=[];var e=0;b[e++]=-1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=-1;b[e++]=0;b[e++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var e=c.textureCoord(1,0),g=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,e,g,c,b,e,g,c));var k=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,k);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var h=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),f=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.bufferData(a.ELEMENT_ARRAY_BUFFER,h,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation,g=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,k);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(g,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.drawElements(a.TRIANGLES,h.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.GL=e.GL||{};c.loadShader=function(a,b,c,e){e=e||BC.Util.error;var d=document.getElementById(b);if(!d)return e("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),e("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,e){for(var d=a.createProgram(),g=0;g<b.length;g++)a.attachShader(d,b[g]);
if(c)for(g=0;g<c.length;g++)a.bindAttribLocation(d,e?e[g]:g,c[g]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,c){var e=1/a,d=1/b;return{tile:function(a,b){var h=e*b,f=d*a;return{textureCoord:function(a,b){return[h+c+(e-2*c)*a,f+c+(d-2*c)*b]}}}}};return e}(BC||{});BC=function(e){var c=e.Selector=e.Selector||{};(c.View=c.View||{}).make=function(a,b,c){var e=-b.ringHeight/2,d=-e;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var g=b.length-2,k=[],h=0;k[h++]=b[g]+0.001;k[h++]=e;k[h++]=-b[g+1]-0.001;k[h++]=b[0]+0.001;k[h++]=e;k[h++]=-b[1]-0.001;k[h++]=b[0]+0.001;k[h++]=d;k[h++]=-b[1]-0.001;k[h++]=b[g]+0.001;k[h++]=d;k[h++]=-b[g+1]-0.001;k[h++]=b[0]+0.001;k[h++]=e;k[h++]=-b[1]-0.001;k[h++]=b[2]+0.001;k[h++]=e;k[h++]=-b[3]-0.001;k[h++]=b[2]+
0.001;k[h++]=d;k[h++]=-b[3]-0.001;k[h++]=b[0]+0.001;k[h++]=d;k[h++]=-b[1]-0.001;var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,new Float32Array(k),a.STATIC_DRAW);e=c.textureCoord(0,0);d=c.textureCoord(1,0);b=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(e,d,b,c,e,d,b,c));var u=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,u);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),w=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
w);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,u);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,w);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.Util=e.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.Drop=c.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,c=BC.Constants.Direction,e=[];return{update:function(d){for(var g=0;g<d.rings.length;g++)for(var k=0;k<a.numCells;k++){var h=d,f=g,u=k,n=h.rings[f].cells[u];n.state===b.BLOCK&&(f+=1,f>=h.rings.length||(h=h.rings[f].cells[u],n.state===b.BLOCK&&h.state==b.EMPTY&&(n=n.sendBlock(0.05),h.receiveBlock(0.05,c.UP,n),e.push(h))))}a:{for(;0<e.length;){if(e[0].hasDroppingBlock()){d=!0;break a}e.shift()}d=
!1}return d}}};return e}(BC||{});BC=function(e){(e.Controller=e.Controller||{}).make=function(c){var a=0,b=0,e=function(){},q=function(){},d=function(){},g=function(){},k=function(){},h=function(){};$(document).keydown(function(a){switch(a.keyCode){case 37:e.call();break;case 39:q.call();break;case 38:d.call();break;case 40:g.call();break;case 32:k.call();break;case 27:h.call();break;default:console.log(a.keyCode)}return!1});$(c).on("touchstart touchmove touchend",function(c){var h=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":a=
h.pageX;b=h.pageY;break;case "touchend":var n=h.pageX-a,w=h.pageY-b,p=Math.abs(n),s=Math.abs(w);c=function(){return 20<s?(0<w?g.call():d.call(),!0):!1};h=function(){return 20<p?(0<n?e.call():q.call(),!0):!1};if(p>s){if(h()||c())break}else if(c()||h())break;k.call()}return!1});return{setMoveLeftListener:function(a){e=a},setMoveRightListener:function(a){q=a},setMoveUpListener:function(a){d=a},setMoveDownListener:function(a){g=a},setPrimaryActionListener:function(a){k=a},setMenuActionListener:function(a){h=
a}}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function e(b,c){var d=c.positionLocation,f=c.textureCoordLocation,g=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,u);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,n[b.blockStyle]);a.enableVertexAttribArray(f);a.vertexAttribPointer(f,2,a.FLOAT,!1,0,0);a.uniform1f(g,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,w);a.drawElements(a.TRIANGLES,
p,a.UNSIGNED_SHORT,0)}var d=b.numCells,g=b.ringOuterRadius,k=b.ringHeight/2,h=-k,f=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,f);g=BC.Math.circlePoints(g,d,f);d=0;f=[];f[d++]=b[0];f[d++]=k;f[d++]=-b[1];f[d++]=g[0];f[d++]=k;f[d++]=-g[1];f[d++]=g[2];f[d++]=k;f[d++]=-g[3];f[d++]=b[2];f[d++]=k;f[d++]=-b[3];f[d++]=g[0];f[d++]=h;f[d++]=-g[1];f[d++]=b[0];f[d++]=h;f[d++]=-b[1];f[d++]=b[2];f[d++]=h;f[d++]=-b[3];f[d++]=g[2];f[d++]=h;f[d++]=-g[3];f[d++]=b[0];f[d++]=k;f[d++]=-b[1];f[d++]=b[0];f[d++]=
h;f[d++]=-b[1];f[d++]=g[0];f[d++]=h;f[d++]=-g[1];f[d++]=g[0];f[d++]=k;f[d++]=-g[1];f[d++]=g[2];f[d++]=k;f[d++]=-g[3];f[d++]=g[2];f[d++]=h;f[d++]=-g[3];f[d++]=b[2];f[d++]=h;f[d++]=-b[3];f[d++]=b[2];f[d++]=k;f[d++]=-b[3];f[d++]=g[0];f[d++]=k;f[d++]=-g[1];f[d++]=g[0];f[d++]=h;f[d++]=-g[1];f[d++]=g[2];f[d++]=h;f[d++]=-g[3];f[d++]=g[2];f[d++]=k;f[d++]=-g[3];f[d++]=b[2];f[d++]=k;f[d++]=-b[3];f[d++]=b[2];f[d++]=h;f[d++]=-b[3];f[d++]=b[0];f[d++]=h;f[d++]=-b[1];f[d++]=b[0];f[d++]=k;f[d++]=-b[1];var u=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,u);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);k=[];for(d=0;d<c.length;d++)for(h=c[d],k[d]=[],g=b=0;6>b;b++)f=h.textureCoord(0,0),k[d][g++]=f[0],k[d][g++]=f[1],f=h.textureCoord(0,1),k[d][g++]=f[0],k[d][g++]=f[1],f=h.textureCoord(1,1),k[d][g++]=f[0],k[d][g++]=f[1],f=h.textureCoord(1,0),k[d][g++]=f[0],k[d][g++]=f[1];for(var n=[],d=0;d<c.length;d++)n[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,n[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(k[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var w=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,w);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var p=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,c),a.enable(a.CULL_FACE))}}};return e}(BC||{});BC=function(e){(e.StopWatch=e.StopWatch||{}).make=function(){function c(){a.then=0.001*Date.now()}var a={reset:c,tick:function(){a.now=0.001*Date.now();a.deltaTime=a.now-a.then;a.then=a.now}};c();return a};return e}(BC||{});
