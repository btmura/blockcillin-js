var BC=function(e){var c=e.Matrix=e.Matrix||{};c.makeLookAt=function(a,b,l){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));l=BC.Math.cross(l,b);var m=BC.Math.cross(b,l);return[l[0],l[1],l[2],0,m[0],m[1],m[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,l,m){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(l-m);return[a/b,0,0,0,0,a,0,0,0,0,(l+m)*d,-1,0,0,l*m*d*2,0]};c.makeTranslation=function(a,b,l){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,l,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,l){return[a,0,0,0,0,b,0,0,0,0,l,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],l=a[1],m=a[2],d=a[3],h=a[4],f=a[5],k=a[6],g=a[7],c=a[8],p=a[9],e=a[10],n=a[11],t=a[12],s=a[13],q=a[14];a=
a[15];var r=e*a,w=q*n,x=k*a,y=q*g,z=k*n,A=e*g,B=m*a,C=q*d,D=m*n,E=e*d,F=m*g,G=k*d,H=c*s,I=t*p,J=h*s,K=t*f,L=h*p,M=c*f,N=b*s,O=t*l,P=b*p,Q=c*l,R=b*f,S=h*l,T=r*f+y*p+z*s-(w*f+x*p+A*s),U=w*l+B*p+E*s-(r*l+C*p+D*s),s=x*l+C*f+F*s-(y*l+B*f+G*s),l=A*l+D*f+G*p-(z*l+E*f+F*p),f=1/(b*T+h*U+c*s+t*l);return[f*T,f*U,f*s,f*l,f*(w*h+x*c+A*t-(r*h+y*c+z*t)),f*(r*b+C*c+D*t-(w*b+B*c+E*t)),f*(y*b+B*h+G*t-(x*b+C*h+F*t)),f*(z*b+E*h+F*c-(A*b+D*h+G*c)),f*(H*g+K*n+L*a-(I*g+J*n+M*a)),f*(I*d+N*n+Q*a-(H*d+O*n+P*a)),f*(J*d+O*g+
R*a-(K*d+N*g+S*a)),f*(M*d+P*g+S*n-(L*d+Q*g+R*n)),f*(J*e+M*q+I*k-(L*q+H*k+K*e)),f*(P*q+H*m+O*e-(N*e+Q*q+I*m)),f*(N*k+S*q+K*m-(R*q+J*m+O*k)),f*(R*e+L*m+Q*k-(P*k+S*e+M*m))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return e}(BC||{});BC=function(e){(e.Resources=e.Resources||{}).make=function(){var c=BC.GL.textureTileSet(8,8,0.002),a=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(0,4),c.tile(0,5),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(2,4),c.tile(2,5),c.tile(1,0),c.tile(1,1),c.tile(1,2),c.tile(1,3),c.tile(1,4),c.tile(1,5)],b=c.tile(4,0),c=c.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:c}};return e}(BC||{});BC=function(e){var c=e.Animation=e.Animation||{};c.make=function(a){var b=a.duration,l=a.startCallback||function(){},c=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},h=0,f=!1,k=!1;return{update:function(a){f||(f=!0,l());var v=a.deltaTime;h+v>b&&(v=b-h);h+=v;a=c({now:a.now,deltaTime:v,elapsedPercent:h/b,deltaPercent:v/b});h>=b&&(k=!0,d());return a},isDone:function(){return k}}};c.process=function(a,b){var l=!1;if(0<a.length){var c=a[0],l=l|c.update(b);c.isDone()&&a.shift()}return l};
return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{},c=c.Chain=c.Chain||{};c.find=function(a){function b(b,d){return a.rings[b].cells[d]}function l(){for(var d=a.rings.length,l=[],c=0;c<d;c++){var h;h=c;for(var m=0,e=b(h,m),q=0;q<k;q++){var r=b(h,m);if(e.state!==r.state||e.blockStyle!=r.blockStyle)break;m+=1;m=m===k?0:m}h=m;for(m=0;m<k;)if(q=(m+h)%k,r=b(c,q),r.state!==f.BLOCK)m++;else{for(var w=1,e=m+1;e<k;e++)if(q=(e+h)%k,q=b(c,q),r.state===q.state&&r.blockStyle==q.blockStyle)w++;else break;if(w>=g){for(r=[];m<
e;m++)q=(m+h)%k,w=b(c,q),r.push({cell:w,row:c,col:q});l.push(r)}m=e}}return l}function c(){for(var d=a.rings.length,l=[],m=0;m<k;m++)for(var h=0;h<d;){var e=b(h,m);if(e.state!==f.BLOCK)h++;else{for(var s=1,q=h+1;q<d;q++){var r=b(q,m);if(e.state===r.state&&e.blockStyle==r.blockStyle)s++;else break}if(s>=g){for(e=[];h<q;h++)s=b(h,m),e.push({cell:s,row:h,col:m});l.push(e)}h=q}}return l}function d(a,b){for(var d=0;d<a.length;d++)for(var f=a[d],g=0;g<b.length;g++){var l=b[g];if(f.blockStyle===l.blockStyle&&
f.row===l.row&&f.col===l.col)return!0}return!1}function h(a,b){for(var d=0;d<a.length;d++){var f=a[d];if(f.blockStyle===b.blockStyle&&f.row===b.row&&f.col===b.col)return!0}return!1}var f=BC.Cell.CellState,k=a.rings[0].cells.length,g=3;return function(){for(var a=[],b=l(),f=c();0<b.length;){var g=b.shift();for(a.push(g);;){for(var k=!1,e=0;e<f.length;e++)if(d(g,f[e])){for(k=0;k<f[e].length;k++)h(g,f[e][k])||g.push(f[e][k]);f.splice(e,1);k=!0}if(!k)break;k=!1;for(e=0;e<b.length;e++)if(d(g,b[e])){for(k=
0;k<b[e].length;k++)h(g,b[e][k])||g.push(b[e][k]);b.splice(e,1);k=!0}if(!k)break}}for(;0<f.length;)g=f.shift(),a.push(g);for(e=0;e<a.length;e++)a[e].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(c){var d=BC.Cell.Chain.find(c);for(c=0;c<d.length;c++){var h=d[c];l.push(h);for(var f=0;f<h.length;f++){var k=h[f].cell;k.markBlock();b.push(k)}}if(0<b.length)switch(k=b[0],k.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:k.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){h=l[0];d=!0;for(c=0;c<h.length;c++)k=h[c].cell,d&=!k.isClearing();if(d){for(c=0;c<h.length;c++)k=h[c].cell,k.state===a.EMPTY_NO_DROP&&(k.state=a.EMPTY);l.shift()}}return 0<l.length}}};return e}(BC||{});BC=function(e){(e.Constants=e.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return e}(BC||{});BC=function(e){(e.Board=e.Board||{}).make=function(c){function a(a){a=BC.Ring.make({metrics:c,translationY:-c.ringHeight*s,selectable:a});t.push(a);s++}function b(){r.translationMatrix=BC.Matrix.makeTranslation(u[0],u[1],u[2])}function l(){var a=BC.Matrix.makeXRotation(n[0]),b=BC.Matrix.makeYRotation(n[1]),d=BC.Matrix.makeZRotation(n[2]),b=BC.Matrix.matrixMultiply(d,b),b=BC.Matrix.matrixMultiply(b,a);r.rotationMatrix=b}for(var m=BC.Cell.CellState,d=BC.Constants.Direction,h=11*c.ringHeight,f=2*c.ringHeight,
k=0,g=c.numCells-1,e=5.5*-c.ringHeight-c.ringHeight/2,p=c.ringHeight*c.numRings,u=[0,e+p,0],n=[0,0,0],t=[],s=0,q=0;q<c.numRings;q++)a(!0);for(q=0;2>q;q++)a(!1);var r={metrics:c,rings:t,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case d.LEFT:w.move(d.LEFT)&&(g--,0>g&&(g=c.numCells-1));break;case d.RIGHT:w.move(d.RIGHT)&&(g++,g>=c.numCells&&(g=0));break;case d.UP:0<k&&w.move(d.UP)&&k--;break;case d.DOWN:k+1<r.rings.length&&t[k+1].isSelectable()&&
w.move(d.DOWN)&&k++}},rotate:function(a){n[1]+=a},swap:function(){var a=t[k].cells[g%c.numCells],b=t[k].cells[(g+1)%c.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var f=a.blockStyle,l=b.blockStyle;a.state!==m.EMPTY&&a.state!==m.EMPTY_NO_DROP||b.state!==m.BLOCK?a.state!==m.BLOCK||b.state!==m.EMPTY&&b.state!==m.EMPTY_NO_DROP?a.state===m.BLOCK&&b.state===m.BLOCK&&(a.receiveBlock(0.1,d.RIGHT,l),b.receiveBlock(0.1,d.LEFT,f)):(a.sendBlock(0.1,d.RIGHT),b.receiveBlock(0.1,d.LEFT,f)):(b.sendBlock(0.1,
d.LEFT),a.receiveBlock(0.1,d.RIGHT,l))},update:function(d){for(var g=0;g<t.length;g++)for(var m=0;m<c.numCells;m++)t[g].cells[m%c.numCells].update(d);g=0|y.update(r);g|=x.update(r);g||(g=0.02*d.deltaTime,p+g>h&&(g=h-p),p+=g,u[1]+=g);w.update(d);b();for(l();0<t.length&&t[0].isEmpty();)t.shift(),p-=c.ringHeight,k--;for(d=p-c.ringHeight*t.length;d>-f;)a(!1),d-=c.ringHeight;for(d=t.length-1;0<=d&&!t[d].isSelectable();d--)0<=p-c.ringHeight*(d+1)&&t[d].setSelectable(!0);p>=h&&BC.Util.log("GAME OVER")}};
b();l();var w=BC.Selector.make(c,r);r.selector=w;e=BC.Stage.make(c,e);r.stage=e;var x=BC.Cell.Chain.makeManager(),y=BC.Cell.Drop.makeManager(c);return r};return e}(BC||{});BC=function(e){(e.Ring=e.Ring||{}).make=function(c){var a=BC.Cell.CellState,b=c.metrics,l=c.translationY,m=c.selectable;c=BC.Math.sliceRadians(b.numCells);for(var l=BC.Matrix.makeTranslation(0,l,0),a=m?a.BLOCK:a.BLOCK_INCOMING,d=[],h=0;h<b.numCells;h++){var f=h*c,k=BC.Math.randomInt(b.numBlockTypes);m||(k+=2*b.numBlockTypes);d[h]=BC.Cell.make({metrics:b,rotationY:f,state:a,blockStyle:k})}return{matrix:l,cells:d,isEmpty:function(){for(var a=0;a<d.length;a++)if(d[a].state!==BC.Cell.CellState.EMPTY)return!1;
return!0},setSelectable:function(a){if(!m&&a)for(var f=0;f<d.length;f++)d[f].state===BC.Cell.CellState.BLOCK_INCOMING&&(d[f].state=BC.Cell.CellState.BLOCK,d[f].blockStyle-=2*b.numBlockTypes);m=a},isSelectable:function(){return m}}};return e}(BC||{});BC=function(e){(e.Stage=e.Stage||{}).make=function(c,a){a+=c.ringHeight/2-0.01;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return e}(BC||{});BC=function(e){(e.Selector=e.Selector||{}).make=function(c,a){function b(b){h=b;0<f.length&&BC.Util.error("startMoving: pending animations: "+f.length);f.push(BC.Animation.make({duration:m,updateCallback:function(b){var d=c.ringHeight*b.deltaPercent;b=g*b.deltaPercent;switch(h){case l.UP:return k[1]+=d,!0;case l.DOWN:return k[1]-=d,!0;case l.LEFT:return a.rotate(b),!0;case l.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){h=l.NONE}}))}var l=BC.Constants.Direction,m=0.025,
d={matrix:BC.Matrix.identity,move:function(a){switch(a){case l.LEFT:return h!==l.NONE?a=!1:(b(l.LEFT),a=!0),a;case l.RIGHT:return h!==l.NONE?a=!1:(b(l.RIGHT),a=!0),a;case l.UP:return h!==l.NONE?a=!1:(b(l.UP),a=!0),a;case l.DOWN:return h!==l.NONE?a=!1:(b(l.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(f,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(k[0],k[1],k[2]);d.matrix=
BC.Matrix.matrixMultiply(a,b)}},h=l.NONE,f=[],k=[0,0,0],g=BC.Math.sliceRadians(c.numCells);return d};return e}(BC||{});BC=function(e){(e.Game=e.Game||{}).run=function(){function c(a){return f.getUniformLocation(u,a)}function a(){return h.width!=h.clientWidth||h.height!=h.clientHeight?(h.width=h.clientWidth,h.height=h.clientHeight,!0):!1}function b(){var a=h.width/h.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function m(){f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);f.viewport(0,0,f.canvas.width,
f.canvas.height);f.uniformMatrix4fv(n.projectionMatrixLocation,!1,t);r.tick();s.update(r);q.draw();requestAnimationFrame(m)}var d=BC.Constants.Direction,h=document.getElementById("canvas");if(h){var f=h.getContext("webgl")||h.getContext("experimental-webgl");if(f){var k=f.createTexture();f.bindTexture(f.TEXTURE_2D,k);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var g=new Image;g.src="images/textures.png";$(g).load(function(){f.bindTexture(f.TEXTURE_2D,
k);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,g);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST);f.generateMipmap(f.TEXTURE_2D)});f.enable(f.CULL_FACE);f.enable(f.DEPTH_TEST);f.enable(f.BLEND);f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);var e=BC.GL.loadShader(f,"vertex-shader",f.VERTEX_SHADER),p=BC.GL.loadShader(f,"fragment-shader",f.FRAGMENT_SHADER),u=BC.GL.createProgram(f,[e,p]);f.useProgram(u);
var n={positionLocation:f.getAttribLocation(u,"a_position"),textureCoordLocation:f.getAttribLocation(u,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardRotationMatrixLocation:c("u_boardRotationMatrix"),boardTranslationMatrixLocation:c("u_boardTranslationMatrix"),selectorMatrixLocation:c("u_selectorMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};
a();var t=b();$(window).resize(function(){a()&&(t=b())});e=l();f.uniformMatrix4fv(n.viewMatrixLocation,!1,e);var e=BC.Resources.make(),s=BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),q=BC.Board.View.make({board:s,gl:f,programLocations:n,resources:e}),e=BC.Controller.make(h);e.setMoveLeftListener(function(){s.move(d.LEFT)});e.setMoveRightListener(function(){s.move(d.RIGHT)});e.setMoveUpListener(function(){s.move(d.UP)});e.setMoveDownListener(function(){s.move(d.DOWN)});
e.setPrimaryActionListener(function(){s.swap()});var r=BC.StopWatch.make();m()}}};return e}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(e){var c=e.Math=e.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var e=2*Math.PI/b,d=[],h=0;h<b;h++)d[2*h]=a*Math.cos(c+h*e),d[2*h+1]=a*Math.sin(c+h*e);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return e}(BC||{});BC=function(e){var c=e.Board=e.Board||{};(c.View=c.View||{}).make=function(a){var b=a.board,c=a.gl,e=a.programLocations;a=a.resources;var d=e.boardRotationMatrixLocation,h=e.boardTranslationMatrixLocation,f=e.selectorMatrixLocation,k=e.ringMatrixLocation,g=e.cellMatrixLocation,v=BC.Cell.View.make(c,b.metrics,a.blockTextureTiles),p=BC.Selector.View.make(c,b.metrics,a.selectorTextureTile),u=BC.Stage.View.make(c,b.metrics,a.blackTextureTile);return{draw:function(){c.uniformMatrix4fv(d,!1,b.rotationMatrix);
c.uniformMatrix4fv(h,!1,b.translationMatrix);c.uniformMatrix4fv(f,!1,BC.Matrix.identity);for(var a=b.rings,t=0;2>t;t++)for(var s=0;s<a.length;s++){c.uniformMatrix4fv(k,!1,a[s].matrix);for(var q=a[s].cells,r=0;r<q.length;r++)c.uniformMatrix4fv(g,!1,q[r].matrix),0==t?v.drawOpaque(q[r],e):v.drawTransparent(q[r],e)}c.uniformMatrix4fv(d,!1,BC.Matrix.identity);c.uniformMatrix4fv(h,!1,BC.Matrix.identity);c.uniformMatrix4fv(f,!1,b.stage.matrix);c.uniformMatrix4fv(k,!1,BC.Matrix.identity);c.uniformMatrix4fv(g,
!1,BC.Matrix.identity);u.draw(e);c.uniformMatrix4fv(d,!1,BC.Matrix.identity);c.uniformMatrix4fv(h,!1,b.translationMatrix);c.uniformMatrix4fv(f,!1,b.selector.matrix);c.uniformMatrix4fv(k,!1,BC.Matrix.identity);c.uniformMatrix4fv(g,!1,BC.Matrix.identity);p.draw(e)}}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};c.make=function(a){function b(){var a=BC.Matrix.makeYRotation(p[1]),b=BC.Matrix.makeTranslation(u[0],u[1],u[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var c=BC.Cell.CellState,e=BC.Constants.Direction,d=a.metrics,h=a.rotationY,f=a.state;a=a.blockStyle;var k=BC.Math.sliceRadians(d.numCells),
g=[],v=!1,p=[0,h,0],u=[0,0,0],n={matrix:BC.Matrix.makeYRotation(p[1]),state:f,blockStyle:a,yellowBoost:0,alpha:1,markBlock:function(){n.state=c.BLOCK_CLEARING_MARKED;0<g.length&&BC.Util.error("markBlock: pending animations: "+g.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){n.state=c.BLOCK_CLEARING_PREPARING},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=
d.numBlockTypes},finishCallback:function(){n.state=c.BLOCK_CLEARING_READY}});g.push(a,b)},clearBlock:function(){n.state=c.BLOCK_CLEARING_IN_PROGRESS;0<g.length&&BC.Util.error("clearBlock: pending animations: "+g.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=c.EMPTY_NO_DROP;n.alpha=1}});g.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=c.EMPTY_NO_SWAP;0<g.length&&BC.Util.error("sendBlock: pending animations: "+
g.length);g.push(BC.Animation.make({duration:a,finishCallback:function(){n.state=c.EMPTY}}));return b},receiveBlock:function(a,f,h){n.blockStyle=h;n.state=c.BLOCK_RECEIVING;switch(f){case e.LEFT:p[1]-=k;break;case e.RIGHT:p[1]+=k;break;case e.UP:u[1]=d.ringHeight;v=!0;break;default:BC.Util.error("receiveBlock: unsupport direction: "+f)}b();0<g.length&&BC.Util.error("receiveBlock: pending animations: "+g.length);g.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=k*a.deltaPercent;
a=d.ringHeight*a.deltaPercent;switch(f){case e.LEFT:return p[1]+=b,!0;case e.RIGHT:return p[1]-=b,!0;case e.UP:return u[1]-=a,!0;default:return!1}},finishCallback:function(){n.state=c.BLOCK;v=!1}}))},isClearing:function(){return n.state===c.BLOCK_CLEARING_MARKED||n.state===c.BLOCK_CLEARING_PREPARING||n.state===c.BLOCK_CLEARING_READY||n.state===c.BLOCK_CLEARING_IN_PROGRESS},isDrawable:function(){return n.state!==c.EMPTY&&n.state!==c.EMPTY_NO_SWAP&&n.state!==c.EMPTY_NO_DROP},isTransparent:function(){return n.state===
c.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return v},update:function(a){BC.Animation.process(g,a)&&b()}};return n};return e}(BC||{});BC=function(e){var c=e.Stage=e.Stage||{};(c.View=c.View||{}).make=function(a,b,c){b=[];var e=0;b[e++]=-1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=-1;b[e++]=0;b[e++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var e=c.textureCoord(1,0),h=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,e,h,c,b,e,h,c));var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var k=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),g=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g);a.bufferData(a.ELEMENT_ARRAY_BUFFER,k,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation,h=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(h,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g);a.drawElements(a.TRIANGLES,k.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.GL=e.GL||{};c.loadShader=function(a,b,c,e){e=e||BC.Util.error;var d=document.getElementById(b);if(!d)return e("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),e("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,e){for(var d=a.createProgram(),h=0;h<b.length;h++)a.attachShader(d,b[h]);
if(c)for(h=0;h<c.length;h++)a.bindAttribLocation(d,e?e[h]:h,c[h]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,c){var e=1/a,d=1/b;return{tile:function(a,b){var k=e*b,g=d*a;return{textureCoord:function(a,b){return[k+c+(e-2*c)*a,g+c+(d-2*c)*b]}}}}};return e}(BC||{});BC=function(e){var c=e.Selector=e.Selector||{};(c.View=c.View||{}).make=function(a,b,c){var e=-b.ringHeight/2,d=-e;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var h=b.length-2,f=[],k=0;f[k++]=b[h]+0.001;f[k++]=e;f[k++]=-b[h+1]-0.001;f[k++]=b[0]+0.001;f[k++]=e;f[k++]=-b[1]-0.001;f[k++]=b[0]+0.001;f[k++]=d;f[k++]=-b[1]-0.001;f[k++]=b[h]+0.001;f[k++]=d;f[k++]=-b[h+1]-0.001;f[k++]=b[0]+0.001;f[k++]=e;f[k++]=-b[1]-0.001;f[k++]=b[2]+0.001;f[k++]=e;f[k++]=-b[3]-0.001;f[k++]=b[2]+
0.001;f[k++]=d;f[k++]=-b[3]-0.001;f[k++]=b[0]+0.001;f[k++]=d;f[k++]=-b[1]-0.001;var g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);e=c.textureCoord(0,0);d=c.textureCoord(1,0);b=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(e,d,b,c,e,d,b,c));var v=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var p=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),u=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
u);a.bufferData(a.ELEMENT_ARRAY_BUFFER,p,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,g);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.drawElements(a.TRIANGLES,p.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.Util=e.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.Drop=c.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,c=BC.Constants.Direction,e=[];return{update:function(d){for(var h=0;h<d.rings.length;h++)for(var f=0;f<a.numCells;f++){var k=d,g=h,v=f,p=k.rings[g].cells[v];p.state===b.BLOCK&&(g+=1,g>=k.rings.length||(k=k.rings[g].cells[v],p.state===b.BLOCK&&k.state==b.EMPTY&&(p=p.sendBlock(0.05),k.receiveBlock(0.05,c.UP,p),e.push(k))))}a:{for(;0<e.length;){if(e[0].hasDroppingBlock()){d=!0;break a}e.shift()}d=
!1}return d}}};return e}(BC||{});BC=function(e){(e.Controller=e.Controller||{}).make=function(c){var a=function(){},b=function(){},e=function(){},m=function(){},d=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:d.call();break;case 37:a.call();break;case 39:b.call();break;case 38:e.call();break;case 40:m.call()}return!1});var h=0,f=0;$(c).on("touchstart touchmove touchend",function(c){var g=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":h=g.pageX;f=g.pageY;break;case "touchend":c=g.pageX-
h,g=g.pageY-f,50<c?a.call():-50>c?b.call():50<g?m.call():-50>g?e.call():d.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){e=a},setMoveDownListener:function(a){m=a},setPrimaryActionListener:function(a){d=a}}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function e(b,c){var d=c.positionLocation,f=c.textureCoordLocation,g=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,p[b.blockStyle]);a.enableVertexAttribArray(f);a.vertexAttribPointer(f,2,a.FLOAT,!1,0,0);a.uniform1f(g,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.drawElements(a.TRIANGLES,
n,a.UNSIGNED_SHORT,0)}var d=b.numCells,h=b.ringOuterRadius,f=b.ringHeight/2,k=-f,g=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,g);h=BC.Math.circlePoints(h,d,g);d=0;g=[];g[d++]=b[0];g[d++]=f;g[d++]=-b[1];g[d++]=h[0];g[d++]=f;g[d++]=-h[1];g[d++]=h[2];g[d++]=f;g[d++]=-h[3];g[d++]=b[2];g[d++]=f;g[d++]=-b[3];g[d++]=h[0];g[d++]=k;g[d++]=-h[1];g[d++]=b[0];g[d++]=k;g[d++]=-b[1];g[d++]=b[2];g[d++]=k;g[d++]=-b[3];g[d++]=h[2];g[d++]=k;g[d++]=-h[3];g[d++]=b[0];g[d++]=f;g[d++]=-b[1];g[d++]=b[0];g[d++]=
k;g[d++]=-b[1];g[d++]=h[0];g[d++]=k;g[d++]=-h[1];g[d++]=h[0];g[d++]=f;g[d++]=-h[1];g[d++]=h[2];g[d++]=f;g[d++]=-h[3];g[d++]=h[2];g[d++]=k;g[d++]=-h[3];g[d++]=b[2];g[d++]=k;g[d++]=-b[3];g[d++]=b[2];g[d++]=f;g[d++]=-b[3];g[d++]=h[0];g[d++]=f;g[d++]=-h[1];g[d++]=h[0];g[d++]=k;g[d++]=-h[1];g[d++]=h[2];g[d++]=k;g[d++]=-h[3];g[d++]=h[2];g[d++]=f;g[d++]=-h[3];g[d++]=b[2];g[d++]=f;g[d++]=-b[3];g[d++]=b[2];g[d++]=k;g[d++]=-b[3];g[d++]=b[0];g[d++]=k;g[d++]=-b[1];g[d++]=b[0];g[d++]=f;g[d++]=-b[1];var v=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,new Float32Array(g),a.STATIC_DRAW);f=[];for(d=0;d<c.length;d++)for(k=c[d],f[d]=[],h=b=0;6>b;b++)g=k.textureCoord(0,0),f[d][h++]=g[0],f[d][h++]=g[1],g=k.textureCoord(0,1),f[d][h++]=g[0],f[d][h++]=g[1],g=k.textureCoord(1,1),f[d][h++]=g[0],f[d][h++]=g[1],g=k.textureCoord(1,0),f[d][h++]=g[0],f[d][h++]=g[1];for(var p=[],d=0;d<c.length;d++)p[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,p[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(f[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var u=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var n=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,c),a.enable(a.CULL_FACE))}}};return e}(BC||{});BC=function(e){(e.StopWatch=e.StopWatch||{}).make=function(){var c={then:0.001*Date.now(),tick:function(){c.now=0.001*Date.now();c.deltaTime=c.now-c.then;c.then=c.now}};return c};return e}(BC||{});
