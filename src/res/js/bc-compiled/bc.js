var BC=function(h){var b=h.Matrix=h.Matrix||{};b.makeLookAt=function(a,c,b){c=BC.Math.normalize(BC.Math.subtractVectors(a,c));b=BC.Math.cross(b,c);var e=BC.Math.cross(c,b);return[b[0],b[1],b[2],0,e[0],e[1],e[2],0,c[0],c[1],c[2],0,a[0],a[1],a[2],1]};b.makePerspective=function(a,c,b,e){a=Math.tan(0.5*Math.PI-0.5*a);var k=1/(b-e);return[a/c,0,0,0,0,a,0,0,0,0,(b+e)*k,-1,0,0,b*e*k*2,0]};b.makeTranslation=function(a,c,b){return[1,0,0,0,0,1,0,0,0,0,1,0,a,c,b,1]};b.makeXRotation=function(a){var c=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,c,a,0,0,-a,c,0,0,0,0,1]};b.makeYRotation=function(a){var c=Math.cos(a);a=Math.sin(a);return[c,0,-a,0,0,1,0,0,a,0,c,0,0,0,0,1]};b.makeZRotation=function(a){var c=Math.cos(a);a=Math.sin(a);return[c,a,0,0,-a,c,0,0,0,0,1,0,0,0,0,1]};b.makeScale=function(a,c,b){return[a,0,0,0,0,c,0,0,0,0,b,0,0,0,0,1]};b.identity=b.makeScale(1,1,1);b.makeInverse=function(a){var c=a[0],b=a[1],e=a[2],k=a[3],f=a[4],d=a[5],g=a[6],h=a[7],l=a[8],p=a[9],m=a[10],r=a[11],t=a[12],s=a[13],u=a[14];a=
a[15];var v=m*a,w=u*r,x=g*a,y=u*h,z=g*r,A=m*h,B=e*a,C=u*k,D=e*r,E=m*k,F=e*h,G=g*k,H=l*s,I=t*p,J=f*s,K=t*d,L=f*p,M=l*d,N=c*s,O=t*b,P=c*p,Q=l*b,R=c*d,S=f*b,T=v*d+y*p+z*s-(w*d+x*p+A*s),U=w*b+B*p+E*s-(v*b+C*p+D*s),s=x*b+C*d+F*s-(y*b+B*d+G*s),b=A*b+D*d+G*p-(z*b+E*d+F*p),d=1/(c*T+f*U+l*s+t*b);return[d*T,d*U,d*s,d*b,d*(w*f+x*l+A*t-(v*f+y*l+z*t)),d*(v*c+C*l+D*t-(w*c+B*l+E*t)),d*(y*c+B*f+G*t-(x*c+C*f+F*t)),d*(z*c+E*f+F*l-(A*c+D*f+G*l)),d*(H*h+K*r+L*a-(I*h+J*r+M*a)),d*(I*k+N*r+Q*a-(H*k+O*r+P*a)),d*(J*k+O*h+
R*a-(K*k+N*h+S*a)),d*(M*k+P*h+S*r-(L*k+Q*h+R*r)),d*(J*m+M*u+I*g-(L*u+H*g+K*m)),d*(P*u+H*e+O*m-(N*m+Q*u+I*e)),d*(N*g+S*u+K*e-(R*u+J*e+O*g)),d*(R*m+L*e+Q*g-(P*g+S*m+M*e))]};b.matrixMultiply=function(a,c){return[a[0]*c[0]+a[1]*c[4]+a[2]*c[8]+a[3]*c[12],a[0]*c[1]+a[1]*c[5]+a[2]*c[9]+a[3]*c[13],a[0]*c[2]+a[1]*c[6]+a[2]*c[10]+a[3]*c[14],a[0]*c[3]+a[1]*c[7]+a[2]*c[11]+a[3]*c[15],a[4]*c[0]+a[5]*c[4]+a[6]*c[8]+a[7]*c[12],a[4]*c[1]+a[5]*c[5]+a[6]*c[9]+a[7]*c[13],a[4]*c[2]+a[5]*c[6]+a[6]*c[10]+a[7]*c[14],a[4]*
c[3]+a[5]*c[7]+a[6]*c[11]+a[7]*c[15],a[8]*c[0]+a[9]*c[4]+a[10]*c[8]+a[11]*c[12],a[8]*c[1]+a[9]*c[5]+a[10]*c[9]+a[11]*c[13],a[8]*c[2]+a[9]*c[6]+a[10]*c[10]+a[11]*c[14],a[8]*c[3]+a[9]*c[7]+a[10]*c[11]+a[11]*c[15],a[12]*c[0]+a[13]*c[4]+a[14]*c[8]+a[15]*c[12],a[12]*c[1]+a[13]*c[5]+a[14]*c[9]+a[15]*c[13],a[12]*c[2]+a[13]*c[6]+a[14]*c[10]+a[15]*c[14],a[12]*c[3]+a[13]*c[7]+a[14]*c[11]+a[15]*c[15]]};return h}(BC||{});BC=function(h){(h.CellView=h.CellView||{}).make=function(b,a,c){function n(a,c){var d=c.positionLocation,g=c.textureCoordLocation,e=c.yellowBoostLocation,f=c.alphaLocation;b.bindBuffer(b.ARRAY_BUFFER,h);b.enableVertexAttribArray(d);b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,l[a.blockStyle]);b.enableVertexAttribArray(g);b.vertexAttribPointer(g,2,b.FLOAT,!1,0,0);b.uniform1f(e,a.yellowBoost);b.uniform1f(f,a.alpha);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,p);b.drawElements(b.TRIANGLES,
m,b.UNSIGNED_SHORT,0)}var e=a.numCells,k=a.ringOuterRadius,f=a.ringHeight/2,d=-f,g=-Math.PI/2;a=BC.Math.circlePoints(a.ringInnerRadius,e,g);k=BC.Math.circlePoints(k,e,g);e=0;g=[];g[e++]=a[0];g[e++]=f;g[e++]=-a[1];g[e++]=k[0];g[e++]=f;g[e++]=-k[1];g[e++]=k[2];g[e++]=f;g[e++]=-k[3];g[e++]=a[2];g[e++]=f;g[e++]=-a[3];g[e++]=a[0];g[e++]=f;g[e++]=-a[1];g[e++]=a[0];g[e++]=d;g[e++]=-a[1];g[e++]=k[0];g[e++]=d;g[e++]=-k[1];g[e++]=k[0];g[e++]=f;g[e++]=-k[1];g[e++]=k[2];g[e++]=f;g[e++]=-k[3];g[e++]=k[2];g[e++]=
d;g[e++]=-k[3];g[e++]=a[2];g[e++]=d;g[e++]=-a[3];g[e++]=a[2];g[e++]=f;g[e++]=-a[3];g[e++]=k[0];g[e++]=f;g[e++]=-k[1];g[e++]=k[0];g[e++]=d;g[e++]=-k[1];g[e++]=k[2];g[e++]=d;g[e++]=-k[3];g[e++]=k[2];g[e++]=f;g[e++]=-k[3];g[e++]=a[2];g[e++]=f;g[e++]=-a[3];g[e++]=a[2];g[e++]=d;g[e++]=-a[3];g[e++]=a[0];g[e++]=d;g[e++]=-a[1];g[e++]=a[0];g[e++]=f;g[e++]=-a[1];var h=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,h);b.bufferData(b.ARRAY_BUFFER,new Float32Array(g),b.STATIC_DRAW);f=[];for(e=0;e<c.length;e++)for(d=
c[e],f[e]=[],k=a=0;5>a;a++)g=d.textureCoord(0,0),f[e][k++]=g[0],f[e][k++]=g[1],g=d.textureCoord(0,1),f[e][k++]=g[0],f[e][k++]=g[1],g=d.textureCoord(1,1),f[e][k++]=g[0],f[e][k++]=g[1],g=d.textureCoord(1,0),f[e][k++]=g[0],f[e][k++]=g[1];for(var l=[],e=0;e<c.length;e++)l[e]=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,l[e]),b.bufferData(b.ARRAY_BUFFER,new Float32Array(f[e]),b.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var p=b.createBuffer();
b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,p);b.bufferData(b.ELEMENT_ARRAY_BUFFER,c,b.STATIC_DRAW);var m=c.length;return{drawOpaque:function(a,c){a.isEmpty()||a.isTransparent()||n(a,c)},drawTransparent:function(a,c){!a.isEmpty()&&a.isTransparent()&&(b.disable(b.CULL_FACE),n(a,c),b.enable(b.CULL_FACE))}}};return h}(BC||{});BC=function(h){(h.Animation=h.Animation||{}).make=function(b){var a=b.duration,c=b.startCallback,n=b.updateCallback,e=b.finishCallback,k=0,f=!1;c();return{update:function(c){var g=c.deltaTime;k+g>a&&(g=a-k);k+=g;c=n({now:c.now,deltaTime:g,elapsedPercent:k/a,deltaPercent:g/a});k>=a&&(e(),f=!0);return c},isDone:function(){return f}}};return h}(BC||{});BC=function(h){(h.BoardView=h.BoardView||{}).make=function(b,a,c){var n=c.boardMatrixLocation,e=c.ringMatrixLocation,k=c.cellMatrixLocation,f=BC.GL.textureTileSet(4,4,0.002),d=[f.tile(0,0),f.tile(0,1),f.tile(0,2),f.tile(0,3),f.tile(1,0),f.tile(1,1)],f=f.tile(1,2),g=BC.CellView.make(a,b.metrics,d),h=BC.SelectorView.make(a,b.metrics,f);return{draw:function(){a.uniformMatrix4fv(n,!1,b.matrix);for(var d=b.rings,f=0;2>f;f++)for(var m=0;m<d.length;m++){a.uniformMatrix4fv(e,!1,d[m].matrix);for(var r=d[m].cells,
t=0;t<r.length;t++)a.uniformMatrix4fv(k,!1,r[t].matrix),0==f?g.drawOpaque(r[t],c):g.drawTransparent(r[t],c)}a.uniformMatrix4fv(n,!1,b.selector.matrix);a.uniformMatrix4fv(e,!1,BC.Matrix.identity);a.uniformMatrix4fv(k,!1,BC.Matrix.identity);h.draw(c)}}};return h}(BC||{});BC=function(h){(h.SelectorView=h.SelectorView||{}).make=function(b,a,c){var n=-a.ringHeight/2,e=-n;a=BC.Math.circlePoints(a.ringOuterRadius+0.01,a.numCells,-Math.PI/2);var k=a.length-2,f=[],d=0;f[d++]=a[k]+0.001;f[d++]=n;f[d++]=-a[k+1]-0.001;f[d++]=a[0]+0.001;f[d++]=n;f[d++]=-a[1]-0.001;f[d++]=a[0]+0.001;f[d++]=e;f[d++]=-a[1]-0.001;f[d++]=a[k]+0.001;f[d++]=e;f[d++]=-a[k+1]-0.001;f[d++]=a[0]+0.001;f[d++]=n;f[d++]=-a[1]-0.001;f[d++]=a[2]+0.001;f[d++]=n;f[d++]=-a[3]-0.001;f[d++]=a[2]+0.001;f[d++]=e;
f[d++]=-a[3]-0.001;f[d++]=a[0]+0.001;f[d++]=e;f[d++]=-a[1]-0.001;var g=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,g);b.bufferData(b.ARRAY_BUFFER,new Float32Array(f),b.STATIC_DRAW);n=c.textureCoord(0,0);e=c.textureCoord(1,0);a=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(n,e,a,c,n,e,a,c));var h=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,h);b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW);var l=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),p=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
p);b.bufferData(b.ELEMENT_ARRAY_BUFFER,l,b.STATIC_DRAW);return{draw:function(a){var c=a.positionLocation,d=a.textureCoordLocation;a=a.alphaLocation;b.bindBuffer(b.ARRAY_BUFFER,g);b.enableVertexAttribArray(c);b.vertexAttribPointer(c,3,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,h);b.enableVertexAttribArray(d);b.vertexAttribPointer(d,2,b.FLOAT,!1,0,0);b.uniform1f(a,1);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,p);b.drawElements(b.TRIANGLES,l.length,b.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){(h.Constants=h.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).make=function(b){function a(a,c){var d=n(a,c);if(d.state!==k.BLOCK)return!1;var g=c-1;0>g&&(g=b.numCells-1);g=n(a,g);if(g.state!==k.BLOCK||g.blockStyle!==d.blockStyle)return!1;var e=c+1;e>=b.numCells&&(e=0);e=n(a,e);if(e.state!==k.BLOCK||e.blockStyle!==d.blockStyle)return!1;g.clear();d.clear();e.clear();return!0}function c(a,c){var d=n(a,c);if(d.state!==k.BLOCK)return!1;var g=a-1;if(0>g)return!1;g=n(g,c);if(g.state!==k.BLOCK||g.blockStyle!==d.blockStyle)return!1;
var e=a+1;if(e>=b.numRings)return!1;e=n(e,c);if(e.state!==k.BLOCK||e.blockStyle!==d.blockStyle)return!1;g.clear();d.clear();e.clear();return!0}function n(a,c){return g.rings[a].cells[c]}for(var e=BC.Constants.Direction,k=BC.Cell.CellState,f=[],d=0;d<b.numRings;d++)f[d]=BC.Ring.make(d,b);var g={rings:f,matrix:BC.Matrix.identity,metrics:b,move:function(a){switch(a){case e.LEFT:m.move(e.LEFT)&&(l--,0>l&&(l=b.numCells-1));break;case e.RIGHT:m.move(e.RIGHT)&&(l++,l>=b.numCells&&(l=0));break;case e.UP:0<
h&&m.move(e.UP)&&h--;break;case e.DOWN:h+1<g.rings.length&&m.move(e.DOWN)&&h++}},rotate:function(a){p[1]+=a},swap:function(){var a=g.rings[h];a.cells[l].swap(a.cells[(l+1)%a.cells.length])},update:function(d){for(var e=0;e<b.numRings;e++)for(var f=0;f<b.numCells;f++){n(e,f).update(d);var h=e,l=f;a(h,l);c(h,l);var q=l,l=n(h,q);l.state===k.BLOCK&&(h+=1,h>=b.numRings||(h=n(h,q),l.drop(h)))}m.update(d);d=BC.Matrix.makeXRotation(p[0]);e=BC.Matrix.makeYRotation(p[1]);f=BC.Matrix.makeZRotation(p[2]);e=BC.Matrix.matrixMultiply(f,
e);e=BC.Matrix.matrixMultiply(e,d);g.matrix=e}},h=0,l=b.numCells-1,p=[0,0,0],m=BC.Selector.make(b,g);g.selector=m;return g};return h}(BC||{});BC=function(h){(h.Ring=h.Ring||{}).make=function(b,a){for(var c=[],h=0;h<a.numCells;h++)c[h]=BC.Cell.make(h,a);h=BC.Matrix.makeTranslation(0,-b*a.ringHeight,0);return{cells:c,matrix:h}};return h}(BC||{});BC=function(h){(h.Selector=h.Selector||{}).make=function(b,a){var c=BC.Constants.Direction,h={matrix:BC.Matrix.identity,move:function(a){switch(a){case c.LEFT:return e!==c.NONE?a=!1:(e=c.LEFT,f=0,a=!0),a;case c.RIGHT:return e!==c.NONE?a=!1:(e=c.RIGHT,f=0,a=!0),a;case c.UP:return e!==c.NONE?a=!1:(e=c.UP,f=0,a=!0),a;case c.DOWN:return e!==c.NONE?a=!1:(e=c.DOWN,f=0,a=!0),a}},update:function(g){if(e!==c.NONE){var q=g.deltaTime;0.05<f+q&&(q=0.05-f);var l=q*b.ringHeight/0.05,p=q*d/0.05;switch(e){case c.UP:k[1]+=
l;break;case c.DOWN:k[1]-=l;break;case c.LEFT:a.rotate(p);break;case c.RIGHT:a.rotate(-p)}f+=q;0.05<=f&&(e=c.NONE,f=0)}g=1+Math.abs(Math.sin(4*g.now))/25;g=BC.Matrix.makeScale(g,g,1);q=BC.Matrix.makeTranslation(k[0],k[1],k[2]);h.matrix=BC.Matrix.matrixMultiply(g,q)}},e=c.NONE,k=[0,0,0],f=0,d=BC.Math.sliceRadians(b.numCells);return h};return h}(BC||{});BC=function(h){(h.Game=h.Game||{}).run=function(){function b(a){return d.getUniformLocation(m,a)}function a(){return f.width!=f.clientWidth||f.height!=f.clientHeight?(f.width=f.clientWidth,f.height=f.clientHeight,!0):!1}function c(){var a=f.width/f.height,c=BC.Math.radians(90);return BC.Matrix.makePerspective(c,a,1,2E3)}function h(){var a=BC.Matrix.makeLookAt([0,0.5,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function e(){d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);d.viewport(0,0,d.canvas.width,
d.canvas.height);d.uniformMatrix4fv(r.projectionMatrixLocation,!1,t);v.tick();s.update(v);u.draw();requestAnimationFrame(e)}var k=BC.Constants.Direction,f=document.getElementById("canvas");if(f){var d=f.getContext("webgl")||f.getContext("experimental-webgl");if(d){var g=d.createTexture();d.bindTexture(d.TEXTURE_2D,g);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,1,1,0,d.RGBA,d.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var q=new Image;q.src="images/textures.png";$(q).load(function(){d.bindTexture(d.TEXTURE_2D,
g);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,q);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_NEAREST);d.generateMipmap(d.TEXTURE_2D)});d.enable(d.CULL_FACE);d.enable(d.DEPTH_TEST);d.enable(d.BLEND);d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);var l=BC.GL.loadShader(d,"vertex-shader",d.VERTEX_SHADER),p=BC.GL.loadShader(d,"fragment-shader",d.FRAGMENT_SHADER),m=BC.GL.createProgram(d,[l,p]);d.useProgram(m);
var r={positionLocation:d.getAttribLocation(m,"a_position"),textureCoordLocation:d.getAttribLocation(m,"a_textureCoord"),projectionMatrixLocation:b("u_projectionMatrix"),viewMatrixLocation:b("u_viewMatrix"),boardMatrixLocation:b("u_boardMatrix"),ringMatrixLocation:b("u_ringMatrix"),cellMatrixLocation:b("u_cellMatrix"),yellowBoostLocation:b("u_yellowBoost"),alphaLocation:b("u_alpha")};a();var t=c();$(window).resize(function(){a()&&(t=c())});l=h();d.uniformMatrix4fv(r.viewMatrixLocation,!1,l);var s=
BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),u=BC.BoardView.make(s,d,r),l=BC.Controller.make(f);l.setMoveLeftListener(function(){s.move(k.LEFT)});l.setMoveRightListener(function(){s.move(k.RIGHT)});l.setMoveUpListener(function(){s.move(k.UP)});l.setMoveDownListener(function(){s.move(k.DOWN)});l.setPrimaryActionListener(function(){s.swap()});var v=BC.StopWatch.make();e()}}};return h}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(h){var b=h.Math=h.Math||{};b.radians=function(a){return a*Math.PI/180};b.sliceRadians=function(a){return 2*Math.PI/a};b.randomInt=function(a){return Math.floor(Math.random()*a)};b.circlePoints=function(a,c,b){b=b||0;for(var e=2*Math.PI/c,h=[],f=0;f<c;f++)h[2*f]=a*Math.cos(b+f*e),h[2*f+1]=a*Math.sin(b+f*e);return h};b.cross=function(a,c){return[a[1]*c[2]-a[2]*c[1],a[2]*c[0]-a[0]*c[2],a[0]*c[1]-a[1]*c[0]]};b.subtractVectors=function(a,c){return[a[0]-c[0],a[1]-c[1],a[2]-c[2]]};b.normalize=
function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<c?[a[0]/c,a[1]/c,a[2]/c]:[0,0,0]};return h}(BC||{});BC=function(h){var b=h.Cell=h.Cell||{};b.CellState={EMPTY:0,BLOCK:1,SWAP_LEFT:2,SWAP_RIGHT:3,SWAP_LEFT_EMPTY:4,SWAP_RIGHT_EMPTY:5,DROP_BLOCK_SRC:6,DROP_BLOCK_DST:7,DISAPPEARING_BLOCK:8};b.make=function(a,c){var b=BC.Cell.CellState,e=BC.Math.randomInt(c.numBlockTypes),h=BC.Math.sliceRadians(c.numCells),f=[0,a*h,0],d={matrix:BC.Matrix.makeYRotation(f[1]),state:b.BLOCK,blockStyle:e,rotation:f,translation:[0,0,0],alpha:1,yellowBoost:0,isEmpty:function(){return d.state===b.EMPTY||d.state===b.SWAP_LEFT_EMPTY||
d.state===b.SWAP_RIGHT_EMPTY||d.state===b.DROP_BLOCK_SRC},isTransparent:function(){return d.state===b.DISAPPEARING_BLOCK},animations:[],swap:function(a){function c(b,e){d.blockStyle=a.blockStyle;d.state=b;d.rotation[1]+=h;d.elapsedSwapTime=0;a.blockStyle=r;a.state=e;a.rotation[1]-=h;a.elapsedSwapTime=0}console.log("left: "+d.state+" right: "+a.state);var e=d.state===b.EMPTY&&a.state===b.BLOCK,f=d.state===b.BLOCK&&a.state===b.EMPTY,m=d.state===b.BLOCK&&a.state===b.BLOCK;if(!e&&!f&&!m)return!1;var r=
d.blockStyle;return e?(c(b.SWAP_RIGHT,b.SWAP_LEFT_EMPTY),!0):f?(c(b.SWAP_RIGHT_EMPTY,b.SWAP_LEFT),!0):m?(c(b.SWAP_RIGHT,b.SWAP_LEFT),!0):!1},update:function(a){var c=!1;switch(d.state){case b.SWAP_LEFT:case b.SWAP_RIGHT:case b.SWAP_LEFT_EMPTY:case b.SWAP_RIGHT_EMPTY:var e=a.deltaTime;0.125<d.elapsedSwapTime+e&&(e=0.125-d.elapsedSwapTime);var f=h*e/0.125;d.rotation[1]=d.state===b.SWAP_LEFT||d.state===b.SWAP_LEFT_EMPTY?d.rotation[1]+f:d.rotation[1]-f;d.matrix=BC.Matrix.makeYRotation(d.rotation[1]);
d.elapsedSwapTime+=e;0.125<=d.elapsedSwapTime&&(d.state=d.isEmpty()?b.EMPTY:b.BLOCK,d.elapsedSwapTime=0);c|=1}0<d.animations.length&&(e=d.animations[0],c|=e.update(a),e.isDone()&&d.animations.shift());c&&(a=BC.Matrix.makeYRotation(d.rotation[1]),c=BC.Matrix.makeTranslation(d.translation[0],d.translation[1],d.translation[2]),d.matrix=BC.Matrix.matrixMultiply(a,c))},clear:function(){var a=BC.Animation.make({duration:0.5,startCallback:function(){d.state=b.DISAPPEARING_BLOCK},updateCallback:function(a){d.yellowBoost=
Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){d.yellowBoost=0}}),c=BC.Animation.make({duration:0.25,startCallback:function(){},updateCallback:function(a){d.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){d.state=b.EMPTY;d.alpha=1}});d.animations.push(a,c)},drop:function(a){if(d.state===b.BLOCK&&a.state==b.EMPTY){var e=d.blockStyle;d.animations.push(BC.Animation.make({duration:0.075,startCallback:function(){d.blockStyle=0;d.state=b.DROP_BLOCK_SRC;d.translation[1]=
0;d.alpha=1},updateCallback:function(a){return!1},finishCallback:function(){d.state=b.EMPTY}}));a.animations.push(BC.Animation.make({duration:0.075,startCallback:function(){a.blockStyle=e;a.state=b.DROP_BLOCK_DST;a.translation[1]=c.ringHeight;a.alpha=1},updateCallback:function(b){a.translation[1]-=c.ringHeight*b.deltaPercent;return!0},finishCallback:function(){a.state=b.BLOCK}}))}}};return d};return h}(BC||{});BC=function(h){var b=h.GL=h.GL||{};b.loadShader=function(a,c,b,e){e=e||BC.Util.error;var h=document.getElementById(c);if(!h)return e("** Error getting script element:"+c),null;c=a.createShader(b);a.shaderSource(c,h.text);a.compileShader(c);return a.getShaderParameter(c,a.COMPILE_STATUS)?c:(lastError=a.getShaderInfoLog(c),e("*** Error compiling shader '"+c+"':"+lastError),a.deleteShader(c),null)};b.createProgram=function(a,c,b,e){for(var h=a.createProgram(),f=0;f<c.length;f++)a.attachShader(h,c[f]);
if(b)for(f=0;f<b.length;f++)a.bindAttribLocation(h,e?e[f]:f,b[f]);a.linkProgram(h);return a.getProgramParameter(h,a.LINK_STATUS)?h:(lastError=a.getProgramInfoLog(h),error("Error in program linking: "+lastError),a.deleteProgram(h),null)};b.textureTileSet=function(a,c,b){var e=1/a,h=1/c;return{tile:function(a,c){var g=e*c,q=h*a;return{textureCoord:function(a,c){return[g+b+(e-2*b)*a,q+b+(h-2*b)*c]}}}}};return h}(BC||{});BC=function(h){(h.Util=h.Util||{}).error=function(b){window.console&&(window.console.error?window.console.error(b):window.console.log&&window.console.log(b))};return h}(BC||{});BC=function(h){(h.Controller=h.Controller||{}).make=function(b){var a=function(){},c=function(){},h=function(){},e=function(){},k=function(){};$(document).keydown(function(b){switch(b.keyCode){case 32:k.call();break;case 37:a.call();break;case 39:c.call();break;case 38:h.call();break;case 40:e.call()}return!1});var f=0,d=0;$(b).on("touchstart touchmove touchend",function(b){var q=b.originalEvent.changedTouches[0];switch(b.type){case "touchstart":f=q.pageX;d=q.pageY;break;case "touchend":b=q.pageX-
f,q=q.pageY-d,50<b?a.call():-50>b?c.call():50<q?e.call():-50>q?h.call():k.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){c=a},setMoveUpListener:function(a){h=a},setMoveDownListener:function(a){e=a},setPrimaryActionListener:function(a){k=a}}};return h}(BC||{});BC=function(h){(h.StopWatch=h.StopWatch||{}).make=function(){var b={then:0.001*Date.now(),tick:function(){b.now=0.001*Date.now();b.deltaTime=b.now-b.then;b.then=b.now}};return b};return h}(BC||{});
