var BC=function(f){var e=f.Matrix=f.Matrix||{};e.makeLookAt=function(a,b,e){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));e=BC.Math.cross(e,b);var c=BC.Math.cross(b,e);return[e[0],e[1],e[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};e.makePerspective=function(a,b,e,c){a=Math.tan(0.5*Math.PI-0.5*a);var h=1/(e-c);return[a/b,0,0,0,0,a,0,0,0,0,(e+c)*h,-1,0,0,e*c*h*2,0]};e.makeTranslation=function(a,b,e){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1]};e.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};e.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};e.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};e.makeScale=function(a,b,e){return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1]};e.makeInverse=function(a){var b=a[0],e=a[1],c=a[2],h=a[3],g=a[4],d=a[5],f=a[6],l=a[7],k=a[8],n=a[9],r=a[10],p=a[11],t=a[12],q=a[13],v=a[14];a=a[15];var u=r*a,w=v*p,x=f*a,y=
v*l,z=f*p,A=r*l,B=c*a,C=v*h,D=c*p,E=r*h,F=c*l,G=f*h,H=k*q,I=t*n,J=g*q,K=t*d,L=g*n,M=k*d,N=b*q,O=t*e,P=b*n,Q=k*e,R=b*d,S=g*e,T=u*d+y*n+z*q-(w*d+x*n+A*q),U=w*e+B*n+E*q-(u*e+C*n+D*q),q=x*e+C*d+F*q-(y*e+B*d+G*q),e=A*e+D*d+G*n-(z*e+E*d+F*n),d=1/(b*T+g*U+k*q+t*e);return[d*T,d*U,d*q,d*e,d*(w*g+x*k+A*t-(u*g+y*k+z*t)),d*(u*b+C*k+D*t-(w*b+B*k+E*t)),d*(y*b+B*g+G*t-(x*b+C*g+F*t)),d*(z*b+E*g+F*k-(A*b+D*g+G*k)),d*(H*l+K*p+L*a-(I*l+J*p+M*a)),d*(I*h+N*p+Q*a-(H*h+O*p+P*a)),d*(J*h+O*l+R*a-(K*h+N*l+S*a)),d*(M*h+P*l+
S*p-(L*h+Q*l+R*p)),d*(J*r+M*v+I*f-(L*v+H*f+K*r)),d*(P*v+H*c+O*r-(N*r+Q*v+I*c)),d*(N*f+S*v+K*c-(R*v+J*c+O*f)),d*(R*r+L*c+Q*f-(P*f+S*r+M*c))]};e.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*
b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return f}(BC||{});BC=function(f){(f.Time=f.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return f}(BC||{});BC=function(f){var e=f.GL=f.GL||{};e.loadShader=function(a,b,e,c){c=c||BC.Util.error;var h=document.getElementById(b);if(!h)return c("** Error getting script element:"+b),null;b=a.createShader(e);a.shaderSource(b,h.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),c("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};e.createProgram=function(a,b,e,c){for(var h=a.createProgram(),g=0;g<b.length;g++)a.attachShader(h,b[g]);
if(e)for(g=0;g<e.length;g++)a.bindAttribLocation(h,c?c[g]:g,e[g]);a.linkProgram(h);return a.getProgramParameter(h,a.LINK_STATUS)?h:(lastError=a.getProgramInfoLog(h),error("Error in program linking: "+lastError),a.deleteProgram(h),null)};e.textureTileSet=function(a,b,e){var c=1/a,h=1/b;return{tile:function(a,b){var f=c*b,l=h*a;return{textureCoord:function(a,b){return[f+e+(c-2*e)*a,l+e+(h-2*e)*b]}}}}};return f}(BC||{});BC=function(f){(f.Selector=f.Selector||{}).make=function(e,a,b){var m=a.ringMinY,c=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var h=a.length-2,g=[],d=0;g[d++]=a[h]+0.001;g[d++]=m;g[d++]=-a[h+1]-0.001;g[d++]=a[0]+0.001;g[d++]=m;g[d++]=-a[1]-0.001;g[d++]=a[0]+0.001;g[d++]=c;g[d++]=-a[1]-0.001;g[d++]=a[h]+0.001;g[d++]=c;g[d++]=-a[h+1]-0.001;g[d++]=a[0]+0.001;g[d++]=m;g[d++]=-a[1]-0.001;g[d++]=a[2]+0.001;g[d++]=m;g[d++]=-a[3]-0.001;g[d++]=a[2]+0.001;g[d++]=c;g[d++]=
-a[3]-0.001;g[d++]=a[0]+0.001;g[d++]=c;g[d++]=-a[1]-0.001;var f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f);e.bufferData(e.ARRAY_BUFFER,new Float32Array(g),e.STATIC_DRAW);m=b.textureCoord(0,0);c=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(m,c,a,b,m,c,a,b));var l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l);e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW);var k=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),n=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,
n);e.bufferData(e.ELEMENT_ARRAY_BUFFER,k,e.STATIC_DRAW);return{draw:function(a,b){e.enable(e.BLEND);e.bindBuffer(e.ARRAY_BUFFER,f);e.enableVertexAttribArray(a);e.vertexAttribPointer(a,3,e.FLOAT,!1,0,0);e.bindBuffer(e.ARRAY_BUFFER,l);e.enableVertexAttribArray(b);e.vertexAttribPointer(b,2,e.FLOAT,!1,0,0);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n);e.drawElements(e.TRIANGLES,k.length,e.UNSIGNED_SHORT,0);e.disable(e.BLEND)}}};return f}(BC||{});BC=function(f){(f.Game=f.Game||{}).run=function(){function e(){return m.width!=m.clientWidth||m.height!=m.clientHeight?(m.width=m.clientWidth,m.height=m.clientHeight,!0):!1}function a(){var a=m.width/m.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);c.viewport(0,0,c.canvas.width,c.canvas.height);var a=BC.Time.getTimeInSeconds(),d=a-y;y=a;c.uniformMatrix4fv(f,!1,t);c.uniformMatrix4fv(l,!1,n);q.update(d);v.draw();requestAnimationFrame(b)}
var m=document.getElementById("canvas");if(m){var c=m.getContext("webgl")||m.getContext("experimental-webgl");if(c){c.enable(c.CULL_FACE);c.enable(c.DEPTH_TEST);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var h=BC.GL.loadShader(c,"vertex-shader",c.VERTEX_SHADER),g=BC.GL.loadShader(c,"fragment-shader",c.FRAGMENT_SHADER),d=BC.GL.createProgram(c,[h,g]);c.useProgram(d);var h=c.getAttribLocation(d,"a_position"),g=c.getAttribLocation(d,"a_texcoord"),f=c.getUniformLocation(d,"u_projectionMatrix"),l=c.getUniformLocation(d,
"u_viewMatrix"),d=c.getUniformLocation(d,"u_matrix"),k=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]),n=BC.Matrix.makeInverse(k),r=c.createTexture();c.bindTexture(c.TEXTURE_2D,r);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var p=new Image;p.src="images/textures.png";$(p).load(function(){c.bindTexture(c.TEXTURE_2D,r);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,p);c.generateMipmap(c.TEXTURE_2D)});e();var t=a();$(window).resize(function(){e()&&
(t=a())});var q=BC.Board.makeModel({numRingCells:24,numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),v=BC.Board.makeView(q,c,h,d,g),u=BC.Common.Direction,w=0,x=0;$(m).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":w=b.pageX;x=b.pageY;break;case "touchend":a=b.pageX-w;var b=b.pageY-x,c=u.NONE;50<a?c=u.LEFT:-50>a?c=u.RIGHT:50<b?c=u.DOWN:-50>b&&(c=u.UP);q.move(c)}return!1});$(document).keydown(function(a){switch(a.keyCode){case 32:q.swap();
break;case 37:q.move(u.LEFT);break;case 39:q.move(u.RIGHT);break;case 38:q.move(u.UP);break;case 40:q.move(u.DOWN)}return!1});var y=BC.Time.getTimeInSeconds();b()}}};return f}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(f){var e=f.Math=f.Math||{};e.radians=function(a){return a*Math.PI/180};e.randomInt=function(a){return Math.floor(Math.random()*a)};e.circlePoints=function(a,b,e){e=e||0;for(var c=2*Math.PI/b,h=[],g=0;g<b;g++)h[2*g]=a*Math.cos(e+g*c),h[2*g+1]=a*Math.sin(e+g*c);return h};e.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};e.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};e.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return f}(BC||{});BC=function(f){(f.Cell=f.Cell||{}).make=function(e,a,b){var f=a.numRingCells,c=a.outerRingRadius,h=a.ringMaxY,g=a.ringMinY,d=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,f,d);for(var f=BC.Math.circlePoints(c,f,d),c=[],s=[],d=0;d<b.length;d++)s[d]=[];var l=function(a,c,d,e,f,g,h){for(var k=0;k<b.length;k++){var l=b[k],m=l.textureCoord(c,d);s[k][a]=m[0];s[k][a+1]=m[1];m=l.textureCoord(e,f);s[k][a+2]=m[0];s[k][a+3]=m[1];m=l.textureCoord(g,h);s[k][a+4]=m[0];s[k][a+5]=m[1]}return a+6},d=0,k;c[d++]=
a[0];c[d++]=h;c[d++]=-a[1];c[d++]=f[0];c[d++]=h;c[d++]=-f[1];c[d++]=f[2];c[d++]=h;c[d++]=-f[3];k=l(0,0,0,0,1,1,1);c[d++]=a[0];c[d++]=h;c[d++]=-a[1];c[d++]=f[2];c[d++]=h;c[d++]=-f[3];c[d++]=a[2];c[d++]=h;c[d++]=-a[3];k=l(k,0,0,1,1,1,0);c[d++]=a[0];c[d++]=g;c[d++]=-a[1];c[d++]=f[2];c[d++]=g;c[d++]=-f[3];c[d++]=f[0];c[d++]=g;c[d++]=-f[1];k=l(k,0,0,1,1,0,1);c[d++]=a[0];c[d++]=g;c[d++]=-a[1];c[d++]=a[2];c[d++]=g;c[d++]=-a[3];c[d++]=f[2];c[d++]=g;c[d++]=-f[3];k=l(k,0,0,1,0,1,1);c[d++]=f[0];c[d++]=g;c[d++]=
-f[1];c[d++]=f[2];c[d++]=g;c[d++]=-f[3];c[d++]=f[2];c[d++]=h;c[d++]=-f[3];k=l(k,0,1,1,1,1,0);c[d++]=f[0];c[d++]=g;c[d++]=-f[1];c[d++]=f[2];c[d++]=h;c[d++]=-f[3];c[d++]=f[0];c[d++]=h;c[d++]=-f[1];k=l(k,0,1,1,0,0,0);c[d++]=a[0];c[d++]=g;c[d++]=-a[1];c[d++]=a[2];c[d++]=h;c[d++]=-a[3];c[d++]=a[2];c[d++]=g;c[d++]=-a[3];k=l(k,0,1,1,0,1,1);c[d++]=a[0];c[d++]=g;c[d++]=-a[1];c[d++]=a[0];c[d++]=h;c[d++]=-a[1];c[d++]=a[2];c[d++]=h;c[d++]=-a[3];k=l(k,0,1,0,0,1,0);var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,
n);e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW);for(var r=c.length/3,p=[],d=0;d<b.length;d++)p[d]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,p[d]),e.bufferData(e.ARRAY_BUFFER,new Float32Array(s[d]),e.STATIC_DRAW);return{draw:function(a,b,c){e.bindBuffer(e.ARRAY_BUFFER,n);e.enableVertexAttribArray(b);e.vertexAttribPointer(b,3,e.FLOAT,!1,0,0);e.bindBuffer(e.ARRAY_BUFFER,p[a.blockStyle]);e.enableVertexAttribArray(c);e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0);e.drawArrays(e.TRIANGLES,
0,r)}}};return f}(BC||{});BC=function(f){(f.Util=f.Util||{}).error=function(e){window.console&&(window.console.error?window.console.error(e):window.console.log&&window.console.log(e))};return f}(BC||{});BC=function(f){(f.Common=f.Common||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).makeView=function(e,a,b,f,c){var h=BC.GL.textureTileSet(4,4,0.002),g=[h.tile(0,0),h.tile(0,1),h.tile(0,2),h.tile(0,3),h.tile(1,0),h.tile(1,1)],h=h.tile(1,2),d=BC.Cell.make(a,e,g),s=BC.Selector.make(a,e,h);return{draw:function(){for(var g=e.boardMatrix,h=e.rings,n=0;n<h.length;n++)for(var r=BC.Matrix.matrixMultiply(g,h[n].matrix),p=h[n].cells,t=0;t<p.length;t++){var q=BC.Matrix.matrixMultiply(r,p[t].matrix);a.uniformMatrix4fv(f,!1,q);d.draw(p[t],b,c)}a.uniformMatrix4fv(f,
!1,e.selectorMatrix);s.draw(b,c)}}};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).makeModel=function(e){function a(a){for(var b=[],c=0;c<e.numRingCells;c++){var d=b,f=c,g=c,h=BC.Math.randomInt(e.numBlockStyles),g=BC.Matrix.makeYRotation(g*l);d[f]={blockStyle:h,matrix:g}}a=BC.Matrix.makeTranslation(0,-a*k,0);return{cells:b,matrix:a}}for(var b=BC.Common.Direction,f=[],c=b.NONE,h=0,g=0,d=[0,0,0],s=[0,0,0],l=2*Math.PI/e.numRingCells,k=e.ringMaxY-e.ringMinY,n=BC.Matrix.makeScale(1,1,1),r={rings:f,boardMatrix:n,selectorMatrix:n,numRingCells:e.numRingCells,
innerRingRadius:e.innerRingRadius,outerRingRadius:e.outerRingRadius,ringMaxY:e.ringMaxY,ringMinY:e.ringMinY,selectorTranslation:d,rotation:s,move:function(a){switch(a){case b.LEFT:c===b.NONE&&(c=b.LEFT,h=0);break;case b.RIGHT:c===b.NONE&&(c=b.RIGHT,h=0);break;case b.UP:c===b.NONE&&0<g&&(c=b.UP,h=0,g--);break;case b.DOWN:c===b.NONE&&g+1<f.length&&(c=b.DOWN,h=0,g++)}},swap:function(){},update:function(a){var e=BC.Matrix.makeXRotation(s[0]),f=BC.Matrix.makeYRotation(s[1]),g=BC.Matrix.makeZRotation(s[2]),
g=BC.Matrix.matrixMultiply(n,g),g=BC.Matrix.matrixMultiply(g,f),g=BC.Matrix.matrixMultiply(g,e);r.boardMatrix=g;e=BC.Matrix.makeTranslation(d[0],d[1],d[2]);e=BC.Matrix.matrixMultiply(n,e);r.selectorMatrix=e;if(c!==b.NONE){0.05<h+a&&(a=0.05-h);e=a*k/0.05;f=a*l/0.05;switch(c){case b.UP:d[1]+=e;break;case b.DOWN:d[1]-=e;break;case b.LEFT:s[1]+=f;break;case b.RIGHT:s[1]-=f}h+=a;0.05<=h&&(c=b.NONE,h=0)}}},p=0;3>p;p++)f[p]=a(p);return r};return f}(BC||{});
