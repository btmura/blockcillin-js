var BC=function(g){var c=g.Matrix=g.Matrix||{};c.makeLookAt=function(a,b,m){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));m=BC.Math.cross(m,b);var k=BC.Math.cross(b,m);return[m[0],m[1],m[2],0,k[0],k[1],k[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,m,k){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(m-k);return[a/b,0,0,0,0,a,0,0,0,0,(m+k)*d,-1,0,0,m*k*d*2,0]};c.makeTranslation=function(a,b,m){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,m,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,m){return[a,0,0,0,0,b,0,0,0,0,m,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],m=a[1],k=a[2],d=a[3],l=a[4],f=a[5],h=a[6],e=a[7],v=a[8],c=a[9],g=a[10],q=a[11],t=a[12],s=a[13],p=a[14];a=
a[15];var r=g*a,w=p*q,x=h*a,y=p*e,z=h*q,A=g*e,B=k*a,C=p*d,D=k*q,E=g*d,F=k*e,G=h*d,H=v*s,I=t*c,J=l*s,K=t*f,L=l*c,M=v*f,N=b*s,O=t*m,P=b*c,Q=v*m,R=b*f,S=l*m,T=r*f+y*c+z*s-(w*f+x*c+A*s),U=w*m+B*c+E*s-(r*m+C*c+D*s),s=x*m+C*f+F*s-(y*m+B*f+G*s),m=A*m+D*f+G*c-(z*m+E*f+F*c),f=1/(b*T+l*U+v*s+t*m);return[f*T,f*U,f*s,f*m,f*(w*l+x*v+A*t-(r*l+y*v+z*t)),f*(r*b+C*v+D*t-(w*b+B*v+E*t)),f*(y*b+B*l+G*t-(x*b+C*l+F*t)),f*(z*b+E*l+F*v-(A*b+D*l+G*v)),f*(H*e+K*q+L*a-(I*e+J*q+M*a)),f*(I*d+N*q+Q*a-(H*d+O*q+P*a)),f*(J*d+O*e+
R*a-(K*d+N*e+S*a)),f*(M*d+P*e+S*q-(L*d+Q*e+R*q)),f*(J*g+M*p+I*h-(L*p+H*h+K*g)),f*(P*p+H*k+O*g-(N*g+Q*p+I*k)),f*(N*h+S*p+K*k-(R*p+J*k+O*h)),f*(R*g+L*k+Q*h-(P*h+S*g+M*k))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){var c=g.Animation=g.Animation||{};c.make=function(a){var b=a.duration,m=a.startCallback||function(){},k=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},l=0,f=!1,h=!1;return{update:function(a){f||(f=!0,m());var c=a.deltaTime;l+c>b&&(c=b-l);l+=c;a=k({now:a.now,deltaTime:c,elapsedPercent:l/b,deltaPercent:c/b});l>=b&&(h=!0,d());return a},isDone:function(){return h}}};c.process=function(a,b){var m=!1;if(0<a.length){var k=a[0],m=m|k.update(b);k.isDone()&&a.shift()}return m};
return g}(BC||{});BC=function(g){var c=g.Cell=g.Cell||{},c=c.Chain=c.Chain||{};c.find=function(a){function b(b,d){return a.rings[b].cells[d]}function m(){for(var d=a.rings.length,k=[],l=0;l<d;l++){var m;m=l;for(var c=0,g=b(m,c),p=0;p<h;p++){var r=b(m,c);if(g.state!==r.state||g.blockStyle!=r.blockStyle)break;c+=1;c=c===h?0:c}m=c;for(c=0;c<h;)if(p=(c+m)%h,r=b(l,p),r.state!==f.BLOCK)c++;else{for(var w=1,g=c+1;g<h;g++)if(p=(g+m)%h,p=b(l,p),r.state===p.state&&r.blockStyle==p.blockStyle)w++;else break;if(w>=e){for(r=[];c<
g;c++)p=(c+m)%h,w=b(l,p),r.push({cell:w,row:l,col:p});k.push(r)}c=g}}return k}function k(){for(var d=a.rings.length,l=[],k=0;k<h;k++)for(var c=0;c<d;){var m=b(c,k);if(m.state!==f.BLOCK)c++;else{for(var g=1,p=c+1;p<d;p++){var r=b(p,k);if(m.state===r.state&&m.blockStyle==r.blockStyle)g++;else break}if(g>=e){for(m=[];c<p;c++)g=b(c,k),m.push({cell:g,row:c,col:k});l.push(m)}c=p}}return l}function d(a,b){for(var d=0;d<a.length;d++)for(var f=a[d],e=0;e<b.length;e++){var c=b[e];if(f.blockStyle===c.blockStyle&&
f.row===c.row&&f.col===c.col)return!0}return!1}function l(a,b){for(var d=0;d<a.length;d++){var f=a[d];if(f.blockStyle===b.blockStyle&&f.row===b.row&&f.col===b.col)return!0}return!1}var f=BC.Cell.CellState,h=a.rings[0].cells.length,e=3;return function(){for(var a=[],b=m(),f=k();0<b.length;){var e=b.shift();for(a.push(e);;){for(var c=!1,h=0;h<f.length;h++)if(d(e,f[h])){for(c=0;c<f[h].length;c++)l(e,f[h][c])||e.push(f[h][c]);f.splice(h,1);c=!0}if(!c)break;c=!1;for(h=0;h<b.length;h++)if(d(e,b[h])){for(c=
0;c<b[h].length;c++)l(e,b[h][c])||e.push(b[h][c]);b.splice(h,1);c=!0}if(!c)break}}for(;0<f.length;)e=f.shift(),a.push(e);for(h=0;h<a.length;h++)a[h].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],c=[];return{update:function(k){var d=BC.Cell.Chain.find(k);for(k=0;k<d.length;k++){var l=d[k];c.push(l);for(var f=0;f<l.length;f++){var h=l[f].cell;h.markBlock();b.push(h)}}if(0<b.length)switch(h=b[0],h.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:h.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<c.length){l=c[0];d=!0;for(k=0;k<l.length;k++)h=l[k].cell,d&=!h.isClearing();if(d){for(k=0;k<l.length;k++)h=l[k].cell,h.state===a.EMPTY_NO_DROP&&(h.state=a.EMPTY);c.shift()}}return 0<c.length}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(c){function a(a){var b=-c.ringHeight*s;t.push(b);a=BC.Ring.make({metrics:c,translationY:b,selectable:a});q.push(a);s++}function b(){r.translationMatrix=BC.Matrix.makeTranslation(n[0],n[1],n[2])}function m(){var a=BC.Matrix.makeXRotation(u[0]),b=BC.Matrix.makeYRotation(u[1]),d=BC.Matrix.makeZRotation(u[2]),b=BC.Matrix.matrixMultiply(d,b),b=BC.Matrix.matrixMultiply(b,a);r.rotationMatrix=b}for(var k=BC.Cell.CellState,d=BC.Constants.Direction,l=11*c.ringHeight,
f=0,h=c.numCells-1,e=5.5*-c.ringHeight-c.ringHeight/2,g=c.ringHeight*c.numRings,n=[0,e+g,0],u=[0,0,0],q=[],t=[],s=0,p=0;p<c.numRings;p++)a(!0);var r={metrics:c,rings:q,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case d.LEFT:w.move(d.LEFT)&&(h--,0>h&&(h=c.numCells-1));break;case d.RIGHT:w.move(d.RIGHT)&&(h++,h>=c.numCells&&(h=0));break;case d.UP:0<f&&w.move(d.UP)&&f--;break;case d.DOWN:f+1<r.rings.length&&q[f+1].isSelectable()&&w.move(d.DOWN)&&
f++}},rotate:function(a){u[1]+=a},swap:function(){var a=q[f].cells[h%c.numCells],b=q[f].cells[(h+1)%c.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var e=a.blockStyle,l=b.blockStyle;a.state!==k.EMPTY&&a.state!==k.EMPTY_NO_DROP||b.state!==k.BLOCK?a.state!==k.BLOCK||b.state!==k.EMPTY&&b.state!==k.EMPTY_NO_DROP?a.state===k.BLOCK&&b.state===k.BLOCK&&(a.receiveBlock(0.1,d.RIGHT,l),b.receiveBlock(0.1,d.LEFT,e)):(a.sendBlock(0.1,d.RIGHT),b.receiveBlock(0.1,d.LEFT,e)):(b.sendBlock(0.1,d.LEFT),
a.receiveBlock(0.1,d.RIGHT,l))},update:function(d){for(var e=0;e<q.length;e++)for(var h=0;h<c.numCells;h++)q[e].cells[h%c.numCells].update(d);e=0|y.update(r);e|=x.update(r);e||(e=0.02*d.deltaTime,g+e>l&&(e=l-g),g+=e,n[1]+=e);w.update(d);b();for(m();0<q.length&&q[0].isEmpty();)q.shift(),t.shift(),g-=c.ringHeight,f--;d=g-c.ringHeight*q.length;e=Math.ceil(d/c.ringHeight);if(0<e)for(h=q.length-1;0<=h&&!q[h].isSelectable();h--)q[h].setSelectable(!0);for(h=0;h<e;h++)d-=c.ringHeight,a(0<=d);g>=l&&BC.Util.log("GAME OVER")}};
b();m();var w=BC.Selector.make(c,r);r.selector=w;e=BC.Stage.make(c,e);r.stage=e;var x=BC.Cell.Chain.makeManager(),y=BC.Cell.Drop.makeManager(c);return r};return g}(BC||{});BC=function(g){(g.Ring=g.Ring||{}).make=function(c){var a=c.metrics,b=c.translationY,m=c.selectable;c=BC.Math.sliceRadians(a.numCells);for(var b=BC.Matrix.makeTranslation(0,b,0),k=[],d=0;d<a.numCells;d++)k[d]=BC.Cell.make(a,d*c);return{matrix:b,cells:k,isEmpty:function(){for(var a=0;a<k.length;a++)if(k[a].state!==BC.Cell.CellState.EMPTY)return!1;return!0},setSelectable:function(a){m=a},isSelectable:function(){return m}}};return g}(BC||{});BC=function(g){(g.Stage=g.Stage||{}).make=function(c,a){a+=c.ringHeight/2;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return g}(BC||{});BC=function(g){(g.Selector=g.Selector||{}).make=function(c,a){function b(b){l=b;0<f.length&&BC.Util.error("startMoving: pending animations: "+f.length);f.push(BC.Animation.make({duration:k,updateCallback:function(b){var d=c.ringHeight*b.deltaPercent;b=e*b.deltaPercent;switch(l){case m.UP:return h[1]+=d,!0;case m.DOWN:return h[1]-=d,!0;case m.LEFT:return a.rotate(b),!0;case m.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){l=m.NONE}}))}var m=BC.Constants.Direction,k=0.025,
d={matrix:BC.Matrix.identity,move:function(a){switch(a){case m.LEFT:return l!==m.NONE?a=!1:(b(m.LEFT),a=!0),a;case m.RIGHT:return l!==m.NONE?a=!1:(b(m.RIGHT),a=!0),a;case m.UP:return l!==m.NONE?a=!1:(b(m.UP),a=!0),a;case m.DOWN:return l!==m.NONE?a=!1:(b(m.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(f,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);d.matrix=
BC.Matrix.matrixMultiply(a,b)}},l=m.NONE,f=[],h=[0,0,0],e=BC.Math.sliceRadians(c.numCells);return d};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function c(a){return f.getUniformLocation(u,a)}function a(){return l.width!=l.clientWidth||l.height!=l.clientHeight?(l.width=l.clientWidth,l.height=l.clientHeight,!0):!1}function b(){var a=l.width/l.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function m(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function k(){f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);f.viewport(0,0,f.canvas.width,
f.canvas.height);f.uniformMatrix4fv(q.projectionMatrixLocation,!1,t);r.tick();s.update(r);p.draw();requestAnimationFrame(k)}var d=BC.Constants.Direction,l=document.getElementById("canvas");if(l){var f=l.getContext("webgl")||l.getContext("experimental-webgl");if(f){var h=f.createTexture();f.bindTexture(f.TEXTURE_2D,h);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var e=new Image;e.src="images/textures.png";$(e).load(function(){f.bindTexture(f.TEXTURE_2D,
h);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST);f.generateMipmap(f.TEXTURE_2D)});f.enable(f.CULL_FACE);f.enable(f.DEPTH_TEST);f.enable(f.BLEND);f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);var g=BC.GL.loadShader(f,"vertex-shader",f.VERTEX_SHADER),n=BC.GL.loadShader(f,"fragment-shader",f.FRAGMENT_SHADER),u=BC.GL.createProgram(f,[g,n]);f.useProgram(u);
var q={positionLocation:f.getAttribLocation(u,"a_position"),textureCoordLocation:f.getAttribLocation(u,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardRotationMatrixLocation:c("u_boardRotationMatrix"),boardTranslationMatrixLocation:c("u_boardTranslationMatrix"),selectorMatrixLocation:c("u_selectorMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};
a();var t=b();$(window).resize(function(){a()&&(t=b())});g=m();f.uniformMatrix4fv(q.viewMatrixLocation,!1,g);var s=BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),p=BC.Board.View.make(s,f,q),g=BC.Controller.make(l);g.setMoveLeftListener(function(){s.move(d.LEFT)});g.setMoveRightListener(function(){s.move(d.RIGHT)});g.setMoveUpListener(function(){s.move(d.UP)});g.setMoveDownListener(function(){s.move(d.DOWN)});g.setPrimaryActionListener(function(){s.swap()});
var r=BC.StopWatch.make();k()}}};return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var c=g.Math=g.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var k=2*Math.PI/b,d=[],l=0;l<b;l++)d[2*l]=a*Math.cos(c+l*k),d[2*l+1]=a*Math.sin(c+l*k);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){var c=g.Board=g.Board||{};(c.View=c.View||{}).make=function(a,b,c){var k=c.boardRotationMatrixLocation,d=c.boardTranslationMatrixLocation,l=c.selectorMatrixLocation,f=c.ringMatrixLocation,h=c.cellMatrixLocation,e=BC.GL.textureTileSet(4,4,0.002),g=[e.tile(0,0),e.tile(0,1),e.tile(0,2),e.tile(0,3),e.tile(1,0),e.tile(1,1),e.tile(2,0),e.tile(2,1),e.tile(2,2),e.tile(2,3),e.tile(3,0),e.tile(3,1)],n=e.tile(1,2),e=e.tile(1,3),u=BC.Cell.View.make(b,a.metrics,g),q=BC.Selector.View.make(b,a.metrics,
n),t=BC.Stage.View.make(b,a.metrics,e);return{draw:function(){b.uniformMatrix4fv(k,!1,a.rotationMatrix);b.uniformMatrix4fv(d,!1,a.translationMatrix);b.uniformMatrix4fv(l,!1,BC.Matrix.identity);for(var e=a.rings,g=0;2>g;g++)for(var n=0;n<e.length;n++){b.uniformMatrix4fv(f,!1,e[n].matrix);for(var v=e[n].cells,x=0;x<v.length;x++)b.uniformMatrix4fv(h,!1,v[x].matrix),0==g?u.drawOpaque(v[x],c):u.drawTransparent(v[x],c)}b.uniformMatrix4fv(k,!1,BC.Matrix.identity);b.uniformMatrix4fv(d,!1,BC.Matrix.identity);
b.uniformMatrix4fv(l,!1,a.stage.matrix);b.uniformMatrix4fv(f,!1,BC.Matrix.identity);b.uniformMatrix4fv(h,!1,BC.Matrix.identity);t.draw(c);b.uniformMatrix4fv(k,!1,BC.Matrix.identity);b.uniformMatrix4fv(d,!1,a.translationMatrix);b.uniformMatrix4fv(l,!1,a.selector.matrix);b.uniformMatrix4fv(f,!1,BC.Matrix.identity);b.uniformMatrix4fv(h,!1,BC.Matrix.identity);q.draw(c)}}};return g}(BC||{});BC=function(g){var c=g.Cell=g.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_RECEIVING:4,BLOCK_CLEARING_MARKED:5,BLOCK_CLEARING_PREPARING:6,BLOCK_CLEARING_READY:7,BLOCK_CLEARING_IN_PROGRESS:8};c.make=function(a,b){function c(){var a=BC.Matrix.makeYRotation(e[1]),b=BC.Matrix.makeTranslation(g[0],g[1],g[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var k=BC.Cell.CellState,d=BC.Constants.Direction,l=BC.Math.sliceRadians(a.numCells),f=BC.Math.randomInt(a.numBlockTypes),h=[],
e=[0,b,0],g=[0,0,0],n={matrix:BC.Matrix.makeYRotation(e[1]),state:k.BLOCK,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){n.state=k.BLOCK_CLEARING_MARKED;0<h.length&&BC.Util.error("markBlock: pending animations: "+h.length);var b=BC.Animation.make({duration:0.5,startCallback:function(){n.state=k.BLOCK_CLEARING_PREPARING},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=0}}),d=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=
a.numBlockTypes},finishCallback:function(){n.state=k.BLOCK_CLEARING_READY}});h.push(b,d)},clearBlock:function(){n.state=k.BLOCK_CLEARING_IN_PROGRESS;0<h.length&&BC.Util.error("clearBlock: pending animations: "+h.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=k.EMPTY_NO_DROP;n.alpha=1}});h.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=k.EMPTY_NO_SWAP;0<h.length&&BC.Util.error("sendBlock: pending animations: "+
h.length);h.push(BC.Animation.make({duration:a,finishCallback:function(){n.state=k.EMPTY}}));return b},receiveBlock:function(b,f,t){n.blockStyle=t;n.state=k.BLOCK_RECEIVING;switch(f){case d.LEFT:e[1]-=l;break;case d.RIGHT:e[1]+=l;break;case d.UP:g[1]=a.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+f)}c();0<h.length&&BC.Util.error("receiveBlock: pending animations: "+h.length);h.push(BC.Animation.make({duration:b,updateCallback:function(b){var c=l*b.deltaPercent;b=a.ringHeight*
b.deltaPercent;switch(f){case d.LEFT:return e[1]+=c,!0;case d.RIGHT:return e[1]-=c,!0;case d.UP:return g[1]-=b,!0;default:return!1}},finishCallback:function(){n.state=k.BLOCK}}))},isClearing:function(){return n.state===k.BLOCK_CLEARING_MARKED||n.state===k.BLOCK_CLEARING_PREPARING||n.state===k.BLOCK_CLEARING_READY||n.state===k.BLOCK_CLEARING_IN_PROGRESS},isDrawable:function(){return n.state!==k.EMPTY&&n.state!==k.EMPTY_NO_SWAP&&n.state!==k.EMPTY_NO_DROP},isTransparent:function(){return n.state===k.BLOCK_CLEARING_IN_PROGRESS},
update:function(a){BC.Animation.process(h,a)&&c()}};return n};return g}(BC||{});BC=function(g){var c=g.Stage=g.Stage||{};(c.View=c.View||{}).make=function(a,b,c){b=[];var k=0;b[k++]=-1;b[k++]=0;b[k++]=1;b[k++]=1;b[k++]=0;b[k++]=1;b[k++]=1;b[k++]=0;b[k++]=-1;b[k++]=-1;b[k++]=0;b[k++]=-1;b[k++]=-1;b[k++]=-1;b[k++]=1;b[k++]=1;b[k++]=-1;b[k++]=1;b[k++]=1;b[k++]=0;b[k++]=1;b[k++]=-1;b[k++]=0;b[k++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var k=c.textureCoord(1,0),l=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,k,l,c,b,k,l,c));var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var h=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),e=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e);a.bufferData(a.ELEMENT_ARRAY_BUFFER,h,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,k=b.textureCoordLocation,l=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(k);a.vertexAttribPointer(k,2,a.FLOAT,!1,0,0);a.uniform1f(l,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e);a.drawElements(a.TRIANGLES,h.length,a.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){var c=g.GL=g.GL||{};c.loadShader=function(a,b,c,k){k=k||BC.Util.error;var d=document.getElementById(b);if(!d)return k("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),k("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,k){for(var d=a.createProgram(),l=0;l<b.length;l++)a.attachShader(d,b[l]);
if(c)for(l=0;l<c.length;l++)a.bindAttribLocation(d,k?k[l]:l,c[l]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,c){var k=1/a,d=1/b;return{tile:function(a,b){var h=k*b,e=d*a;return{textureCoord:function(a,b){return[h+c+(k-2*c)*a,e+c+(d-2*c)*b]}}}}};return g}(BC||{});BC=function(g){var c=g.Selector=g.Selector||{};(c.View=c.View||{}).make=function(a,b,c){var k=-b.ringHeight/2,d=-k;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var l=b.length-2,f=[],h=0;f[h++]=b[l]+0.001;f[h++]=k;f[h++]=-b[l+1]-0.001;f[h++]=b[0]+0.001;f[h++]=k;f[h++]=-b[1]-0.001;f[h++]=b[0]+0.001;f[h++]=d;f[h++]=-b[1]-0.001;f[h++]=b[l]+0.001;f[h++]=d;f[h++]=-b[l+1]-0.001;f[h++]=b[0]+0.001;f[h++]=k;f[h++]=-b[1]-0.001;f[h++]=b[2]+0.001;f[h++]=k;f[h++]=-b[3]-0.001;f[h++]=b[2]+
0.001;f[h++]=d;f[h++]=-b[3]-0.001;f[h++]=b[0]+0.001;f[h++]=d;f[h++]=-b[1]-0.001;var e=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,e);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);k=c.textureCoord(0,0);d=c.textureCoord(1,0);b=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(k,d,b,c,k,d,b,c));var g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),u=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
u);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,e);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,g);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){var c=g.Util=g.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return g}(BC||{});BC=function(g){var c=g.Cell=g.Cell||{};(c.Drop=c.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,c=BC.Constants.Direction;return{update:function(k){for(var d=0;d<k.rings.length;d++)for(var l=0;l<a.numCells;l++){var f=k,h=d,e=l,g=f.rings[h].cells[e];g.state===b.BLOCK&&(h+=1,h>=f.rings.length||(f=f.rings[h].cells[e],g.state===b.BLOCK&&f.state==b.EMPTY&&(g=g.sendBlock(0.05),f.receiveBlock(0.05,c.UP,g))))}return!1}}};return g}(BC||{});BC=function(g){(g.Controller=g.Controller||{}).make=function(c){var a=function(){},b=function(){},g=function(){},k=function(){},d=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:d.call();break;case 37:a.call();break;case 39:b.call();break;case 38:g.call();break;case 40:k.call()}return!1});var l=0,f=0;$(c).on("touchstart touchmove touchend",function(c){var e=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":l=e.pageX;f=e.pageY;break;case "touchend":c=e.pageX-
l,e=e.pageY-f,50<c?a.call():-50>c?b.call():50<e?k.call():-50>e?g.call():d.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){g=a},setMoveDownListener:function(a){k=a},setPrimaryActionListener:function(a){d=a}}};return g}(BC||{});BC=function(g){var c=g.Cell=g.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function k(b,c){var d=c.positionLocation,e=c.textureCoordLocation,f=c.yellowBoostLocation,g=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,n[b.blockStyle]);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,b.yellowBoost);a.uniform1f(g,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.drawElements(a.TRIANGLES,
q,a.UNSIGNED_SHORT,0)}var d=b.numCells,g=b.ringOuterRadius,f=b.ringHeight/2,h=-f,e=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,e);g=BC.Math.circlePoints(g,d,e);d=0;e=[];e[d++]=b[0];e[d++]=f;e[d++]=-b[1];e[d++]=g[0];e[d++]=f;e[d++]=-g[1];e[d++]=g[2];e[d++]=f;e[d++]=-g[3];e[d++]=b[2];e[d++]=f;e[d++]=-b[3];e[d++]=g[0];e[d++]=h;e[d++]=-g[1];e[d++]=b[0];e[d++]=h;e[d++]=-b[1];e[d++]=b[2];e[d++]=h;e[d++]=-b[3];e[d++]=g[2];e[d++]=h;e[d++]=-g[3];e[d++]=b[0];e[d++]=f;e[d++]=-b[1];e[d++]=b[0];e[d++]=
h;e[d++]=-b[1];e[d++]=g[0];e[d++]=h;e[d++]=-g[1];e[d++]=g[0];e[d++]=f;e[d++]=-g[1];e[d++]=g[2];e[d++]=f;e[d++]=-g[3];e[d++]=g[2];e[d++]=h;e[d++]=-g[3];e[d++]=b[2];e[d++]=h;e[d++]=-b[3];e[d++]=b[2];e[d++]=f;e[d++]=-b[3];e[d++]=g[0];e[d++]=f;e[d++]=-g[1];e[d++]=g[0];e[d++]=h;e[d++]=-g[1];e[d++]=g[2];e[d++]=h;e[d++]=-g[3];e[d++]=g[2];e[d++]=f;e[d++]=-g[3];e[d++]=b[2];e[d++]=f;e[d++]=-b[3];e[d++]=b[2];e[d++]=h;e[d++]=-b[3];e[d++]=b[0];e[d++]=h;e[d++]=-b[1];e[d++]=b[0];e[d++]=f;e[d++]=-b[1];var v=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,new Float32Array(e),a.STATIC_DRAW);f=[];for(d=0;d<c.length;d++)for(h=c[d],f[d]=[],g=b=0;6>b;b++)e=h.textureCoord(0,0),f[d][g++]=e[0],f[d][g++]=e[1],e=h.textureCoord(0,1),f[d][g++]=e[0],f[d][g++]=e[1],e=h.textureCoord(1,1),f[d][g++]=e[0],f[d][g++]=e[1],e=h.textureCoord(1,0),f[d][g++]=e[0],f[d][g++]=e[1];for(var n=[],d=0;d<c.length;d++)n[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,n[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(f[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var u=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var q=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&k(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),k(b,c),a.enable(a.CULL_FACE))}}};return g}(BC||{});BC=function(g){(g.StopWatch=g.StopWatch||{}).make=function(){var c={then:0.001*Date.now(),tick:function(){c.now=0.001*Date.now();c.deltaTime=c.now-c.then;c.then=c.now}};return c};return g}(BC||{});
