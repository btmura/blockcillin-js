var BC=function(h){var e=h.Matrix=h.Matrix||{};e.makeLookAt=function(a,b,l){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));l=BC.Math.cross(l,b);var m=BC.Math.cross(b,l);return[l[0],l[1],l[2],0,m[0],m[1],m[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};e.makePerspective=function(a,b,l,m){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(l-m);return[a/b,0,0,0,0,a,0,0,0,0,(l+m)*d,-1,0,0,l*m*d*2,0]};e.makeTranslation=function(a,b,l){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,l,1]};e.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};e.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};e.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};e.makeScale=function(a,b,l){return[a,0,0,0,0,b,0,0,0,0,l,0,0,0,0,1]};e.identity=e.makeScale(1,1,1);e.makeInverse=function(a){var b=a[0],l=a[1],m=a[2],d=a[3],f=a[4],c=a[5],k=a[6],g=a[7],e=a[8],n=a[9],q=a[10],t=a[11],u=a[12],r=a[13],h=a[14];a=
a[15];var p=q*a,v=h*t,x=k*a,y=h*g,z=k*t,A=q*g,B=m*a,C=h*d,D=m*t,E=q*d,F=m*g,G=k*d,H=e*r,I=u*n,J=f*r,K=u*c,L=f*n,M=e*c,N=b*r,O=u*l,P=b*n,Q=e*l,R=b*c,S=f*l,T=p*c+y*n+z*r-(v*c+x*n+A*r),U=v*l+B*n+E*r-(p*l+C*n+D*r),r=x*l+C*c+F*r-(y*l+B*c+G*r),l=A*l+D*c+G*n-(z*l+E*c+F*n),c=1/(b*T+f*U+e*r+u*l);return[c*T,c*U,c*r,c*l,c*(v*f+x*e+A*u-(p*f+y*e+z*u)),c*(p*b+C*e+D*u-(v*b+B*e+E*u)),c*(y*b+B*f+G*u-(x*b+C*f+F*u)),c*(z*b+E*f+F*e-(A*b+D*f+G*e)),c*(H*g+K*t+L*a-(I*g+J*t+M*a)),c*(I*d+N*t+Q*a-(H*d+O*t+P*a)),c*(J*d+O*g+
R*a-(K*d+N*g+S*a)),c*(M*d+P*g+S*t-(L*d+Q*g+R*t)),c*(J*q+M*h+I*k-(L*h+H*k+K*q)),c*(P*h+H*m+O*q-(N*q+Q*h+I*m)),c*(N*k+S*h+K*m-(R*h+J*m+O*k)),c*(R*q+L*m+Q*k-(P*k+S*q+M*m))]};e.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return h}(BC||{});BC=function(h){var e=h.Animation=h.Animation||{};e.make=function(a){var b=a.duration,l=a.startCallback||function(){},m=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},f=0,c=!1,k=!1;return{update:function(a){c||(c=!0,l());var e=a.deltaTime;f+e>b&&(e=b-f);f+=e;a=m({now:a.now,deltaTime:e,elapsedPercent:f/b,deltaPercent:e/b});f>=b&&(k=!0,d());return a},isDone:function(){return k}}};e.process=function(a,b){var l=!1;if(0<a.length){var m=a[0],l=l|m.update(b);m.isDone()&&a.shift()}return l};
return h}(BC||{});BC=function(h){var e=h.Cell=h.Cell||{},e=e.Chain=e.Chain||{};e.find=function(a){function b(b,c){return a.rings[b].cells[c]}function l(){for(var a=[],d=0;d<g;d++){var l;l=d;for(var f=0,m=b(l,f),h=0;h<k;h++){var p=b(l,f);if(m.state!==p.state||m.blockStyle!=p.blockStyle)break;f+=1;f=f===k?0:f}l=f;for(f=0;f<k;)if(h=(f+l)%k,p=b(d,h),p.state!==c.BLOCK)f++;else{for(var v=1,m=f+1;m<k;m++)if(h=(m+l)%k,h=b(d,h),p.state===h.state&&p.blockStyle==h.blockStyle)v++;else break;if(v>=e){for(p=[];f<m;f++)h=(f+l)%k,
v=b(d,h),p.push({cell:v,row:d,col:h});a.push(p)}f=m}}return a}function m(){for(var a=[],d=0;d<k;d++)for(var f=0;f<g;){var l=b(f,d);if(l.state!==c.BLOCK)f++;else{for(var m=1,h=f+1;h<g;h++){var p=b(h,d);if(l.state===p.state&&l.blockStyle==p.blockStyle)m++;else break}if(m>=e){for(l=[];f<h;f++)m=b(f,d),l.push({cell:m,row:f,col:d});a.push(l)}f=h}}return a}function d(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],f=0;f<b.length;f++){var l=b[f];if(d.blockStyle===l.blockStyle&&d.row===l.row&&d.col===l.col)return!0}return!1}
function f(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.blockStyle===b.blockStyle&&d.row===b.row&&d.col===b.col)return!0}return!1}var c=BC.Cell.CellState,k=a.rings[0].cells.length,g=a.rings.length,e=3;return function(){for(var a=[],b=l(),c=m();0<b.length;){var g=b.shift();for(a.push(g);;){for(var k=!1,e=0;e<c.length;e++)if(d(g,c[e])){for(k=0;k<c[e].length;k++)f(g,c[e][k])||g.push(c[e][k]);c.splice(e,1);k=!0}if(!k)break;k=!1;for(e=0;e<b.length;e++)if(d(g,b[e])){for(k=0;k<b[e].length;k++)f(g,b[e][k])||
g.push(b[e][k]);b.splice(e,1);k=!0}if(!k)break}}for(;0<c.length;)g=c.shift(),a.push(g);for(e=0;e<a.length;e++)a[e].sort(function(a,b){return a.row-b.row});return a}()};e.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(e){var d=BC.Cell.Chain.find(e);for(e=0;e<d.length;e++){var f=d[e];l.push(f);for(var c=0;c<f.length;c++){var k=f[c].cell;k.markBlock();b.push(k)}}if(0<b.length)switch(k=b[0],k.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;case a.BLOCK_CLEARING_READY:k.clearBlock();
break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){f=l[0];d=!0;for(e=0;e<f.length;e++)k=f[e].cell,d&=!k.isClearing();if(d){for(e=0;e<f.length;e++)k=f[e].cell,k.state===a.EMPTY_NO_DROP&&(k.state=a.EMPTY);l.shift()}}}}};return h}(BC||{});BC=function(h){(h.Constants=h.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).make=function(e,a){var b=BC.Cell.CellState,l=BC.Constants.Direction,m={metrics:e,rings:a,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case l.LEFT:g.move(l.LEFT)&&(f--,0>f&&(f=e.numCells-1));break;case l.RIGHT:g.move(l.RIGHT)&&(f++,f>=e.numCells&&(f=0));break;case l.UP:0<d&&g.move(l.UP)&&d--;break;case l.DOWN:d+1<m.rings.length&&g.move(l.DOWN)&&d++}},rotate:function(a){c[1]+=a},swap:function(){var a=m.rings[d].cells[f%
e.numCells],c=m.rings[d].cells[(f+1)%e.numCells];BC.Util.log("swap: ("+a.state+", "+c.state+")");var g=a.blockStyle,k=c.blockStyle;a.state!==b.EMPTY&&a.state!==b.EMPTY_NO_DROP||c.state!==b.BLOCK?a.state!==b.BLOCK||c.state!==b.EMPTY&&c.state!==b.EMPTY_NO_DROP?a.state===b.BLOCK&&c.state===b.BLOCK&&(a.receiveBlock(0.1,l.RIGHT,k),c.receiveBlock(0.1,l.LEFT,g)):(a.sendBlock(0.1,l.RIGHT),c.receiveBlock(0.1,l.LEFT,g)):(c.sendBlock(0.1,l.LEFT),a.receiveBlock(0.1,l.RIGHT,k))},update:function(a){for(var b=0;b<
e.numRings;b++)for(var d=0;d<e.numCells;d++)m.rings[b].cells[d%e.numCells].update(a);h.update(m);n.update(m);g.update(a);var b=BC.Matrix.makeXRotation(c[0]),d=BC.Matrix.makeYRotation(c[1]),f=BC.Matrix.makeZRotation(c[2]),d=BC.Matrix.matrixMultiply(f,d),d=BC.Matrix.matrixMultiply(d,b);m.rotationMatrix=d;k[1]+=0.02*a.deltaTime;1.25<=k[1]&&(k[1]=1.25);m.translationMatrix=BC.Matrix.makeTranslation(k[0],k[1],k[2])}},d=0,f=e.numCells-1,c=[0,0,0],k=[0,0,0],g=BC.Selector.make(e,m);m.selector=g;var h=BC.Cell.Chain.makeManager(),
n=BC.Cell.Drop.makeManager(e);return m};return h}(BC||{});BC=function(h){(h.Ring=h.Ring||{}).make=function(e,a){for(var b=[],l=0;l<a.numCells;l++)b[l]=BC.Cell.make(l,a);l=BC.Matrix.makeTranslation(0,-e*a.ringHeight,0);return{cells:b,matrix:l}};return h}(BC||{});BC=function(h){(h.Selector=h.Selector||{}).make=function(e,a){function b(b){f=b;0<c.length&&BC.Util.error("startMoving: pending animations: "+c.length);c.push(BC.Animation.make({duration:m,updateCallback:function(b){var c=e.ringHeight*b.deltaPercent;b=g*b.deltaPercent;switch(f){case l.UP:return k[1]+=c,!0;case l.DOWN:return k[1]-=c,!0;case l.LEFT:return a.rotate(b),!0;case l.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){f=l.NONE}}))}var l=BC.Constants.Direction,m=0.025,
d={matrix:BC.Matrix.identity,move:function(a){switch(a){case l.LEFT:return f!==l.NONE?a=!1:(b(l.LEFT),a=!0),a;case l.RIGHT:return f!==l.NONE?a=!1:(b(l.RIGHT),a=!0),a;case l.UP:return f!==l.NONE?a=!1:(b(l.UP),a=!0),a;case l.DOWN:return f!==l.NONE?a=!1:(b(l.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(c,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(k[0],k[1],k[2]);d.matrix=
BC.Matrix.matrixMultiply(a,b)}},f=l.NONE,c=[],k=[0,0,0],g=BC.Math.sliceRadians(e.numCells);return d};return h}(BC||{});BC=function(h){(h.Game=h.Game||{}).run=function(){function e(a){return c.getUniformLocation(q,a)}function a(){return f.width!=f.clientWidth||f.height!=f.clientHeight?(f.width=f.clientWidth,f.height=f.clientHeight,!0):!1}function b(){var a=f.width/f.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.5,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function m(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);c.viewport(0,0,c.canvas.width,
c.canvas.height);c.uniformMatrix4fv(t.projectionMatrixLocation,!1,u);v.tick();w.update(v);p.draw();requestAnimationFrame(m)}var d=BC.Constants.Direction,f=document.getElementById("canvas");if(f){var c=f.getContext("webgl")||f.getContext("experimental-webgl");if(c){var k=c.createTexture();c.bindTexture(c.TEXTURE_2D,k);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var g=new Image;g.src="images/textures.png";$(g).load(function(){c.bindTexture(c.TEXTURE_2D,
k);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,g);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST);c.generateMipmap(c.TEXTURE_2D)});c.enable(c.CULL_FACE);c.enable(c.DEPTH_TEST);c.enable(c.BLEND);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var h=BC.GL.loadShader(c,"vertex-shader",c.VERTEX_SHADER),n=BC.GL.loadShader(c,"fragment-shader",c.FRAGMENT_SHADER),q=BC.GL.createProgram(c,[h,n]);c.useProgram(q);
var t={positionLocation:c.getAttribLocation(q,"a_position"),textureCoordLocation:c.getAttribLocation(q,"a_textureCoord"),projectionMatrixLocation:e("u_projectionMatrix"),viewMatrixLocation:e("u_viewMatrix"),boardRotationMatrixLocation:e("u_boardRotationMatrix"),boardTranslationMatrixLocation:e("u_boardTranslationMatrix"),selectorMatrixLocation:e("u_selectorMatrix"),ringMatrixLocation:e("u_ringMatrix"),cellMatrixLocation:e("u_cellMatrix"),yellowBoostLocation:e("u_yellowBoost"),alphaLocation:e("u_alpha")};
a();var u=b();$(window).resize(function(){a()&&(u=b())});h=l();c.uniformMatrix4fv(t.viewMatrixLocation,!1,h);for(var h={numRings:4,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},n=[],r=0;r<h.numRings;r++)n[r]=BC.Ring.make(r,h);var w=BC.Board.make(h,n),p=BC.Board.View.make(w,c,t),h=BC.Controller.make(f);h.setMoveLeftListener(function(){w.move(d.LEFT)});h.setMoveRightListener(function(){w.move(d.RIGHT)});h.setMoveUpListener(function(){w.move(d.UP)});h.setMoveDownListener(function(){w.move(d.DOWN)});
h.setPrimaryActionListener(function(){w.swap()});var v=BC.StopWatch.make();m()}}};return h}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(h){var e=h.Math=h.Math||{};e.radians=function(a){return a*Math.PI/180};e.sliceRadians=function(a){return 2*Math.PI/a};e.randomInt=function(a){return Math.floor(Math.random()*a)};e.circlePoints=function(a,b,l){l=l||0;for(var e=2*Math.PI/b,d=[],f=0;f<b;f++)d[2*f]=a*Math.cos(l+f*e),d[2*f+1]=a*Math.sin(l+f*e);return d};e.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};e.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};e.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return h}(BC||{});BC=function(h){var e=h.Board=h.Board||{};(e.View=e.View||{}).make=function(a,b,l){var e=l.boardRotationMatrixLocation,d=l.boardTranslationMatrixLocation,f=l.selectorMatrixLocation,c=l.ringMatrixLocation,k=l.cellMatrixLocation,g=BC.GL.textureTileSet(4,4,0.002),h=[g.tile(0,0),g.tile(0,1),g.tile(0,2),g.tile(0,3),g.tile(1,0),g.tile(1,1),g.tile(2,0),g.tile(2,1),g.tile(2,2),g.tile(2,3),g.tile(3,0),g.tile(3,1)],g=g.tile(1,2),n=BC.Cell.View.make(b,a.metrics,h),q=BC.Selector.View.make(b,a.metrics,g);return{draw:function(){b.uniformMatrix4fv(e,
!1,a.rotationMatrix);b.uniformMatrix4fv(d,!1,a.translationMatrix);b.uniformMatrix4fv(f,!1,BC.Matrix.identity);for(var g=a.rings,h=0;2>h;h++)for(var r=0;r<g.length;r++){b.uniformMatrix4fv(c,!1,g[r].matrix);for(var s=g[r].cells,p=0;p<s.length;p++)b.uniformMatrix4fv(k,!1,s[p].matrix),0==h?n.drawOpaque(s[p],l):n.drawTransparent(s[p],l)}b.uniformMatrix4fv(e,!1,BC.Matrix.identity);b.uniformMatrix4fv(d,!1,a.translationMatrix);b.uniformMatrix4fv(f,!1,a.selector.matrix);b.uniformMatrix4fv(c,!1,BC.Matrix.identity);
b.uniformMatrix4fv(k,!1,BC.Matrix.identity);q.draw(l)}}};return h}(BC||{});BC=function(h){var e=h.Cell=h.Cell||{};e.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_RECEIVING:4,BLOCK_CLEARING_MARKED:5,BLOCK_CLEARING_PREPARING:6,BLOCK_CLEARING_READY:7,BLOCK_CLEARING_IN_PROGRESS:8};e.make=function(a,b){function l(){var a=BC.Matrix.makeYRotation(g[1]),b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var e=BC.Cell.CellState,d=BC.Constants.Direction,f=BC.Math.randomInt(b.numBlockTypes),c=[],k=BC.Math.sliceRadians(b.numCells),
g=[0,a*k,0],h=[0,0,0],n={matrix:BC.Matrix.makeYRotation(g[1]),state:e.BLOCK,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){n.state=e.BLOCK_CLEARING_MARKED;0<c.length&&BC.Util.error("markBlock: pending animations: "+c.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){n.state=e.BLOCK_CLEARING_PREPARING},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=0}}),d=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=
b.numBlockTypes},finishCallback:function(){n.state=e.BLOCK_CLEARING_READY}});c.push(a,d)},clearBlock:function(){n.state=e.BLOCK_CLEARING_IN_PROGRESS;0<c.length&&BC.Util.error("clearBlock: pending animations: "+c.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=e.EMPTY_NO_DROP;n.alpha=1}});c.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=e.EMPTY_NO_SWAP;0<c.length&&BC.Util.error("sendBlock: pending animations: "+
c.length);c.push(BC.Animation.make({duration:a,finishCallback:function(){n.state=e.EMPTY}}));return b},receiveBlock:function(a,f,u){n.blockStyle=u;n.state=e.BLOCK_RECEIVING;switch(f){case d.LEFT:g[1]-=k;break;case d.RIGHT:g[1]+=k;break;case d.UP:h[1]=b.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+f)}l();0<c.length&&BC.Util.error("receiveBlock: pending animations: "+c.length);c.push(BC.Animation.make({duration:a,updateCallback:function(a){var c=k*a.deltaPercent;a=b.ringHeight*
a.deltaPercent;switch(f){case d.LEFT:return g[1]+=c,!0;case d.RIGHT:return g[1]-=c,!0;case d.UP:return h[1]-=a,!0;default:return!1}},finishCallback:function(){n.state=e.BLOCK}}))},isClearing:function(){return n.state===e.BLOCK_CLEARING_MARKED||n.state===e.BLOCK_CLEARING_PREPARING||n.state===e.BLOCK_CLEARING_READY||n.state===e.BLOCK_CLEARING_IN_PROGRESS},isDrawable:function(){return n.state!==e.EMPTY&&n.state!==e.EMPTY_NO_SWAP&&n.state!==e.EMPTY_NO_DROP},isTransparent:function(){return n.state===e.BLOCK_CLEARING_IN_PROGRESS},
update:function(a){BC.Animation.process(c,a)&&l()}};return n};return h}(BC||{});BC=function(h){var e=h.GL=h.GL||{};e.loadShader=function(a,b,e,h){h=h||BC.Util.error;var d=document.getElementById(b);if(!d)return h("** Error getting script element:"+b),null;b=a.createShader(e);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),h("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};e.createProgram=function(a,b,e,h){for(var d=a.createProgram(),f=0;f<b.length;f++)a.attachShader(d,b[f]);
if(e)for(f=0;f<e.length;f++)a.bindAttribLocation(d,h?h[f]:f,e[f]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),error("Error in program linking: "+lastError),a.deleteProgram(d),null)};e.textureTileSet=function(a,b,e){var h=1/a,d=1/b;return{tile:function(a,b){var k=h*b,g=d*a;return{textureCoord:function(a,b){return[k+e+(h-2*e)*a,g+e+(d-2*e)*b]}}}}};return h}(BC||{});BC=function(h){var e=h.Selector=h.Selector||{};(e.View=e.View||{}).make=function(a,b,e){var h=-b.ringHeight/2,d=-h;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var f=b.length-2,c=[],k=0;c[k++]=b[f]+0.001;c[k++]=h;c[k++]=-b[f+1]-0.001;c[k++]=b[0]+0.001;c[k++]=h;c[k++]=-b[1]-0.001;c[k++]=b[0]+0.001;c[k++]=d;c[k++]=-b[1]-0.001;c[k++]=b[f]+0.001;c[k++]=d;c[k++]=-b[f+1]-0.001;c[k++]=b[0]+0.001;c[k++]=h;c[k++]=-b[1]-0.001;c[k++]=b[2]+0.001;c[k++]=h;c[k++]=-b[3]-0.001;c[k++]=b[2]+
0.001;c[k++]=d;c[k++]=-b[3]-0.001;c[k++]=b[0]+0.001;c[k++]=d;c[k++]=-b[1]-0.001;var g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g);a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW);h=e.textureCoord(0,0);d=e.textureCoord(1,0);b=e.textureCoord(1,1);e=e.textureCoord(0,1);e=new Float32Array([].concat(h,d,b,e,h,d,b,e));var s=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,s);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),q=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
q);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,g);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,s);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){var e=h.Util=h.Util||{};e.log=function(a){window.console&&window.console.log&&window.console.log(a)};e.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return h}(BC||{});BC=function(h){var e=h.Cell=h.Cell||{};(e.Drop=e.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,e=BC.Constants.Direction;return{update:function(h){for(var d=0;d<a.numRings;d++)for(var f=0;f<a.numCells;f++){var c=h,k=d,g=f,s=c.rings[k].cells[g];s.state===b.BLOCK&&(k+=1,k>=a.numRings||(c=c.rings[k].cells[g],s.state===b.BLOCK&&c.state==b.EMPTY&&(s=s.sendBlock(0.05),c.receiveBlock(0.05,e.UP,s))))}}}};return h}(BC||{});BC=function(h){(h.Controller=h.Controller||{}).make=function(e){var a=function(){},b=function(){},h=function(){},m=function(){},d=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:d.call();break;case 37:a.call();break;case 39:b.call();break;case 38:h.call();break;case 40:m.call()}return!1});var f=0,c=0;$(e).on("touchstart touchmove touchend",function(e){var g=e.originalEvent.changedTouches[0];switch(e.type){case "touchstart":f=g.pageX;c=g.pageY;break;case "touchend":e=g.pageX-
f,g=g.pageY-c,50<e?a.call():-50>e?b.call():50<g?m.call():-50>g?h.call():d.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){h=a},setMoveDownListener:function(a){m=a},setPrimaryActionListener:function(a){d=a}}};return h}(BC||{});BC=function(h){var e=h.Cell=h.Cell||{};(e.View=e.View||{}).make=function(a,b,e){function h(b,c){var d=c.positionLocation,e=c.textureCoordLocation,f=c.yellowBoostLocation,g=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,s);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,n[b.blockStyle]);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,b.yellowBoost);a.uniform1f(g,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.drawElements(a.TRIANGLES,
t,a.UNSIGNED_SHORT,0)}var d=b.numCells,f=b.ringOuterRadius,c=b.ringHeight/2,k=-c,g=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,g);f=BC.Math.circlePoints(f,d,g);d=0;g=[];g[d++]=b[0];g[d++]=c;g[d++]=-b[1];g[d++]=f[0];g[d++]=c;g[d++]=-f[1];g[d++]=f[2];g[d++]=c;g[d++]=-f[3];g[d++]=b[2];g[d++]=c;g[d++]=-b[3];g[d++]=b[0];g[d++]=c;g[d++]=-b[1];g[d++]=b[0];g[d++]=k;g[d++]=-b[1];g[d++]=f[0];g[d++]=k;g[d++]=-f[1];g[d++]=f[0];g[d++]=c;g[d++]=-f[1];g[d++]=f[2];g[d++]=c;g[d++]=-f[3];g[d++]=f[2];g[d++]=
k;g[d++]=-f[3];g[d++]=b[2];g[d++]=k;g[d++]=-b[3];g[d++]=b[2];g[d++]=c;g[d++]=-b[3];g[d++]=f[0];g[d++]=c;g[d++]=-f[1];g[d++]=f[0];g[d++]=k;g[d++]=-f[1];g[d++]=f[2];g[d++]=k;g[d++]=-f[3];g[d++]=f[2];g[d++]=c;g[d++]=-f[3];g[d++]=b[2];g[d++]=c;g[d++]=-b[3];g[d++]=b[2];g[d++]=k;g[d++]=-b[3];g[d++]=b[0];g[d++]=k;g[d++]=-b[1];g[d++]=b[0];g[d++]=c;g[d++]=-b[1];var s=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,s);a.bufferData(a.ARRAY_BUFFER,new Float32Array(g),a.STATIC_DRAW);c=[];for(d=0;d<e.length;d++)for(k=
e[d],c[d]=[],f=b=0;5>b;b++)g=k.textureCoord(0,0),c[d][f++]=g[0],c[d][f++]=g[1],g=k.textureCoord(0,1),c[d][f++]=g[0],c[d][f++]=g[1],g=k.textureCoord(1,1),c[d][f++]=g[0],c[d][f++]=g[1],g=k.textureCoord(1,0),c[d][f++]=g[0],c[d][f++]=g[1];for(var n=[],d=0;d<e.length;d++)n[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,n[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(c[d]),a.STATIC_DRAW);e=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var q=a.createBuffer();
a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.bufferData(a.ELEMENT_ARRAY_BUFFER,e,a.STATIC_DRAW);var t=e.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&h(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),h(b,c),a.enable(a.CULL_FACE))}}};return h}(BC||{});BC=function(h){(h.StopWatch=h.StopWatch||{}).make=function(){var e={then:0.001*Date.now(),tick:function(){e.now=0.001*Date.now();e.deltaTime=e.now-e.then;e.then=e.now}};return e};return h}(BC||{});
