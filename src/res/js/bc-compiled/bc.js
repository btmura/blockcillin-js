var BC=function(e){var c=e.Cell=e.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};c.make=function(a){function b(){var a=BC.Math.Matrix.makeYRotation(n[1]),b=BC.Math.Matrix.makeTranslation(t[0],t[1],t[2]);p.matrix=BC.Math.Matrix.matrixMultiply(a,b)}var k=BC.Cell.CellState,q=BC.Direction,d=BC.Audio.Sound,f=a.metrics,g=a.rotationY,c=a.state,
h=a.blockStyle,e=a.audioPlayer,m=BC.Math.sliceRadians(f.numCells),r=[],v=!1,n=[0,g,0],t=[0,0,0],p={matrix:BC.Math.Matrix.makeYRotation(n[1]),state:c,blockStyle:h,yellowBoost:0,alpha:1,markBlock:function(){p.state=k.BLOCK_CLEARING_MARKED;0<r.length&&BC.Log.error("markBlock: pending animations: "+r.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){p.state=k.BLOCK_CLEARING_PREPARING},updateCallback:function(a){p.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){p.yellowBoost=
0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){p.blockStyle+=f.numBlockTypes},finishCallback:function(){p.state=k.BLOCK_CLEARING_READY}});r.push(a,b)},clearBlock:function(){p.state=k.BLOCK_CLEARING_IN_PROGRESS;0<r.length&&BC.Log.error("clearBlock: pending animations: "+r.length);var a=BC.Animation.make({duration:0.25,startCallback:function(){e.play(d.CELL_CLEAR)},updateCallback:function(a){p.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){p.state=k.EMPTY_NO_DROP;p.alpha=
1}});r.push(a)},sendBlock:function(a){var b=p.blockStyle;p.blockStyle=0;p.state=k.EMPTY_NO_SWAP;0<r.length&&BC.Log.error("sendBlock: pending animations: "+r.length);r.push(BC.Animation.make({duration:a,finishCallback:function(){p.state=k.EMPTY}}));return b},receiveBlock:function(a,d,g){p.blockStyle=g;p.state=k.BLOCK_RECEIVING;switch(d){case q.LEFT:n[1]-=m;break;case q.RIGHT:n[1]+=m;break;case q.UP:t[1]=f.ringHeight;v=!0;break;default:BC.Log.error("receiveBlock: unsupport direction: "+d)}b();0<r.length&&
BC.Log.error("receiveBlock: pending animations: "+r.length);r.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=m*a.deltaPercent;a=f.ringHeight*a.deltaPercent;switch(d){case q.LEFT:return n[1]+=b,!0;case q.RIGHT:return n[1]-=b,!0;case q.UP:return t[1]-=a,!0;default:return!1}},finishCallback:function(){p.state=k.BLOCK;v=!1}}))},isClearing:function(){return p.state===k.BLOCK_CLEARING_MARKED||p.state===k.BLOCK_CLEARING_PREPARING||p.state===k.BLOCK_CLEARING_READY||p.state===k.BLOCK_CLEARING_IN_PROGRESS},
isDrawable:function(){return p.state!==k.EMPTY&&p.state!==k.EMPTY_NO_SWAP&&p.state!==k.EMPTY_NO_DROP},isTransparent:function(){return p.state===k.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return v},update:function(a){BC.Animation.process(r,a)&&b()}};return p};return e}(BC||{});BC=function(e){e.Unit={NONE:"NONE",SECONDS:"SECONDS"};return e}(BC||{});BC=function(e){(e.Ring=e.Ring||{}).make=function(c){var a=BC.Cell.CellState,b=c.metrics,k=c.translationY,q=c.selectable;c=c.audioPlayer;for(var d=BC.Math.sliceRadians(b.numCells),k=BC.Math.Matrix.makeTranslation(0,k,0),a=q?a.BLOCK:a.BLOCK_INCOMING,f=[],g=0;g<b.numCells;g++){var e=g*d,h=BC.Math.randomInt(b.numBlockTypes);q||(h+=2*b.numBlockTypes);f[g]=BC.Cell.make({metrics:b,rotationY:e,state:a,blockStyle:h,audioPlayer:c})}return{matrix:k,cells:f,isEmpty:function(){for(var a=0;a<f.length;a++)if(f[a].state!==
BC.Cell.CellState.EMPTY)return!1;return!0},setSelectable:function(a){if(!q&&a)for(var d=0;d<f.length;d++)f[d].state===BC.Cell.CellState.BLOCK_INCOMING&&(f[d].state=BC.Cell.CellState.BLOCK,f[d].blockStyle-=2*b.numBlockTypes);q=a},isSelectable:function(){return q}}};return e}(BC||{});BC=function(e){var c=e.Menu=e.Menu||{};(c.Game=c.Game||{}).make=function(){var a=$("#game-menu"),b=$("#pause-button",a),k=BC.Stat.View.make($("#speed-level-stat",a)),q=BC.Stat.View.make($("#elapsed-time-stat",a)),d=BC.Stat.View.make($("#score-stat",a)),f=function(){};b.click(function(){f()});return{setPauseListener:function(a){f=a},show:function(){a.fadeIn("slow")},hide:function(){a.fadeOut("slow")},getSpeedLevelView:function(){return k},getElapsedTimeView:function(){return q},getScoreView:function(){return d}}};
return e}(BC||{});BC=function(e){var c=e.Math=e.Math||{},c=c.Matrix=c.Matrix||{};c.makeLookAt=function(a,b,k){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));k=BC.Math.cross(k,b);var q=BC.Math.cross(b,k);return[k[0],k[1],k[2],0,q[0],q[1],q[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,k,q){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(k-q);return[a/b,0,0,0,0,a,0,0,0,0,(k+q)*d,-1,0,0,k*q*d*2,0]};c.makeTranslation=function(a,b,k){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,k,1]};c.makeXRotation=function(a){var b=
Math.cos(a);a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,k){return[a,0,0,0,0,b,0,0,0,0,k,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],k=a[1],q=a[2],d=a[3],f=a[4],g=a[5],c=a[6],h=a[7],e=a[8],m=a[9],r=a[10],v=a[11],n=a[12],t=a[13],
p=a[14];a=a[15];var u=r*a,z=p*v,x=c*a,w=p*h,B=c*v,D=r*h,y=q*a,A=p*d,E=q*v,C=r*d,F=q*h,J=c*d,K=e*t,H=n*m,G=f*t,I=n*g,L=f*m,M=e*g,N=b*t,O=n*k,P=b*m,Q=e*k,R=b*g,S=f*k,T=u*g+w*m+B*t-(z*g+x*m+D*t),U=z*k+y*m+C*t-(u*k+A*m+E*t),t=x*k+A*g+F*t-(w*k+y*g+J*t),k=D*k+E*g+J*m-(B*k+C*g+F*m),g=1/(b*T+f*U+e*t+n*k);return[g*T,g*U,g*t,g*k,g*(z*f+x*e+D*n-(u*f+w*e+B*n)),g*(u*b+A*e+E*n-(z*b+y*e+C*n)),g*(w*b+y*f+J*n-(x*b+A*f+F*n)),g*(B*b+C*f+F*e-(D*b+E*f+J*e)),g*(K*h+I*v+L*a-(H*h+G*v+M*a)),g*(H*d+N*v+Q*a-(K*d+O*v+P*a)),
g*(G*d+O*h+R*a-(I*d+N*h+S*a)),g*(M*d+P*h+S*v-(L*d+Q*h+R*v)),g*(G*r+M*p+H*c-(L*p+K*c+I*r)),g*(P*p+K*q+O*r-(N*r+Q*p+H*q)),g*(N*c+S*p+I*q-(R*p+G*q+O*c)),g*(R*r+L*q+Q*c-(P*c+S*r+M*q))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*
b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return e}(BC||{});BC=function(e){var c=e.Board=e.Board||{};(c.View=c.View||{}).make=function(a){var b=a.board,k=a.gl,q=a.programLocations,d=a.resources,f=a.speedLevelStatView,c=a.elapsedTimeStatView,e=a.scoreStatView,h=q.boardRotationMatrixLocation,s=q.boardTranslationMatrixLocation,m=q.selectorMatrixLocation,r=q.ringMatrixLocation,v=q.cellMatrixLocation,n=BC.Cell.View.make(k,b.metrics,d.blockTextureTiles),t=BC.Selector.View.make(k,b.metrics,d.selectorTextureTile),p=BC.Stage.View.make(k,b.metrics,d.blackTextureTile);
return{draw:function(){f.draw(b.speedLevel);c.draw(b.elapsedTime);e.draw(b.score);k.uniformMatrix4fv(h,!1,b.rotationMatrix);k.uniformMatrix4fv(s,!1,b.translationMatrix);k.uniformMatrix4fv(m,!1,BC.Math.Matrix.identity);for(var a=b.rings,d=0;2>d;d++)for(var x=0;x<a.length;x++){k.uniformMatrix4fv(r,!1,a[x].matrix);for(var w=a[x].cells,B=0;B<w.length;B++)k.uniformMatrix4fv(v,!1,w[B].matrix),0==d?n.drawOpaque(w[B],q):n.drawTransparent(w[B],q)}k.uniformMatrix4fv(h,!1,BC.Math.Matrix.identity);k.uniformMatrix4fv(s,
!1,BC.Math.Matrix.identity);k.uniformMatrix4fv(m,!1,b.stage.matrix);k.uniformMatrix4fv(r,!1,BC.Math.Matrix.identity);k.uniformMatrix4fv(v,!1,BC.Math.Matrix.identity);p.draw(q);k.uniformMatrix4fv(h,!1,BC.Math.Matrix.identity);k.uniformMatrix4fv(s,!1,b.translationMatrix);k.uniformMatrix4fv(m,!1,b.selector.matrix);k.uniformMatrix4fv(r,!1,BC.Math.Matrix.identity);k.uniformMatrix4fv(v,!1,BC.Math.Matrix.identity);t.draw(q)}}};return e}(BC||{});BC=function(e){var c=e.Math=e.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,k){k=k||0;for(var q=2*Math.PI/b,d=[],f=0;f<b;f++)d[2*f]=a*Math.cos(k+f*q),d[2*f+1]=a*Math.sin(k+f*q);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return e}(BC||{});BC=function(e){e.Direction={NONE:"0",UP:"1",DOWN:"2",LEFT:"3",RIGHT:"4"};return e}(BC||{});BC=function(e){var c=e.Stat=e.Stat||{},a;(c.View=c.View||{}).make=function(b){if(!a){var k=BC.Unit;a={};a[k.NONE]=function(a){return a};a[k.SECONDS]=function(a){var b=Math.floor(a/3600);a-=3600*b;var k=Math.floor(a/60);a=Math.floor(a-60*k);10>b&&(b="0"+b);10>k&&(k="0"+k);10>a&&(a="0"+a);return b+":"+k+":"+a}}return{draw:function(k){b.text((0,a[k.unit])(k.value))}}};return e}(BC||{});BC=function(e){(e.Storage=e.Storage||{}).make=function(){var c=localStorage||{};return{get:function(a){return c[a]},set:function(a,b){c[a]=b}}};return e}(BC||{});BC=function(e){var c=e.Menu=e.Menu||{};(c.Stats=c.Stats||{}).make=function(a){function b(){g.fadeOut(k)}var k="slow",c=BC.Stat,d=BC.Unit,f=a.statBoard,g=$("#stats-menu"),e=$("#no-stats-label",g);a=$("#close-button",g);for(var h=[],s=[],m=1;5>=m;m++){var r=$("#stats-entry-"+m,g);h.push(r);var v=function(a){return BC.Stat.View.make($(a,r))};s.push({speedLevel:v("#speed-level-stat"),elapsedTime:v("#elapsed-time-stat"),score:v("#score-stat")})}var n=c.make(),t=c.make({unit:d.SECONDS}),p=c.make();a.click(function(){b()});
return{show:function(){var a=f.getStats();0==a.length?e.show():e.hide();for(var b=0;b<h.length;b++)b<a.length?(n.value=a[b].speedLevel,t.value=a[b].elapsedTime,p.value=a[b].score,s[b].speedLevel.draw(n),s[b].elapsedTime.draw(t),s[b].score.draw(p),h[b].show()):h[b].hide();g.fadeIn(k)},hide:b}};return e}(BC||{});BC=function(e){var c=e.GL=e.GL||{};c.loadShader=function(a,b,k,c){c=c||BC.Log.error;var d=document.getElementById(b);if(!d)return c("** Error getting script element:"+b),null;b=a.createShader(k);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),c("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,k,c){for(var d=a.createProgram(),f=0;f<b.length;f++)a.attachShader(d,b[f]);
if(k)for(f=0;f<k.length;f++)a.bindAttribLocation(d,c?c[f]:f,k[f]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Log.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,k){var c=1/a,d=1/b;return{tile:function(a,b){var e=c*b,h=d*a;return{textureCoord:function(a,b){return[e+k+(c-2*k)*a,h+k+(d-2*k)*b]}}}}};return e}(BC||{});BC=function(e){(e.Selector=e.Selector||{}).make=function(c){function a(a){h=a;0<s.length&&BC.Log.error("startMoving: pending animations: "+s.length);s.push(BC.Animation.make({duration:g,updateCallback:function(a){var c=b.ringHeight*a.deltaPercent;a=r*a.deltaPercent;switch(h){case d.UP:return m[1]+=c,!0;case d.DOWN:return m[1]-=c,!0;case d.LEFT:return k.rotate(a),!0;case d.RIGHT:return k.rotate(-a),!0;default:return!1}},finishCallback:function(){h=d.NONE;e.play(f.SELECTOR_MOVEMENT)}}))}var b=c.metrics,
k=c.board,e=c.audioPlayer,d=BC.Direction,f=BC.Audio.Sound,g=0.025,l={matrix:BC.Math.Matrix.identity,move:function(b){switch(b){case d.LEFT:return h!==d.NONE?b=!1:(a(d.LEFT),b=!0),b;case d.RIGHT:return h!==d.NONE?b=!1:(a(d.RIGHT),b=!0),b;case d.UP:return h!==d.NONE?b=!1:(a(d.UP),b=!0),b;case d.DOWN:return h!==d.NONE?b=!1:(a(d.DOWN),b=!0),b;default:return BC.Log.error("move: unsupported direction: "+b),!1}},update:function(a){BC.Animation.process(s,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Math.Matrix.makeScale(a,
a,1);var b=BC.Math.Matrix.makeTranslation(m[0],m[1],m[2]);l.matrix=BC.Math.Matrix.matrixMultiply(a,b)}},h=d.NONE,s=[],m=[0,0,0],r=BC.Math.sliceRadians(b.numCells);return l};return e}(BC||{});BC=function(e){var c=e.Time=e.Time||{};(c.Stopwatch=c.Stopwatch||{}).make=function(a){function b(){c.then=0.001*k.now()}var k=a.clock,c={reset:b,tick:function(){c.now=0.001*k.now();c.deltaTime=c.now-c.then;c.then=c.now}};b();return c};return e}(BC||{});BC=function(e){(e.Resources=e.Resources||{}).make=function(){var c=BC.GL.textureTileSet(8,8,0.002),a=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(0,4),c.tile(0,5),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(2,4),c.tile(2,5),c.tile(1,0),c.tile(1,1),c.tile(1,2),c.tile(1,3),c.tile(1,4),c.tile(1,5)],b=c.tile(4,0),c=c.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:c}};return e}(BC||{});BC=function(e){var c=e.Menu=e.Menu||{};(c.Main=c.Main||{}).make=function(a){function b(a){return a.isGameOver()?f:a.isStarted()&&a.isPaused()?d:e}var c=BC.Audio.Sound,e="b l o c k c i l l i n",d="P A U S E D",f="G A M E  O V E R",g=$("#main-menu"),l=$("#main-menu-title",g),h=$("#main-menu-stats",g),s=$("#continue-button",g),m=$("#new-game-button",g),r=$("#stats-button",g),v=$("#options-button",g),n=$("#credits-button",g),t=BC.Stat.View.make($("#speed-level-stat",g)),p=BC.Stat.View.make($("#elapsed-time-stat",
g)),u=BC.Stat.View.make($("#score-stat",g)),z=a.audioPlayer;a=$(".button");a.click(function(a){z.play(c.BUTTON_CLICK);$(a.target).fadeIn(20).fadeOut(20).fadeIn(20).fadeOut(20).fadeIn(20)});a.mouseenter(function(){z.play(c.BUTTON_HOVER)});var x=function(){},w=function(){},B=function(){},D=function(){},y=function(){};s.click(function(){x()});m.click(function(){w()});r.click(function(){B()});v.click(function(){D()});n.click(function(){y()});return{setContinueListener:function(a){x=a},setNewGameListener:function(a){w=
a},setStatsListener:function(a){B=a},setOptionsListener:function(a){D=a},setCreditsListener:function(a){y=a},show:function(a){l.text(b(a));var d=a.isStarted()||a.isGameOver();d&&(t.draw(a.getSpeedLevel()),u.draw(a.getScore()),p.draw(a.getElapsedTime()));d?h.show():h.hide();a.isStarted()?s.show():s.hide();g.fadeIn("slow")},hide:function(){g.fadeOut("slow")}}};return e}(BC||{});BC=function(e){var c=e.Time=e.Time||{};(c.Clock=c.Clock||{}).make=function(){return{now:function(){return Date.now()}}};return e}(BC||{});BC=function(e){(e.Game=e.Game||{}).make=function(c){function a(a){return m.getUniformLocation(G,a)}function b(){return canvas.width!=canvas.clientWidth||canvas.height!=canvas.clientHeight?(canvas.width=canvas.clientWidth,canvas.height=canvas.clientHeight,!0):!1}function k(){var a=canvas.width/canvas.height,b=BC.Math.radians(90);return BC.Math.Matrix.makePerspective(b,a,1,2E3)}function e(){x=!1;C();y.reset();d()}function d(){m.clear(m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT);m.viewport(0,0,m.canvas.width,
m.canvas.height);m.uniformMatrix4fv(I.projectionMatrixLocation,!1,L);var a=!x&&!w&&A;if(a){y.tick();var b=w;w=A.update(y);b!==w&&v.addStats({speedLevel:A.speedLevel.value,elapsedTime:A.elapsedTime.value,score:A.score.value})}E&&E.draw();a&&requestAnimationFrame(d);w&&(x=z=!1,J())}var f=BC.Time.Clock,g=BC.Direction,l=BC.GL,h=BC.Math.Matrix,s=BC.Time.Stopwatch,m=c.gl,r=c.controller,v=c.statBoard,n=c.audioPlayer,t=c.gmSpeedLevelView,p=c.gmElapsedTimeView,u=c.gmScoreView,z=!1,x=!1,w=!1,B={numRings:3,
numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},D=BC.Resources.make();c=f.make();var y=s.make({clock:c}),A,E,C=function(){},F=function(){},J=function(){},K=m.createTexture();m.bindTexture(m.TEXTURE_2D,K);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,1,1,0,m.RGBA,m.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var H=new Image;H.src="images/textures.png";$(H).load(function(){m.bindTexture(m.TEXTURE_2D,K);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,H);m.texParameteri(m.TEXTURE_2D,
m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR_MIPMAP_NEAREST);m.generateMipmap(m.TEXTURE_2D)});m.enable(m.CULL_FACE);m.enable(m.DEPTH_TEST);m.enable(m.BLEND);m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA);s=l.loadShader(m,"vertex-shader",m.VERTEX_SHADER);c=l.loadShader(m,"fragment-shader",m.FRAGMENT_SHADER);var G=l.createProgram(m,[s,c]);m.useProgram(G);var I={positionLocation:m.getAttribLocation(G,"a_position"),textureCoordLocation:m.getAttribLocation(G,
"a_textureCoord"),projectionMatrixLocation:a("u_projectionMatrix"),viewMatrixLocation:a("u_viewMatrix"),boardRotationMatrixLocation:a("u_boardRotationMatrix"),boardTranslationMatrixLocation:a("u_boardTranslationMatrix"),selectorMatrixLocation:a("u_selectorMatrix"),ringMatrixLocation:a("u_ringMatrix"),cellMatrixLocation:a("u_cellMatrix"),yellowBoostLocation:a("u_yellowBoost"),alphaLocation:a("u_alpha")};b();var L=k();$(window).resize(function(){b()&&(L=k(),d())});l=function(){var a=h.makeLookAt([0,
0.1,3],[0,0,0],[0,1,0]);return h.makeInverse(a)}();m.uniformMatrix4fv(I.viewMatrixLocation,!1,l);return{resume:e,start:function(){z=!0;w=!1;A=BC.Board.make({metrics:B,audioPlayer:n});E=BC.Board.View.make({board:A,gl:m,programLocations:I,resources:D,speedLevelStatView:t,elapsedTimeStatView:p,scoreStatView:u});r.setMoveLeftListener(function(){A.move(g.LEFT)});r.setMoveRightListener(function(){A.move(g.RIGHT)});r.setMoveUpListener(function(){A.move(g.UP)});r.setMoveDownListener(function(){A.move(g.DOWN)});
r.setPrimaryActionListener(function(){A.swap()});e()},pause:function(){x=!0;F()},isPaused:function(){return x},isGameOver:function(){return w},isStarted:function(){return z},setResumeListener:function(a){C=a},setPauseListener:function(a){F=a},setGameOverListener:function(a){J=a},getSpeedLevel:function(){return A.speedLevel},getElapsedTime:function(){return A.elapsedTime},getScore:function(){return A.score}}};return e}(BC||{});BC=function(e){(e.Stage=e.Stage||{}).make=function(c,a){a+=c.ringHeight/2-0.01;return{matrix:BC.Math.Matrix.makeTranslation(0,a,0)}};return e}(BC||{});BC=function(e){var c=e.Selector=e.Selector||{};(c.View=c.View||{}).make=function(a,b,c){var e=-b.ringHeight/2,d=-e;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var f=b.length-2,g=[],l=0;g[l++]=b[f]+0.001;g[l++]=e;g[l++]=-b[f+1]-0.001;g[l++]=b[0]+0.001;g[l++]=e;g[l++]=-b[1]-0.001;g[l++]=b[0]+0.001;g[l++]=d;g[l++]=-b[1]-0.001;g[l++]=b[f]+0.001;g[l++]=d;g[l++]=-b[f+1]-0.001;g[l++]=b[0]+0.001;g[l++]=e;g[l++]=-b[1]-0.001;g[l++]=b[2]+0.001;g[l++]=e;g[l++]=-b[3]-0.001;g[l++]=b[2]+
0.001;g[l++]=d;g[l++]=-b[3]-0.001;g[l++]=b[0]+0.001;g[l++]=d;g[l++]=-b[1]-0.001;var h=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,h);a.bufferData(a.ARRAY_BUFFER,new Float32Array(g),a.STATIC_DRAW);e=c.textureCoord(0,0);d=c.textureCoord(1,0);b=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(e,d,b,c,e,d,b,c));var s=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,s);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var m=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),r=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
r);a.bufferData(a.ELEMENT_ARRAY_BUFFER,m,a.STATIC_DRAW);return{draw:function(b){var d=b.positionLocation,c=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,h);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,s);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.drawElements(a.TRIANGLES,m.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.Audio=e.Audio||{};(c.Player=c.Player||{}).make=function(){function a(a){var d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";d.onload=function(){b.decodeAudioData(d.response,function(a){c=a},function(){BC.Log.error("error decoding data for "+a)})};d.send()}var b,c;window.AudioContext=window.AudioContext||window.webkitAudioContext;window.AudioContext&&(b=new AudioContext,a("audio/sounds.ogg"));return{play:function(a){if(c){var d=c,e=a.offset;a=a.duration;
var g=b.createBufferSource();g.buffer=d;g.connect(b.destination);g.start(0,e,a)}}}};return e}(BC||{});BC=function(e){(e.Drop=e.Drop||{}).makeManager=function(c){var a=BC.Cell.CellState,b=BC.Direction,e=[];return{update:function(q){for(var d=0;d<q.rings.length;d++)for(var f=0;f<c.numCells;f++){var g=q,l=d,h=f,s=g.rings[l].cells[h];s.state===a.BLOCK&&(l+=1,l>=g.rings.length||(g=g.rings[l].cells[h],s.state===a.BLOCK&&g.state==a.EMPTY&&(s=s.sendBlock(0.05),g.receiveBlock(0.05,b.UP,s),e.push(g))))}a:{for(;0<e.length;){if(e[0].hasDroppingBlock()){q=!0;break a}e.shift()}q=!1}return q}}};return e}(BC||{});BC=function(e){function c(a,b){return{offset:a,duration:b}}(e.Audio=e.Audio||{}).Sound={BUTTON_HOVER:c(1,0.5),BUTTON_CLICK:c(0,0.75),SELECTOR_MOVEMENT:c(1,0.5),CELL_SWAP:c(2,0.5),CELL_CLEAR:c(3,0.5)};return e}(BC||{});BC=function(e){var c=e.Animation=e.Animation||{};c.make=function(a){var b=a.duration,c=a.startCallback||function(){},e=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},f=0,g=!1,l=!1;return{update:function(a){g||(g=!0,c());var s=a.deltaTime;f+s>b&&(s=b-f);f+=s;a=e({now:a.now,deltaTime:s,elapsedPercent:f/b,deltaPercent:s/b});f>=b&&(l=!0,d());return a},isDone:function(){return l}}};c.process=function(a,b){var c=!1;if(0<a.length){var e=a[0],c=c|e.update(b);e.isDone()&&a.shift()}return c};
return e}(BC||{});BC=function(e){(e.Main=e.Main||{}).run=function(){function c(a){a?(f.show(m),g.hide()):(f.hide(),g.show())}var a=document.getElementById("canvas");if(a){var b=a.getContext("webgl")||a.getContext("experimental-webgl");if(b){var e=BC.Storage.make(),a=BC.Controller.make({canvas:a,storage:e}),q=BC.StatBoard.make({storage:e}),d=BC.Audio.Player.make(),f=BC.Menu.Main.make({audioPlayer:d}),g=BC.Menu.Game.make(),l=BC.Menu.Stats.make({statBoard:q}),h=BC.Menu.Options.make({controller:a}),s=BC.Menu.Credits.make(),
m=BC.Game.make({gl:b,storage:e,controller:a,statBoard:q,audioPlayer:d,gmSpeedLevelView:g.getSpeedLevelView(),gmElapsedTimeView:g.getElapsedTimeView(),gmScoreView:g.getScoreView()});f.setContinueListener(function(){m.resume()});f.setNewGameListener(function(){m.start()});f.setStatsListener(function(){l.show()});f.setOptionsListener(function(){h.show()});f.setCreditsListener(function(){s.show()});g.setPauseListener(function(){m.pause()});m.setResumeListener(function(){c(!1)});m.setPauseListener(function(){c(!0)});
m.setGameOverListener(function(){c(!0)});a.setMenuActionListener(function(){m.isPaused()?m.resume():m.pause()});document.addEventListener("visibilitychange",function(){document.hidden&&m.pause()});c(!0)}}};return e}(BC||{});$(document).ready(function(){BC.Main.run()});BC=function(e){var c=e.Stage=e.Stage||{};(c.View=c.View||{}).make=function(a,b,c){b=[];var e=0;b[e++]=-1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=-1;b[e++]=0;b[e++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var e=c.textureCoord(1,0),f=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,e,f,c,b,e,f,c));var g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var l=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),h=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h);a.bufferData(a.ELEMENT_ARRAY_BUFFER,l,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation,f=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,g);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h);a.drawElements(a.TRIANGLES,l.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){(e.StatBoard=e.StatBoard||{}).make=function(c){function a(){var a=q.get(e);return a?JSON.parse(a):[]}function b(a,b){var c=b.score-a.score;if(0!==c)return c;c=b.elapsedTime-a.elapsedTime;return 0!==c?c:b.speedLevel-a.speedLevel}var e="bc.stats",q=c.storage;return{getStats:a,addStats:function(d){var c=a();c.push(d);c.sort(b);c.slice(0,5);q.set(e,JSON.stringify(c))}}};return e}(BC||{});BC=function(e){var c=e.Log=e.Log||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return e}(BC||{});BC=function(e){(e.Stat=e.Stat||{}).make=function(c){c=c||{};return{value:c.value||0,unit:c.unit||BC.Unit.NONE}};return e}(BC||{});BC=function(e){var c=e.Menu=e.Menu||{};(c.Options=c.Options||{}).make=function(a){function b(a,b,d){var c=$(a,b);s[d]=c;c.click(function(){c.text(g);h.startKeyCodeAssignment(d)});return c}function c(a,b){var d=h.getKeyCode(b);a.text(f[d]||"#"+d)}function e(){h.cancelKeyCodeAssignment();m.fadeOut(l)}var d=BC.Controller.Key,f={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",
39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",
109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},g="PRESS KEY",l="slow",h=a.controller,s={},m=$("#options-menu"),r=b("#up-button",m,d.UP),v=b("#down-button",m,d.DOWN),n=b("#left-button",m,d.LEFT),t=b("#right-button",m,d.RIGHT),p=b("#swap-button",
m,d.PRIMARY_ACTION),u=b("#menu-button",m,d.MENU_ACTION);$("#close-button",m).click(function(){e()});h.setKeyCodeAssignmentListener(function(a,b){s[a].text(f[b]||"#"+b)});return{show:function(){c(r,d.UP);c(v,d.DOWN);c(n,d.LEFT);c(t,d.RIGHT);c(p,d.PRIMARY_ACTION);c(u,d.MENU_ACTION);m.fadeIn(l)},hide:e}};return e}(BC||{});BC=function(e){(e.Board=e.Board||{}).make=function(c){function a(a){a=BC.Ring.make({metrics:n,translationY:-n.ringHeight*A,selectable:a,audioPlayer:t});y.push(a);A++}function b(){C.translationMatrix=l.makeTranslation(B[0],B[1],B[2])}function e(){var a=l.makeXRotation(D[0]),b=l.makeYRotation(D[1]),d=l.makeZRotation(D[2]),b=l.matrixMultiply(d,b),b=l.matrixMultiply(b,a);C.rotationMatrix=b}var q=BC.Cell.CellState,d=BC.Chain,f=BC.Direction,g=BC.Drop,l=BC.Math.Matrix,h=BC.Selector,s=BC.Audio.Sound,m=BC.Stage,
r=BC.Stat,v=BC.Unit,n=c.metrics,t=c.audioPlayer,p=11*n.ringHeight,u=2*n.ringHeight,z=0,x=n.numCells-1;c=5.5*-n.ringHeight-n.ringHeight/2;for(var w=n.ringHeight*n.numRings,B=[0,c+w,0],D=[0,0,0],y=[],A=0,E=0;E<n.numRings;E++)a(!0);for(E=0;2>E;E++)a(!1);var C={metrics:n,rings:y,rotationMatrix:l.identity,translationMatrix:l.identity,move:function(a){switch(a){case f.LEFT:F.move(f.LEFT)&&(x--,0>x&&(x=n.numCells-1));break;case f.RIGHT:F.move(f.RIGHT)&&(x++,x>=n.numCells&&(x=0));break;case f.UP:0<z&&F.move(f.UP)&&
z--;break;case f.DOWN:z+1<C.rings.length&&y[z+1].isSelectable()&&F.move(f.DOWN)&&z++}},rotate:function(a){D[1]+=a},swap:function(){var a=y[z].cells[x%n.numCells],b=y[z].cells[(x+1)%n.numCells];BC.Log.log("swap: ("+a.state+", "+b.state+")");var d=a.blockStyle,c=b.blockStyle;a.state!==q.EMPTY&&a.state!==q.EMPTY_NO_DROP||b.state!==q.BLOCK?a.state!==q.BLOCK||b.state!==q.EMPTY&&b.state!==q.EMPTY_NO_DROP?a.state===q.BLOCK&&b.state===q.BLOCK&&(a.receiveBlock(0.1,f.RIGHT,c),b.receiveBlock(0.1,f.LEFT,d),t.play(s.CELL_SWAP)):
(a.sendBlock(0.1,f.RIGHT),b.receiveBlock(0.1,f.LEFT,d),t.play(s.CELL_SWAP)):(b.sendBlock(0.1,f.LEFT),a.receiveBlock(0.1,f.RIGHT,c),t.play(s.CELL_SWAP))},update:function(d){for(var c=0;c<y.length;c++)for(var g=0;g<n.numCells;g++)y[c].cells[g%n.numCells].update(d);for(var c=0|K.update(C),g=J.update(C),h=0;h<g.newChains.length;h++)I.value+=100*g.newChains[h].length;c|=0<g.pendingChainCount;c||(c=(0.02+0.01*(H.value-1))*d.deltaTime,w+c>p&&(c=p-w),w+=c,B[1]+=c);G.value+=d.deltaTime;H.value=1+Math.floor(G.value/
30);F.update(d);b();for(e();0<y.length&&y[0].isEmpty();)y.shift(),w-=n.ringHeight,z--;for(d=w-n.ringHeight*y.length;d>-u;)a(!1),d-=n.ringHeight;for(d=y.length-1;0<=d&&!y[d].isSelectable();d--)0<=w-n.ringHeight*(d+1)&&y[d].setSelectable(!0);return w>=p}};b();e();var F=h.make({metrics:n,board:C,audioPlayer:t});C.selector=F;h=m.make(n,c);C.stage=h;var J=d.makeManager(),K=g.makeManager(n),H=r.make({value:1,unit:v.NONE});C.speedLevel=H;var G=r.make({value:0,unit:v.SECONDS});C.elapsedTime=G;var I=r.make({value:0,
unit:v.NONE});C.score=I;return C};return e}(BC||{});BC=function(e){var c=e.Controller=e.Controller||{};c.Key={UP:"0",DOWN:"1",LEFT:"2",RIGHT:"3",PRIMARY_ACTION:"4",MENU_ACTION:"5"};c.make=function(a){function b(a,b){var c=parseInt(f.get(a),10)||b;return{storageKey:a,keyCode:c}}function c(a){return u[a].keyCode}function e(a,b){u[a].keyCode=b;f.set(u[a].storageKey,b);v(a,b)}var d=BC.Controller.Key,f=a.storage;a=a.canvas;var g=function(){},l=function(){},h=function(){},s=function(){},m=function(){},r=function(){},v=function(){},n=0,t=0,p,u={};u[d.UP]=
b("bc.controller.up",38);u[d.DOWN]=b("bc.controller.down",40);u[d.LEFT]=b("bc.controller.left",37);u[d.RIGHT]=b("bc.controller.right",39);u[d.PRIMARY_ACTION]=b("bc.controller.primaryAction",32);u[d.MENU_ACTION]=b("bc.controller.menuAction",27);$(document).keydown(function(a){if(null!=p){a=a.keyCode;var b=c(p),f;a:{var n=p;for(f in u)if(u.hasOwnProperty(f)&&f!==n&&u[f].keyCode===a)break a;f=null}f&&e(f,b);e(p,a);p=null;return!1}switch(a.keyCode){case c(d.LEFT):g.call();break;case c(d.RIGHT):l.call();
break;case c(d.UP):h.call();break;case c(d.DOWN):s.call();break;case c(d.PRIMARY_ACTION):m.call();break;case c(d.MENU_ACTION):r.call();break;default:console.log(a.keyCode)}return!1});$(a).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":n=b.pageX;t=b.pageY;break;case "touchend":var c=b.pageX-n,d=b.pageY-t,e=Math.abs(c),f=Math.abs(d);a=function(){return 20<f?(0<d?s.call():h.call(),!0):!1};b=function(){return 20<e?(0<c?g.call():
l.call(),!0):!1};if(e>f){if(b()||a())break}else if(a()||b())break;m.call()}return!1});return{setMoveLeftListener:function(a){g=a},setMoveRightListener:function(a){l=a},setMoveUpListener:function(a){h=a},setMoveDownListener:function(a){s=a},setPrimaryActionListener:function(a){m=a},setMenuActionListener:function(a){r=a},setKeyCodeAssignmentListener:function(a){v=a},startKeyCodeAssignment:function(a){p=a},cancelKeyCodeAssignment:function(){p=null},getKeyCode:c}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function e(b,c){var d=c.positionLocation,f=c.textureCoordLocation,g=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,s);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,m[b.blockStyle]);a.enableVertexAttribArray(f);a.vertexAttribPointer(f,2,a.FLOAT,!1,0,0);a.uniform1f(g,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.drawElements(a.TRIANGLES,
v,a.UNSIGNED_SHORT,0)}var d=b.numCells,f=b.ringOuterRadius,g=b.ringHeight/2,l=-g,h=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,h);f=BC.Math.circlePoints(f,d,h);d=0;h=[];h[d++]=b[0];h[d++]=g;h[d++]=-b[1];h[d++]=f[0];h[d++]=g;h[d++]=-f[1];h[d++]=f[2];h[d++]=g;h[d++]=-f[3];h[d++]=b[2];h[d++]=g;h[d++]=-b[3];h[d++]=f[0];h[d++]=l;h[d++]=-f[1];h[d++]=b[0];h[d++]=l;h[d++]=-b[1];h[d++]=b[2];h[d++]=l;h[d++]=-b[3];h[d++]=f[2];h[d++]=l;h[d++]=-f[3];h[d++]=b[0];h[d++]=g;h[d++]=-b[1];h[d++]=b[0];h[d++]=
l;h[d++]=-b[1];h[d++]=f[0];h[d++]=l;h[d++]=-f[1];h[d++]=f[0];h[d++]=g;h[d++]=-f[1];h[d++]=f[2];h[d++]=g;h[d++]=-f[3];h[d++]=f[2];h[d++]=l;h[d++]=-f[3];h[d++]=b[2];h[d++]=l;h[d++]=-b[3];h[d++]=b[2];h[d++]=g;h[d++]=-b[3];h[d++]=f[0];h[d++]=g;h[d++]=-f[1];h[d++]=f[0];h[d++]=l;h[d++]=-f[1];h[d++]=f[2];h[d++]=l;h[d++]=-f[3];h[d++]=f[2];h[d++]=g;h[d++]=-f[3];h[d++]=b[2];h[d++]=g;h[d++]=-b[3];h[d++]=b[2];h[d++]=l;h[d++]=-b[3];h[d++]=b[0];h[d++]=l;h[d++]=-b[1];h[d++]=b[0];h[d++]=g;h[d++]=-b[1];var s=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,s);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);g=[];for(d=0;d<c.length;d++)for(l=c[d],g[d]=[],f=b=0;6>b;b++)h=l.textureCoord(0,0),g[d][f++]=h[0],g[d][f++]=h[1],h=l.textureCoord(0,1),g[d][f++]=h[0],g[d][f++]=h[1],h=l.textureCoord(1,1),g[d][f++]=h[0],g[d][f++]=h[1],h=l.textureCoord(1,0),g[d][f++]=h[0],g[d][f++]=h[1];for(var m=[],d=0;d<c.length;d++)m[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,m[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(g[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var r=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var v=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,c),a.enable(a.CULL_FACE))}}};return e}(BC||{});BC=function(e){var c=e.Chain=e.Chain||{};c.find=function(a){function b(b,c){return a.rings[b].cells[c]}function c(){for(var d=a.rings.length,e=[],f=0;f<d;f++){var k;k=f;for(var n=0,q=b(k,n),p=0;p<l;p++){var u=b(k,n);if(q.state!==u.state||q.blockStyle!=u.blockStyle)break;n+=1;n=n===l?0:n}k=n;for(n=0;n<l;)if(p=(n+k)%l,u=b(f,p),u.state!==g.BLOCK)n++;else{for(var z=1,q=n+1;q<l;q++)if(p=(q+k)%l,p=b(f,p),u.state===p.state&&u.blockStyle==p.blockStyle)z++;else break;if(z>=h){for(u=[];n<q;n++)p=(n+k)%l,z=
b(f,p),u.push({cell:z,row:f,col:p});e.push(u)}n=q}}return e}function e(){for(var c=a.rings.length,d=[],f=0;f<l;f++)for(var k=0;k<c;){var n=b(k,f);if(n.state!==g.BLOCK)k++;else{for(var q=1,p=k+1;p<c;p++){var u=b(p,f);if(n.state===u.state&&n.blockStyle==u.blockStyle)q++;else break}if(q>=h){for(n=[];k<p;k++)q=b(k,f),n.push({cell:q,row:k,col:f});d.push(n)}k=p}}return d}function d(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],e=0;e<b.length;e++){var f=b[e];if(d.blockStyle===f.blockStyle&&d.row===f.row&&
d.col===f.col)return!0}return!1}function f(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.blockStyle===b.blockStyle&&d.row===b.row&&d.col===b.col)return!0}return!1}var g=BC.Cell.CellState,l=a.rings[0].cells.length,h=3;return function(){for(var a=[],b=c(),g=e();0<b.length;){var h=b.shift();for(a.push(h);;){for(var n=!1,l=0;l<g.length;l++)if(d(h,g[l])){for(n=0;n<g[l].length;n++)f(h,g[l][n])||h.push(g[l][n]);g.splice(l,1);n=!0}if(!n)break;n=!1;for(l=0;l<b.length;l++)if(d(h,b[l])){for(n=0;n<b[l].length;n++)f(h,
b[l][n])||h.push(b[l][n]);b.splice(l,1);n=!0}if(!n)break}}for(;0<g.length;)h=g.shift(),a.push(h);for(l=0;l<a.length;l++)a[l].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],c=[];return{update:function(e){e=BC.Chain.find(e);for(var d=0;d<e.length;d++){var f=e[d];c.push(f);for(var g=0;g<f.length;g++){var l=f[g].cell;l.markBlock();b.push(l)}}if(0<b.length)switch(l=b[0],l.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:l.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<c.length){f=c[0];g=!0;for(d=0;d<f.length;d++)l=f[d].cell,g&=!l.isClearing();if(g){for(d=0;d<f.length;d++)l=f[d].cell,l.state===a.EMPTY_NO_DROP&&(l.state=a.EMPTY);c.shift()}}return{newChains:e,pendingChainCount:c.length}}}};return e}(BC||{});BC=function(e){var c=e.Menu=e.Menu||{};(c.Credits=c.Credits||{}).make=function(){function a(){e||(e=$("#credits-menu"),$("#close-button",e).click(function(){b()}))}function b(){e.fadeOut(c)}var c="slow",e;return{show:function(){a();e.fadeIn(c)},hide:b}};return e}(BC||{});
