var BC=function(f){var d=f.Matrix=f.Matrix||{};d.makeLookAt=function(a,b,d){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));d=BC.Math.cross(d,b);var c=BC.Math.cross(b,d);return[d[0],d[1],d[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};d.makePerspective=function(a,b,d,c){a=Math.tan(0.5*Math.PI-0.5*a);var h=1/(d-c);return[a/b,0,0,0,0,a,0,0,0,0,(d+c)*h,-1,0,0,d*c*h*2,0]};d.makeTranslation=function(a,b,d){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,d,1]};d.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};d.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};d.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};d.makeScale=function(a,b,d){return[a,0,0,0,0,b,0,0,0,0,d,0,0,0,0,1]};d.makeInverse=function(a){var b=a[0],d=a[1],c=a[2],h=a[3],g=a[4],e=a[5],f=a[6],l=a[7],k=a[8],n=a[9],s=a[10],p=a[11],q=a[12],r=a[13],v=a[14];a=a[15];var u=s*a,w=v*p,x=f*a,y=
v*l,z=f*p,A=s*l,B=c*a,C=v*h,D=c*p,E=s*h,F=c*l,G=f*h,H=k*r,I=q*n,J=g*r,K=q*e,L=g*n,M=k*e,N=b*r,O=q*d,P=b*n,Q=k*d,R=b*e,S=g*d,T=u*e+y*n+z*r-(w*e+x*n+A*r),U=w*d+B*n+E*r-(u*d+C*n+D*r),r=x*d+C*e+F*r-(y*d+B*e+G*r),d=A*d+D*e+G*n-(z*d+E*e+F*n),e=1/(b*T+g*U+k*r+q*d);return[e*T,e*U,e*r,e*d,e*(w*g+x*k+A*q-(u*g+y*k+z*q)),e*(u*b+C*k+D*q-(w*b+B*k+E*q)),e*(y*b+B*g+G*q-(x*b+C*g+F*q)),e*(z*b+E*g+F*k-(A*b+D*g+G*k)),e*(H*l+K*p+L*a-(I*l+J*p+M*a)),e*(I*h+N*p+Q*a-(H*h+O*p+P*a)),e*(J*h+O*l+R*a-(K*h+N*l+S*a)),e*(M*h+P*l+
S*p-(L*h+Q*l+R*p)),e*(J*s+M*v+I*f-(L*v+H*f+K*s)),e*(P*v+H*c+O*s-(N*s+Q*v+I*c)),e*(N*f+S*v+K*c-(R*v+J*c+O*f)),e*(R*s+L*c+Q*f-(P*f+S*s+M*c))]};d.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*
b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return f}(BC||{});BC=function(f){(f.Time=f.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return f}(BC||{});BC=function(f){var d=f.GL=f.GL||{};d.loadShader=function(a,b,d,c){c=c||BC.Util.error;var h=document.getElementById(b);if(!h)return c("** Error getting script element:"+b),null;b=a.createShader(d);a.shaderSource(b,h.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),c("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};d.createProgram=function(a,b,d,c){for(var h=a.createProgram(),g=0;g<b.length;g++)a.attachShader(h,b[g]);
if(d)for(g=0;g<d.length;g++)a.bindAttribLocation(h,c?c[g]:g,d[g]);a.linkProgram(h);return a.getProgramParameter(h,a.LINK_STATUS)?h:(lastError=a.getProgramInfoLog(h),error("Error in program linking: "+lastError),a.deleteProgram(h),null)};d.textureTileSet=function(a,b,d){var c=1/a,h=1/b;return{tile:function(a,b){var f=c*b,l=h*a;return{textureCoord:function(a,b){return[f+d+(c-2*d)*a,l+d+(h-2*d)*b]}}}}};return f}(BC||{});BC=function(f){(f.Selector=f.Selector||{}).make=function(d,a,b){var m=a.ringMinY,c=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var h=a.length-2,g=[],e=0;g[e++]=a[h]+0.001;g[e++]=m;g[e++]=-a[h+1]-0.001;g[e++]=a[0]+0.001;g[e++]=m;g[e++]=-a[1]-0.001;g[e++]=a[0]+0.001;g[e++]=c;g[e++]=-a[1]-0.001;g[e++]=a[h]+0.001;g[e++]=c;g[e++]=-a[h+1]-0.001;g[e++]=a[0]+0.001;g[e++]=m;g[e++]=-a[1]-0.001;g[e++]=a[2]+0.001;g[e++]=m;g[e++]=-a[3]-0.001;g[e++]=a[2]+0.001;g[e++]=c;g[e++]=
-a[3]-0.001;g[e++]=a[0]+0.001;g[e++]=c;g[e++]=-a[1]-0.001;var f=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f);d.bufferData(d.ARRAY_BUFFER,new Float32Array(g),d.STATIC_DRAW);m=b.textureCoord(0,0);c=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(m,c,a,b,m,c,a,b));var l=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,l);d.bufferData(d.ARRAY_BUFFER,b,d.STATIC_DRAW);var k=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),n=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,
n);d.bufferData(d.ELEMENT_ARRAY_BUFFER,k,d.STATIC_DRAW);return{draw:function(a,b){d.enable(d.BLEND);d.bindBuffer(d.ARRAY_BUFFER,f);d.enableVertexAttribArray(a);d.vertexAttribPointer(a,3,d.FLOAT,!1,0,0);d.bindBuffer(d.ARRAY_BUFFER,l);d.enableVertexAttribArray(b);d.vertexAttribPointer(b,2,d.FLOAT,!1,0,0);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,n);d.drawElements(d.TRIANGLES,k.length,d.UNSIGNED_SHORT,0);d.disable(d.BLEND)}}};return f}(BC||{});BC=function(f){(f.Game=f.Game||{}).run=function(){function d(){return m.width!=m.clientWidth||m.height!=m.clientHeight?(m.width=m.clientWidth,m.height=m.clientHeight,!0):!1}function a(){var a=m.width/m.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);c.viewport(0,0,c.canvas.width,c.canvas.height);var a=BC.Time.getTimeInSeconds(),e=a-y;y=a;c.uniformMatrix4fv(f,!1,q);c.uniformMatrix4fv(l,!1,n);r.update(e);v.draw();requestAnimationFrame(b)}
var m=document.getElementById("canvas");if(m){var c=m.getContext("webgl")||m.getContext("experimental-webgl");if(c){c.enable(c.CULL_FACE);c.enable(c.DEPTH_TEST);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var h=BC.GL.loadShader(c,"vertex-shader",c.VERTEX_SHADER),g=BC.GL.loadShader(c,"fragment-shader",c.FRAGMENT_SHADER),e=BC.GL.createProgram(c,[h,g]);c.useProgram(e);var h=c.getAttribLocation(e,"a_position"),g=c.getAttribLocation(e,"a_texcoord"),f=c.getUniformLocation(e,"u_projectionMatrix"),l=c.getUniformLocation(e,
"u_viewMatrix"),e=c.getUniformLocation(e,"u_matrix"),k=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]),n=BC.Matrix.makeInverse(k),s=c.createTexture();c.bindTexture(c.TEXTURE_2D,s);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var p=new Image;p.src="images/textures.png";$(p).load(function(){c.bindTexture(c.TEXTURE_2D,s);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,p);c.generateMipmap(c.TEXTURE_2D)});d();var q=a();$(window).resize(function(){d()&&
(q=a())});var r=BC.Board.makeModel({numRingCells:24,numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),v=BC.Board.makeView(r,c,h,e,g),u=BC.Common.Direction,w=0,x=0;$(m).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":w=b.pageX;x=b.pageY;break;case "touchend":a=b.pageX-w;var b=b.pageY-x,c=u.NONE;50<a?c=u.LEFT:-50>a?c=u.RIGHT:50<b?c=u.DOWN:-50>b&&(c=u.UP);r.move(c)}return!1});$(document).keydown(function(a){switch(a.keyCode){case 32:r.swap();
break;case 37:r.move(u.LEFT);break;case 39:r.move(u.RIGHT);break;case 38:r.move(u.UP);break;case 40:r.move(u.DOWN)}return!1});var y=BC.Time.getTimeInSeconds();b()}}};return f}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(f){var d=f.Math=f.Math||{};d.radians=function(a){return a*Math.PI/180};d.randomInt=function(a){return Math.floor(Math.random()*a)};d.circlePoints=function(a,b,d){d=d||0;for(var c=2*Math.PI/b,h=[],g=0;g<b;g++)h[2*g]=a*Math.cos(d+g*c),h[2*g+1]=a*Math.sin(d+g*c);return h};d.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};d.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};d.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return f}(BC||{});BC=function(f){(f.Cell=f.Cell||{}).make=function(d,a,b){var f=a.numRingCells,c=a.outerRingRadius,h=a.ringMaxY,g=a.ringMinY,e=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,f,e);for(var f=BC.Math.circlePoints(c,f,e),c=[],t=[],e=0;e<b.length;e++)t[e]=[];var l=function(a,c,e,d,f,g,h){for(var k=0;k<b.length;k++){var l=b[k],m=l.textureCoord(c,e);t[k][a]=m[0];t[k][a+1]=m[1];m=l.textureCoord(d,f);t[k][a+2]=m[0];t[k][a+3]=m[1];m=l.textureCoord(g,h);t[k][a+4]=m[0];t[k][a+5]=m[1]}return a+6},e=0,k;c[e++]=
a[0];c[e++]=h;c[e++]=-a[1];c[e++]=f[0];c[e++]=h;c[e++]=-f[1];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];k=l(0,0,0,0,1,1,1);c[e++]=a[0];c[e++]=h;c[e++]=-a[1];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];c[e++]=a[2];c[e++]=h;c[e++]=-a[3];k=l(k,0,0,1,1,1,0);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=f[2];c[e++]=g;c[e++]=-f[3];c[e++]=f[0];c[e++]=g;c[e++]=-f[1];k=l(k,0,0,1,1,0,1);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=a[2];c[e++]=g;c[e++]=-a[3];c[e++]=f[2];c[e++]=g;c[e++]=-f[3];k=l(k,0,0,1,0,1,1);c[e++]=f[0];c[e++]=g;c[e++]=
-f[1];c[e++]=f[2];c[e++]=g;c[e++]=-f[3];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];k=l(k,0,1,1,1,1,0);c[e++]=f[0];c[e++]=g;c[e++]=-f[1];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];c[e++]=f[0];c[e++]=h;c[e++]=-f[1];k=l(k,0,1,1,0,0,0);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=a[2];c[e++]=h;c[e++]=-a[3];c[e++]=a[2];c[e++]=g;c[e++]=-a[3];k=l(k,0,1,1,0,1,1);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=a[0];c[e++]=h;c[e++]=-a[1];c[e++]=a[2];c[e++]=h;c[e++]=-a[3];k=l(k,0,1,0,0,1,0);var n=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,
n);d.bufferData(d.ARRAY_BUFFER,new Float32Array(c),d.STATIC_DRAW);for(var s=c.length/3,p=[],e=0;e<b.length;e++)p[e]=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,p[e]),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t[e]),d.STATIC_DRAW);return{draw:function(a,b,c){d.bindBuffer(d.ARRAY_BUFFER,n);d.enableVertexAttribArray(b);d.vertexAttribPointer(b,3,d.FLOAT,!1,0,0);d.bindBuffer(d.ARRAY_BUFFER,p[a.blockStyle]);d.enableVertexAttribArray(c);d.vertexAttribPointer(c,2,d.FLOAT,!1,0,0);d.drawArrays(d.TRIANGLES,
0,s)}}};return f}(BC||{});BC=function(f){(f.Util=f.Util||{}).error=function(d){window.console&&(window.console.error?window.console.error(d):window.console.log&&window.console.log(d))};return f}(BC||{});BC=function(f){(f.Common=f.Common||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).makeView=function(d,a,b,f,c){var h=BC.GL.textureTileSet(4,4,0.002),g=[h.tile(0,0),h.tile(0,1),h.tile(0,2),h.tile(0,3),h.tile(1,0),h.tile(1,1)],h=h.tile(1,2),e=BC.Cell.make(a,d,g),t=BC.Selector.make(a,d,h);return{draw:function(){for(var g=d.boardMatrix,h=d.rings,n=0;n<h.length;n++)for(var s=BC.Matrix.matrixMultiply(g,h[n].matrix),p=h[n].cells,q=0;q<p.length;q++){var r=BC.Matrix.matrixMultiply(s,p[q].matrix);a.uniformMatrix4fv(f,!1,r);e.draw(p[q],b,c)}a.uniformMatrix4fv(f,
!1,d.selectorMatrix);t.draw(b,c)}}};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).makeModel=function(d){function a(a){for(var b=[],c=0;c<d.numRingCells;c++){var e=b,f=c,g=c,h=BC.Math.randomInt(d.numBlockStyles),g=BC.Matrix.makeYRotation(g*k);e[f]={blockStyle:h,matrix:g}}a=BC.Matrix.makeTranslation(0,-a*n,0);return{cells:b,matrix:a}}for(var b=BC.Common.Direction,f=[],c=0,h=0,g=b.NONE,e=0,t=[0,0,0],l=[0,0,0],k=2*Math.PI/d.numRingCells,n=d.ringMaxY-d.ringMinY,s=BC.Matrix.makeScale(1,1,1),p={rings:f,boardMatrix:s,selectorMatrix:s,numRingCells:d.numRingCells,
innerRingRadius:d.innerRingRadius,outerRingRadius:d.outerRingRadius,ringMaxY:d.ringMaxY,ringMinY:d.ringMinY,selectorTranslation:t,rotation:l,move:function(a){switch(a){case b.LEFT:g===b.NONE&&(g=b.LEFT,e=0,h--,0>h&&(h=d.numRingCells-1));break;case b.RIGHT:g===b.NONE&&(g=b.RIGHT,e=0,h++,h>=d.numRingCells&&(h=0));break;case b.UP:g===b.NONE&&0<c&&(g=b.UP,e=0,c--);break;case b.DOWN:g===b.NONE&&c+1<f.length&&(g=b.DOWN,e=0,c++)}},swap:function(){console.log("ring: "+c+" cell: "+h)},update:function(a){if(g!==
b.NONE){0.05<e+a&&(a=0.05-e);var c=a*n/0.05,d=a*k/0.05;switch(g){case b.UP:t[1]+=c;break;case b.DOWN:t[1]-=c;break;case b.LEFT:l[1]+=d;break;case b.RIGHT:l[1]-=d}e+=a;0.05<=e&&(g=b.NONE,e=0)}a=BC.Matrix.makeXRotation(l[0]);c=BC.Matrix.makeYRotation(l[1]);d=BC.Matrix.makeZRotation(l[2]);d=BC.Matrix.matrixMultiply(s,d);d=BC.Matrix.matrixMultiply(d,c);d=BC.Matrix.matrixMultiply(d,a);p.boardMatrix=d;a=BC.Matrix.makeTranslation(t[0],t[1],t[2]);a=BC.Matrix.matrixMultiply(s,a);p.selectorMatrix=a}},q=0;3>
q;q++)f[q]=a(q);return p};return f}(BC||{});
