var BC=function(g){var b=g.Matrix=g.Matrix||{};b.makeLookAt=function(a,c,b){c=BC.Math.normalize(BC.Math.subtractVectors(a,c));b=BC.Math.cross(b,c);var e=BC.Math.cross(c,b);return[b[0],b[1],b[2],0,e[0],e[1],e[2],0,c[0],c[1],c[2],0,a[0],a[1],a[2],1]};b.makePerspective=function(a,c,b,e){a=Math.tan(0.5*Math.PI-0.5*a);var k=1/(b-e);return[a/c,0,0,0,0,a,0,0,0,0,(b+e)*k,-1,0,0,b*e*k*2,0]};b.makeTranslation=function(a,c,b){return[1,0,0,0,0,1,0,0,0,0,1,0,a,c,b,1]};b.makeXRotation=function(a){var c=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,c,a,0,0,-a,c,0,0,0,0,1]};b.makeYRotation=function(a){var c=Math.cos(a);a=Math.sin(a);return[c,0,-a,0,0,1,0,0,a,0,c,0,0,0,0,1]};b.makeZRotation=function(a){var c=Math.cos(a);a=Math.sin(a);return[c,a,0,0,-a,c,0,0,0,0,1,0,0,0,0,1]};b.makeScale=function(a,c,b){return[a,0,0,0,0,c,0,0,0,0,b,0,0,0,0,1]};b.identity=b.makeScale(1,1,1);b.makeInverse=function(a){var c=a[0],b=a[1],e=a[2],k=a[3],d=a[4],f=a[5],h=a[6],l=a[7],g=a[8],m=a[9],p=a[10],q=a[11],s=a[12],t=a[13],u=a[14];a=
a[15];var v=p*a,w=u*q,x=h*a,y=u*l,z=h*q,A=p*l,B=e*a,C=u*k,D=e*q,E=p*k,F=e*l,G=h*k,H=g*t,I=s*m,J=d*t,K=s*f,L=d*m,M=g*f,N=c*t,O=s*b,P=c*m,Q=g*b,R=c*f,S=d*b,T=v*f+y*m+z*t-(w*f+x*m+A*t),U=w*b+B*m+E*t-(v*b+C*m+D*t),t=x*b+C*f+F*t-(y*b+B*f+G*t),b=A*b+D*f+G*m-(z*b+E*f+F*m),f=1/(c*T+d*U+g*t+s*b);return[f*T,f*U,f*t,f*b,f*(w*d+x*g+A*s-(v*d+y*g+z*s)),f*(v*c+C*g+D*s-(w*c+B*g+E*s)),f*(y*c+B*d+G*s-(x*c+C*d+F*s)),f*(z*c+E*d+F*g-(A*c+D*d+G*g)),f*(H*l+K*q+L*a-(I*l+J*q+M*a)),f*(I*k+N*q+Q*a-(H*k+O*q+P*a)),f*(J*k+O*l+
R*a-(K*k+N*l+S*a)),f*(M*k+P*l+S*q-(L*k+Q*l+R*q)),f*(J*p+M*u+I*h-(L*u+H*h+K*p)),f*(P*u+H*e+O*p-(N*p+Q*u+I*e)),f*(N*h+S*u+K*e-(R*u+J*e+O*h)),f*(R*p+L*e+Q*h-(P*h+S*p+M*e))]};b.matrixMultiply=function(a,c){return[a[0]*c[0]+a[1]*c[4]+a[2]*c[8]+a[3]*c[12],a[0]*c[1]+a[1]*c[5]+a[2]*c[9]+a[3]*c[13],a[0]*c[2]+a[1]*c[6]+a[2]*c[10]+a[3]*c[14],a[0]*c[3]+a[1]*c[7]+a[2]*c[11]+a[3]*c[15],a[4]*c[0]+a[5]*c[4]+a[6]*c[8]+a[7]*c[12],a[4]*c[1]+a[5]*c[5]+a[6]*c[9]+a[7]*c[13],a[4]*c[2]+a[5]*c[6]+a[6]*c[10]+a[7]*c[14],a[4]*
c[3]+a[5]*c[7]+a[6]*c[11]+a[7]*c[15],a[8]*c[0]+a[9]*c[4]+a[10]*c[8]+a[11]*c[12],a[8]*c[1]+a[9]*c[5]+a[10]*c[9]+a[11]*c[13],a[8]*c[2]+a[9]*c[6]+a[10]*c[10]+a[11]*c[14],a[8]*c[3]+a[9]*c[7]+a[10]*c[11]+a[11]*c[15],a[12]*c[0]+a[13]*c[4]+a[14]*c[8]+a[15]*c[12],a[12]*c[1]+a[13]*c[5]+a[14]*c[9]+a[15]*c[13],a[12]*c[2]+a[13]*c[6]+a[14]*c[10]+a[15]*c[14],a[12]*c[3]+a[13]*c[7]+a[14]*c[11]+a[15]*c[15]]};return g}(BC||{});BC=function(g){(g.CellView=g.CellView||{}).make=function(b,a,c){function n(a,c){var h=c.positionLocation,d=c.textureCoordLocation,e=c.alphaLocation;b.bindBuffer(b.ARRAY_BUFFER,l);b.enableVertexAttribArray(h);b.vertexAttribPointer(h,3,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,g[a.blockStyle]);b.enableVertexAttribArray(d);b.vertexAttribPointer(d,2,b.FLOAT,!1,0,0);b.uniform1f(e,a.alpha);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,m);b.drawElements(b.TRIANGLES,p,b.UNSIGNED_SHORT,0)}var e=a.numCells,k=a.ringOuterRadius,
d=a.ringHeight/2,f=-d,h=-Math.PI/2;a=BC.Math.circlePoints(a.ringInnerRadius,e,h);k=BC.Math.circlePoints(k,e,h);e=0;h=[];h[e++]=a[0];h[e++]=d;h[e++]=-a[1];h[e++]=k[0];h[e++]=d;h[e++]=-k[1];h[e++]=k[2];h[e++]=d;h[e++]=-k[3];h[e++]=a[2];h[e++]=d;h[e++]=-a[3];h[e++]=a[0];h[e++]=d;h[e++]=-a[1];h[e++]=a[0];h[e++]=f;h[e++]=-a[1];h[e++]=k[0];h[e++]=f;h[e++]=-k[1];h[e++]=k[0];h[e++]=d;h[e++]=-k[1];h[e++]=k[2];h[e++]=d;h[e++]=-k[3];h[e++]=k[2];h[e++]=f;h[e++]=-k[3];h[e++]=a[2];h[e++]=f;h[e++]=-a[3];h[e++]=
a[2];h[e++]=d;h[e++]=-a[3];h[e++]=k[0];h[e++]=d;h[e++]=-k[1];h[e++]=k[0];h[e++]=f;h[e++]=-k[1];h[e++]=k[2];h[e++]=f;h[e++]=-k[3];h[e++]=k[2];h[e++]=d;h[e++]=-k[3];h[e++]=a[2];h[e++]=d;h[e++]=-a[3];h[e++]=a[2];h[e++]=f;h[e++]=-a[3];h[e++]=a[0];h[e++]=f;h[e++]=-a[1];h[e++]=a[0];h[e++]=d;h[e++]=-a[1];var l=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,l);b.bufferData(b.ARRAY_BUFFER,new Float32Array(h),b.STATIC_DRAW);d=[];for(e=0;e<c.length;e++)for(f=c[e],d[e]=[],k=a=0;5>a;a++)h=f.textureCoord(0,0),d[e][k++]=
h[0],d[e][k++]=h[1],h=f.textureCoord(0,1),d[e][k++]=h[0],d[e][k++]=h[1],h=f.textureCoord(1,1),d[e][k++]=h[0],d[e][k++]=h[1],h=f.textureCoord(1,0),d[e][k++]=h[0],d[e][k++]=h[1];for(var g=[],e=0;e<c.length;e++)g[e]=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,g[e]),b.bufferData(b.ARRAY_BUFFER,new Float32Array(d[e]),b.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var m=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,m);b.bufferData(b.ELEMENT_ARRAY_BUFFER,
c,b.STATIC_DRAW);var p=c.length;return{drawOpaque:function(a,c){a.isEmpty()||a.isTransparent()||n(a,c)},drawTransparent:function(a,c){!a.isEmpty()&&a.isTransparent()&&(b.disable(b.CULL_FACE),n(a,c),b.enable(b.CULL_FACE))}}};return g}(BC||{});BC=function(g){(g.BoardView=g.BoardView||{}).make=function(b,a,c){var n=c.boardMatrixLocation,e=c.ringMatrixLocation,k=c.cellMatrixLocation,d=BC.GL.textureTileSet(4,4,0.002),f=[d.tile(0,0),d.tile(0,1),d.tile(0,2),d.tile(0,3),d.tile(1,0),d.tile(1,1)],d=d.tile(1,2),h=BC.CellView.make(a,b.metrics,f),l=BC.SelectorView.make(a,b.metrics,d);return{draw:function(){a.uniformMatrix4fv(n,!1,b.matrix);for(var d=b.rings,f=0;2>f;f++)for(var g=0;g<d.length;g++){a.uniformMatrix4fv(e,!1,d[g].matrix);for(var q=d[g].cells,
s=0;s<q.length;s++)a.uniformMatrix4fv(k,!1,q[s].matrix),0==f?h.drawOpaque(q[s],c):h.drawTransparent(q[s],c)}a.uniformMatrix4fv(n,!1,b.selector.matrix);a.uniformMatrix4fv(e,!1,BC.Matrix.identity);a.uniformMatrix4fv(k,!1,BC.Matrix.identity);l.draw(c)}}};return g}(BC||{});BC=function(g){(g.SelectorView=g.SelectorView||{}).make=function(b,a,c){var n=-a.ringHeight/2,e=-n;a=BC.Math.circlePoints(a.ringOuterRadius+0.01,a.numCells,-Math.PI/2);var k=a.length-2,d=[],f=0;d[f++]=a[k]+0.001;d[f++]=n;d[f++]=-a[k+1]-0.001;d[f++]=a[0]+0.001;d[f++]=n;d[f++]=-a[1]-0.001;d[f++]=a[0]+0.001;d[f++]=e;d[f++]=-a[1]-0.001;d[f++]=a[k]+0.001;d[f++]=e;d[f++]=-a[k+1]-0.001;d[f++]=a[0]+0.001;d[f++]=n;d[f++]=-a[1]-0.001;d[f++]=a[2]+0.001;d[f++]=n;d[f++]=-a[3]-0.001;d[f++]=a[2]+0.001;d[f++]=e;
d[f++]=-a[3]-0.001;d[f++]=a[0]+0.001;d[f++]=e;d[f++]=-a[1]-0.001;var h=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,h);b.bufferData(b.ARRAY_BUFFER,new Float32Array(d),b.STATIC_DRAW);n=c.textureCoord(0,0);e=c.textureCoord(1,0);a=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(n,e,a,c,n,e,a,c));var g=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,g);b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW);var r=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),m=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
m);b.bufferData(b.ELEMENT_ARRAY_BUFFER,r,b.STATIC_DRAW);return{draw:function(a){var c=a.positionLocation,d=a.textureCoordLocation;a=a.alphaLocation;b.bindBuffer(b.ARRAY_BUFFER,h);b.enableVertexAttribArray(c);b.vertexAttribPointer(c,3,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,g);b.enableVertexAttribArray(d);b.vertexAttribPointer(d,2,b.FLOAT,!1,0,0);b.uniform1f(a,1);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,m);b.drawElements(b.TRIANGLES,r.length,b.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(b){function a(a,c){var h=n(a,c);if(h.state!==k.BLOCK)return!1;var d=c-1;0>d&&(d=b.numCells-1);d=n(a,d);if(d.state!==k.BLOCK||d.blockStyle!==h.blockStyle)return!1;var e=c+1;e>=b.numCells&&(e=0);e=n(a,e);if(e.state!==k.BLOCK||e.blockStyle!==h.blockStyle)return!1;d.clear();h.clear();e.clear();return!0}function c(a,c){var h=n(a,c);if(h.state!==k.BLOCK)return!1;var d=a-1;if(0>d)return!1;d=n(d,c);if(d.state!==k.BLOCK||d.blockStyle!==h.blockStyle)return!1;
var e=a+1;if(e>=b.numRings)return!1;e=n(e,c);if(e.state!==k.BLOCK||e.blockStyle!==h.blockStyle)return!1;d.clear();h.clear();e.clear();return!0}function n(a,c){return h.rings[a].cells[c]}for(var e=BC.Constants.Direction,k=BC.Cell.CellState,d=[],f=0;f<b.numRings;f++)d[f]=BC.Ring.make(f,b);var h={rings:d,matrix:BC.Matrix.identity,metrics:b,move:function(a){switch(a){case e.LEFT:p.move(e.LEFT)&&(r--,0>r&&(r=b.numCells-1));break;case e.RIGHT:p.move(e.RIGHT)&&(r++,r>=b.numCells&&(r=0));break;case e.UP:0<
g&&p.move(e.UP)&&g--;break;case e.DOWN:g+1<h.rings.length&&p.move(e.DOWN)&&g++}},rotate:function(a){m[1]+=a},swap:function(){var a=h.rings[g];a.cells[r].swap(a.cells[(r+1)%a.cells.length])},update:function(d){for(var e=0;e<b.numRings;e++)for(var f=0;f<b.numCells;f++){n(e,f).update(d);var g=e,l=f;a(g,l);c(g,l);var r=l,l=n(g,r);l.state===k.BLOCK&&(g+=1,g>=b.numRings||(g=n(g,r),l.drop(g)))}p.update(d);d=BC.Matrix.makeXRotation(m[0]);e=BC.Matrix.makeYRotation(m[1]);f=BC.Matrix.makeZRotation(m[2]);e=BC.Matrix.matrixMultiply(f,
e);e=BC.Matrix.matrixMultiply(e,d);h.matrix=e}},g=0,r=b.numCells-1,m=[0,0,0],p=BC.Selector.make(b,h);h.selector=p;return h};return g}(BC||{});BC=function(g){(g.Ring=g.Ring||{}).make=function(b,a){for(var c=[],g=0;g<a.numCells;g++)c[g]=BC.Cell.make(g,a);g=BC.Matrix.makeTranslation(0,-b*a.ringHeight,0);return{cells:c,matrix:g}};return g}(BC||{});BC=function(g){(g.Selector=g.Selector||{}).make=function(b,a){var c=BC.Constants.Direction,g={matrix:BC.Matrix.identity,move:function(a){switch(a){case c.LEFT:return e!==c.NONE?a=!1:(e=c.LEFT,d=0,a=!0),a;case c.RIGHT:return e!==c.NONE?a=!1:(e=c.RIGHT,d=0,a=!0),a;case c.UP:return e!==c.NONE?a=!1:(e=c.UP,d=0,a=!0),a;case c.DOWN:return e!==c.NONE?a=!1:(e=c.DOWN,d=0,a=!0),a}},update:function(h){if(e!==c.NONE){var l=h.deltaTime;0.05<d+l&&(l=0.05-d);var r=l*b.ringHeight/0.05,m=l*f/0.05;switch(e){case c.UP:k[1]+=
r;break;case c.DOWN:k[1]-=r;break;case c.LEFT:a.rotate(m);break;case c.RIGHT:a.rotate(-m)}d+=l;0.05<=d&&(e=c.NONE,d=0)}h=1+Math.abs(Math.sin(4*h.now))/25;h=BC.Matrix.makeScale(h,h,1);l=BC.Matrix.makeTranslation(k[0],k[1],k[2]);g.matrix=BC.Matrix.matrixMultiply(h,l)}},e=c.NONE,k=[0,0,0],d=0,f=BC.Math.sliceRadians(b.numCells);return g};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function b(){return k.width!=k.clientWidth||k.height!=k.clientHeight?(k.width=k.clientWidth,k.height=k.clientHeight,!0):!1}function a(){var a=k.width/k.height,c=BC.Math.radians(90);return BC.Matrix.makePerspective(c,a,1,2E3)}function c(){var a=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function g(){d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);d.viewport(0,0,d.canvas.width,d.canvas.height);d.uniformMatrix4fv(m.projectionMatrixLocation,
!1,p);t.tick();q.update(t);s.draw();requestAnimationFrame(g)}var e=BC.Constants.Direction,k=document.getElementById("canvas");if(k){var d=k.getContext("webgl")||k.getContext("experimental-webgl");if(d){var f=d.createTexture();d.bindTexture(d.TEXTURE_2D,f);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,1,1,0,d.RGBA,d.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var h=new Image;h.src="images/textures.png";$(h).load(function(){d.bindTexture(d.TEXTURE_2D,f);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,
h);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_NEAREST);d.generateMipmap(d.TEXTURE_2D)});d.enable(d.CULL_FACE);d.enable(d.DEPTH_TEST);d.enable(d.BLEND);d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);var l=BC.GL.loadShader(d,"vertex-shader",d.VERTEX_SHADER),r=BC.GL.loadShader(d,"fragment-shader",d.FRAGMENT_SHADER),l=BC.GL.createProgram(d,[l,r]);d.useProgram(l);var m={positionLocation:d.getAttribLocation(l,"a_position"),
textureCoordLocation:d.getAttribLocation(l,"a_textureCoord"),projectionMatrixLocation:d.getUniformLocation(l,"u_projectionMatrix"),viewMatrixLocation:d.getUniformLocation(l,"u_viewMatrix"),boardMatrixLocation:d.getUniformLocation(l,"u_boardMatrix"),ringMatrixLocation:d.getUniformLocation(l,"u_ringMatrix"),cellMatrixLocation:d.getUniformLocation(l,"u_cellMatrix"),alphaLocation:d.getUniformLocation(l,"u_alpha")};b();var p=a();$(window).resize(function(){b()&&(p=a())});l=c();d.uniformMatrix4fv(m.viewMatrixLocation,
!1,l);var q=BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),s=BC.BoardView.make(q,d,m),l=BC.Controller.make(k);l.setMoveLeftListener(function(){q.move(e.LEFT)});l.setMoveRightListener(function(){q.move(e.RIGHT)});l.setMoveUpListener(function(){q.move(e.UP)});l.setMoveDownListener(function(){q.move(e.DOWN)});l.setPrimaryActionListener(function(){q.swap()});var t=BC.StopWatch.make();g()}}};return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var b=g.Math=g.Math||{};b.radians=function(a){return a*Math.PI/180};b.sliceRadians=function(a){return 2*Math.PI/a};b.randomInt=function(a){return Math.floor(Math.random()*a)};b.circlePoints=function(a,c,b){b=b||0;for(var e=2*Math.PI/c,g=[],d=0;d<c;d++)g[2*d]=a*Math.cos(b+d*e),g[2*d+1]=a*Math.sin(b+d*e);return g};b.cross=function(a,c){return[a[1]*c[2]-a[2]*c[1],a[2]*c[0]-a[0]*c[2],a[0]*c[1]-a[1]*c[0]]};b.subtractVectors=function(a,c){return[a[0]-c[0],a[1]-c[1],a[2]-c[2]]};b.normalize=
function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<c?[a[0]/c,a[1]/c,a[2]/c]:[0,0,0]};return g}(BC||{});BC=function(g){var b=g.Cell=g.Cell||{};b.CellState={EMPTY:0,BLOCK:1,SWAP_LEFT:2,SWAP_RIGHT:3,SWAP_LEFT_EMPTY:4,SWAP_RIGHT_EMPTY:5,DROP_BLOCK_SRC:6,DROP_BLOCK_DST:7,DISAPPEARING_BLOCK:8};b.make=function(a,c){var b=BC.Cell.CellState,e=BC.Math.randomInt(c.numBlockTypes),g=BC.Math.sliceRadians(c.numCells),d=[0,a*g,0],f={matrix:BC.Matrix.makeYRotation(d[1]),state:b.BLOCK,blockStyle:e,rotation:d,translation:[0,0,0],alpha:1,isEmpty:function(){return f.state===b.EMPTY||f.state===b.SWAP_LEFT_EMPTY||f.state===
b.SWAP_RIGHT_EMPTY||f.state===b.DROP_BLOCK_SRC},isTransparent:function(){return f.state===b.DISAPPEARING_BLOCK},swap:function(a){function c(b,d){f.blockStyle=a.blockStyle;f.state=b;f.rotation[1]+=g;f.elapsedSwapTime=0;a.blockStyle=q;a.state=d;a.rotation[1]-=g;a.elapsedSwapTime=0}console.log("left: "+f.state+" right: "+a.state);var d=f.state===b.EMPTY&&a.state===b.BLOCK,e=f.state===b.BLOCK&&a.state===b.EMPTY,p=f.state===b.BLOCK&&a.state===b.BLOCK;if(!d&&!e&&!p)return!1;var q=f.blockStyle;return d?
(c(b.SWAP_RIGHT,b.SWAP_LEFT_EMPTY),!0):e?(c(b.SWAP_RIGHT_EMPTY,b.SWAP_LEFT),!0):p?(c(b.SWAP_RIGHT,b.SWAP_LEFT),!0):!1},update:function(a){var d=!1;switch(f.state){case b.DROP_BLOCK_SRC:case b.DROP_BLOCK_DST:a=a.deltaTime;0.075<f.elapsedAnimationTime+a&&(a=0.075-f.elapsedAnimationTime);f.state==b.DROP_BLOCK_DST&&(f.translation[1]-=c.ringHeight*a/0.075);f.elapsedAnimationTime+=a;0.075<=f.elapsedAnimationTime&&(f.state=f.state===b.DROP_BLOCK_SRC?b.EMPTY:b.BLOCK,f.elapsedAnimationTime=0);d|=1;break;case b.DISAPPEARING_BLOCK:a=
a.deltaTime;0.25<f.elapsedDisappearingTime+a&&(a=0.25-f.elapsedDisappearingTime);f.elapsedDisappearingTime+=a;f.alpha=1-f.elapsedDisappearingTime/0.25;0.25<=f.elapsedDisappearingTime&&(f.state=b.EMPTY,f.elapsedDisappearingTime=0,f.alpha=1);d|=0;break;case b.SWAP_LEFT:case b.SWAP_RIGHT:case b.SWAP_LEFT_EMPTY:case b.SWAP_RIGHT_EMPTY:a=a.deltaTime;0.125<f.elapsedSwapTime+a&&(a=0.125-f.elapsedSwapTime);var e=g*a/0.125;f.rotation[1]=f.state===b.SWAP_LEFT||f.state===b.SWAP_LEFT_EMPTY?f.rotation[1]+e:f.rotation[1]-
e;f.matrix=BC.Matrix.makeYRotation(f.rotation[1]);f.elapsedSwapTime+=a;0.125<=f.elapsedSwapTime&&(f.state=f.isEmpty()?b.EMPTY:b.BLOCK,f.elapsedSwapTime=0);d|=1}d&&(d=BC.Matrix.makeYRotation(f.rotation[1]),a=BC.Matrix.makeTranslation(f.translation[0],f.translation[1],f.translation[2]),f.matrix=BC.Matrix.matrixMultiply(d,a))},clear:function(){f.state=b.DISAPPEARING_BLOCK;f.elapsedDisappearingTime=0;f.alpha=1},drop:function(a){f.state===b.BLOCK&&a.state==b.EMPTY&&(a.blockStyle=f.blockStyle,a.state=b.DROP_BLOCK_DST,
a.translation[1]=c.ringHeight,a.elapsedAnimationTime=0,a.alpha=1,f.blockStyle=0,f.state=b.DROP_BLOCK_SRC,f.translation[1]=0,f.elapsedAnimationTime=0,f.alpha=1)}};return f};return g}(BC||{});BC=function(g){var b=g.GL=g.GL||{};b.loadShader=function(a,c,b,e){e=e||BC.Util.error;var g=document.getElementById(c);if(!g)return e("** Error getting script element:"+c),null;c=a.createShader(b);a.shaderSource(c,g.text);a.compileShader(c);return a.getShaderParameter(c,a.COMPILE_STATUS)?c:(lastError=a.getShaderInfoLog(c),e("*** Error compiling shader '"+c+"':"+lastError),a.deleteShader(c),null)};b.createProgram=function(a,c,b,e){for(var g=a.createProgram(),d=0;d<c.length;d++)a.attachShader(g,c[d]);
if(b)for(d=0;d<b.length;d++)a.bindAttribLocation(g,e?e[d]:d,b[d]);a.linkProgram(g);return a.getProgramParameter(g,a.LINK_STATUS)?g:(lastError=a.getProgramInfoLog(g),error("Error in program linking: "+lastError),a.deleteProgram(g),null)};b.textureTileSet=function(a,b,g){var e=1/a,k=1/b;return{tile:function(a,b){var c=e*b,l=k*a;return{textureCoord:function(a,b){return[c+g+(e-2*g)*a,l+g+(k-2*g)*b]}}}}};return g}(BC||{});BC=function(g){(g.Util=g.Util||{}).error=function(b){window.console&&(window.console.error?window.console.error(b):window.console.log&&window.console.log(b))};return g}(BC||{});BC=function(g){(g.Controller=g.Controller||{}).make=function(b){var a=function(){},c=function(){},g=function(){},e=function(){},k=function(){};$(document).keydown(function(b){switch(b.keyCode){case 32:k.call();break;case 37:a.call();break;case 39:c.call();break;case 38:g.call();break;case 40:e.call()}return!1});var d=0,f=0;$(b).on("touchstart touchmove touchend",function(b){var l=b.originalEvent.changedTouches[0];switch(b.type){case "touchstart":d=l.pageX;f=l.pageY;break;case "touchend":b=l.pageX-
d,l=l.pageY-f,50<b?a.call():-50>b?c.call():50<l?e.call():-50>l?g.call():k.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){c=a},setMoveUpListener:function(a){g=a},setMoveDownListener:function(a){e=a},setPrimaryActionListener:function(a){k=a}}};return g}(BC||{});BC=function(g){(g.StopWatch=g.StopWatch||{}).make=function(){var b={then:0.001*Date.now(),tick:function(){b.now=0.001*Date.now();b.deltaTime=b.now-b.then;b.then=b.now}};return b};return g}(BC||{});
