var BC=function(e){var c=e.Cell=e.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};c.make=function(a){function b(){var a=BC.Matrix.makeYRotation(t[1]),b=BC.Matrix.makeTranslation(s[0],s[1],s[2]);m.matrix=BC.Matrix.matrixMultiply(a,b)}var l=BC.Cell.CellState,k=BC.Constants.Direction,d=BC.Audio.Sound,f=a.metrics,h=a.rotationY,c=a.state,g=a.blockStyle,
e=a.audioPlayer,q=BC.Math.sliceRadians(f.numCells),r=[],u=!1,t=[0,h,0],s=[0,0,0],m={matrix:BC.Matrix.makeYRotation(t[1]),state:c,blockStyle:g,yellowBoost:0,alpha:1,markBlock:function(){m.state=l.BLOCK_CLEARING_MARKED;0<r.length&&BC.Util.error("markBlock: pending animations: "+r.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){m.state=l.BLOCK_CLEARING_PREPARING},updateCallback:function(a){m.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){m.yellowBoost=
0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){m.blockStyle+=f.numBlockTypes},finishCallback:function(){m.state=l.BLOCK_CLEARING_READY}});r.push(a,b)},clearBlock:function(){m.state=l.BLOCK_CLEARING_IN_PROGRESS;0<r.length&&BC.Util.error("clearBlock: pending animations: "+r.length);var a=BC.Animation.make({duration:0.25,startCallback:function(){e.play(d.CELL_CLEAR)},updateCallback:function(a){m.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){m.state=l.EMPTY_NO_DROP;m.alpha=
1}});r.push(a)},sendBlock:function(a){var b=m.blockStyle;m.blockStyle=0;m.state=l.EMPTY_NO_SWAP;0<r.length&&BC.Util.error("sendBlock: pending animations: "+r.length);r.push(BC.Animation.make({duration:a,finishCallback:function(){m.state=l.EMPTY}}));return b},receiveBlock:function(a,d,g){m.blockStyle=g;m.state=l.BLOCK_RECEIVING;switch(d){case k.LEFT:t[1]-=q;break;case k.RIGHT:t[1]+=q;break;case k.UP:s[1]=f.ringHeight;u=!0;break;default:BC.Util.error("receiveBlock: unsupport direction: "+d)}b();0<r.length&&
BC.Util.error("receiveBlock: pending animations: "+r.length);r.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=q*a.deltaPercent;a=f.ringHeight*a.deltaPercent;switch(d){case k.LEFT:return t[1]+=b,!0;case k.RIGHT:return t[1]-=b,!0;case k.UP:return s[1]-=a,!0;default:return!1}},finishCallback:function(){m.state=l.BLOCK;u=!1}}))},isClearing:function(){return m.state===l.BLOCK_CLEARING_MARKED||m.state===l.BLOCK_CLEARING_PREPARING||m.state===l.BLOCK_CLEARING_READY||m.state===l.BLOCK_CLEARING_IN_PROGRESS},
isDrawable:function(){return m.state!==l.EMPTY&&m.state!==l.EMPTY_NO_SWAP&&m.state!==l.EMPTY_NO_DROP},isTransparent:function(){return m.state===l.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return u},update:function(a){BC.Animation.process(r,a)&&b()}};return m};return e}(BC||{});BC=function(e){(e.Ring=e.Ring||{}).make=function(c){var a=BC.Cell.CellState,b=c.metrics,l=c.translationY,k=c.selectable;c=c.audioPlayer;for(var d=BC.Math.sliceRadians(b.numCells),l=BC.Matrix.makeTranslation(0,l,0),a=k?a.BLOCK:a.BLOCK_INCOMING,f=[],h=0;h<b.numCells;h++){var n=h*d,g=BC.Math.randomInt(b.numBlockTypes);k||(g+=2*b.numBlockTypes);f[h]=BC.Cell.make({metrics:b,rotationY:n,state:a,blockStyle:g,audioPlayer:c})}return{matrix:l,cells:f,isEmpty:function(){for(var a=0;a<f.length;a++)if(f[a].state!==
BC.Cell.CellState.EMPTY)return!1;return!0},setSelectable:function(a){if(!k&&a)for(var d=0;d<f.length;d++)f[d].state===BC.Cell.CellState.BLOCK_INCOMING&&(f[d].state=BC.Cell.CellState.BLOCK,f[d].blockStyle-=2*b.numBlockTypes);k=a},isSelectable:function(){return k}}};return e}(BC||{});BC=function(e){var c=e.Board=e.Board||{};(c.View=c.View||{}).make=function(a){var b=a.board,l=a.gl,k=a.programLocations;a=a.resources;var d=k.boardRotationMatrixLocation,f=k.boardTranslationMatrixLocation,h=k.selectorMatrixLocation,c=k.ringMatrixLocation,g=k.cellMatrixLocation,e=BC.Cell.View.make(l,b.metrics,a.blockTextureTiles),q=BC.Selector.View.make(l,b.metrics,a.selectorTextureTile),r=BC.Stage.View.make(l,b.metrics,a.blackTextureTile),u=BC.Stat.View.make("#speed-stat"),t=BC.Stat.View.make("#time-stat"),
s=BC.Stat.View.make("#score-stat");return{draw:function(){u.draw(b.speed);t.draw(b.time);s.draw(b.score);l.uniformMatrix4fv(d,!1,b.rotationMatrix);l.uniformMatrix4fv(f,!1,b.translationMatrix);l.uniformMatrix4fv(h,!1,BC.Matrix.identity);for(var a=b.rings,x=0;2>x;x++)for(var v=0;v<a.length;v++){l.uniformMatrix4fv(c,!1,a[v].matrix);for(var y=a[v].cells,z=0;z<y.length;z++)l.uniformMatrix4fv(g,!1,y[z].matrix),0==x?e.drawOpaque(y[z],k):e.drawTransparent(y[z],k)}l.uniformMatrix4fv(d,!1,BC.Matrix.identity);
l.uniformMatrix4fv(f,!1,BC.Matrix.identity);l.uniformMatrix4fv(h,!1,b.stage.matrix);l.uniformMatrix4fv(c,!1,BC.Matrix.identity);l.uniformMatrix4fv(g,!1,BC.Matrix.identity);r.draw(k);l.uniformMatrix4fv(d,!1,BC.Matrix.identity);l.uniformMatrix4fv(f,!1,b.translationMatrix);l.uniformMatrix4fv(h,!1,b.selector.matrix);l.uniformMatrix4fv(c,!1,BC.Matrix.identity);l.uniformMatrix4fv(g,!1,BC.Matrix.identity);q.draw(k)}}};return e}(BC||{});BC=function(e){var c=e.Math=e.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,l){l=l||0;for(var k=2*Math.PI/b,d=[],f=0;f<b;f++)d[2*f]=a*Math.cos(l+f*k),d[2*f+1]=a*Math.sin(l+f*k);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return e}(BC||{});BC=function(e){var c=e.GL=e.GL||{};c.loadShader=function(a,b,l,k){k=k||BC.Util.error;var d=document.getElementById(b);if(!d)return k("** Error getting script element:"+b),null;b=a.createShader(l);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),k("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,l,k){for(var d=a.createProgram(),f=0;f<b.length;f++)a.attachShader(d,b[f]);
if(l)for(f=0;f<l.length;f++)a.bindAttribLocation(d,k?k[f]:f,l[f]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,l){var k=1/a,d=1/b;return{tile:function(a,b){var c=k*b,g=d*a;return{textureCoord:function(a,b){return[c+l+(k-2*l)*a,g+l+(d-2*l)*b]}}}}};return e}(BC||{});BC=function(e){var c=e.Audio=e.Audio||{};(c.Player=c.Player||{}).make=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;var a=new AudioContext,b;(function(l){var k=new XMLHttpRequest;k.open("GET",l,!0);k.responseType="arraybuffer";k.onload=function(){a.decodeAudioData(k.response,function(a){b=a},function(){BC.Util.error("error decoding data for "+l)})};k.send()})("audio/sounds.ogg");return{play:function(l){if(b){var k=b,d=l.offset;l=l.duration;var f=a.createBufferSource();
f.buffer=k;f.connect(a.destination);f.start(0,d,l)}}}};return e}(BC||{});BC=function(e){function c(a,b){return{offset:a,duration:b}}(e.Audio=e.Audio||{}).Sound={BUTTON_HOVER:c(1,0.5),BUTTON_CLICK:c(0,0.75),SELECTOR_MOVEMENT:c(1,0.5),CELL_SWAP:c(2,0.5),CELL_CLEAR:c(3,0.5)};return e}(BC||{});BC=function(e){(e.Selector=e.Selector||{}).make=function(c){function a(a){g=a;0<e.length&&BC.Util.error("startMoving: pending animations: "+e.length);e.push(BC.Animation.make({duration:h,updateCallback:function(a){var k=b.ringHeight*a.deltaPercent;a=r*a.deltaPercent;switch(g){case d.UP:return q[1]+=k,!0;case d.DOWN:return q[1]-=k,!0;case d.LEFT:return l.rotate(a),!0;case d.RIGHT:return l.rotate(-a),!0;default:return!1}},finishCallback:function(){g=d.NONE;k.play(f.SELECTOR_MOVEMENT)}}))}var b=c.metrics,
l=c.board,k=c.audioPlayer,d=BC.Constants.Direction,f=BC.Audio.Sound,h=0.025,n={matrix:BC.Matrix.identity,move:function(b){switch(b){case d.LEFT:return g!==d.NONE?b=!1:(a(d.LEFT),b=!0),b;case d.RIGHT:return g!==d.NONE?b=!1:(a(d.RIGHT),b=!0),b;case d.UP:return g!==d.NONE?b=!1:(a(d.UP),b=!0),b;case d.DOWN:return g!==d.NONE?b=!1:(a(d.DOWN),b=!0),b;default:return BC.Util.error("move: unsupported direction: "+b),!1}},update:function(a){BC.Animation.process(e,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,
a,1);var b=BC.Matrix.makeTranslation(q[0],q[1],q[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}},g=d.NONE,e=[],q=[0,0,0],r=BC.Math.sliceRadians(b.numCells);return n};return e}(BC||{});BC=function(e){(e.Resources=e.Resources||{}).make=function(){var c=BC.GL.textureTileSet(8,8,0.002),a=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(0,4),c.tile(0,5),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(2,4),c.tile(2,5),c.tile(1,0),c.tile(1,1),c.tile(1,2),c.tile(1,3),c.tile(1,4),c.tile(1,5)],b=c.tile(4,0),c=c.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:c}};return e}(BC||{});BC=function(e){(e.Game=e.Game||{}).run=function(){function c(a){return p.getUniformLocation(H,a)}function a(){return A.width!=A.clientWidth||A.height!=A.clientHeight?(A.width=A.clientWidth,A.height=A.clientHeight,!0):!1}function b(){var a=A.width/A.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function k(a){a.mouseenter(function(){F.play(m.BUTTON_HOVER)})}function d(){x=!0;
y=!1;B=BC.Board.make({metrics:Q,audioPlayer:F});J=BC.Board.View.make({board:B,gl:p,programLocations:K,resources:R});D.setMoveLeftListener(function(){B.move(s.LEFT)});D.setMoveRightListener(function(){B.move(s.RIGHT)});D.setMoveUpListener(function(){B.move(s.UP)});D.setMoveDownListener(function(){B.move(s.DOWN)});D.setPrimaryActionListener(function(){B.swap()});f()}function f(){v=!1;e(!1);L.reset();h()}function h(){p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.viewport(0,0,p.canvas.width,p.canvas.height);
p.uniformMatrix4fv(K.projectionMatrixLocation,!1,T);var a=!v&&!y&&B;a&&(L.tick(),y=B.update(L));J&&J.draw();a&&requestAnimationFrame(h);y&&(v=x=!1,e(!0))}function e(a){a?(I.text(y?r:v?q:w),a=C,x?a.show():a.hide(),z.fadeIn(u),E.fadeOut(u)):(z.fadeOut(u),E.fadeIn(u))}function g(a){a.fadeIn(t).fadeOut(t).fadeIn(t).fadeOut(t).fadeIn(t)}var w="b l o c k c i l l i n",q="P A U S E D",r="G A M E  O V E R",u="slow",t=20,s=BC.Constants.Direction,m=BC.Audio.Sound,x=!1,v=!1,y=!1,z=$("#main-menu"),I=$("#main-menu-title"),
G=$("#new-game-button"),C=$("#continue-game-button"),E=$("#game-menu"),M=$("#pause-button"),Q={numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},R=BC.Resources.make(),L=BC.StopWatch.make(),F=BC.Audio.Player.make(),B,J,A=document.getElementById("canvas");if(A){var D=BC.Controller.make(A),p=A.getContext("webgl")||A.getContext("experimental-webgl");if(p){var P=p.createTexture();p.bindTexture(p.TEXTURE_2D,P);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,1,1,0,p.RGBA,p.UNSIGNED_BYTE,
new Uint8Array([0,0,0,255]));var N=new Image;N.src="images/textures.png";$(N).load(function(){p.bindTexture(p.TEXTURE_2D,P);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,N);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.LINEAR_MIPMAP_NEAREST);p.generateMipmap(p.TEXTURE_2D)});p.enable(p.CULL_FACE);p.enable(p.DEPTH_TEST);p.enable(p.BLEND);p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA);var O=BC.GL.loadShader(p,"vertex-shader",
p.VERTEX_SHADER),S=BC.GL.loadShader(p,"fragment-shader",p.FRAGMENT_SHADER),H=BC.GL.createProgram(p,[O,S]);p.useProgram(H);var K={positionLocation:p.getAttribLocation(H,"a_position"),textureCoordLocation:p.getAttribLocation(H,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardRotationMatrixLocation:c("u_boardRotationMatrix"),boardTranslationMatrixLocation:c("u_boardTranslationMatrix"),selectorMatrixLocation:c("u_selectorMatrix"),ringMatrixLocation:c("u_ringMatrix"),
cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};a();var T=b();$(window).resize(function(){a()&&(T=b(),h())});O=l();p.uniformMatrix4fv(K.viewMatrixLocation,!1,O);e(!0);k(G);k(C);k(M);G.click(function(){g(G);F.play(m.BUTTON_CLICK);d()});C.click(function(){g(C);F.play(m.BUTTON_CLICK);f()});M.click(function(){g(M);F.play(m.BUTTON_CLICK);v=!0;e(!0)});D.setMenuActionListener(function(){v?f():(v=!0,e(!0))});document.addEventListener("visibilitychange",
function(){document.hidden&&(v=!0,e(!0))})}}};return e}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(e){var c=e.Cell=e.Cell||{},c=c.Chain=c.Chain||{};c.find=function(a){function b(b,d){return a.rings[b].cells[d]}function l(){for(var d=a.rings.length,k=[],l=0;l<d;l++){var f;f=l;for(var e=0,s=b(f,e),m=0;m<c;m++){var x=b(f,e);if(s.state!==x.state||s.blockStyle!=x.blockStyle)break;e+=1;e=e===c?0:e}f=e;for(e=0;e<c;)if(m=(e+f)%c,x=b(l,m),x.state!==h.BLOCK)e++;else{for(var v=1,s=e+1;s<c;s++)if(m=(s+f)%c,m=b(l,m),x.state===m.state&&x.blockStyle==m.blockStyle)v++;else break;if(v>=g){for(x=[];e<
s;e++)m=(e+f)%c,v=b(l,m),x.push({cell:v,row:l,col:m});k.push(x)}e=s}}return k}function k(){for(var d=a.rings.length,k=[],l=0;l<c;l++)for(var f=0;f<d;){var e=b(f,l);if(e.state!==h.BLOCK)f++;else{for(var s=1,m=f+1;m<d;m++){var x=b(m,l);if(e.state===x.state&&e.blockStyle==x.blockStyle)s++;else break}if(s>=g){for(e=[];f<m;f++)s=b(f,l),e.push({cell:s,row:f,col:l});k.push(e)}f=m}}return k}function d(a,b){for(var d=0;d<a.length;d++)for(var g=a[d],k=0;k<b.length;k++){var l=b[k];if(g.blockStyle===l.blockStyle&&
g.row===l.row&&g.col===l.col)return!0}return!1}function f(a,b){for(var d=0;d<a.length;d++){var g=a[d];if(g.blockStyle===b.blockStyle&&g.row===b.row&&g.col===b.col)return!0}return!1}var h=BC.Cell.CellState,c=a.rings[0].cells.length,g=3;return function(){for(var a=[],b=l(),g=k();0<b.length;){var c=b.shift();for(a.push(c);;){for(var e=!1,h=0;h<g.length;h++)if(d(c,g[h])){for(e=0;e<g[h].length;e++)f(c,g[h][e])||c.push(g[h][e]);g.splice(h,1);e=!0}if(!e)break;e=!1;for(h=0;h<b.length;h++)if(d(c,b[h])){for(e=
0;e<b[h].length;e++)f(c,b[h][e])||c.push(b[h][e]);b.splice(h,1);e=!0}if(!e)break}}for(;0<g.length;)c=g.shift(),a.push(c);for(h=0;h<a.length;h++)a[h].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(k){k=BC.Cell.Chain.find(k);for(var d=0;d<k.length;d++){var f=k[d];l.push(f);for(var h=0;h<f.length;h++){var e=f[h].cell;e.markBlock();b.push(e)}}if(0<b.length)switch(e=b[0],e.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:e.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){f=l[0];h=!0;for(d=0;d<f.length;d++)e=f[d].cell,h&=!e.isClearing();if(h){for(d=0;d<f.length;d++)e=f[d].cell,e.state===a.EMPTY_NO_DROP&&(e.state=a.EMPTY);l.shift()}}return{newChains:k,pendingChainCount:l.length}}}};return e}(BC||{});BC=function(e){(e.Stage=e.Stage||{}).make=function(e,a){a+=e.ringHeight/2-0.01;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return e}(BC||{});BC=function(e){var c=e.Util=e.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return e}(BC||{});BC=function(e){var c=e.Selector=e.Selector||{};(c.View=c.View||{}).make=function(a,b,e){var k=-b.ringHeight/2,d=-k;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var f=b.length-2,h=[],c=0;h[c++]=b[f]+0.001;h[c++]=k;h[c++]=-b[f+1]-0.001;h[c++]=b[0]+0.001;h[c++]=k;h[c++]=-b[1]-0.001;h[c++]=b[0]+0.001;h[c++]=d;h[c++]=-b[1]-0.001;h[c++]=b[f]+0.001;h[c++]=d;h[c++]=-b[f+1]-0.001;h[c++]=b[0]+0.001;h[c++]=k;h[c++]=-b[1]-0.001;h[c++]=b[2]+0.001;h[c++]=k;h[c++]=-b[3]-0.001;h[c++]=b[2]+
0.001;h[c++]=d;h[c++]=-b[3]-0.001;h[c++]=b[0]+0.001;h[c++]=d;h[c++]=-b[1]-0.001;var g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);k=e.textureCoord(0,0);d=e.textureCoord(1,0);b=e.textureCoord(1,1);e=e.textureCoord(0,1);e=new Float32Array([].concat(k,d,b,e,k,d,b,e));var w=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,w);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);var q=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),r=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
r);a.bufferData(a.ELEMENT_ARRAY_BUFFER,q,a.STATIC_DRAW);return{draw:function(b){var d=b.positionLocation,e=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,g);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,w);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.drawElements(a.TRIANGLES,q.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.Matrix=e.Matrix||{};c.makeLookAt=function(a,b,e){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));e=BC.Math.cross(e,b);var c=BC.Math.cross(b,e);return[e[0],e[1],e[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,e,c){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(e-c);return[a/b,0,0,0,0,a,0,0,0,0,(e+c)*d,-1,0,0,e*c*d*2,0]};c.makeTranslation=function(a,b,e){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,e){return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],e=a[1],c=a[2],d=a[3],f=a[4],h=a[5],n=a[6],g=a[7],w=a[8],q=a[9],r=a[10],u=a[11],t=a[12],s=a[13],m=a[14];a=
a[15];var x=r*a,v=m*u,y=n*a,z=m*g,I=n*u,G=r*g,C=c*a,E=m*d,M=c*u,Q=r*d,R=c*g,L=n*d,F=w*s,B=t*q,J=f*s,A=t*h,D=f*q,p=w*h,P=b*s,N=t*e,O=b*q,S=w*e,H=b*h,K=f*e,T=x*h+z*q+I*s-(v*h+y*q+G*s),U=v*e+C*q+Q*s-(x*e+E*q+M*s),s=y*e+E*h+R*s-(z*e+C*h+L*s),e=G*e+M*h+L*q-(I*e+Q*h+R*q),h=1/(b*T+f*U+w*s+t*e);return[h*T,h*U,h*s,h*e,h*(v*f+y*w+G*t-(x*f+z*w+I*t)),h*(x*b+E*w+M*t-(v*b+C*w+Q*t)),h*(z*b+C*f+L*t-(y*b+E*f+R*t)),h*(I*b+Q*f+R*w-(G*b+M*f+L*w)),h*(F*g+A*u+D*a-(B*g+J*u+p*a)),h*(B*d+P*u+S*a-(F*d+N*u+O*a)),h*(J*d+N*g+
H*a-(A*d+P*g+K*a)),h*(p*d+O*g+K*u-(D*d+S*g+H*u)),h*(J*r+p*m+B*n-(D*m+F*n+A*r)),h*(O*m+F*c+N*r-(P*r+S*m+B*c)),h*(P*n+K*m+A*c-(H*m+J*c+N*n)),h*(H*r+D*c+S*n-(O*n+K*r+p*c))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.Drop=c.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,e=BC.Constants.Direction,c=[];return{update:function(d){for(var f=0;f<d.rings.length;f++)for(var h=0;h<a.numCells;h++){var n=d,g=f,w=h,q=n.rings[g].cells[w];q.state===b.BLOCK&&(g+=1,g>=n.rings.length||(n=n.rings[g].cells[w],q.state===b.BLOCK&&n.state==b.EMPTY&&(q=q.sendBlock(0.05),n.receiveBlock(0.05,e.UP,q),c.push(n))))}a:{for(;0<c.length;){if(c[0].hasDroppingBlock()){d=!0;break a}c.shift()}d=
!1}return d}}};return e}(BC||{});BC=function(e){(e.Constants=e.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return e}(BC||{});BC=function(e){var c=e.Animation=e.Animation||{};c.make=function(a){var b=a.duration,e=a.startCallback||function(){},c=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},f=0,h=!1,n=!1;return{update:function(a){h||(h=!0,e());var w=a.deltaTime;f+w>b&&(w=b-f);f+=w;a=c({now:a.now,deltaTime:w,elapsedPercent:f/b,deltaPercent:w/b});f>=b&&(n=!0,d());return a},isDone:function(){return n}}};c.process=function(a,b){var e=!1;if(0<a.length){var c=a[0],e=e|c.update(b);c.isDone()&&a.shift()}return e};
return e}(BC||{});BC=function(e){var c=e.Stage=e.Stage||{};(c.View=c.View||{}).make=function(a,b,e){b=[];var c=0;b[c++]=-1;b[c++]=0;b[c++]=1;b[c++]=1;b[c++]=0;b[c++]=1;b[c++]=1;b[c++]=0;b[c++]=-1;b[c++]=-1;b[c++]=0;b[c++]=-1;b[c++]=-1;b[c++]=-1;b[c++]=1;b[c++]=1;b[c++]=-1;b[c++]=1;b[c++]=1;b[c++]=0;b[c++]=1;b[c++]=-1;b[c++]=0;b[c++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=e.textureCoord(0,0);var c=e.textureCoord(1,0),f=e.textureCoord(1,
1);e=e.textureCoord(0,1);e=new Float32Array([].concat(b,c,f,e,b,c,f,e));var h=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,h);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),g=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation,f=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,h);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){(e.Board=e.Board||{}).make=function(c){function a(a){a=BC.Ring.make({metrics:k,translationY:-k.ringHeight*x,selectable:a,audioPlayer:d});m.push(a);x++}function b(){y.translationMatrix=BC.Matrix.makeTranslation(t[0],t[1],t[2])}function e(){var a=BC.Matrix.makeXRotation(s[0]),b=BC.Matrix.makeYRotation(s[1]),d=BC.Matrix.makeZRotation(s[2]),b=BC.Matrix.matrixMultiply(d,b),b=BC.Matrix.matrixMultiply(b,a);y.rotationMatrix=b}var k=c.metrics,d=c.audioPlayer,f=BC.Cell.CellState,h=BC.Constants.Direction,
n=BC.Audio.Sound,g=11*k.ringHeight,w=2*k.ringHeight,q=0,r=k.numCells-1;c=5.5*-k.ringHeight-k.ringHeight/2;for(var u=k.ringHeight*k.numRings,t=[0,c+u,0],s=[0,0,0],m=[],x=0,v=0;v<k.numRings;v++)a(!0);for(v=0;2>v;v++)a(!1);var y={metrics:k,rings:m,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case h.LEFT:z.move(h.LEFT)&&(r--,0>r&&(r=k.numCells-1));break;case h.RIGHT:z.move(h.RIGHT)&&(r++,r>=k.numCells&&(r=0));break;case h.UP:0<q&&z.move(h.UP)&&q--;
break;case h.DOWN:q+1<y.rings.length&&m[q+1].isSelectable()&&z.move(h.DOWN)&&q++}},rotate:function(a){s[1]+=a},swap:function(){var a=m[q].cells[r%k.numCells],b=m[q].cells[(r+1)%k.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var c=a.blockStyle,e=b.blockStyle;a.state!==f.EMPTY&&a.state!==f.EMPTY_NO_DROP||b.state!==f.BLOCK?a.state!==f.BLOCK||b.state!==f.EMPTY&&b.state!==f.EMPTY_NO_DROP?a.state===f.BLOCK&&b.state===f.BLOCK&&(a.receiveBlock(0.1,h.RIGHT,e),b.receiveBlock(0.1,h.LEFT,c),d.play(n.CELL_SWAP)):
(a.sendBlock(0.1,h.RIGHT),b.receiveBlock(0.1,h.LEFT,c),d.play(n.CELL_SWAP)):(b.sendBlock(0.1,h.LEFT),a.receiveBlock(0.1,h.RIGHT,e),d.play(n.CELL_SWAP))},update:function(d){for(var c=0;c<m.length;c++)for(var f=0;f<k.numCells;f++)m[c].cells[f%k.numCells].update(d);for(var c=0|G.update(y),f=I.update(y),h=0;h<f.newChains.length;h++)E.value+=100*f.newChains[h].length;c|=0<f.pendingChainCount;c||(c=0.02*d.deltaTime,u+c>g&&(c=g-u),u+=c,t[1]+=c);C.value+=d.deltaTime;z.update(d);b();for(e();0<m.length&&m[0].isEmpty();)m.shift(),
u-=k.ringHeight,q--;for(d=u-k.ringHeight*m.length;d>-w;)a(!1),d-=k.ringHeight;for(d=m.length-1;0<=d&&!m[d].isSelectable();d--)0<=u-k.ringHeight*(d+1)&&m[d].setSelectable(!0);return u>=g}};b();e();var z=BC.Selector.make({metrics:k,board:y,audioPlayer:d});y.selector=z;c=BC.Stage.make(k,c);y.stage=c;var I=BC.Cell.Chain.makeManager(),G=BC.Cell.Drop.makeManager(k);c=BC.Stat.make({value:1,unit:BC.Stat.Unit.INTEGER});y.speed=c;var C=BC.Stat.make({value:0,unit:BC.Stat.Unit.SECONDS});y.time=C;var E=BC.Stat.make({value:0,
unit:BC.Stat.Unit.INTEGER});y.score=E;return y};return e}(BC||{});BC=function(e){(e.Controller=e.Controller||{}).make=function(c){var a=0,b=0,e=function(){},k=function(){},d=function(){},f=function(){},h=function(){},n=function(){};$(document).keydown(function(a){switch(a.keyCode){case 37:e.call();break;case 39:k.call();break;case 38:d.call();break;case 40:f.call();break;case 32:h.call();break;case 27:n.call();break;default:console.log(a.keyCode)}return!1});$(c).on("touchstart touchmove touchend",function(c){var n=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":a=
n.pageX;b=n.pageY;break;case "touchend":var q=n.pageX-a,r=n.pageY-b,u=Math.abs(q),t=Math.abs(r);c=function(){return 20<t?(0<r?f.call():d.call(),!0):!1};n=function(){return 20<u?(0<q?e.call():k.call(),!0):!1};if(u>t){if(n()||c())break}else if(c()||n())break;h.call()}return!1});return{setMoveLeftListener:function(a){e=a},setMoveRightListener:function(a){k=a},setMoveUpListener:function(a){d=a},setMoveDownListener:function(a){f=a},setPrimaryActionListener:function(a){h=a},setMenuActionListener:function(a){n=
a}}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function e(b,c){var d=c.positionLocation,f=c.textureCoordLocation,h=c.yellowBoostLocation,g=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,w);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,q[b.blockStyle]);a.enableVertexAttribArray(f);a.vertexAttribPointer(f,2,a.FLOAT,!1,0,0);a.uniform1f(h,b.yellowBoost);a.uniform1f(g,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.drawElements(a.TRIANGLES,
u,a.UNSIGNED_SHORT,0)}var d=b.numCells,f=b.ringOuterRadius,h=b.ringHeight/2,n=-h,g=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,g);f=BC.Math.circlePoints(f,d,g);d=0;g=[];g[d++]=b[0];g[d++]=h;g[d++]=-b[1];g[d++]=f[0];g[d++]=h;g[d++]=-f[1];g[d++]=f[2];g[d++]=h;g[d++]=-f[3];g[d++]=b[2];g[d++]=h;g[d++]=-b[3];g[d++]=f[0];g[d++]=n;g[d++]=-f[1];g[d++]=b[0];g[d++]=n;g[d++]=-b[1];g[d++]=b[2];g[d++]=n;g[d++]=-b[3];g[d++]=f[2];g[d++]=n;g[d++]=-f[3];g[d++]=b[0];g[d++]=h;g[d++]=-b[1];g[d++]=b[0];g[d++]=
n;g[d++]=-b[1];g[d++]=f[0];g[d++]=n;g[d++]=-f[1];g[d++]=f[0];g[d++]=h;g[d++]=-f[1];g[d++]=f[2];g[d++]=h;g[d++]=-f[3];g[d++]=f[2];g[d++]=n;g[d++]=-f[3];g[d++]=b[2];g[d++]=n;g[d++]=-b[3];g[d++]=b[2];g[d++]=h;g[d++]=-b[3];g[d++]=f[0];g[d++]=h;g[d++]=-f[1];g[d++]=f[0];g[d++]=n;g[d++]=-f[1];g[d++]=f[2];g[d++]=n;g[d++]=-f[3];g[d++]=f[2];g[d++]=h;g[d++]=-f[3];g[d++]=b[2];g[d++]=h;g[d++]=-b[3];g[d++]=b[2];g[d++]=n;g[d++]=-b[3];g[d++]=b[0];g[d++]=n;g[d++]=-b[1];g[d++]=b[0];g[d++]=h;g[d++]=-b[1];var w=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,w);a.bufferData(a.ARRAY_BUFFER,new Float32Array(g),a.STATIC_DRAW);h=[];for(d=0;d<c.length;d++)for(n=c[d],h[d]=[],f=b=0;6>b;b++)g=n.textureCoord(0,0),h[d][f++]=g[0],h[d][f++]=g[1],g=n.textureCoord(0,1),h[d][f++]=g[0],h[d][f++]=g[1],g=n.textureCoord(1,1),h[d][f++]=g[0],h[d][f++]=g[1],g=n.textureCoord(1,0),h[d][f++]=g[0],h[d][f++]=g[1];for(var q=[],d=0;d<c.length;d++)q[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,q[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(h[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var r=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var u=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,c),a.enable(a.CULL_FACE))}}};return e}(BC||{});BC=function(e){var c=e.Stat=e.Stat||{};c.Unit={INTEGER:0,SECONDS:1};c.make=function(a){return{value:a.value,unit:a.unit}};return e}(BC||{});BC=function(e){var c=e.Stat=e.Stat||{},a;(c.View=c.View||{}).make=function(b){if(!a){var c=BC.Stat.Unit;a={};a[c.INTEGER]=function(a){return a};a[c.SECONDS]=function(a){var b=Math.floor(a/3600);a-=3600*b;var c=Math.floor(a/60);a=Math.floor(a-60*c);10>b&&(b="0"+b);10>c&&(c="0"+c);10>a&&(a="0"+a);return b+":"+c+":"+a}}var e=$(b);return{draw:function(b){e.text((0,a[b.unit])(b.value))}}};return e}(BC||{});BC=function(e){(e.StopWatch=e.StopWatch||{}).make=function(){function c(){a.then=0.001*Date.now()}var a={reset:c,tick:function(){a.now=0.001*Date.now();a.deltaTime=a.now-a.then;a.then=a.now}};c();return a};return e}(BC||{});
