var BC=function(f){var d=f.Matrix=f.Matrix||{};d.makeLookAt=function(a,b,d){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));d=BC.Math.cross(d,b);var c=BC.Math.cross(b,d);return[d[0],d[1],d[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};d.makePerspective=function(a,b,d,c){a=Math.tan(0.5*Math.PI-0.5*a);var h=1/(d-c);return[a/b,0,0,0,0,a,0,0,0,0,(d+c)*h,-1,0,0,d*c*h*2,0]};d.makeTranslation=function(a,b,d){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,d,1]};d.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};d.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};d.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};d.makeScale=function(a,b,d){return[a,0,0,0,0,b,0,0,0,0,d,0,0,0,0,1]};d.makeInverse=function(a){var b=a[0],d=a[1],c=a[2],h=a[3],g=a[4],e=a[5],f=a[6],m=a[7],k=a[8],n=a[9],q=a[10],r=a[11],v=a[12],s=a[13],p=a[14];a=a[15];var u=q*a,y=p*r,w=f*a,z=
p*m,x=f*r,A=q*m,B=c*a,C=p*h,D=c*r,E=q*h,F=c*m,G=f*h,H=k*s,I=v*n,J=g*s,K=v*e,L=g*n,M=k*e,N=b*s,O=v*d,P=b*n,Q=k*d,R=b*e,S=g*d,T=u*e+z*n+x*s-(y*e+w*n+A*s),U=y*d+B*n+E*s-(u*d+C*n+D*s),s=w*d+C*e+F*s-(z*d+B*e+G*s),d=A*d+D*e+G*n-(x*d+E*e+F*n),e=1/(b*T+g*U+k*s+v*d);return[e*T,e*U,e*s,e*d,e*(y*g+w*k+A*v-(u*g+z*k+x*v)),e*(u*b+C*k+D*v-(y*b+B*k+E*v)),e*(z*b+B*g+G*v-(w*b+C*g+F*v)),e*(x*b+E*g+F*k-(A*b+D*g+G*k)),e*(H*m+K*r+L*a-(I*m+J*r+M*a)),e*(I*h+N*r+Q*a-(H*h+O*r+P*a)),e*(J*h+O*m+R*a-(K*h+N*m+S*a)),e*(M*h+P*m+
S*r-(L*h+Q*m+R*r)),e*(J*q+M*p+I*f-(L*p+H*f+K*q)),e*(P*p+H*c+O*q-(N*q+Q*p+I*c)),e*(N*f+S*p+K*c-(R*p+J*c+O*f)),e*(R*q+L*c+Q*f-(P*f+S*q+M*c))]};d.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*
b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return f}(BC||{});BC=function(f){(f.Time=f.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return f}(BC||{});BC=function(f){var d=f.GL=f.GL||{};d.loadShader=function(a,b,d,c){c=c||BC.Util.error;var h=document.getElementById(b);if(!h)return c("** Error getting script element:"+b),null;b=a.createShader(d);a.shaderSource(b,h.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),c("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};d.createProgram=function(a,b,d,c){for(var h=a.createProgram(),g=0;g<b.length;g++)a.attachShader(h,b[g]);
if(d)for(g=0;g<d.length;g++)a.bindAttribLocation(h,c?c[g]:g,d[g]);a.linkProgram(h);return a.getProgramParameter(h,a.LINK_STATUS)?h:(lastError=a.getProgramInfoLog(h),error("Error in program linking: "+lastError),a.deleteProgram(h),null)};d.textureTileSet=function(a,b,d){var c=1/a,h=1/b;return{tile:function(a,b){var f=c*b,m=h*a;return{textureCoord:function(a,b){return[f+d+(c-2*d)*a,m+d+(h-2*d)*b]}}}}};return f}(BC||{});BC=function(f){(f.Selector=f.Selector||{}).make=function(d,a,b){var l=a.ringMinY,c=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var h=a.length-2,g=[],e=0;g[e++]=a[h]+0.001;g[e++]=l;g[e++]=-a[h+1]-0.001;g[e++]=a[0]+0.001;g[e++]=l;g[e++]=-a[1]-0.001;g[e++]=a[0]+0.001;g[e++]=c;g[e++]=-a[1]-0.001;g[e++]=a[h]+0.001;g[e++]=c;g[e++]=-a[h+1]-0.001;g[e++]=a[0]+0.001;g[e++]=l;g[e++]=-a[1]-0.001;g[e++]=a[2]+0.001;g[e++]=l;g[e++]=-a[3]-0.001;g[e++]=a[2]+0.001;g[e++]=c;g[e++]=
-a[3]-0.001;g[e++]=a[0]+0.001;g[e++]=c;g[e++]=-a[1]-0.001;var f=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f);d.bufferData(d.ARRAY_BUFFER,new Float32Array(g),d.STATIC_DRAW);l=b.textureCoord(0,0);c=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(l,c,a,b,l,c,a,b));var m=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,m);d.bufferData(d.ARRAY_BUFFER,b,d.STATIC_DRAW);var k=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),n=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,
n);d.bufferData(d.ELEMENT_ARRAY_BUFFER,k,d.STATIC_DRAW);return{draw:function(a,b){d.enable(d.BLEND);d.bindBuffer(d.ARRAY_BUFFER,f);d.enableVertexAttribArray(a);d.vertexAttribPointer(a,3,d.FLOAT,!1,0,0);d.bindBuffer(d.ARRAY_BUFFER,m);d.enableVertexAttribArray(b);d.vertexAttribPointer(b,2,d.FLOAT,!1,0,0);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,n);d.drawElements(d.TRIANGLES,k.length,d.UNSIGNED_SHORT,0);d.disable(d.BLEND)}}};return f}(BC||{});BC=function(f){(f.Game=f.Game||{}).run=function(){function d(){return l.width!=l.clientWidth||l.height!=l.clientHeight?(l.width=l.clientWidth,l.height=l.clientHeight,!0):!1}function a(){var a=l.width/l.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);c.viewport(0,0,c.canvas.width,c.canvas.height);var a=BC.Time.getTimeInSeconds(),e=a-x;x=a;c.uniformMatrix4fv(f,!1,v);c.uniformMatrix4fv(m,!1,n);s.update(e);p.draw();requestAnimationFrame(b)}
var l=document.getElementById("canvas");if(l){var c=l.getContext("webgl")||l.getContext("experimental-webgl");if(c){c.enable(c.CULL_FACE);c.enable(c.DEPTH_TEST);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var h=BC.GL.loadShader(c,"vertex-shader",c.VERTEX_SHADER),g=BC.GL.loadShader(c,"fragment-shader",c.FRAGMENT_SHADER),e=BC.GL.createProgram(c,[h,g]);c.useProgram(e);var h=c.getAttribLocation(e,"a_position"),g=c.getAttribLocation(e,"a_texcoord"),f=c.getUniformLocation(e,"u_projectionMatrix"),m=c.getUniformLocation(e,
"u_viewMatrix"),e=c.getUniformLocation(e,"u_matrix"),k=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]),n=BC.Matrix.makeInverse(k),q=c.createTexture();c.bindTexture(c.TEXTURE_2D,q);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var r=new Image;r.src="images/textures.png";$(r).load(function(){c.bindTexture(c.TEXTURE_2D,q);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,r);c.generateMipmap(c.TEXTURE_2D)});d();var v=a();$(window).resize(function(){d()&&
(v=a())});var s=BC.Board.makeModel({numRingCells:24,numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),p=BC.Board.makeView(s,c,h,e,g),u=BC.Common.Direction,y=0,w=0;$(l).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":y=b.pageX;w=b.pageY;break;case "touchend":a=b.pageX-y;var b=b.pageY-w,c=u.NONE;50<a?c=u.LEFT:-50>a?c=u.RIGHT:50<b?c=u.DOWN:-50>b&&(c=u.UP);s.move(c)}return!1});var z={37:u.LEFT,
39:u.RIGHT,38:u.UP,40:u.DOWN};$(document).keydown(function(a){s.move(z[a.keyCode]);return!1});var x=BC.Time.getTimeInSeconds();b()}}};return f}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(f){var d=f.Math=f.Math||{};d.radians=function(a){return a*Math.PI/180};d.randomInt=function(a){return Math.floor(Math.random()*a)};d.circlePoints=function(a,b,d){d=d||0;for(var c=2*Math.PI/b,h=[],g=0;g<b;g++)h[2*g]=a*Math.cos(d+g*c),h[2*g+1]=a*Math.sin(d+g*c);return h};d.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};d.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};d.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return f}(BC||{});BC=function(f){(f.Cell=f.Cell||{}).make=function(d,a,b){var f=a.numRingCells,c=a.outerRingRadius,h=a.ringMaxY,g=a.ringMinY,e=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,f,e);for(var f=BC.Math.circlePoints(c,f,e),c=[],t=[],e=0;e<b.length;e++)t[e]=[];var m=function(a,c,d,e,f,g,h){for(var k=0;k<b.length;k++){var q=b[k],l=q.textureCoord(c,d);t[k][a]=l[0];t[k][a+1]=l[1];l=q.textureCoord(e,f);t[k][a+2]=l[0];t[k][a+3]=l[1];l=q.textureCoord(g,h);t[k][a+4]=l[0];t[k][a+5]=l[1]}return a+6},e=0,k;c[e++]=
a[0];c[e++]=h;c[e++]=-a[1];c[e++]=f[0];c[e++]=h;c[e++]=-f[1];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];k=m(0,0,0,0,1,1,1);c[e++]=a[0];c[e++]=h;c[e++]=-a[1];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];c[e++]=a[2];c[e++]=h;c[e++]=-a[3];k=m(k,0,0,1,1,1,0);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=f[2];c[e++]=g;c[e++]=-f[3];c[e++]=f[0];c[e++]=g;c[e++]=-f[1];k=m(k,0,0,1,1,0,1);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=a[2];c[e++]=g;c[e++]=-a[3];c[e++]=f[2];c[e++]=g;c[e++]=-f[3];k=m(k,0,0,1,0,1,1);c[e++]=f[0];c[e++]=g;c[e++]=
-f[1];c[e++]=f[2];c[e++]=g;c[e++]=-f[3];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];k=m(k,0,1,1,1,1,0);c[e++]=f[0];c[e++]=g;c[e++]=-f[1];c[e++]=f[2];c[e++]=h;c[e++]=-f[3];c[e++]=f[0];c[e++]=h;c[e++]=-f[1];k=m(k,0,1,1,0,0,0);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=a[2];c[e++]=h;c[e++]=-a[3];c[e++]=a[2];c[e++]=g;c[e++]=-a[3];k=m(k,0,1,1,0,1,1);c[e++]=a[0];c[e++]=g;c[e++]=-a[1];c[e++]=a[0];c[e++]=h;c[e++]=-a[1];c[e++]=a[2];c[e++]=h;c[e++]=-a[3];k=m(k,0,1,0,0,1,0);var n=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,
n);d.bufferData(d.ARRAY_BUFFER,new Float32Array(c),d.STATIC_DRAW);for(var q=c.length/3,r=[],e=0;e<b.length;e++)r[e]=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,r[e]),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t[e]),d.STATIC_DRAW);return{draw:function(a,b,c){d.bindBuffer(d.ARRAY_BUFFER,n);d.enableVertexAttribArray(b);d.vertexAttribPointer(b,3,d.FLOAT,!1,0,0);d.bindBuffer(d.ARRAY_BUFFER,r[a.blockStyle]);d.enableVertexAttribArray(c);d.vertexAttribPointer(c,2,d.FLOAT,!1,0,0);d.drawArrays(d.TRIANGLES,
0,q)}}};return f}(BC||{});BC=function(f){(f.Util=f.Util||{}).error=function(d){window.console&&(window.console.error?window.console.error(d):window.console.log&&window.console.log(d))};return f}(BC||{});BC=function(f){(f.Common=f.Common||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).makeView=function(d,a,b,f,c){var h=BC.GL.textureTileSet(4,4,0.002),g=[h.tile(0,0),h.tile(0,1),h.tile(0,2),h.tile(0,3),h.tile(1,0),h.tile(1,1)],h=h.tile(1,2),e=BC.Cell.make(a,d,g),t=BC.Selector.make(a,d,h),m=BC.Matrix.makeScale(1,1,1),k=BC.Matrix.makeTranslation(0,0,0),n=[0,0,0],q=[0,0,0],r=d.ringMaxY-d.ringMinY;return{draw:function(){for(var g=BC.Matrix.makeXRotation(d.rotation[0]),h=BC.Matrix.makeYRotation(d.rotation[1]),p=BC.Matrix.makeZRotation(d.rotation[2]),
p=BC.Matrix.matrixMultiply(m,p),p=BC.Matrix.matrixMultiply(p,h),p=BC.Matrix.matrixMultiply(p,g),p=BC.Matrix.matrixMultiply(p,k),g=d.rings,h=0;h<g.length;h++){q[1]=-h*r;n[1]=0;for(var u=BC.Matrix.makeTranslation(q[0],q[1],q[2]),y=g[h].cells,w=0;w<y.length;w++){var z=BC.Matrix.makeYRotation(n[1]),x=BC.Matrix.matrixMultiply(p,u),x=BC.Matrix.matrixMultiply(x,z);a.uniformMatrix4fv(f,!1,x);e.draw(y[w],b,c);n[1]+=2*Math.PI/d.numRingCells}}p=BC.Matrix.makeScale(1,1,1);g=BC.Matrix.makeTranslation(d.selectorTranslation[0],
d.selectorTranslation[1],d.selectorTranslation[2]);p=BC.Matrix.matrixMultiply(p,g);a.uniformMatrix4fv(f,!1,p);t.draw(b,c)}}};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).makeModel=function(d){function a(){for(var a=[],b=0;b<d.numRingCells;b++){var c=a,e=b,f=BC.Math.randomInt(d.numBlockStyles);c[e]={blockStyle:f}}return{cells:a}}for(var b=BC.Common.Direction,f=[],c=b.NONE,h=0,g=0,e=[0,0,0],t=[0,0,0],m=2*Math.PI/d.numRingCells,k=d.ringMaxY-d.ringMinY,n=0;3>n;n++)f[n]=a();return{rings:f,numRingCells:d.numRingCells,innerRingRadius:d.innerRingRadius,outerRingRadius:d.outerRingRadius,ringMaxY:d.ringMaxY,ringMinY:d.ringMinY,move:function(a){switch(a){case b.LEFT:c===
b.NONE&&(c=b.LEFT,h=0);break;case b.RIGHT:c===b.NONE&&(c=b.RIGHT,h=0);break;case b.UP:c===b.NONE&&0<g&&(c=b.UP,h=0,g--);break;case b.DOWN:c===b.NONE&&g+1<f.length&&(c=b.DOWN,h=0,g++)}},update:function(a){if(c!==b.NONE){0.05<h+a&&(a=0.05-h);var d=a*k/0.05,f=a*m/0.05;switch(c){case b.UP:e[1]+=d;break;case b.DOWN:e[1]-=d;break;case b.LEFT:t[1]+=f;break;case b.RIGHT:t[1]-=f}h+=a;0.05<=h&&(c=b.NONE,h=0)}},selectorTranslation:e,rotation:t}};return f}(BC||{});
