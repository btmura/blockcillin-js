var BC=function(h){var e=h.Matrix=h.Matrix||{};e.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var e=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,e[0],e[1],e[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};e.makePerspective=function(a,b,c,e){a=Math.tan(0.5*Math.PI-0.5*a);var g=1/(c-e);return[a/b,0,0,0,0,a,0,0,0,0,(c+e)*g,-1,0,0,c*e*g*2,0]};e.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};e.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};e.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};e.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};e.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};e.identity=e.makeScale(1,1,1);e.makeInverse=function(a){var b=a[0],c=a[1],e=a[2],g=a[3],d=a[4],f=a[5],r=a[6],l=a[7],h=a[8],n=a[9],p=a[10],m=a[11],s=a[12],q=a[13],u=a[14];a=
a[15];var v=p*a,w=u*m,x=r*a,y=u*l,z=r*m,A=p*l,B=e*a,C=u*g,D=e*m,E=p*g,F=e*l,G=r*g,H=h*q,I=s*n,J=d*q,K=s*f,L=d*n,M=h*f,N=b*q,O=s*c,P=b*n,Q=h*c,R=b*f,S=d*c,T=v*f+y*n+z*q-(w*f+x*n+A*q),U=w*c+B*n+E*q-(v*c+C*n+D*q),q=x*c+C*f+F*q-(y*c+B*f+G*q),c=A*c+D*f+G*n-(z*c+E*f+F*n),f=1/(b*T+d*U+h*q+s*c);return[f*T,f*U,f*q,f*c,f*(w*d+x*h+A*s-(v*d+y*h+z*s)),f*(v*b+C*h+D*s-(w*b+B*h+E*s)),f*(y*b+B*d+G*s-(x*b+C*d+F*s)),f*(z*b+E*d+F*h-(A*b+D*d+G*h)),f*(H*l+K*m+L*a-(I*l+J*m+M*a)),f*(I*g+N*m+Q*a-(H*g+O*m+P*a)),f*(J*g+O*l+
R*a-(K*g+N*l+S*a)),f*(M*g+P*l+S*m-(L*g+Q*l+R*m)),f*(J*p+M*u+I*r-(L*u+H*r+K*p)),f*(P*u+H*e+O*p-(N*p+Q*u+I*e)),f*(N*r+S*u+K*e-(R*u+J*e+O*r)),f*(R*p+L*e+Q*r-(P*r+S*p+M*e))]};e.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return h}(BC||{});BC=function(h){(h.CellView=h.CellView||{}).make=function(e,a,b){var c=a.numCells,k=a.ringOuterRadius,g=a.ringHeight/2,d=-g,f=-Math.PI/2;a=BC.Math.circlePoints(a.ringInnerRadius,c,f);k=BC.Math.circlePoints(k,c,f);c=0;f=[];f[c++]=a[0];f[c++]=g;f[c++]=-a[1];f[c++]=k[0];f[c++]=g;f[c++]=-k[1];f[c++]=k[2];f[c++]=g;f[c++]=-k[3];f[c++]=a[2];f[c++]=g;f[c++]=-a[3];f[c++]=a[0];f[c++]=g;f[c++]=-a[1];f[c++]=a[0];f[c++]=d;f[c++]=-a[1];f[c++]=k[0];f[c++]=d;f[c++]=-k[1];f[c++]=k[0];f[c++]=g;f[c++]=-k[1];f[c++]=k[2];
f[c++]=g;f[c++]=-k[3];f[c++]=k[2];f[c++]=d;f[c++]=-k[3];f[c++]=a[2];f[c++]=d;f[c++]=-a[3];f[c++]=a[2];f[c++]=g;f[c++]=-a[3];f[c++]=k[0];f[c++]=g;f[c++]=-k[1];f[c++]=k[0];f[c++]=d;f[c++]=-k[1];f[c++]=k[2];f[c++]=d;f[c++]=-k[3];f[c++]=k[2];f[c++]=g;f[c++]=-k[3];f[c++]=a[2];f[c++]=g;f[c++]=-a[3];f[c++]=a[2];f[c++]=d;f[c++]=-a[3];f[c++]=a[0];f[c++]=d;f[c++]=-a[1];f[c++]=a[0];f[c++]=g;f[c++]=-a[1];var h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h);e.bufferData(e.ARRAY_BUFFER,new Float32Array(f),e.STATIC_DRAW);
g=[];for(c=0;c<b.length;c++)for(d=b[c],g[c]=[],k=a=0;5>a;a++)f=d.textureCoord(0,0),g[c][k++]=f[0],g[c][k++]=f[1],f=d.textureCoord(0,1),g[c][k++]=f[0],g[c][k++]=f[1],f=d.textureCoord(1,1),g[c][k++]=f[0],g[c][k++]=f[1],f=d.textureCoord(1,0),g[c][k++]=f[0],g[c][k++]=f[1];for(var l=[],c=0;c<b.length;c++)l[c]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,l[c]),e.bufferData(e.ARRAY_BUFFER,new Float32Array(g[c]),e.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,
17,18,16,18,19]);var t=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t);e.bufferData(e.ELEMENT_ARRAY_BUFFER,b,e.STATIC_DRAW);var n=b.length;return{draw:function(a,b){var d=b.positionLocation,c=b.textureCoordLocation;e.bindBuffer(e.ARRAY_BUFFER,h);e.enableVertexAttribArray(d);e.vertexAttribPointer(d,3,e.FLOAT,!1,0,0);e.bindBuffer(e.ARRAY_BUFFER,l[a.blockStyle]);e.enableVertexAttribArray(c);e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t);e.drawElements(e.TRIANGLES,
n,e.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){(h.BoardView=h.BoardView||{}).make=function(e,a,b){var c=b.boardMatrixLocation,k=b.ringMatrixLocation,g=b.cellMatrixLocation,d=BC.GL.textureTileSet(4,4,0.002),f=[d.tile(0,0),d.tile(0,1),d.tile(0,2),d.tile(0,3),d.tile(1,0),d.tile(1,1)],d=d.tile(1,2),h=BC.CellView.make(a,e.metrics,f),l=BC.SelectorView.make(a,e.metrics,d);return{draw:function(){a.uniformMatrix4fv(c,!1,e.matrix);for(var d=e.rings,f=0;f<d.length;f++){a.uniformMatrix4fv(k,!1,d[f].matrix);for(var p=d[f].cells,m=0;m<p.length;m++)a.uniformMatrix4fv(g,
!1,p[m].matrix),h.draw(p[m],b)}a.uniformMatrix4fv(c,!1,e.selector.matrix);a.uniformMatrix4fv(k,!1,BC.Matrix.identity);a.uniformMatrix4fv(g,!1,BC.Matrix.identity);l.draw(b)}}};return h}(BC||{});BC=function(h){(h.SelectorView=h.SelectorView||{}).make=function(e,a,b){var c=-a.ringHeight/2,k=-c;a=BC.Math.circlePoints(a.ringOuterRadius+0.01,a.numCells,-Math.PI/2);var g=a.length-2,d=[],f=0;d[f++]=a[g]+0.001;d[f++]=c;d[f++]=-a[g+1]-0.001;d[f++]=a[0]+0.001;d[f++]=c;d[f++]=-a[1]-0.001;d[f++]=a[0]+0.001;d[f++]=k;d[f++]=-a[1]-0.001;d[f++]=a[g]+0.001;d[f++]=k;d[f++]=-a[g+1]-0.001;d[f++]=a[0]+0.001;d[f++]=c;d[f++]=-a[1]-0.001;d[f++]=a[2]+0.001;d[f++]=c;d[f++]=-a[3]-0.001;d[f++]=a[2]+0.001;d[f++]=k;
d[f++]=-a[3]-0.001;d[f++]=a[0]+0.001;d[f++]=k;d[f++]=-a[1]-0.001;var h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h);e.bufferData(e.ARRAY_BUFFER,new Float32Array(d),e.STATIC_DRAW);c=b.textureCoord(0,0);k=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(c,k,a,b,c,k,a,b));var l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l);e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW);var t=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),n=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,
n);e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,e.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation;a=a.textureCoordLocation;e.enable(e.BLEND);e.bindBuffer(e.ARRAY_BUFFER,h);e.enableVertexAttribArray(b);e.vertexAttribPointer(b,3,e.FLOAT,!1,0,0);e.bindBuffer(e.ARRAY_BUFFER,l);e.enableVertexAttribArray(a);e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n);e.drawElements(e.TRIANGLES,t.length,e.UNSIGNED_SHORT,0);e.disable(e.BLEND)}}};return h}(BC||{});BC=function(h){(h.Constants=h.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).make=function(e){for(var a=BC.Constants.Direction,b=[],c=0;c<e.numRings;c++)b[c]=BC.Ring.make(c,e);var k={rings:b,matrix:BC.Matrix.identity,metrics:e,move:function(b){switch(b){case a.LEFT:h.move(a.LEFT)&&(d--,0>d&&(d=e.numCells-1));break;case a.RIGHT:h.move(a.RIGHT)&&(d++,d>=e.numCells&&(d=0));break;case a.UP:0<g&&h.move(a.UP)&&g--;break;case a.DOWN:g+1<k.rings.length&&h.move(a.DOWN)&&g++}},rotate:function(a){f[1]+=a},swap:function(){var a=k.rings[g];a.cells[d].swap(a.cells[(d+
1)%a.cells.length])},update:function(a){for(var b=k.rings,d=0;d<b.length;d++)b[d].update(a);h.update(a);a=BC.Matrix.makeXRotation(f[0]);b=BC.Matrix.makeYRotation(f[1]);d=BC.Matrix.makeZRotation(f[2]);b=BC.Matrix.matrixMultiply(d,b);b=BC.Matrix.matrixMultiply(b,a);k.matrix=b}},g=0,d=e.numCells-1,f=[0,0,0],h=BC.Selector.make(e,k);k.selector=h;return k};return h}(BC||{});BC=function(h){(h.Ring=h.Ring||{}).make=function(e,a){for(var b=[],c=0;c<a.numCells;c++)b[c]=BC.Cell.make(c,a);c=BC.Matrix.makeTranslation(0,-e*a.ringHeight,0);return{cells:b,matrix:c,update:function(a){for(var c=0;c<b.length;c++)b[c].update(a)}}};return h}(BC||{});BC=function(h){(h.Selector=h.Selector||{}).make=function(e,a){var b=BC.Constants.Direction,c={matrix:BC.Matrix.identity,move:function(a){switch(a){case b.LEFT:return k!==b.NONE?a=!1:(k=b.LEFT,d=0,a=!0),a;case b.RIGHT:return k!==b.NONE?a=!1:(k=b.RIGHT,d=0,a=!0),a;case b.UP:return k!==b.NONE?a=!1:(k=b.UP,d=0,a=!0),a;case b.DOWN:return k!==b.NONE?a=!1:(k=b.DOWN,d=0,a=!0),a}},update:function(h){if(k!==b.NONE){var l=h.deltaTime;0.05<d+l&&(l=0.05-d);var t=l*e.ringHeight/0.05,n=l*f/0.05;switch(k){case b.UP:g[1]+=
t;break;case b.DOWN:g[1]-=t;break;case b.LEFT:a.rotate(n);break;case b.RIGHT:a.rotate(-n)}d+=l;0.05<=d&&(k=b.NONE,d=0)}h=1+Math.abs(Math.sin(4*h.now))/25;h=BC.Matrix.makeScale(h,h,1);l=BC.Matrix.makeTranslation(g[0],g[1],g[2]);c.matrix=BC.Matrix.matrixMultiply(h,l)}},k=b.NONE,g=[0,0,0],d=0,f=BC.Math.sliceRadians(e.numCells);return c};return h}(BC||{});BC=function(h){(h.Game=h.Game||{}).run=function(){function e(){return g.width!=g.clientWidth||g.height!=g.clientHeight?(g.width=g.clientWidth,g.height=g.clientHeight,!0):!1}function a(){var a=g.width/g.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){var a=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function c(){d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);d.viewport(0,0,d.canvas.width,d.canvas.height);d.uniformMatrix4fv(n.projectionMatrixLocation,
!1,p);q.tick();m.update(q);s.draw();requestAnimationFrame(c)}var h=BC.Constants.Direction,g=document.getElementById("canvas");if(g){var d=g.getContext("webgl")||g.getContext("experimental-webgl");if(d){var f=d.createTexture();d.bindTexture(d.TEXTURE_2D,f);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,1,1,0,d.RGBA,d.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var r=new Image;r.src="images/textures.png";$(r).load(function(){d.bindTexture(d.TEXTURE_2D,f);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,
r);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_NEAREST);d.generateMipmap(d.TEXTURE_2D)});d.enable(d.CULL_FACE);d.enable(d.DEPTH_TEST);d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);var l=BC.GL.loadShader(d,"vertex-shader",d.VERTEX_SHADER),t=BC.GL.loadShader(d,"fragment-shader",d.FRAGMENT_SHADER),l=BC.GL.createProgram(d,[l,t]);d.useProgram(l);var n={positionLocation:d.getAttribLocation(l,"a_position"),textureCoordLocation:d.getAttribLocation(l,
"a_texcoord"),projectionMatrixLocation:d.getUniformLocation(l,"u_projectionMatrix"),viewMatrixLocation:d.getUniformLocation(l,"u_viewMatrix"),boardMatrixLocation:d.getUniformLocation(l,"u_boardMatrix"),ringMatrixLocation:d.getUniformLocation(l,"u_ringMatrix"),cellMatrixLocation:d.getUniformLocation(l,"u_cellMatrix")};e();var p=a();$(window).resize(function(){e()&&(p=a())});l=b();d.uniformMatrix4fv(n.viewMatrixLocation,!1,l);var m=BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,
ringOuterRadius:1,ringHeight:0.3}),s=BC.BoardView.make(m,d,n),l=BC.Controller.make(g);l.setMoveLeftListener(function(){m.move(h.LEFT)});l.setMoveRightListener(function(){m.move(h.RIGHT)});l.setMoveUpListener(function(){m.move(h.UP)});l.setMoveDownListener(function(){m.move(h.DOWN)});l.setPrimaryActionListener(function(){m.swap()});var q=BC.StopWatch.make();c()}}};return h}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(h){var e=h.Math=h.Math||{};e.radians=function(a){return a*Math.PI/180};e.sliceRadians=function(a){return 2*Math.PI/a};e.randomInt=function(a){return Math.floor(Math.random()*a)};e.circlePoints=function(a,b,c){c=c||0;for(var e=2*Math.PI/b,g=[],d=0;d<b;d++)g[2*d]=a*Math.cos(c+d*e),g[2*d+1]=a*Math.sin(c+d*e);return g};e.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};e.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};e.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return h}(BC||{});BC=function(h){(h.Cell=h.Cell||{}).make=function(e,a){var b=BC.Math.randomInt(a.numBlockTypes),c=BC.Math.sliceRadians(a.numCells),h=[0,e*c,0],g={matrix:BC.Matrix.makeYRotation(h[1]),state:0,blockStyle:b,rotation:h,swap:function(a){var b=g.blockStyle;g.blockStyle=a.blockStyle;g.state=2;g.rotation[1]+=c;g.elapsedSwapTime=0;a.blockStyle=b;a.state=1;a.rotation[1]-=c;a.elapsedSwapTime=0},update:function(a){if(1==g.state||2==g.state){a=a.deltaTime;0.125<g.elapsedSwapTime+a&&(a=0.125-g.elapsedSwapTime);
var b=c*a/0.125;g.rotation[1]=1==g.state?g.rotation[1]+b:g.rotation[1]-b;g.matrix=BC.Matrix.makeYRotation(g.rotation[1]);g.elapsedSwapTime+=a;0.125<=g.elapsedSwapTime&&(g.state=0,g.elapsedSwapTime=0)}}};return g};return h}(BC||{});BC=function(h){var e=h.GL=h.GL||{};e.loadShader=function(a,b,c,e){e=e||BC.Util.error;var g=document.getElementById(b);if(!g)return e("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,g.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),e("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};e.createProgram=function(a,b,c,e){for(var g=a.createProgram(),d=0;d<b.length;d++)a.attachShader(g,b[d]);
if(c)for(d=0;d<c.length;d++)a.bindAttribLocation(g,e?e[d]:d,c[d]);a.linkProgram(g);return a.getProgramParameter(g,a.LINK_STATUS)?g:(lastError=a.getProgramInfoLog(g),error("Error in program linking: "+lastError),a.deleteProgram(g),null)};e.textureTileSet=function(a,b,c){var e=1/a,g=1/b;return{tile:function(a,b){var h=e*b,l=g*a;return{textureCoord:function(a,b){return[h+c+(e-2*c)*a,l+c+(g-2*c)*b]}}}}};return h}(BC||{});BC=function(h){(h.Util=h.Util||{}).error=function(e){window.console&&(window.console.error?window.console.error(e):window.console.log&&window.console.log(e))};return h}(BC||{});BC=function(h){(h.Controller=h.Controller||{}).make=function(e){var a=function(){},b=function(){},c=function(){},h=function(){},g=function(){};$(document).keydown(function(d){switch(d.keyCode){case 32:g.call();break;case 37:a.call();break;case 39:b.call();break;case 38:c.call();break;case 40:h.call()}return!1});var d=0,f=0;$(e).on("touchstart touchmove touchend",function(e){var l=e.originalEvent.changedTouches[0];switch(e.type){case "touchstart":d=l.pageX;f=l.pageY;break;case "touchend":e=l.pageX-
d,l=l.pageY-f,50<e?a.call():-50>e?b.call():50<l?h.call():-50>l?c.call():g.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){c=a},setMoveDownListener:function(a){h=a},setPrimaryActionListener:function(a){g=a}}};return h}(BC||{});BC=function(h){(h.StopWatch=h.StopWatch||{}).make=function(){var e={then:0.001*Date.now(),tick:function(){e.now=0.001*Date.now();e.deltaTime=e.now-e.then;e.then=e.now}};return e};return h}(BC||{});
