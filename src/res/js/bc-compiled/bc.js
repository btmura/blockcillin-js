var BC=function(e){var c=e.Cell=e.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};c.make=function(a){function b(){var a=BC.Matrix.makeYRotation(u[1]),b=BC.Matrix.makeTranslation(r[0],r[1],r[2]);m.matrix=BC.Matrix.matrixMultiply(a,b)}var l=BC.Cell.CellState,k=BC.Constants.Direction,d=BC.Audio.Sound,h=a.metrics,f=a.rotationY,c=a.state,g=a.blockStyle,
e=a.audioPlayer,p=BC.Math.sliceRadians(h.numCells),s=[],v=!1,u=[0,f,0],r=[0,0,0],m={matrix:BC.Matrix.makeYRotation(u[1]),state:c,blockStyle:g,yellowBoost:0,alpha:1,markBlock:function(){m.state=l.BLOCK_CLEARING_MARKED;0<s.length&&BC.Util.error("markBlock: pending animations: "+s.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){m.state=l.BLOCK_CLEARING_PREPARING},updateCallback:function(a){m.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){m.yellowBoost=
0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){m.blockStyle+=h.numBlockTypes},finishCallback:function(){m.state=l.BLOCK_CLEARING_READY}});s.push(a,b)},clearBlock:function(){m.state=l.BLOCK_CLEARING_IN_PROGRESS;0<s.length&&BC.Util.error("clearBlock: pending animations: "+s.length);var a=BC.Animation.make({duration:0.25,startCallback:function(){e.play(d.CELL_CLEAR)},updateCallback:function(a){m.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){m.state=l.EMPTY_NO_DROP;m.alpha=
1}});s.push(a)},sendBlock:function(a){var b=m.blockStyle;m.blockStyle=0;m.state=l.EMPTY_NO_SWAP;0<s.length&&BC.Util.error("sendBlock: pending animations: "+s.length);s.push(BC.Animation.make({duration:a,finishCallback:function(){m.state=l.EMPTY}}));return b},receiveBlock:function(a,d,f){m.blockStyle=f;m.state=l.BLOCK_RECEIVING;switch(d){case k.LEFT:u[1]-=p;break;case k.RIGHT:u[1]+=p;break;case k.UP:r[1]=h.ringHeight;v=!0;break;default:BC.Util.error("receiveBlock: unsupport direction: "+d)}b();0<s.length&&
BC.Util.error("receiveBlock: pending animations: "+s.length);s.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=p*a.deltaPercent;a=h.ringHeight*a.deltaPercent;switch(d){case k.LEFT:return u[1]+=b,!0;case k.RIGHT:return u[1]-=b,!0;case k.UP:return r[1]-=a,!0;default:return!1}},finishCallback:function(){m.state=l.BLOCK;v=!1}}))},isClearing:function(){return m.state===l.BLOCK_CLEARING_MARKED||m.state===l.BLOCK_CLEARING_PREPARING||m.state===l.BLOCK_CLEARING_READY||m.state===l.BLOCK_CLEARING_IN_PROGRESS},
isDrawable:function(){return m.state!==l.EMPTY&&m.state!==l.EMPTY_NO_SWAP&&m.state!==l.EMPTY_NO_DROP},isTransparent:function(){return m.state===l.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return v},update:function(a){BC.Animation.process(s,a)&&b()}};return m};return e}(BC||{});BC=function(e){(e.Ring=e.Ring||{}).make=function(c){var a=BC.Cell.CellState,b=c.metrics,l=c.translationY,k=c.selectable;c=c.audioPlayer;for(var d=BC.Math.sliceRadians(b.numCells),l=BC.Matrix.makeTranslation(0,l,0),a=k?a.BLOCK:a.BLOCK_INCOMING,h=[],f=0;f<b.numCells;f++){var n=f*d,g=BC.Math.randomInt(b.numBlockTypes);k||(g+=2*b.numBlockTypes);h[f]=BC.Cell.make({metrics:b,rotationY:n,state:a,blockStyle:g,audioPlayer:c})}return{matrix:l,cells:h,isEmpty:function(){for(var a=0;a<h.length;a++)if(h[a].state!==
BC.Cell.CellState.EMPTY)return!1;return!0},setSelectable:function(a){if(!k&&a)for(var d=0;d<h.length;d++)h[d].state===BC.Cell.CellState.BLOCK_INCOMING&&(h[d].state=BC.Cell.CellState.BLOCK,h[d].blockStyle-=2*b.numBlockTypes);k=a},isSelectable:function(){return k}}};return e}(BC||{});BC=function(e){var c=e.Board=e.Board||{};(c.View=c.View||{}).make=function(a){var b=a.board,l=a.gl,k=a.programLocations;a=a.resources;var d=k.boardRotationMatrixLocation,h=k.boardTranslationMatrixLocation,f=k.selectorMatrixLocation,c=k.ringMatrixLocation,g=k.cellMatrixLocation,e=BC.Cell.View.make(l,b.metrics,a.blockTextureTiles),p=BC.Selector.View.make(l,b.metrics,a.selectorTextureTile),s=BC.Stage.View.make(l,b.metrics,a.blackTextureTile),v=BC.Stat.View.make("#speed-level-stat"),u=BC.Stat.View.make("#elapsed-time-stat"),
r=BC.Stat.View.make("#score-stat");return{draw:function(){v.draw(b.speedLevel);u.draw(b.elapsedTime);r.draw(b.score);l.uniformMatrix4fv(d,!1,b.rotationMatrix);l.uniformMatrix4fv(h,!1,b.translationMatrix);l.uniformMatrix4fv(f,!1,BC.Matrix.identity);for(var a=b.rings,w=0;2>w;w++)for(var y=0;y<a.length;y++){l.uniformMatrix4fv(c,!1,a[y].matrix);for(var x=a[y].cells,z=0;z<x.length;z++)l.uniformMatrix4fv(g,!1,x[z].matrix),0==w?e.drawOpaque(x[z],k):e.drawTransparent(x[z],k)}l.uniformMatrix4fv(d,!1,BC.Matrix.identity);
l.uniformMatrix4fv(h,!1,BC.Matrix.identity);l.uniformMatrix4fv(f,!1,b.stage.matrix);l.uniformMatrix4fv(c,!1,BC.Matrix.identity);l.uniformMatrix4fv(g,!1,BC.Matrix.identity);s.draw(k);l.uniformMatrix4fv(d,!1,BC.Matrix.identity);l.uniformMatrix4fv(h,!1,b.translationMatrix);l.uniformMatrix4fv(f,!1,b.selector.matrix);l.uniformMatrix4fv(c,!1,BC.Matrix.identity);l.uniformMatrix4fv(g,!1,BC.Matrix.identity);p.draw(k)}}};return e}(BC||{});BC=function(e){var c=e.Math=e.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,l){l=l||0;for(var k=2*Math.PI/b,d=[],h=0;h<b;h++)d[2*h]=a*Math.cos(l+h*k),d[2*h+1]=a*Math.sin(l+h*k);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return e}(BC||{});BC=function(e){var c=e.GL=e.GL||{};c.loadShader=function(a,b,l,k){k=k||BC.Util.error;var d=document.getElementById(b);if(!d)return k("** Error getting script element:"+b),null;b=a.createShader(l);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),k("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,l,k){for(var d=a.createProgram(),h=0;h<b.length;h++)a.attachShader(d,b[h]);
if(l)for(h=0;h<l.length;h++)a.bindAttribLocation(d,k?k[h]:h,l[h]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,l){var k=1/a,d=1/b;return{tile:function(a,b){var c=k*b,g=d*a;return{textureCoord:function(a,b){return[c+l+(k-2*l)*a,g+l+(d-2*l)*b]}}}}};return e}(BC||{});BC=function(e){var c=e.Audio=e.Audio||{};(c.Player=c.Player||{}).make=function(){function a(a){var d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";d.onload=function(){b.decodeAudioData(d.response,function(a){l=a},function(){BC.Util.error("error decoding data for "+a)})};d.send()}var b,l;window.AudioContext=window.AudioContext||window.webkitAudioContext;window.AudioContext&&(b=new AudioContext,a("audio/sounds.ogg"));return{play:function(a){if(l){var d=l,h=a.offset;a=a.duration;
var f=b.createBufferSource();f.buffer=d;f.connect(b.destination);f.start(0,h,a)}}}};return e}(BC||{});BC=function(e){function c(a,b){return{offset:a,duration:b}}(e.Audio=e.Audio||{}).Sound={BUTTON_HOVER:c(1,0.5),BUTTON_CLICK:c(0,0.75),SELECTOR_MOVEMENT:c(1,0.5),CELL_SWAP:c(2,0.5),CELL_CLEAR:c(3,0.5)};return e}(BC||{});BC=function(e){(e.Selector=e.Selector||{}).make=function(c){function a(a){g=a;0<t.length&&BC.Util.error("startMoving: pending animations: "+t.length);t.push(BC.Animation.make({duration:f,updateCallback:function(a){var f=b.ringHeight*a.deltaPercent;a=s*a.deltaPercent;switch(g){case d.UP:return p[1]+=f,!0;case d.DOWN:return p[1]-=f,!0;case d.LEFT:return l.rotate(a),!0;case d.RIGHT:return l.rotate(-a),!0;default:return!1}},finishCallback:function(){g=d.NONE;k.play(h.SELECTOR_MOVEMENT)}}))}var b=c.metrics,
l=c.board,k=c.audioPlayer,d=BC.Constants.Direction,h=BC.Audio.Sound,f=0.025,e={matrix:BC.Matrix.identity,move:function(b){switch(b){case d.LEFT:return g!==d.NONE?b=!1:(a(d.LEFT),b=!0),b;case d.RIGHT:return g!==d.NONE?b=!1:(a(d.RIGHT),b=!0),b;case d.UP:return g!==d.NONE?b=!1:(a(d.UP),b=!0),b;case d.DOWN:return g!==d.NONE?b=!1:(a(d.DOWN),b=!0),b;default:return BC.Util.error("move: unsupported direction: "+b),!1}},update:function(a){BC.Animation.process(t,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,
a,1);var b=BC.Matrix.makeTranslation(p[0],p[1],p[2]);e.matrix=BC.Matrix.matrixMultiply(a,b)}},g=d.NONE,t=[],p=[0,0,0],s=BC.Math.sliceRadians(b.numCells);return e};return e}(BC||{});BC=function(e){(e.Resources=e.Resources||{}).make=function(){var c=BC.GL.textureTileSet(8,8,0.002),a=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(0,4),c.tile(0,5),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(2,4),c.tile(2,5),c.tile(1,0),c.tile(1,1),c.tile(1,2),c.tile(1,3),c.tile(1,4),c.tile(1,5)],b=c.tile(4,0),c=c.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:c}};return e}(BC||{});BC=function(e){(e.Game=e.Game||{}).run=function(){function c(a){return q.getUniformLocation(U,a)}function a(){return A.width!=A.clientWidth||A.height!=A.clientHeight?(A.width=A.clientWidth,A.height=A.clientHeight,!0):!1}function b(){var a=A.width/A.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function k(){u=!0;m=!1;B=BC.Board.make({metrics:N,audioPlayer:H});I=BC.Board.View.make({board:B,
gl:q,programLocations:W,resources:O});C.setMoveLeftListener(function(){B.move(s.LEFT)});C.setMoveRightListener(function(){B.move(s.RIGHT)});C.setMoveUpListener(function(){B.move(s.UP)});C.setMoveDownListener(function(){B.move(s.DOWN)});C.setPrimaryActionListener(function(){B.swap()});d()}function d(){r=!1;f(!1);J.reset();h()}function h(){q.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT);q.viewport(0,0,q.canvas.width,q.canvas.height);q.uniformMatrix4fv(W.projectionMatrixLocation,!1,X);var a=!r&&!m&&B;
a&&(J.tick(),m=B.update(J));I&&I.draw();a&&requestAnimationFrame(h);m&&(r=u=!1,f(!0))}function f(a){if(a){y.text(m?t:u&&r?g:e);if(a=u||m)P.draw(B.speedLevel),Q.draw(B.score),R.draw(B.elapsedTime);var b=x;a?b.show():b.hide();a=z;u?a.show():a.hide();w.fadeIn(p);D.fadeOut(p)}else w.fadeOut(p),D.fadeIn(p)}var e="b l o c k c i l l i n",g="P A U S E D",t="G A M E  O V E R",p="slow",s=BC.Constants.Direction,v=BC.Audio.Sound,u=!1,r=!1,m=!1,w=$("#main-menu"),y=$("#main-menu-title"),x=$("#main-menu-stats"),
z=$("#continue-button"),G=$("#new-game-button"),K=$("#options-button"),D=$("#game-menu"),E=$("#pause-button"),F=$(".button"),N={numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},O=BC.Resources.make(),J=BC.StopWatch.make(),H=BC.Audio.Player.make(),P=BC.Stat.View.make("#main-menu-speed-level-stat"),R=BC.Stat.View.make("#main-menu-elapsed-time-stat"),Q=BC.Stat.View.make("#main-menu-score-stat"),B,I,A=document.getElementById("canvas");if(A){var C=BC.Controller.make(A),
S=BC.Menu.Options.make({controller:C}),q=A.getContext("webgl")||A.getContext("experimental-webgl");if(q){var M=q.createTexture();q.bindTexture(q.TEXTURE_2D,M);q.texImage2D(q.TEXTURE_2D,0,q.RGBA,1,1,0,q.RGBA,q.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var L=new Image;L.src="images/textures.png";$(L).load(function(){q.bindTexture(q.TEXTURE_2D,M);q.texImage2D(q.TEXTURE_2D,0,q.RGBA,q.RGBA,q.UNSIGNED_BYTE,L);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MIN_FILTER,
q.LINEAR_MIPMAP_NEAREST);q.generateMipmap(q.TEXTURE_2D)});q.enable(q.CULL_FACE);q.enable(q.DEPTH_TEST);q.enable(q.BLEND);q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA);var T=BC.GL.loadShader(q,"vertex-shader",q.VERTEX_SHADER),V=BC.GL.loadShader(q,"fragment-shader",q.FRAGMENT_SHADER),U=BC.GL.createProgram(q,[T,V]);q.useProgram(U);var W={positionLocation:q.getAttribLocation(U,"a_position"),textureCoordLocation:q.getAttribLocation(U,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),
viewMatrixLocation:c("u_viewMatrix"),boardRotationMatrixLocation:c("u_boardRotationMatrix"),boardTranslationMatrixLocation:c("u_boardTranslationMatrix"),selectorMatrixLocation:c("u_selectorMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};a();var X=b();$(window).resize(function(){a()&&(X=b(),h())});T=l();q.uniformMatrix4fv(W.viewMatrixLocation,!1,T);F.click(function(a){H.play(v.BUTTON_CLICK);$(a.target).fadeIn(20).fadeOut(20).fadeIn(20).fadeOut(20).fadeIn(20)});
F.mouseenter(function(){H.play(v.BUTTON_HOVER)});f(!0);G.click(function(){k()});z.click(function(){d()});E.click(function(){r=!0;f(!0)});K.click(function(){S.show()});C.setMenuActionListener(function(){r?d():(r=!0,f(!0))});document.addEventListener("visibilitychange",function(){document.hidden&&(r=!0,f(!0))})}}};return e}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(e){var c=e.Cell=e.Cell||{},c=c.Chain=c.Chain||{};c.find=function(a){function b(b,d){return a.rings[b].cells[d]}function l(){for(var d=a.rings.length,l=[],k=0;k<d;k++){var h;h=k;for(var e=0,r=b(h,e),m=0;m<c;m++){var w=b(h,e);if(r.state!==w.state||r.blockStyle!=w.blockStyle)break;e+=1;e=e===c?0:e}h=e;for(e=0;e<c;)if(m=(e+h)%c,w=b(k,m),w.state!==f.BLOCK)e++;else{for(var y=1,r=e+1;r<c;r++)if(m=(r+h)%c,m=b(k,m),w.state===m.state&&w.blockStyle==m.blockStyle)y++;else break;if(y>=g){for(w=[];e<
r;e++)m=(e+h)%c,y=b(k,m),w.push({cell:y,row:k,col:m});l.push(w)}e=r}}return l}function k(){for(var d=a.rings.length,l=[],k=0;k<c;k++)for(var h=0;h<d;){var e=b(h,k);if(e.state!==f.BLOCK)h++;else{for(var r=1,m=h+1;m<d;m++){var w=b(m,k);if(e.state===w.state&&e.blockStyle==w.blockStyle)r++;else break}if(r>=g){for(e=[];h<m;h++)r=b(h,k),e.push({cell:r,row:h,col:k});l.push(e)}h=m}}return l}function d(a,b){for(var d=0;d<a.length;d++)for(var k=a[d],l=0;l<b.length;l++){var h=b[l];if(k.blockStyle===h.blockStyle&&
k.row===h.row&&k.col===h.col)return!0}return!1}function h(a,b){for(var d=0;d<a.length;d++){var k=a[d];if(k.blockStyle===b.blockStyle&&k.row===b.row&&k.col===b.col)return!0}return!1}var f=BC.Cell.CellState,c=a.rings[0].cells.length,g=3;return function(){for(var a=[],b=l(),f=k();0<b.length;){var g=b.shift();for(a.push(g);;){for(var c=!1,e=0;e<f.length;e++)if(d(g,f[e])){for(c=0;c<f[e].length;c++)h(g,f[e][c])||g.push(f[e][c]);f.splice(e,1);c=!0}if(!c)break;c=!1;for(e=0;e<b.length;e++)if(d(g,b[e])){for(c=
0;c<b[e].length;c++)h(g,b[e][c])||g.push(b[e][c]);b.splice(e,1);c=!0}if(!c)break}}for(;0<f.length;)g=f.shift(),a.push(g);for(e=0;e<a.length;e++)a[e].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(k){k=BC.Cell.Chain.find(k);for(var d=0;d<k.length;d++){var c=k[d];l.push(c);for(var f=0;f<c.length;f++){var e=c[f].cell;e.markBlock();b.push(e)}}if(0<b.length)switch(e=b[0],e.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:e.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){c=l[0];f=!0;for(d=0;d<c.length;d++)e=c[d].cell,f&=!e.isClearing();if(f){for(d=0;d<c.length;d++)e=c[d].cell,e.state===a.EMPTY_NO_DROP&&(e.state=a.EMPTY);l.shift()}}return{newChains:k,pendingChainCount:l.length}}}};return e}(BC||{});BC=function(e){(e.Stage=e.Stage||{}).make=function(c,a){a+=c.ringHeight/2-0.01;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return e}(BC||{});BC=function(e){var c=e.Util=e.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return e}(BC||{});BC=function(e){var c=e.Selector=e.Selector||{};(c.View=c.View||{}).make=function(a,b,c){var k=-b.ringHeight/2,d=-k;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var e=b.length-2,f=[],n=0;f[n++]=b[e]+0.001;f[n++]=k;f[n++]=-b[e+1]-0.001;f[n++]=b[0]+0.001;f[n++]=k;f[n++]=-b[1]-0.001;f[n++]=b[0]+0.001;f[n++]=d;f[n++]=-b[1]-0.001;f[n++]=b[e]+0.001;f[n++]=d;f[n++]=-b[e+1]-0.001;f[n++]=b[0]+0.001;f[n++]=k;f[n++]=-b[1]-0.001;f[n++]=b[2]+0.001;f[n++]=k;f[n++]=-b[3]-0.001;f[n++]=b[2]+
0.001;f[n++]=d;f[n++]=-b[3]-0.001;f[n++]=b[0]+0.001;f[n++]=d;f[n++]=-b[1]-0.001;var g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);k=c.textureCoord(0,0);d=c.textureCoord(1,0);b=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(k,d,b,c,k,d,b,c));var t=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,t);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var p=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),s=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
s);a.bufferData(a.ELEMENT_ARRAY_BUFFER,p,a.STATIC_DRAW);return{draw:function(b){var d=b.positionLocation,c=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,g);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,t);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s);a.drawElements(a.TRIANGLES,p.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){var c=e.Matrix=e.Matrix||{};c.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var e=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,e[0],e[1],e[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,c,e){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(c-e);return[a/b,0,0,0,0,a,0,0,0,0,(c+e)*d,-1,0,0,c*e*d*2,0]};c.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],c=a[1],e=a[2],d=a[3],h=a[4],f=a[5],n=a[6],g=a[7],t=a[8],p=a[9],s=a[10],v=a[11],u=a[12],r=a[13],m=a[14];a=
a[15];var w=s*a,y=m*v,x=n*a,z=m*g,G=n*v,K=s*g,D=e*a,E=m*d,F=e*v,N=s*d,O=e*g,J=n*d,H=t*r,P=u*p,R=h*r,Q=u*f,B=h*p,I=t*f,A=b*r,C=u*c,S=b*p,q=t*c,M=b*f,L=h*c,T=w*f+z*p+G*r-(y*f+x*p+K*r),V=y*c+D*p+N*r-(w*c+E*p+F*r),r=x*c+E*f+O*r-(z*c+D*f+J*r),c=K*c+F*f+J*p-(G*c+N*f+O*p),f=1/(b*T+h*V+t*r+u*c);return[f*T,f*V,f*r,f*c,f*(y*h+x*t+K*u-(w*h+z*t+G*u)),f*(w*b+E*t+F*u-(y*b+D*t+N*u)),f*(z*b+D*h+J*u-(x*b+E*h+O*u)),f*(G*b+N*h+O*t-(K*b+F*h+J*t)),f*(H*g+Q*v+B*a-(P*g+R*v+I*a)),f*(P*d+A*v+q*a-(H*d+C*v+S*a)),f*(R*d+C*g+
M*a-(Q*d+A*g+L*a)),f*(I*d+S*g+L*v-(B*d+q*g+M*v)),f*(R*s+I*m+P*n-(B*m+H*n+Q*s)),f*(S*m+H*e+C*s-(A*s+q*m+P*e)),f*(A*n+L*m+Q*e-(M*m+R*e+C*n)),f*(M*s+B*e+q*n-(S*n+L*s+I*e))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.Drop=c.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,c=BC.Constants.Direction,e=[];return{update:function(d){for(var h=0;h<d.rings.length;h++)for(var f=0;f<a.numCells;f++){var n=d,g=h,t=f,p=n.rings[g].cells[t];p.state===b.BLOCK&&(g+=1,g>=n.rings.length||(n=n.rings[g].cells[t],p.state===b.BLOCK&&n.state==b.EMPTY&&(p=p.sendBlock(0.05),n.receiveBlock(0.05,c.UP,p),e.push(n))))}a:{for(;0<e.length;){if(e[0].hasDroppingBlock()){d=!0;break a}e.shift()}d=
!1}return d}}};return e}(BC||{});BC=function(e){(e.Constants=e.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return e}(BC||{});BC=function(e){var c=e.Animation=e.Animation||{};c.make=function(a){var b=a.duration,c=a.startCallback||function(){},e=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},h=0,f=!1,n=!1;return{update:function(a){f||(f=!0,c());var t=a.deltaTime;h+t>b&&(t=b-h);h+=t;a=e({now:a.now,deltaTime:t,elapsedPercent:h/b,deltaPercent:t/b});h>=b&&(n=!0,d());return a},isDone:function(){return n}}};c.process=function(a,b){var c=!1;if(0<a.length){var e=a[0],c=c|e.update(b);e.isDone()&&a.shift()}return c};
return e}(BC||{});BC=function(e){var c=e.Stage=e.Stage||{};(c.View=c.View||{}).make=function(a,b,c){b=[];var e=0;b[e++]=-1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=-1;b[e++]=0;b[e++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var e=c.textureCoord(1,0),h=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,e,h,c,b,e,h,c));var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),g=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation,h=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(h,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return e}(BC||{});BC=function(e){(e.Board=e.Board||{}).make=function(c){function a(a){a=BC.Ring.make({metrics:k,translationY:-k.ringHeight*w,selectable:a,audioPlayer:d});m.push(a);w++}function b(){x.translationMatrix=BC.Matrix.makeTranslation(u[0],u[1],u[2])}function e(){var a=BC.Matrix.makeXRotation(r[0]),b=BC.Matrix.makeYRotation(r[1]),d=BC.Matrix.makeZRotation(r[2]),b=BC.Matrix.matrixMultiply(d,b),b=BC.Matrix.matrixMultiply(b,a);x.rotationMatrix=b}var k=c.metrics,d=c.audioPlayer,h=BC.Cell.CellState,f=BC.Constants.Direction,
n=BC.Audio.Sound,g=11*k.ringHeight,t=2*k.ringHeight,p=0,s=k.numCells-1;c=5.5*-k.ringHeight-k.ringHeight/2;for(var v=k.ringHeight*k.numRings,u=[0,c+v,0],r=[0,0,0],m=[],w=0,y=0;y<k.numRings;y++)a(!0);for(y=0;2>y;y++)a(!1);var x={metrics:k,rings:m,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case f.LEFT:z.move(f.LEFT)&&(s--,0>s&&(s=k.numCells-1));break;case f.RIGHT:z.move(f.RIGHT)&&(s++,s>=k.numCells&&(s=0));break;case f.UP:0<p&&z.move(f.UP)&&p--;
break;case f.DOWN:p+1<x.rings.length&&m[p+1].isSelectable()&&z.move(f.DOWN)&&p++}},rotate:function(a){r[1]+=a},swap:function(){var a=m[p].cells[s%k.numCells],b=m[p].cells[(s+1)%k.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var e=a.blockStyle,c=b.blockStyle;a.state!==h.EMPTY&&a.state!==h.EMPTY_NO_DROP||b.state!==h.BLOCK?a.state!==h.BLOCK||b.state!==h.EMPTY&&b.state!==h.EMPTY_NO_DROP?a.state===h.BLOCK&&b.state===h.BLOCK&&(a.receiveBlock(0.1,f.RIGHT,c),b.receiveBlock(0.1,f.LEFT,e),d.play(n.CELL_SWAP)):
(a.sendBlock(0.1,f.RIGHT),b.receiveBlock(0.1,f.LEFT,e),d.play(n.CELL_SWAP)):(b.sendBlock(0.1,f.LEFT),a.receiveBlock(0.1,f.RIGHT,c),d.play(n.CELL_SWAP))},update:function(d){for(var c=0;c<m.length;c++)for(var f=0;f<k.numCells;f++)m[c].cells[f%k.numCells].update(d);for(var c=0|K.update(x),f=G.update(x),h=0;h<f.newChains.length;h++)F.value+=100*f.newChains[h].length;c|=0<f.pendingChainCount;c||(c=(0.02+0.01*(D.value-1))*d.deltaTime,v+c>g&&(c=g-v),v+=c,u[1]+=c);E.value+=d.deltaTime;D.value=1+Math.floor(E.value/
30);z.update(d);b();for(e();0<m.length&&m[0].isEmpty();)m.shift(),v-=k.ringHeight,p--;for(d=v-k.ringHeight*m.length;d>-t;)a(!1),d-=k.ringHeight;for(d=m.length-1;0<=d&&!m[d].isSelectable();d--)0<=v-k.ringHeight*(d+1)&&m[d].setSelectable(!0);return v>=g}};b();e();var z=BC.Selector.make({metrics:k,board:x,audioPlayer:d});x.selector=z;c=BC.Stage.make(k,c);x.stage=c;var G=BC.Cell.Chain.makeManager(),K=BC.Cell.Drop.makeManager(k),D=BC.Stat.make({value:1,unit:BC.Stat.Unit.INTEGER});x.speedLevel=D;var E=
BC.Stat.make({value:0,unit:BC.Stat.Unit.SECONDS});x.elapsedTime=E;var F=BC.Stat.make({value:0,unit:BC.Stat.Unit.INTEGER});x.score=F;return x};return e}(BC||{});BC=function(e){var c=e.Menu=e.Menu||{};(c.Options=c.Options||{}).make=function(a){function b(a,b){c(a,g.getKeyCode(b));a.click(function(){a.text(f);g.assign(b,function(b){c(a,b)})})}function c(a,b){a.text(h[b]||b)}function e(){t.fadeOut(n)}var d=BC.Controller.Key,h={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",
50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",
114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},f="PRESS KEY",n="slow",g=a.controller,t=$("#options-menu");a=$("#up-button",t);var p=$("#down-button",t),s=$("#left-button",t),v=$("#right-button",t),u=$("#swap-button",t),r=$("#menu-button",t),m=$("#close-button",t);b(a,d.UP);b(p,d.DOWN);b(s,d.LEFT);
b(v,d.RIGHT);b(u,d.PRIMARY_ACTION);b(r,d.MENU_ACTION);m.click(function(){e()});return{show:function(){t.fadeIn(n)},hide:e}};return e}(BC||{});BC=function(e){var c=e.Controller=e.Controller||{};c.Key={UP:0,DOWN:1,LEFT:2,RIGHT:3,PRIMARY_ACTION:4,MENU_ACTION:5};c.make=function(a){function b(a,b,d){t[a]=b;p[a]=parseInt(s[b],10)||d}var c=BC.Controller.Key,e=function(){},d=function(){},h=function(){},f=function(){},n=function(){},g=function(){},t={},p={},s=localStorage||{},v,u,r=0,m=0;b(c.UP,"bc.controller.up",38);b(c.DOWN,"bc.controller.down",40);b(c.LEFT,"bc.controller.left",37);b(c.RIGHT,"bc.controller.right",39);b(c.PRIMARY_ACTION,"bc.controller.primaryAction",
32);b(c.MENU_ACTION,"bc.controller.menuAction",27);$(document).keydown(function(a){if(null!=v)return p[v]=a.keyCode,s[t[v]]=a.keyCode,v=null,u.call(null,a.keyCode),!1;switch(a.keyCode){case p[c.LEFT]:e.call();break;case p[c.RIGHT]:d.call();break;case p[c.UP]:h.call();break;case p[c.DOWN]:f.call();break;case p[c.PRIMARY_ACTION]:n.call();break;case p[c.MENU_ACTION]:g.call();break;default:console.log(p),console.log(a.keyCode)}return!1});$(a).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];
switch(a.type){case "touchstart":r=b.pageX;m=b.pageY;break;case "touchend":var c=b.pageX-r,g=b.pageY-m,l=Math.abs(c),p=Math.abs(g);a=function(){return 20<p?(0<g?f.call():h.call(),!0):!1};b=function(){return 20<l?(0<c?e.call():d.call(),!0):!1};if(l>p){if(b()||a())break}else if(a()||b())break;n.call()}return!1});return{setMoveLeftListener:function(a){e=a},setMoveRightListener:function(a){d=a},setMoveUpListener:function(a){h=a},setMoveDownListener:function(a){f=a},setPrimaryActionListener:function(a){n=
a},setMenuActionListener:function(a){g=a},assign:function(a,b){v=a;u=b},getKeyCode:function(a){return p[a]}}};return e}(BC||{});BC=function(e){var c=e.Cell=e.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function e(b,d){var c=d.positionLocation,f=d.textureCoordLocation,g=d.yellowBoostLocation,h=d.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,t);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,p[b.blockStyle]);a.enableVertexAttribArray(f);a.vertexAttribPointer(f,2,a.FLOAT,!1,0,0);a.uniform1f(g,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s);a.drawElements(a.TRIANGLES,
v,a.UNSIGNED_SHORT,0)}var d=b.numCells,h=b.ringOuterRadius,f=b.ringHeight/2,n=-f,g=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,g);h=BC.Math.circlePoints(h,d,g);d=0;g=[];g[d++]=b[0];g[d++]=f;g[d++]=-b[1];g[d++]=h[0];g[d++]=f;g[d++]=-h[1];g[d++]=h[2];g[d++]=f;g[d++]=-h[3];g[d++]=b[2];g[d++]=f;g[d++]=-b[3];g[d++]=h[0];g[d++]=n;g[d++]=-h[1];g[d++]=b[0];g[d++]=n;g[d++]=-b[1];g[d++]=b[2];g[d++]=n;g[d++]=-b[3];g[d++]=h[2];g[d++]=n;g[d++]=-h[3];g[d++]=b[0];g[d++]=f;g[d++]=-b[1];g[d++]=b[0];g[d++]=
n;g[d++]=-b[1];g[d++]=h[0];g[d++]=n;g[d++]=-h[1];g[d++]=h[0];g[d++]=f;g[d++]=-h[1];g[d++]=h[2];g[d++]=f;g[d++]=-h[3];g[d++]=h[2];g[d++]=n;g[d++]=-h[3];g[d++]=b[2];g[d++]=n;g[d++]=-b[3];g[d++]=b[2];g[d++]=f;g[d++]=-b[3];g[d++]=h[0];g[d++]=f;g[d++]=-h[1];g[d++]=h[0];g[d++]=n;g[d++]=-h[1];g[d++]=h[2];g[d++]=n;g[d++]=-h[3];g[d++]=h[2];g[d++]=f;g[d++]=-h[3];g[d++]=b[2];g[d++]=f;g[d++]=-b[3];g[d++]=b[2];g[d++]=n;g[d++]=-b[3];g[d++]=b[0];g[d++]=n;g[d++]=-b[1];g[d++]=b[0];g[d++]=f;g[d++]=-b[1];var t=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,t);a.bufferData(a.ARRAY_BUFFER,new Float32Array(g),a.STATIC_DRAW);f=[];for(d=0;d<c.length;d++)for(n=c[d],f[d]=[],h=b=0;6>b;b++)g=n.textureCoord(0,0),f[d][h++]=g[0],f[d][h++]=g[1],g=n.textureCoord(0,1),f[d][h++]=g[0],f[d][h++]=g[1],g=n.textureCoord(1,1),f[d][h++]=g[0],f[d][h++]=g[1],g=n.textureCoord(1,0),f[d][h++]=g[0],f[d][h++]=g[1];for(var p=[],d=0;d<c.length;d++)p[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,p[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(f[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var s=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,s);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var v=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,d){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,d),a.enable(a.CULL_FACE))}}};return e}(BC||{});BC=function(e){var c=e.Stat=e.Stat||{};c.Unit={INTEGER:0,SECONDS:1};c.make=function(a){return{value:a.value,unit:a.unit}};return e}(BC||{});BC=function(e){var c=e.Stat=e.Stat||{},a;(c.View=c.View||{}).make=function(b){if(!a){var c=BC.Stat.Unit;a={};a[c.INTEGER]=function(a){return a};a[c.SECONDS]=function(a){var b=Math.floor(a/3600);a-=3600*b;var c=Math.floor(a/60);a=Math.floor(a-60*c);10>b&&(b="0"+b);10>c&&(c="0"+c);10>a&&(a="0"+a);return b+":"+c+":"+a}}var e=$(b);return{draw:function(b){e.text((0,a[b.unit])(b.value))}}};return e}(BC||{});BC=function(e){(e.StopWatch=e.StopWatch||{}).make=function(){function c(){a.then=0.001*Date.now()}var a={reset:c,tick:function(){a.now=0.001*Date.now();a.deltaTime=a.now-a.then;a.then=a.now}};c();return a};return e}(BC||{});
