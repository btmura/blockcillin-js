var BC=function(f){var c=f.Matrix=f.Matrix||{};c.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var d=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,d[0],d[1],d[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,c,d){a=Math.tan(0.5*Math.PI-0.5*a);var k=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,(c+d)*k,-1,0,0,c*d*k*2,0]};c.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],c=a[1],d=a[2],k=a[3],e=a[4],g=a[5],h=a[6],f=a[7],l=a[8],p=a[9],n=a[10],r=a[11],t=a[12],s=a[13],v=a[14];a=
a[15];var w=n*a,x=v*r,y=h*a,z=v*f,A=h*r,B=n*f,q=d*a,C=v*k,D=d*r,E=n*k,F=d*f,G=h*k,H=l*s,I=t*p,J=e*s,K=t*g,L=e*p,M=l*g,N=b*s,O=t*c,P=b*p,Q=l*c,R=b*g,S=e*c,T=w*g+z*p+A*s-(x*g+y*p+B*s),U=x*c+q*p+E*s-(w*c+C*p+D*s),s=y*c+C*g+F*s-(z*c+q*g+G*s),c=B*c+D*g+G*p-(A*c+E*g+F*p),g=1/(b*T+e*U+l*s+t*c);return[g*T,g*U,g*s,g*c,g*(x*e+y*l+B*t-(w*e+z*l+A*t)),g*(w*b+C*l+D*t-(x*b+q*l+E*t)),g*(z*b+q*e+G*t-(y*b+C*e+F*t)),g*(A*b+E*e+F*l-(B*b+D*e+G*l)),g*(H*f+K*r+L*a-(I*f+J*r+M*a)),g*(I*k+N*r+Q*a-(H*k+O*r+P*a)),g*(J*k+O*f+
R*a-(K*k+N*f+S*a)),g*(M*k+P*f+S*r-(L*k+Q*f+R*r)),g*(J*n+M*v+I*h-(L*v+H*h+K*n)),g*(P*v+H*d+O*n-(N*n+Q*v+I*d)),g*(N*h+S*v+K*d-(R*v+J*d+O*h)),g*(R*n+L*d+Q*h-(P*h+S*n+M*d))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return f}(BC||{});BC=function(f){(f.CellView=f.CellView||{}).make=function(c,a,b){function u(a,b){var e=b.positionLocation,d=b.textureCoordLocation,g=b.yellowBoostLocation,h=b.alphaLocation;c.bindBuffer(c.ARRAY_BUFFER,f);c.enableVertexAttribArray(e);c.vertexAttribPointer(e,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,l[a.blockStyle]);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0);c.uniform1f(g,a.yellowBoost);c.uniform1f(h,a.alpha);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,p);c.drawElements(c.TRIANGLES,
n,c.UNSIGNED_SHORT,0)}var d=a.numCells,k=a.ringOuterRadius,e=a.ringHeight/2,g=-e,h=-Math.PI/2;a=BC.Math.circlePoints(a.ringInnerRadius,d,h);k=BC.Math.circlePoints(k,d,h);d=0;h=[];h[d++]=a[0];h[d++]=e;h[d++]=-a[1];h[d++]=k[0];h[d++]=e;h[d++]=-k[1];h[d++]=k[2];h[d++]=e;h[d++]=-k[3];h[d++]=a[2];h[d++]=e;h[d++]=-a[3];h[d++]=a[0];h[d++]=e;h[d++]=-a[1];h[d++]=a[0];h[d++]=g;h[d++]=-a[1];h[d++]=k[0];h[d++]=g;h[d++]=-k[1];h[d++]=k[0];h[d++]=e;h[d++]=-k[1];h[d++]=k[2];h[d++]=e;h[d++]=-k[3];h[d++]=k[2];h[d++]=
g;h[d++]=-k[3];h[d++]=a[2];h[d++]=g;h[d++]=-a[3];h[d++]=a[2];h[d++]=e;h[d++]=-a[3];h[d++]=k[0];h[d++]=e;h[d++]=-k[1];h[d++]=k[0];h[d++]=g;h[d++]=-k[1];h[d++]=k[2];h[d++]=g;h[d++]=-k[3];h[d++]=k[2];h[d++]=e;h[d++]=-k[3];h[d++]=a[2];h[d++]=e;h[d++]=-a[3];h[d++]=a[2];h[d++]=g;h[d++]=-a[3];h[d++]=a[0];h[d++]=g;h[d++]=-a[1];h[d++]=a[0];h[d++]=e;h[d++]=-a[1];var f=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,f);c.bufferData(c.ARRAY_BUFFER,new Float32Array(h),c.STATIC_DRAW);e=[];for(d=0;d<b.length;d++)for(g=
b[d],e[d]=[],k=a=0;5>a;a++)h=g.textureCoord(0,0),e[d][k++]=h[0],e[d][k++]=h[1],h=g.textureCoord(0,1),e[d][k++]=h[0],e[d][k++]=h[1],h=g.textureCoord(1,1),e[d][k++]=h[0],e[d][k++]=h[1],h=g.textureCoord(1,0),e[d][k++]=h[0],e[d][k++]=h[1];for(var l=[],d=0;d<b.length;d++)l[d]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,l[d]),c.bufferData(c.ARRAY_BUFFER,new Float32Array(e[d]),c.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var p=c.createBuffer();
c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,p);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);var n=b.length;return{drawOpaque:function(a,b){a.isEmpty()||a.isTransparent()||u(a,b)},drawTransparent:function(a,b){!a.isEmpty()&&a.isTransparent()&&(c.disable(c.CULL_FACE),u(a,b),c.enable(c.CULL_FACE))}}};return f}(BC||{});BC=function(f){var c=f.Animation=f.Animation||{};c.make=function(a){var b=a.duration,c=a.startCallback,d=a.updateCallback,k=a.finishCallback,e=0,g=!1,h=!1;return{update:function(a){g||(g=!0,c());var l=a.deltaTime;e+l>b&&(l=b-e);e+=l;a=d({now:a.now,deltaTime:l,elapsedPercent:e/b,deltaPercent:l/b});e>=b&&(k(),h=!0);return a},isDone:function(){return h}}};c.process=function(a,b){var c=!1;if(0<a.length){var d=a[0],c=c|d.update(b);d.isDone()&&a.shift()}return c};return f}(BC||{});BC=function(f){(f.BoardView=f.BoardView||{}).make=function(c,a,b){var u=b.boardMatrixLocation,d=b.ringMatrixLocation,k=b.cellMatrixLocation,e=BC.GL.textureTileSet(4,4,0.002),g=[e.tile(0,0),e.tile(0,1),e.tile(0,2),e.tile(0,3),e.tile(1,0),e.tile(1,1),e.tile(2,0),e.tile(2,1),e.tile(2,2),e.tile(2,3),e.tile(3,0),e.tile(3,1)],e=e.tile(1,2),h=BC.CellView.make(a,c.metrics,g),f=BC.SelectorView.make(a,c.metrics,e);return{draw:function(){a.uniformMatrix4fv(u,!1,c.matrix);for(var e=c.rings,g=0;2>g;g++)for(var n=
0;n<e.length;n++){a.uniformMatrix4fv(d,!1,e[n].matrix);for(var r=e[n].cells,t=0;t<r.length;t++)a.uniformMatrix4fv(k,!1,r[t].matrix),0==g?h.drawOpaque(r[t],b):h.drawTransparent(r[t],b)}a.uniformMatrix4fv(u,!1,c.selector.matrix);a.uniformMatrix4fv(d,!1,BC.Matrix.identity);a.uniformMatrix4fv(k,!1,BC.Matrix.identity);f.draw(b)}}};return f}(BC||{});BC=function(f){(f.SelectorView=f.SelectorView||{}).make=function(c,a,b){var f=-a.ringHeight/2,d=-f;a=BC.Math.circlePoints(a.ringOuterRadius+0.01,a.numCells,-Math.PI/2);var k=a.length-2,e=[],g=0;e[g++]=a[k]+0.001;e[g++]=f;e[g++]=-a[k+1]-0.001;e[g++]=a[0]+0.001;e[g++]=f;e[g++]=-a[1]-0.001;e[g++]=a[0]+0.001;e[g++]=d;e[g++]=-a[1]-0.001;e[g++]=a[k]+0.001;e[g++]=d;e[g++]=-a[k+1]-0.001;e[g++]=a[0]+0.001;e[g++]=f;e[g++]=-a[1]-0.001;e[g++]=a[2]+0.001;e[g++]=f;e[g++]=-a[3]-0.001;e[g++]=a[2]+0.001;e[g++]=d;
e[g++]=-a[3]-0.001;e[g++]=a[0]+0.001;e[g++]=d;e[g++]=-a[1]-0.001;var h=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,h);c.bufferData(c.ARRAY_BUFFER,new Float32Array(e),c.STATIC_DRAW);f=b.textureCoord(0,0);d=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(f,d,a,b,f,d,a,b));var m=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,m);c.bufferData(c.ARRAY_BUFFER,b,c.STATIC_DRAW);var l=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),p=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
p);c.bufferData(c.ELEMENT_ARRAY_BUFFER,l,c.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation,e=a.textureCoordLocation;a=a.alphaLocation;c.bindBuffer(c.ARRAY_BUFFER,h);c.enableVertexAttribArray(b);c.vertexAttribPointer(b,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,m);c.enableVertexAttribArray(e);c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0);c.uniform1f(a,1);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,p);c.drawElements(c.TRIANGLES,l.length,c.UNSIGNED_SHORT,0)}}};return f}(BC||{});BC=function(f){(f.Constants=f.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return f}(BC||{});BC=function(f){(f.Board=f.Board||{}).make=function(c){function a(a,h){function k(a){return a.state===e.BLOCK&&a.blockStyle===l.blockStyle}var l=b(a,h);if(l.state!==e.BLOCK)return!1;for(var p=[],n=[],m=0,q=f(h);q!=h;q=f(q)){var r=b(a,q);if(k(r))p.push({cell:r,row:a,col:--m});else break}m=0;for(q=d(h);q!=h;q=d(q))if(r=b(a,q),k(r))p.push({cell:r,row:a,col:++m});else break;for(m=a-1;0<=m;m--)if(q=b(m,h),k(q))n.push({cell:q,row:m,col:0});else break;for(m=a+1;m<c.numRings;m++)if(q=b(m,h),k(q))n.push({cell:q,
row:m,col:0});else break;q=[];p.length+1>=g&&(q=q.concat(p));n.length+1>=g&&(q=q.concat(n));0<q.length&&q.push({cell:l,row:a,col:0});q.sort(function(a,b){return 0!=a.row-b.row?a.row-b.row:0!=a.col-b.col?a.col-b.col:0});for(m=0;m<q.length;m++)q[m].cell.markBlock(),t.push(q[m].cell)}function b(a,b){return l.rings[a].cells[b]}function f(a){a-=1;return 0>a?c.numCells-1:a}function d(a){a+=1;return a===c.numCells?0:a}for(var k=BC.Constants.Direction,e=BC.Cell.CellState,g=3,h=[],m=0;m<c.numRings;m++)h[m]=
BC.Ring.make(m,c);var l={rings:h,matrix:BC.Matrix.identity,metrics:c,move:function(a){switch(a){case k.LEFT:s.move(k.LEFT)&&(n--,0>n&&(n=c.numCells-1));break;case k.RIGHT:s.move(k.RIGHT)&&(n++,n>=c.numCells&&(n=0));break;case k.UP:0<p&&s.move(k.UP)&&p--;break;case k.DOWN:p+1<l.rings.length&&s.move(k.DOWN)&&p++}},rotate:function(a){r[1]+=a},swap:function(){var a=l.rings[p],b=a.cells[n],a=a.cells[(n+1)%a.cells.length],c=b.blockStyle,d=a.blockStyle;console.log(b.state+", "+a.state);b.state===e.EMPTY&&
a.state===e.BLOCK?(a.sendBlock(0.125,k.LEFT),b.receiveBlock(0.125,k.RIGHT,d)):b.state===e.BLOCK&&a.state===e.EMPTY?(b.sendBlock(0.125,k.RIGHT),a.receiveBlock(0.125,k.LEFT,c)):b.state===e.BLOCK&&a.state===e.BLOCK&&(b.receiveBlock(0.125,k.RIGHT,d),a.receiveBlock(0.125,k.LEFT,c))},update:function(d){for(var h=0;h<c.numRings;h++)for(var g=0;g<c.numCells;g++){var f=h,u=g;a(f,u);var p=u;0<t.length||(u=b(f,p),u.state===e.BLOCK&&(f+=1,f>=c.numRings||(f=b(f,p),u.state===e.BLOCK&&f.state==e.EMPTY&&(u=u.sendBlock(0.075),
f.receiveBlock(0.075,k.UP,u)))))}for(h=0;h<c.numRings;h++)for(g=0;g<c.numCells;g++)b(h,g).update(d);if(0<t.length)switch(h=t[0],h.state){case e.MARK_TO_CLEAR_BLOCK:break;case e.READY_TO_CLEAR_BLOCK:h.clearBlock();break;case e.CLEARING_BLOCK:break;default:t.shift()}s.update(d);d=BC.Matrix.makeXRotation(r[0]);h=BC.Matrix.makeYRotation(r[1]);g=BC.Matrix.makeZRotation(r[2]);h=BC.Matrix.matrixMultiply(g,h);h=BC.Matrix.matrixMultiply(h,d);l.matrix=h}},p=0,n=c.numCells-1,r=[0,0,0],t=[],s=BC.Selector.make(c,
l);l.selector=s;return l};return f}(BC||{});BC=function(f){(f.Ring=f.Ring||{}).make=function(c,a){for(var b=[],f=0;f<a.numCells;f++)b[f]=BC.Cell.make(f,a);f=BC.Matrix.makeTranslation(0,-c*a.ringHeight,0);return{cells:b,matrix:f}};return f}(BC||{});BC=function(f){(f.Selector=f.Selector||{}).make=function(c,a){function b(b){g.push(BC.Animation.make({duration:d,startCallback:function(){e=b},updateCallback:function(b){var d=c.ringHeight*b.deltaPercent;b=m*b.deltaPercent;switch(e){case f.UP:return h[1]+=d,!0;case f.DOWN:return h[1]-=d,!0;case f.LEFT:return a.rotate(b),!0;case f.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){e=f.NONE}}))}var f=BC.Constants.Direction,d=0.025,k={matrix:BC.Matrix.identity,move:function(a){switch(a){case f.LEFT:return e!==
f.NONE?a=!1:(b(f.LEFT),a=!0),a;case f.RIGHT:return e!==f.NONE?a=!1:(b(f.RIGHT),a=!0),a;case f.UP:return e!==f.NONE?a=!1:(b(f.UP),a=!0),a;case f.DOWN:return e!==f.NONE?a=!1:(b(f.DOWN),a=!0),a}},update:function(a){BC.Animation.process(g,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);k.matrix=BC.Matrix.matrixMultiply(a,b)}},e=f.NONE,g=[],h=[0,0,0],m=BC.Math.sliceRadians(c.numCells);return k};return f}(BC||{});BC=function(f){(f.Game=f.Game||{}).run=function(){function c(a){return g.getUniformLocation(n,a)}function a(){return e.width!=e.clientWidth||e.height!=e.clientHeight?(e.width=e.clientWidth,e.height=e.clientHeight,!0):!1}function b(){var a=e.width/e.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function f(){var a=BC.Matrix.makeLookAt([0,0.5,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function d(){g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT);g.viewport(0,0,g.canvas.width,
g.canvas.height);g.uniformMatrix4fv(r.projectionMatrixLocation,!1,t);w.tick();s.update(w);v.draw();requestAnimationFrame(d)}var k=BC.Constants.Direction,e=document.getElementById("canvas");if(e){var g=e.getContext("webgl")||e.getContext("experimental-webgl");if(g){var h=g.createTexture();g.bindTexture(g.TEXTURE_2D,h);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,1,1,0,g.RGBA,g.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var m=new Image;m.src="images/textures.png";$(m).load(function(){g.bindTexture(g.TEXTURE_2D,
h);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,m);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR_MIPMAP_NEAREST);g.generateMipmap(g.TEXTURE_2D)});g.enable(g.CULL_FACE);g.enable(g.DEPTH_TEST);g.enable(g.BLEND);g.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA);var l=BC.GL.loadShader(g,"vertex-shader",g.VERTEX_SHADER),p=BC.GL.loadShader(g,"fragment-shader",g.FRAGMENT_SHADER),n=BC.GL.createProgram(g,[l,p]);g.useProgram(n);
var r={positionLocation:g.getAttribLocation(n,"a_position"),textureCoordLocation:g.getAttribLocation(n,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardMatrixLocation:c("u_boardMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};a();var t=b();$(window).resize(function(){a()&&(t=b())});l=f();g.uniformMatrix4fv(r.viewMatrixLocation,!1,l);var s=
BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),v=BC.BoardView.make(s,g,r),l=BC.Controller.make(e);l.setMoveLeftListener(function(){s.move(k.LEFT)});l.setMoveRightListener(function(){s.move(k.RIGHT)});l.setMoveUpListener(function(){s.move(k.UP)});l.setMoveDownListener(function(){s.move(k.DOWN)});l.setPrimaryActionListener(function(){s.swap()});var w=BC.StopWatch.make();d()}}};return f}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(f){var c=f.Math=f.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var d=2*Math.PI/b,f=[],e=0;e<b;e++)f[2*e]=a*Math.cos(c+e*d),f[2*e+1]=a*Math.sin(c+e*d);return f};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return f}(BC||{});BC=function(f){var c=f.Cell=f.Cell||{};c.CellState={EMPTY:0,EMPTY_RESERVED:1,BLOCK:2,RECEIVING_BLOCK:3,MARK_TO_CLEAR_BLOCK:4,READY_TO_CLEAR_BLOCK:5,CLEARING_BLOCK:6};c.make=function(a,b){var c=BC.Cell.CellState,d=BC.Constants.Direction,f=BC.Math.randomInt(b.numBlockTypes),e=[],g=BC.Math.sliceRadians(b.numCells),h=[0,a*g,0],m=[0,0,0],l={matrix:BC.Matrix.makeYRotation(h[1]),state:c.BLOCK,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){l.state=c.MARK_TO_CLEAR_BLOCK;var a=BC.Animation.make({duration:0.75,
startCallback:function(){},updateCallback:function(a){l.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){l.yellowBoost=0}}),h=BC.Animation.make({duration:0.25,startCallback:function(){l.blockStyle+=b.numBlockTypes},updateCallback:function(a){return!1},finishCallback:function(){l.state=c.READY_TO_CLEAR_BLOCK}});e.push(a,h)},clearBlock:function(){l.state=c.CLEARING_BLOCK;var a=BC.Animation.make({duration:0.25,startCallback:function(){},updateCallback:function(a){l.alpha=
1-a.elapsedPercent;return!1},finishCallback:function(){l.state=c.EMPTY;l.alpha=1}});e.push(a)},sendBlock:function(a){var b=l.blockStyle;e.push(BC.Animation.make({duration:a,startCallback:function(){l.blockStyle=0;l.state=c.EMPTY_RESERVED},updateCallback:function(a){return!1},finishCallback:function(){l.state=c.EMPTY}}));return b},receiveBlock:function(a,f,k){e.push(BC.Animation.make({duration:a,startCallback:function(){l.state=c.RECEIVING_BLOCK;l.blockStyle=k;switch(f){case d.LEFT:h[1]-=g;break;case d.RIGHT:h[1]+=
g;break;case d.UP:m[1]=b.ringHeight}},updateCallback:function(a){var c=g*a.deltaPercent;a=b.ringHeight*a.deltaPercent;switch(f){case d.LEFT:return h[1]+=c,!0;case d.RIGHT:return h[1]-=c,!0;case d.UP:return m[1]-=a,!0;default:return!1}},finishCallback:function(){l.state=c.BLOCK}}))},isEmpty:function(){return l.state===c.EMPTY||l.state===c.EMPTY_RESERVED},isTransparent:function(){return l.state===c.CLEARING_BLOCK},update:function(a){if(BC.Animation.process(e,a)){a=BC.Matrix.makeYRotation(h[1]);var b=
BC.Matrix.makeTranslation(m[0],m[1],m[2]);l.matrix=BC.Matrix.matrixMultiply(a,b)}}};return l};return f}(BC||{});BC=function(f){var c=f.GL=f.GL||{};c.loadShader=function(a,b,c,d){d=d||BC.Util.error;var f=document.getElementById(b);if(!f)return d("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,f.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),d("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,d){for(var f=a.createProgram(),e=0;e<b.length;e++)a.attachShader(f,b[e]);
if(c)for(e=0;e<c.length;e++)a.bindAttribLocation(f,d?d[e]:e,c[e]);a.linkProgram(f);return a.getProgramParameter(f,a.LINK_STATUS)?f:(lastError=a.getProgramInfoLog(f),error("Error in program linking: "+lastError),a.deleteProgram(f),null)};c.textureTileSet=function(a,b,c){var d=1/a,f=1/b;return{tile:function(a,b){var h=d*b,m=f*a;return{textureCoord:function(a,b){return[h+c+(d-2*c)*a,m+c+(f-2*c)*b]}}}}};return f}(BC||{});BC=function(f){(f.Util=f.Util||{}).error=function(c){window.console&&(window.console.error?window.console.error(c):window.console.log&&window.console.log(c))};return f}(BC||{});BC=function(f){(f.Controller=f.Controller||{}).make=function(c){var a=function(){},b=function(){},f=function(){},d=function(){},k=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:k.call();break;case 37:a.call();break;case 39:b.call();break;case 38:f.call();break;case 40:d.call()}return!1});var e=0,g=0;$(c).on("touchstart touchmove touchend",function(c){var m=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":e=m.pageX;g=m.pageY;break;case "touchend":c=m.pageX-
e,m=m.pageY-g,50<c?a.call():-50>c?b.call():50<m?d.call():-50>m?f.call():k.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){f=a},setMoveDownListener:function(a){d=a},setPrimaryActionListener:function(a){k=a}}};return f}(BC||{});BC=function(f){(f.StopWatch=f.StopWatch||{}).make=function(){var c={then:0.001*Date.now(),tick:function(){c.now=0.001*Date.now();c.deltaTime=c.now-c.then;c.then=c.now}};return c};return f}(BC||{});
