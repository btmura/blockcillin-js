var BC=function(h){var c=h.Matrix=h.Matrix||{};c.makeLookAt=function(a,b,f){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));f=BC.Math.cross(f,b);var c=BC.Math.cross(b,f);return[f[0],f[1],f[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,f,c){a=Math.tan(0.5*Math.PI-0.5*a);var g=1/(f-c);return[a/b,0,0,0,0,a,0,0,0,0,(f+c)*g,-1,0,0,f*c*g*2,0]};c.makeTranslation=function(a,b,f){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,f,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,f){return[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],f=a[1],c=a[2],g=a[3],e=a[4],d=a[5],h=a[6],l=a[7],q=a[8],r=a[9],s=a[10],n=a[11],u=a[12],p=a[13],m=a[14];a=
a[15];var t=s*a,v=m*n,w=h*a,x=m*l,y=h*n,z=s*l,A=c*a,B=m*g,C=c*n,D=s*g,E=c*l,F=h*g,G=q*p,H=u*r,I=e*p,J=u*d,K=e*r,L=q*d,M=b*p,N=u*f,O=b*r,P=q*f,Q=b*d,R=e*f,S=t*d+x*r+y*p-(v*d+w*r+z*p),T=v*f+A*r+D*p-(t*f+B*r+C*p),p=w*f+B*d+E*p-(x*f+A*d+F*p),f=z*f+C*d+F*r-(y*f+D*d+E*r),d=1/(b*S+e*T+q*p+u*f);return[d*S,d*T,d*p,d*f,d*(v*e+w*q+z*u-(t*e+x*q+y*u)),d*(t*b+B*q+C*u-(v*b+A*q+D*u)),d*(x*b+A*e+F*u-(w*b+B*e+E*u)),d*(y*b+D*e+E*q-(z*b+C*e+F*q)),d*(G*l+J*n+K*a-(H*l+I*n+L*a)),d*(H*g+M*n+P*a-(G*g+N*n+O*a)),d*(I*g+N*l+
Q*a-(J*g+M*l+R*a)),d*(L*g+O*l+R*n-(K*g+P*l+Q*n)),d*(I*s+L*m+H*h-(K*m+G*h+J*s)),d*(O*m+G*c+N*s-(M*s+P*m+H*c)),d*(M*h+R*m+J*c-(Q*m+I*c+N*h)),d*(Q*s+K*c+P*h-(O*h+R*s+L*c))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return h}(BC||{});BC=function(h){(h.CellView=h.CellView||{}).make=function(c,a,b){var f=a.numRingCells,k=a.outerRingRadius,g=a.ringMaxY,e=a.ringMinY,d=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,f,d);k=BC.Math.circlePoints(k,f,d);f=0;d=[];d[f++]=a[0];d[f++]=g;d[f++]=-a[1];d[f++]=k[0];d[f++]=g;d[f++]=-k[1];d[f++]=k[2];d[f++]=g;d[f++]=-k[3];d[f++]=a[2];d[f++]=g;d[f++]=-a[3];d[f++]=a[0];d[f++]=g;d[f++]=-a[1];d[f++]=a[0];d[f++]=e;d[f++]=-a[1];d[f++]=k[0];d[f++]=e;d[f++]=-k[1];d[f++]=k[0];d[f++]=g;d[f++]=-k[1];
d[f++]=k[2];d[f++]=g;d[f++]=-k[3];d[f++]=k[2];d[f++]=e;d[f++]=-k[3];d[f++]=a[2];d[f++]=e;d[f++]=-a[3];d[f++]=a[2];d[f++]=g;d[f++]=-a[3];d[f++]=k[0];d[f++]=g;d[f++]=-k[1];d[f++]=k[0];d[f++]=e;d[f++]=-k[1];d[f++]=k[2];d[f++]=e;d[f++]=-k[3];d[f++]=k[2];d[f++]=g;d[f++]=-k[3];d[f++]=a[2];d[f++]=g;d[f++]=-a[3];d[f++]=a[2];d[f++]=e;d[f++]=-a[3];d[f++]=a[0];d[f++]=e;d[f++]=-a[1];d[f++]=a[0];d[f++]=g;d[f++]=-a[1];var h=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,h);c.bufferData(c.ARRAY_BUFFER,new Float32Array(d),
c.STATIC_DRAW);g=[];for(f=0;f<b.length;f++)for(e=b[f],g[f]=[],k=a=0;5>a;a++)d=e.textureCoord(0,0),g[f][k++]=d[0],g[f][k++]=d[1],d=e.textureCoord(0,1),g[f][k++]=d[0],g[f][k++]=d[1],d=e.textureCoord(1,1),g[f][k++]=d[0],g[f][k++]=d[1],d=e.textureCoord(1,0),g[f][k++]=d[0],g[f][k++]=d[1];for(var l=[],f=0;f<b.length;f++)l[f]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,l[f]),c.bufferData(c.ARRAY_BUFFER,new Float32Array(g[f]),c.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,
14,12,14,15,16,17,18,16,18,19]);var q=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,q);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);var r=b.length;return{draw:function(a,b){var f=b.positionLocation,d=b.textureCoordLocation;c.bindBuffer(c.ARRAY_BUFFER,h);c.enableVertexAttribArray(f);c.vertexAttribPointer(f,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,l[a.blockStyle]);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,q);c.drawElements(c.TRIANGLES,
r,c.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){(h.BoardView=h.BoardView||{}).make=function(c,a,b){var f=b.boardMatrixLocation,k=b.ringMatrixLocation,g=b.cellMatrixLocation,e=BC.GL.textureTileSet(4,4,0.002),d=[e.tile(0,0),e.tile(0,1),e.tile(0,2),e.tile(0,3),e.tile(1,0),e.tile(1,1)],e=e.tile(1,2),h=BC.CellView.make(a,c,d),l=BC.SelectorView.make(a,c,e);return{draw:function(){a.uniformMatrix4fv(f,!1,c.matrix);for(var d=c.rings,e=0;e<d.length;e++){a.uniformMatrix4fv(k,!1,d[e].matrix);for(var s=d[e].cells,n=0;n<s.length;n++)a.uniformMatrix4fv(g,
!1,s[n].matrix),h.draw(s[n],b)}a.uniformMatrix4fv(f,!1,c.selector.matrix);a.uniformMatrix4fv(k,!1,BC.Matrix.identity);a.uniformMatrix4fv(g,!1,BC.Matrix.identity);l.draw(b)}}};return h}(BC||{});BC=function(h){(h.Time=h.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return h}(BC||{});BC=function(h){(h.SelectorView=h.SelectorView||{}).make=function(c,a,b){var f=a.ringMinY,k=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var g=a.length-2,e=[],d=0;e[d++]=a[g]+0.001;e[d++]=f;e[d++]=-a[g+1]-0.001;e[d++]=a[0]+0.001;e[d++]=f;e[d++]=-a[1]-0.001;e[d++]=a[0]+0.001;e[d++]=k;e[d++]=-a[1]-0.001;e[d++]=a[g]+0.001;e[d++]=k;e[d++]=-a[g+1]-0.001;e[d++]=a[0]+0.001;e[d++]=f;e[d++]=-a[1]-0.001;e[d++]=a[2]+0.001;e[d++]=f;e[d++]=-a[3]-0.001;e[d++]=a[2]+0.001;e[d++]=
k;e[d++]=-a[3]-0.001;e[d++]=a[0]+0.001;e[d++]=k;e[d++]=-a[1]-0.001;var h=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,h);c.bufferData(c.ARRAY_BUFFER,new Float32Array(e),c.STATIC_DRAW);f=b.textureCoord(0,0);k=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(f,k,a,b,f,k,a,b));var l=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,l);c.bufferData(c.ARRAY_BUFFER,b,c.STATIC_DRAW);var q=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),r=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
r);c.bufferData(c.ELEMENT_ARRAY_BUFFER,q,c.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation;a=a.textureCoordLocation;c.enable(c.BLEND);c.bindBuffer(c.ARRAY_BUFFER,h);c.enableVertexAttribArray(b);c.vertexAttribPointer(b,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,l);c.enableVertexAttribArray(a);c.vertexAttribPointer(a,2,c.FLOAT,!1,0,0);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,r);c.drawElements(c.TRIANGLES,q.length,c.UNSIGNED_SHORT,0);c.disable(c.BLEND)}}};return h}(BC||{});BC=function(h){(h.Constants=h.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).make=function(c){function a(a){for(var b=[],d=0;d<c.numRingCells;d++){var e=b,h=d,l=d,m=BC.Math.randomInt(c.numBlockStyles),l=[0,l*k,0],t=BC.Matrix.makeYRotation(l[1]);e[h]={matrix:t,state:f.NONE,blockStyle:m,elapsedSwapTime:0,rotation:l}}a=BC.Matrix.makeTranslation(0,-a*g,0);return{cells:b,matrix:a}}for(var b=BC.Constants.Direction,f={NONE:0,SWAP_LEFT:1,SWAP_RIGHT:2},k=2*Math.PI/c.numRingCells,g=c.ringMaxY-c.ringMinY,e=[],d=0;3>d;d++)e[d]=a(d);var h=BC.Selector.make(),
l={rings:e,selector:h,matrix:BC.Matrix.identity,numRingCells:c.numRingCells,innerRingRadius:c.innerRingRadius,outerRingRadius:c.outerRingRadius,ringMaxY:c.ringMaxY,ringMinY:c.ringMinY,move:function(a){switch(a){case b.LEFT:h.move(b.LEFT)&&(l.currentCell--,0>l.currentCell&&(l.currentCell=c.numRingCells-1));break;case b.RIGHT:h.move(b.RIGHT)&&(l.currentCell++,l.currentCell>=c.numRingCells&&(l.currentCell=0));break;case b.UP:0<l.currentRing&&h.move(b.UP)&&l.currentRing--;break;case b.DOWN:l.currentRing+
1<l.rings.length&&h.move(b.DOWN)&&l.currentRing++}},swap:function(){var a=l.rings[l.currentRing],b=a.cells[l.currentCell],a=a.cells[(l.currentCell+1)%a.cells.length],c=b.blockStyle;b.blockStyle=a.blockStyle;b.state=f.SWAP_RIGHT;b.rotation[1]+=k;b.elapsedSwapTime=0;a.blockStyle=c;a.state=f.SWAP_LEFT;a.rotation[1]-=k;a.elapsedSwapTime=0},update:function(a,b){for(var c=l.rings,d=0;d<c.length;d++)for(var e=c[d].cells,p=0;p<e.length;p++){var m=e[p];if(m.state==f.SWAP_LEFT||m.state==f.SWAP_RIGHT){var t=
a;0.125<m.elapsedSwapTime+a&&(t=0.125-m.elapsedSwapTime);var v=k*t/0.125;m.rotation[1]=m.state==f.SWAP_LEFT?m.rotation[1]+v:m.rotation[1]-v;m.matrix=BC.Matrix.makeYRotation(m.rotation[1]);m.elapsedSwapTime+=t;0.125<=m.elapsedSwapTime&&(m.state=f.NONE,m.elapsedSwapTime=0)}}c=BC.Matrix.makeXRotation(l.rotation[0]);d=BC.Matrix.makeYRotation(l.rotation[1]);e=BC.Matrix.makeZRotation(l.rotation[2]);d=BC.Matrix.matrixMultiply(e,d);d=BC.Matrix.matrixMultiply(d,c);l.matrix=d;h.update(a,b,g,k,l.rotation)},
currentRing:0,currentCell:c.numRingCells-1,rotation:[0,0,0]};return l};return h}(BC||{});BC=function(h){var c=h.GL=h.GL||{};c.loadShader=function(a,b,c,k){k=k||BC.Util.error;var g=document.getElementById(b);if(!g)return k("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,g.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),k("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,k){for(var g=a.createProgram(),e=0;e<b.length;e++)a.attachShader(g,b[e]);
if(c)for(e=0;e<c.length;e++)a.bindAttribLocation(g,k?k[e]:e,c[e]);a.linkProgram(g);return a.getProgramParameter(g,a.LINK_STATUS)?g:(lastError=a.getProgramInfoLog(g),error("Error in program linking: "+lastError),a.deleteProgram(g),null)};c.textureTileSet=function(a,b,c){var k=1/a,g=1/b;return{tile:function(a,b){var h=k*b,l=g*a;return{textureCoord:function(a,b){return[h+c+(k-2*c)*a,l+c+(g-2*c)*b]}}}}};return h}(BC||{});BC=function(h){(h.Selector=h.Selector||{}).make=function(){var c=BC.Constants.Direction,a={matrix:BC.Matrix.identity,move:function(a){switch(a){case c.LEFT:return b!==c.NONE?a=!1:(b=c.LEFT,k=0,a=!0),a;case c.RIGHT:return b!==c.NONE?a=!1:(b=c.RIGHT,k=0,a=!0),a;case c.UP:return b!==c.NONE?a=!1:(b=c.UP,k=0,a=!0),a;case c.DOWN:return b!==c.NONE?a=!1:(b=c.DOWN,k=0,a=!0),a}},update:function(g,e,d,h,l){if(b!==c.NONE){0.05<k+g&&(g=0.05-k);d=g*d/0.05;h=g*h/0.05;switch(b){case c.UP:f[1]+=d;break;case c.DOWN:f[1]-=
d;break;case c.LEFT:l[1]+=h;break;case c.RIGHT:l[1]-=h}k+=g;0.05<=k&&(b=c.NONE,k=0)}g=1+Math.abs(Math.sin(4*e))/25;g=BC.Matrix.makeScale(g,g,1);e=BC.Matrix.makeTranslation(f[0],f[1],f[2]);a.matrix=BC.Matrix.matrixMultiply(g,e)}},b=c.NONE,f=[0,0,0],k=0;return a};return h}(BC||{});BC=function(h){(h.Game=h.Game||{}).run=function(){function c(){return g.width!=g.clientWidth||g.height!=g.clientHeight?(g.width=g.clientWidth,g.height=g.clientHeight,!0):!1}function a(){var a=g.width/g.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){var a=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function f(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);e.viewport(0,0,e.canvas.width,e.canvas.height);e.uniformMatrix4fv(r.projectionMatrixLocation,
!1,s);var a=BC.Time.getTimeInSeconds(),b=a-t;t=a;n.update(b,a);u.draw();requestAnimationFrame(f)}var k=BC.Constants.Direction,g=document.getElementById("canvas");if(g){var e=g.getContext("webgl")||g.getContext("experimental-webgl");if(e){var d=e.createTexture();e.bindTexture(e.TEXTURE_2D,d);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var h=new Image;h.src="images/textures.png";$(h).load(function(){e.bindTexture(e.TEXTURE_2D,d);e.texImage2D(e.TEXTURE_2D,
0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST);e.generateMipmap(e.TEXTURE_2D)});e.enable(e.CULL_FACE);e.enable(e.DEPTH_TEST);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);var l=BC.GL.loadShader(e,"vertex-shader",e.VERTEX_SHADER),q=BC.GL.loadShader(e,"fragment-shader",e.FRAGMENT_SHADER),l=BC.GL.createProgram(e,[l,q]);e.useProgram(l);var r={positionLocation:e.getAttribLocation(l,
"a_position"),textureCoordLocation:e.getAttribLocation(l,"a_texcoord"),projectionMatrixLocation:e.getUniformLocation(l,"u_projectionMatrix"),viewMatrixLocation:e.getUniformLocation(l,"u_viewMatrix"),boardMatrixLocation:e.getUniformLocation(l,"u_boardMatrix"),ringMatrixLocation:e.getUniformLocation(l,"u_ringMatrix"),cellMatrixLocation:e.getUniformLocation(l,"u_cellMatrix")};c();var s=a();$(window).resize(function(){c()&&(s=a())});l=b();e.uniformMatrix4fv(r.viewMatrixLocation,!1,l);var n=BC.Board.make({numRingCells:24,
numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),u=BC.BoardView.make(n,e,r),p=0,m=0;$(g).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":p=b.pageX;m=b.pageY;break;case "touchend":a=b.pageX-p,b=b.pageY-m,50<a?n.move(k.LEFT):-50>a?n.move(k.RIGHT):50<b?n.move(k.DOWN):-50>b?n.move(k.UP):n.swap()}return!1});$(document).keydown(function(a){switch(a.keyCode){case 32:n.swap();break;case 37:n.move(k.LEFT);
break;case 39:n.move(k.RIGHT);break;case 38:n.move(k.UP);break;case 40:n.move(k.DOWN)}return!1});var t=BC.Time.getTimeInSeconds();f()}}};return h}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(h){var c=h.Math=h.Math||{};c.radians=function(a){return a*Math.PI/180};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var h=2*Math.PI/b,g=[],e=0;e<b;e++)g[2*e]=a*Math.cos(c+e*h),g[2*e+1]=a*Math.sin(c+e*h);return g};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return h}(BC||{});BC=function(h){(h.Util=h.Util||{}).error=function(c){window.console&&(window.console.error?window.console.error(c):window.console.log&&window.console.log(c))};return h}(BC||{});
