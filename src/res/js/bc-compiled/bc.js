var BC=function(g){var c=g.Matrix=g.Matrix||{};c.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var f=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,f[0],f[1],f[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,c,f){a=Math.tan(0.5*Math.PI-0.5*a);var k=1/(c-f);return[a/b,0,0,0,0,a,0,0,0,0,(c+f)*k,-1,0,0,c*f*k*2,0]};c.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],c=a[1],f=a[2],k=a[3],d=a[4],e=a[5],h=a[6],g=a[7],l=a[8],n=a[9],m=a[10],t=a[11],s=a[12],q=a[13],D=a[14];a=
a[15];var F=m*a,G=D*t,H=h*a,y=D*g,A=h*t,v=m*g,u=f*a,B=D*k,C=f*t,E=m*k,z=f*g,r=h*k,w=l*q,I=s*n,J=d*q,K=s*e,L=d*n,M=l*e,N=b*q,O=s*c,P=b*n,Q=l*c,R=b*e,S=d*c,T=F*e+y*n+A*q-(G*e+H*n+v*q),U=G*c+u*n+E*q-(F*c+B*n+C*q),q=H*c+B*e+z*q-(y*c+u*e+r*q),c=v*c+C*e+r*n-(A*c+E*e+z*n),e=1/(b*T+d*U+l*q+s*c);return[e*T,e*U,e*q,e*c,e*(G*d+H*l+v*s-(F*d+y*l+A*s)),e*(F*b+B*l+C*s-(G*b+u*l+E*s)),e*(y*b+u*d+r*s-(H*b+B*d+z*s)),e*(A*b+E*d+z*l-(v*b+C*d+r*l)),e*(w*g+K*t+L*a-(I*g+J*t+M*a)),e*(I*k+N*t+Q*a-(w*k+O*t+P*a)),e*(J*k+O*g+
R*a-(K*k+N*g+S*a)),e*(M*k+P*g+S*t-(L*k+Q*g+R*t)),e*(J*m+M*D+I*h-(L*D+w*h+K*m)),e*(P*D+w*f+O*m-(N*m+Q*D+I*f)),e*(N*h+S*D+K*f-(R*D+J*f+O*h)),e*(R*m+L*f+Q*h-(P*h+S*m+M*f))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){(g.CellView=g.CellView||{}).make=function(c,a,b){function x(a,b){var d=b.positionLocation,e=b.textureCoordLocation,f=b.yellowBoostLocation,h=b.alphaLocation;c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,l[a.blockStyle]);c.enableVertexAttribArray(e);c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0);c.uniform1f(f,a.yellowBoost);c.uniform1f(h,a.alpha);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,n);c.drawElements(c.TRIANGLES,
m,c.UNSIGNED_SHORT,0)}var f=a.numCells,k=a.ringOuterRadius,d=a.ringHeight/2,e=-d,h=-Math.PI/2;a=BC.Math.circlePoints(a.ringInnerRadius,f,h);k=BC.Math.circlePoints(k,f,h);f=0;h=[];h[f++]=a[0];h[f++]=d;h[f++]=-a[1];h[f++]=k[0];h[f++]=d;h[f++]=-k[1];h[f++]=k[2];h[f++]=d;h[f++]=-k[3];h[f++]=a[2];h[f++]=d;h[f++]=-a[3];h[f++]=a[0];h[f++]=d;h[f++]=-a[1];h[f++]=a[0];h[f++]=e;h[f++]=-a[1];h[f++]=k[0];h[f++]=e;h[f++]=-k[1];h[f++]=k[0];h[f++]=d;h[f++]=-k[1];h[f++]=k[2];h[f++]=d;h[f++]=-k[3];h[f++]=k[2];h[f++]=
e;h[f++]=-k[3];h[f++]=a[2];h[f++]=e;h[f++]=-a[3];h[f++]=a[2];h[f++]=d;h[f++]=-a[3];h[f++]=k[0];h[f++]=d;h[f++]=-k[1];h[f++]=k[0];h[f++]=e;h[f++]=-k[1];h[f++]=k[2];h[f++]=e;h[f++]=-k[3];h[f++]=k[2];h[f++]=d;h[f++]=-k[3];h[f++]=a[2];h[f++]=d;h[f++]=-a[3];h[f++]=a[2];h[f++]=e;h[f++]=-a[3];h[f++]=a[0];h[f++]=e;h[f++]=-a[1];h[f++]=a[0];h[f++]=d;h[f++]=-a[1];var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,new Float32Array(h),c.STATIC_DRAW);d=[];for(f=0;f<b.length;f++)for(e=
b[f],d[f]=[],k=a=0;5>a;a++)h=e.textureCoord(0,0),d[f][k++]=h[0],d[f][k++]=h[1],h=e.textureCoord(0,1),d[f][k++]=h[0],d[f][k++]=h[1],h=e.textureCoord(1,1),d[f][k++]=h[0],d[f][k++]=h[1],h=e.textureCoord(1,0),d[f][k++]=h[0],d[f][k++]=h[1];for(var l=[],f=0;f<b.length;f++)l[f]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,l[f]),c.bufferData(c.ARRAY_BUFFER,new Float32Array(d[f]),c.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var n=c.createBuffer();
c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,n);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);var m=b.length;return{drawOpaque:function(a,b){a.isEmpty()||a.isTransparent()||x(a,b)},drawTransparent:function(a,b){!a.isEmpty()&&a.isTransparent()&&(c.disable(c.CULL_FACE),x(a,b),c.enable(c.CULL_FACE))}}};return g}(BC||{});BC=function(g){var c=g.Animation=g.Animation||{};c.make=function(a){var b=a.duration,c=a.startCallback||function(){},f=a.updateCallback||function(){return!1},k=a.finishCallback||function(){},d=0,e=!1,h=!1;return{update:function(a){e||(e=!0,c());var l=a.deltaTime;d+l>b&&(l=b-d);d+=l;a=f({now:a.now,deltaTime:l,elapsedPercent:d/b,deltaPercent:l/b});d>=b&&(h=!0,k());return a},isDone:function(){return h}}};c.process=function(a,b){var c=!1;if(0<a.length){var f=a[0],c=c|f.update(b);f.isDone()&&a.shift()}return c};
return g}(BC||{});BC=function(g){(g.BoardView=g.BoardView||{}).make=function(c,a,b){var x=b.boardMatrixLocation,f=b.ringMatrixLocation,k=b.cellMatrixLocation,d=BC.GL.textureTileSet(4,4,0.002),e=[d.tile(0,0),d.tile(0,1),d.tile(0,2),d.tile(0,3),d.tile(1,0),d.tile(1,1),d.tile(2,0),d.tile(2,1),d.tile(2,2),d.tile(2,3),d.tile(3,0),d.tile(3,1)],d=d.tile(1,2),h=BC.CellView.make(a,c.metrics,e),g=BC.SelectorView.make(a,c.metrics,d);return{draw:function(){a.uniformMatrix4fv(x,!1,c.matrix);for(var d=c.rings,e=0;2>e;e++)for(var m=
0;m<d.length;m++){a.uniformMatrix4fv(f,!1,d[m].matrix);for(var t=d[m].cells,s=0;s<t.length;s++)a.uniformMatrix4fv(k,!1,t[s].matrix),0==e?h.drawOpaque(t[s],b):h.drawTransparent(t[s],b)}a.uniformMatrix4fv(x,!1,c.selector.matrix);a.uniformMatrix4fv(f,!1,BC.Matrix.identity);a.uniformMatrix4fv(k,!1,BC.Matrix.identity);g.draw(b)}}};return g}(BC||{});BC=function(g){(g.SelectorView=g.SelectorView||{}).make=function(c,a,b){var x=-a.ringHeight/2,f=-x;a=BC.Math.circlePoints(a.ringOuterRadius+0.01,a.numCells,-Math.PI/2);var k=a.length-2,d=[],e=0;d[e++]=a[k]+0.001;d[e++]=x;d[e++]=-a[k+1]-0.001;d[e++]=a[0]+0.001;d[e++]=x;d[e++]=-a[1]-0.001;d[e++]=a[0]+0.001;d[e++]=f;d[e++]=-a[1]-0.001;d[e++]=a[k]+0.001;d[e++]=f;d[e++]=-a[k+1]-0.001;d[e++]=a[0]+0.001;d[e++]=x;d[e++]=-a[1]-0.001;d[e++]=a[2]+0.001;d[e++]=x;d[e++]=-a[3]-0.001;d[e++]=a[2]+0.001;d[e++]=f;
d[e++]=-a[3]-0.001;d[e++]=a[0]+0.001;d[e++]=f;d[e++]=-a[1]-0.001;var h=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,h);c.bufferData(c.ARRAY_BUFFER,new Float32Array(d),c.STATIC_DRAW);x=b.textureCoord(0,0);f=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(x,f,a,b,x,f,a,b));var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,b,c.STATIC_DRAW);var l=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),n=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
n);c.bufferData(c.ELEMENT_ARRAY_BUFFER,l,c.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation,d=a.textureCoordLocation;a=a.alphaLocation;c.bindBuffer(c.ARRAY_BUFFER,h);c.enableVertexAttribArray(b);c.vertexAttribPointer(b,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0);c.uniform1f(a,1);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,n);c.drawElements(c.TRIANGLES,l.length,c.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(c){function a(a,b){return(b.state===e.BLOCK||b.state===e.MARKED_BLOCK)&&b.blockStyle===a}function b(a,b){return l.rings[a].cells[b]}function g(a){a-=1;return 0>a?c.numCells-1:a}function f(a){a+=1;return a===c.numCells?0:a}function k(a){if(0<t.length)switch(a&&t.sort(function(a,b){return 0!=a.row-b.row?a.row-b.row:0!=a.col-b.col?a.col-b.col:0}),a=t[0].cell,a.state){case e.MARKED_BLOCK:case e.FREEZING_BLOCK:break;case e.READY_TO_CLEAR_BLOCK:a.clearBlock();
break;case e.CLEARING_BLOCK:break;default:t.shift()}}for(var d=BC.Constants.Direction,e=BC.Cell.CellState,h=[],p=0;p<c.numRings;p++)h[p]=BC.Ring.make(p,c);var l={rings:h,matrix:BC.Matrix.identity,metrics:c,move:function(a){switch(a){case d.LEFT:q.move(d.LEFT)&&(m--,0>m&&(m=c.numCells-1));break;case d.RIGHT:q.move(d.RIGHT)&&(m++,m>=c.numCells&&(m=0));break;case d.UP:0<n&&q.move(d.UP)&&n--;break;case d.DOWN:n+1<l.rings.length&&q.move(d.DOWN)&&n++}},rotate:function(a){s[1]+=a},swap:function(){var a=
l.rings[n],b=a.cells[m],a=a.cells[(m+1)%a.cells.length],c=b.blockStyle,f=a.blockStyle;BC.Util.log("swap: ("+b.state+", "+a.state+")");b.state===e.EMPTY&&a.state===e.BLOCK?(a.sendBlock(0.125,d.LEFT),b.receiveBlock(0.125,d.RIGHT,f)):b.state===e.BLOCK&&a.state===e.EMPTY?(b.sendBlock(0.125,d.RIGHT),a.receiveBlock(0.125,d.LEFT,c)):b.state===e.BLOCK&&a.state===e.BLOCK&&(b.receiveBlock(0.125,d.RIGHT,f),a.receiveBlock(0.125,d.LEFT,c))},update:function(h){for(var n=0;n<c.numRings;n++)for(var m=0;m<c.numCells;m++){var p=
h;b(n,m).update(p)}p=!1;for(n=0;n<c.numRings;n++)for(m=0;m<c.numCells;m++){var y=n,A=m,v;v=y;var u=A,B=b(v,u);if(B.state!==e.BLOCK)v=[];else{for(var C=[],E=B.blockStyle,z=[],r=g(u);r!=u;r=g(r)){var w=b(v,r);if(a(E,w))z.push({cell:w,row:v,col:r});else break}for(r=f(u);r!=u;r=f(r))if(w=b(v,r),a(E,w))z.push({cell:w,row:v,col:r});else break;3<=z.length+1&&(C=C.concat(z));E=B.blockStyle;z=[];for(r=v-1;0<=r;r--)if(w=b(r,u),a(E,w))z.push({cell:w,row:r,col:u});else break;for(r=v+1;r<c.numRings;r++)if(w=b(r,
u),a(E,w))z.push({cell:w,row:r,col:u});else break;3<=z.length+1&&(C=C.concat(z));0<C.length&&C.push({cell:B,row:v,col:u});v=C}for(u=0;u<v.length;u++)B=v[u].cell,B.state!==e.MARKED_BLOCK&&(B.markBlock(),t.push(v[u]));v=0<v.length;u=A;A=b(y,u);A.state===e.BLOCK&&(y+=1,y>=c.numRings||(y=b(y,u),A.state===e.BLOCK&&y.state==e.EMPTY&&(A=A.sendBlock(0.075),y.receiveBlock(0.075,d.UP,A))));p|=v}k(p);q.update(h);h=BC.Matrix.makeXRotation(s[0]);n=BC.Matrix.makeYRotation(s[1]);m=BC.Matrix.makeZRotation(s[2]);
n=BC.Matrix.matrixMultiply(m,n);n=BC.Matrix.matrixMultiply(n,h);l.matrix=n}},n=0,m=c.numCells-1,t=[],s=[0,0,0],q=BC.Selector.make(c,l);l.selector=q;return l};return g}(BC||{});BC=function(g){(g.Ring=g.Ring||{}).make=function(c,a){for(var b=[],g=0;g<a.numCells;g++)b[g]=BC.Cell.make(g,a);g=BC.Matrix.makeTranslation(0,-c*a.ringHeight,0);return{cells:b,matrix:g}};return g}(BC||{});BC=function(g){(g.Selector=g.Selector||{}).make=function(c,a){function b(b){d=b;0<e.length&&BC.Util.error("startMoving: pending animations: "+e.length);e.push(BC.Animation.make({duration:f,updateCallback:function(b){var e=c.ringHeight*b.deltaPercent;b=p*b.deltaPercent;switch(d){case g.UP:return h[1]+=e,!0;case g.DOWN:return h[1]-=e,!0;case g.LEFT:return a.rotate(b),!0;case g.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){d=g.NONE}}))}var g=BC.Constants.Direction,f=0.025,
k={matrix:BC.Matrix.identity,move:function(a){switch(a){case g.LEFT:return d!==g.NONE?a=!1:(b(g.LEFT),a=!0),a;case g.RIGHT:return d!==g.NONE?a=!1:(b(g.RIGHT),a=!0),a;case g.UP:return d!==g.NONE?a=!1:(b(g.UP),a=!0),a;case g.DOWN:return d!==g.NONE?a=!1:(b(g.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(e,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);k.matrix=
BC.Matrix.matrixMultiply(a,b)}},d=g.NONE,e=[],h=[0,0,0],p=BC.Math.sliceRadians(c.numCells);return k};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function c(a){return e.getUniformLocation(m,a)}function a(){return d.width!=d.clientWidth||d.height!=d.clientHeight?(d.width=d.clientWidth,d.height=d.clientHeight,!0):!1}function b(){var a=d.width/d.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function g(){var a=BC.Matrix.makeLookAt([0,0.5,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function f(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);e.viewport(0,0,e.canvas.width,
e.canvas.height);e.uniformMatrix4fv(t.projectionMatrixLocation,!1,s);F.tick();q.update(F);D.draw();requestAnimationFrame(f)}var k=BC.Constants.Direction,d=document.getElementById("canvas");if(d){var e=d.getContext("webgl")||d.getContext("experimental-webgl");if(e){var h=e.createTexture();e.bindTexture(e.TEXTURE_2D,h);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var p=new Image;p.src="images/textures.png";$(p).load(function(){e.bindTexture(e.TEXTURE_2D,
h);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,p);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST);e.generateMipmap(e.TEXTURE_2D)});e.enable(e.CULL_FACE);e.enable(e.DEPTH_TEST);e.enable(e.BLEND);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);var l=BC.GL.loadShader(e,"vertex-shader",e.VERTEX_SHADER),n=BC.GL.loadShader(e,"fragment-shader",e.FRAGMENT_SHADER),m=BC.GL.createProgram(e,[l,n]);e.useProgram(m);
var t={positionLocation:e.getAttribLocation(m,"a_position"),textureCoordLocation:e.getAttribLocation(m,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardMatrixLocation:c("u_boardMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};a();var s=b();$(window).resize(function(){a()&&(s=b())});l=g();e.uniformMatrix4fv(t.viewMatrixLocation,!1,l);var q=
BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),D=BC.BoardView.make(q,e,t),l=BC.Controller.make(d);l.setMoveLeftListener(function(){q.move(k.LEFT)});l.setMoveRightListener(function(){q.move(k.RIGHT)});l.setMoveUpListener(function(){q.move(k.UP)});l.setMoveDownListener(function(){q.move(k.DOWN)});l.setPrimaryActionListener(function(){q.swap()});var F=BC.StopWatch.make();f()}}};return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var c=g.Math=g.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var f=2*Math.PI/b,g=[],d=0;d<b;d++)g[2*d]=a*Math.cos(c+d*f),g[2*d+1]=a*Math.sin(c+d*f);return g};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){var c=g.Cell=g.Cell||{};c.CellState={EMPTY:0,EMPTY_RESERVED:1,BLOCK:2,RECEIVING_BLOCK:3,MARKED_BLOCK:4,FREEZING_BLOCK:5,READY_TO_CLEAR_BLOCK:6,CLEARING_BLOCK:7};c.make=function(a,b){var c=BC.Cell.CellState,f=BC.Constants.Direction,g=BC.Math.randomInt(b.numBlockTypes),d=[],e=BC.Math.sliceRadians(b.numCells),h=[0,a*e,0],p=[0,0,0],l={matrix:BC.Matrix.makeYRotation(h[1]),state:c.BLOCK,blockStyle:g,yellowBoost:0,alpha:1,markBlock:function(){l.state=c.MARKED_BLOCK;0<d.length&&BC.Util.error("markBlock: pending animations: "+
d.length);var a=BC.Animation.make({duration:0.75,startCallback:function(){l.state=c.FREEZING_BLOCK},updateCallback:function(a){l.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){l.yellowBoost=0}}),e=BC.Animation.make({duration:0.25,startCallback:function(){l.blockStyle+=b.numBlockTypes},finishCallback:function(){l.state=c.READY_TO_CLEAR_BLOCK}});d.push(a,e)},clearBlock:function(){l.state=c.CLEARING_BLOCK;0<d.length&&BC.Util.error("clearBlock: pending animations: "+d.length);
var a=BC.Animation.make({duration:0.25,updateCallback:function(a){l.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){l.state=c.EMPTY;l.alpha=1}});d.push(a)},sendBlock:function(a){var b=l.blockStyle;l.blockStyle=0;l.state=c.EMPTY_RESERVED;0<d.length&&BC.Util.error("sendBlock: pending animations: "+d.length);d.push(BC.Animation.make({duration:a,finishCallback:function(){l.state=c.EMPTY}}));return b},receiveBlock:function(a,g,k){l.state=c.RECEIVING_BLOCK;l.blockStyle=k;switch(g){case f.LEFT:h[1]-=
e;break;case f.RIGHT:h[1]+=e;break;case f.UP:p[1]=b.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+g)}0<d.length&&BC.Util.error("receiveBlock: pending animations: "+d.length);d.push(BC.Animation.make({duration:a,updateCallback:function(a){var c=e*a.deltaPercent;a=b.ringHeight*a.deltaPercent;switch(g){case f.LEFT:return h[1]+=c,!0;case f.RIGHT:return h[1]-=c,!0;case f.UP:return p[1]-=a,!0;default:return!1}},finishCallback:function(){l.state=c.BLOCK}}))},isEmpty:function(){return l.state===
c.EMPTY||l.state===c.EMPTY_RESERVED},isTransparent:function(){return l.state===c.CLEARING_BLOCK},update:function(a){if(BC.Animation.process(d,a)){a=BC.Matrix.makeYRotation(h[1]);var b=BC.Matrix.makeTranslation(p[0],p[1],p[2]);l.matrix=BC.Matrix.matrixMultiply(a,b)}}};return l};return g}(BC||{});BC=function(g){var c=g.GL=g.GL||{};c.loadShader=function(a,b,c,f){f=f||BC.Util.error;var g=document.getElementById(b);if(!g)return f("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,g.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),f("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,f){for(var g=a.createProgram(),d=0;d<b.length;d++)a.attachShader(g,b[d]);
if(c)for(d=0;d<c.length;d++)a.bindAttribLocation(g,f?f[d]:d,c[d]);a.linkProgram(g);return a.getProgramParameter(g,a.LINK_STATUS)?g:(lastError=a.getProgramInfoLog(g),error("Error in program linking: "+lastError),a.deleteProgram(g),null)};c.textureTileSet=function(a,b,c){var f=1/a,g=1/b;return{tile:function(a,b){var h=f*b,p=g*a;return{textureCoord:function(a,b){return[h+c+(f-2*c)*a,p+c+(g-2*c)*b]}}}}};return g}(BC||{});BC=function(g){var c=g.Util=g.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return g}(BC||{});BC=function(g){(g.Controller=g.Controller||{}).make=function(c){var a=function(){},b=function(){},g=function(){},f=function(){},k=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:k.call();break;case 37:a.call();break;case 39:b.call();break;case 38:g.call();break;case 40:f.call()}return!1});var d=0,e=0;$(c).on("touchstart touchmove touchend",function(c){var p=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":d=p.pageX;e=p.pageY;break;case "touchend":c=p.pageX-
d,p=p.pageY-e,50<c?a.call():-50>c?b.call():50<p?f.call():-50>p?g.call():k.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){g=a},setMoveDownListener:function(a){f=a},setPrimaryActionListener:function(a){k=a}}};return g}(BC||{});BC=function(g){(g.StopWatch=g.StopWatch||{}).make=function(){var c={then:0.001*Date.now(),tick:function(){c.now=0.001*Date.now();c.deltaTime=c.now-c.then;c.then=c.now}};return c};return g}(BC||{});
