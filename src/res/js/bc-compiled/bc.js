var BC=function(g){var d=g.Matrix=g.Matrix||{};d.makeLookAt=function(a,b,l){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));l=BC.Math.cross(l,b);var m=BC.Math.cross(b,l);return[l[0],l[1],l[2],0,m[0],m[1],m[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};d.makePerspective=function(a,b,l,m){a=Math.tan(0.5*Math.PI-0.5*a);var e=1/(l-m);return[a/b,0,0,0,0,a,0,0,0,0,(l+m)*e,-1,0,0,l*m*e*2,0]};d.makeTranslation=function(a,b,l){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,l,1]};d.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};d.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};d.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};d.makeScale=function(a,b,l){return[a,0,0,0,0,b,0,0,0,0,l,0,0,0,0,1]};d.identity=d.makeScale(1,1,1);d.makeInverse=function(a){var b=a[0],l=a[1],m=a[2],e=a[3],f=a[4],c=a[5],k=a[6],h=a[7],d=a[8],n=a[9],q=a[10],r=a[11],s=a[12],p=a[13],g=a[14];a=
a[15];var t=q*a,u=g*r,x=k*a,y=g*h,z=k*r,A=q*h,B=m*a,C=g*e,D=m*r,E=q*e,F=m*h,G=k*e,H=d*p,I=s*n,J=f*p,K=s*c,L=f*n,M=d*c,N=b*p,O=s*l,P=b*n,Q=d*l,R=b*c,S=f*l,T=t*c+y*n+z*p-(u*c+x*n+A*p),U=u*l+B*n+E*p-(t*l+C*n+D*p),p=x*l+C*c+F*p-(y*l+B*c+G*p),l=A*l+D*c+G*n-(z*l+E*c+F*n),c=1/(b*T+f*U+d*p+s*l);return[c*T,c*U,c*p,c*l,c*(u*f+x*d+A*s-(t*f+y*d+z*s)),c*(t*b+C*d+D*s-(u*b+B*d+E*s)),c*(y*b+B*f+G*s-(x*b+C*f+F*s)),c*(z*b+E*f+F*d-(A*b+D*f+G*d)),c*(H*h+K*r+L*a-(I*h+J*r+M*a)),c*(I*e+N*r+Q*a-(H*e+O*r+P*a)),c*(J*e+O*h+
R*a-(K*e+N*h+S*a)),c*(M*e+P*h+S*r-(L*e+Q*h+R*r)),c*(J*q+M*g+I*k-(L*g+H*k+K*q)),c*(P*g+H*m+O*q-(N*q+Q*g+I*m)),c*(N*k+S*g+K*m-(R*g+J*m+O*k)),c*(R*q+L*m+Q*k-(P*k+S*q+M*m))]};d.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){var d=g.Animation=g.Animation||{};d.make=function(a){var b=a.duration,l=a.startCallback||function(){},m=a.updateCallback||function(){return!1},e=a.finishCallback||function(){},f=0,c=!1,k=!1;return{update:function(a){c||(c=!0,l());var d=a.deltaTime;f+d>b&&(d=b-f);f+=d;a=m({now:a.now,deltaTime:d,elapsedPercent:f/b,deltaPercent:d/b});f>=b&&(k=!0,e());return a},isDone:function(){return k}}};d.process=function(a,b){var l=!1;if(0<a.length){var m=a[0],l=l|m.update(b);m.isDone()&&a.shift()}return l};
return g}(BC||{});BC=function(g){var d=g.Cell=g.Cell||{},d=d.Chain=d.Chain||{};d.find=function(a){function b(b,c){return a.rings[b].cells[c]}function l(){for(var a=[],e=0;e<h;e++){var l;l=e;for(var f=0,m=b(l,f),g=0;g<k;g++){var t=b(l,f);if(m.state!==t.state||m.blockStyle!=t.blockStyle)break;f+=1;f=f===k?0:f}l=f;for(f=0;f<k;)if(g=(f+l)%k,t=b(e,g),t.state!==c.BLOCK)f++;else{for(var u=1,m=f+1;m<k;m++)if(g=(m+l)%k,g=b(e,g),t.state===g.state&&t.blockStyle==g.blockStyle)u++;else break;if(u>=d){for(t=[];f<m;f++)g=(f+l)%k,
u=b(e,g),t.push({cell:u,row:e,col:g});a.push(t)}f=m}}return a}function m(){for(var a=[],e=0;e<k;e++)for(var f=0;f<h;){var l=b(f,e);if(l.state!==c.BLOCK)f++;else{for(var m=1,g=f+1;g<h;g++){var t=b(g,e);if(l.state===t.state&&l.blockStyle==t.blockStyle)m++;else break}if(m>=d){for(l=[];f<g;f++)m=b(f,e),l.push({cell:m,row:f,col:e});a.push(l)}f=g}}return a}function e(a,b){for(var c=0;c<a.length;c++)for(var e=a[c],f=0;f<b.length;f++){var l=b[f];if(e.blockStyle===l.blockStyle&&e.row===l.row&&e.col===l.col)return!0}return!1}
function f(a,b){for(var c=0;c<a.length;c++){var e=a[c];if(e.blockStyle===b.blockStyle&&e.row===b.row&&e.col===b.col)return!0}return!1}var c=BC.Cell.CellState,k=a.rings[0].cells.length,h=a.rings.length,d=3;return function(){for(var a=[],b=l(),c=m();0<b.length;){var h=b.shift();for(a.push(h);;){for(var k=!1,d=0;d<c.length;d++)if(e(h,c[d])){for(k=0;k<c[d].length;k++)f(h,c[d][k])||h.push(c[d][k]);c.splice(d,1);k=!0}if(!k)break;k=!1;for(d=0;d<b.length;d++)if(e(h,b[d])){for(k=0;k<b[d].length;k++)f(h,b[d][k])||
h.push(b[d][k]);b.splice(d,1);k=!0}if(!k)break}}for(;0<c.length;)h=c.shift(),a.push(h);for(d=0;d<a.length;d++)a[d].sort(function(a,b){return a.row-b.row});return a}()};d.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(d){var e=BC.Cell.Chain.find(d);for(d=0;d<e.length;d++){var f=e[d];l.push(f);for(var c=0;c<f.length;c++){var k=f[c].cell;k.markBlock();b.push(k)}}if(0<b.length)switch(k=b[0],k.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;case a.BLOCK_CLEARING_READY:k.clearBlock();
break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){f=l[0];e=!0;for(d=0;d<f.length;d++)k=f[d].cell,e&=!k.isClearing();if(e){for(d=0;d<f.length;d++)k=f[d].cell,k.state===a.EMPTY_NO_DROP&&(k.state=a.EMPTY);l.shift()}}}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(d,a){var b=BC.Cell.CellState,l=BC.Constants.Direction,m={rings:a,matrix:BC.Matrix.identity,metrics:d,move:function(a){switch(a){case l.LEFT:k.move(l.LEFT)&&(f--,0>f&&(f=d.numCells-1));break;case l.RIGHT:k.move(l.RIGHT)&&(f++,f>=d.numCells&&(f=0));break;case l.UP:0<e&&k.move(l.UP)&&e--;break;case l.DOWN:e+1<m.rings.length&&k.move(l.DOWN)&&e++}},rotate:function(a){c[1]+=a},swap:function(){var a=m.rings[e].cells[f%d.numCells],c=m.rings[e].cells[(f+1)%
d.numCells];BC.Util.log("swap: ("+a.state+", "+c.state+")");var k=a.blockStyle,h=c.blockStyle;a.state!==b.EMPTY&&a.state!==b.EMPTY_NO_DROP||c.state!==b.BLOCK?a.state!==b.BLOCK||c.state!==b.EMPTY&&c.state!==b.EMPTY_NO_DROP?a.state===b.BLOCK&&c.state===b.BLOCK&&(a.receiveBlock(0.1,l.RIGHT,h),c.receiveBlock(0.1,l.LEFT,k)):(a.sendBlock(0.1,l.RIGHT),c.receiveBlock(0.1,l.LEFT,k)):(c.sendBlock(0.1,l.LEFT),a.receiveBlock(0.1,l.RIGHT,h))},update:function(a){for(var b=0;b<d.numRings;b++)for(var e=0;e<d.numCells;e++)m.rings[b].cells[e%
d.numCells].update(a);h.update(m);g.update(m);k.update(a);a=BC.Matrix.makeXRotation(c[0]);b=BC.Matrix.makeYRotation(c[1]);e=BC.Matrix.makeZRotation(c[2]);b=BC.Matrix.matrixMultiply(e,b);b=BC.Matrix.matrixMultiply(b,a);m.matrix=b}},e=0,f=d.numCells-1,c=[0,0,0],k=BC.Selector.make(d,m);m.selector=k;var h=BC.Cell.Chain.makeManager(),g=BC.Cell.Drop.makeManager(d);return m};return g}(BC||{});BC=function(g){(g.Ring=g.Ring||{}).make=function(d,a){for(var b=[],l=0;l<a.numCells;l++)b[l]=BC.Cell.make(l,a);l=BC.Matrix.makeTranslation(0,-d*a.ringHeight,0);return{cells:b,matrix:l}};return g}(BC||{});BC=function(g){(g.Selector=g.Selector||{}).make=function(d,a){function b(b){f=b;0<c.length&&BC.Util.error("startMoving: pending animations: "+c.length);c.push(BC.Animation.make({duration:m,updateCallback:function(b){var c=d.ringHeight*b.deltaPercent;b=h*b.deltaPercent;switch(f){case l.UP:return k[1]+=c,!0;case l.DOWN:return k[1]-=c,!0;case l.LEFT:return a.rotate(b),!0;case l.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){f=l.NONE}}))}var l=BC.Constants.Direction,m=0.025,
e={matrix:BC.Matrix.identity,move:function(a){switch(a){case l.LEFT:return f!==l.NONE?a=!1:(b(l.LEFT),a=!0),a;case l.RIGHT:return f!==l.NONE?a=!1:(b(l.RIGHT),a=!0),a;case l.UP:return f!==l.NONE?a=!1:(b(l.UP),a=!0),a;case l.DOWN:return f!==l.NONE?a=!1:(b(l.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(c,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(k[0],k[1],k[2]);e.matrix=
BC.Matrix.matrixMultiply(a,b)}},f=l.NONE,c=[],k=[0,0,0],h=BC.Math.sliceRadians(d.numCells);return e};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function d(a){return c.getUniformLocation(q,a)}function a(){return f.width!=f.clientWidth||f.height!=f.clientHeight?(f.width=f.clientWidth,f.height=f.clientHeight,!0):!1}function b(){var a=f.width/f.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.5,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function m(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);c.viewport(0,0,c.canvas.width,
c.canvas.height);c.uniformMatrix4fv(r.projectionMatrixLocation,!1,s);u.tick();w.update(u);t.draw();requestAnimationFrame(m)}var e=BC.Constants.Direction,f=document.getElementById("canvas");if(f){var c=f.getContext("webgl")||f.getContext("experimental-webgl");if(c){var k=c.createTexture();c.bindTexture(c.TEXTURE_2D,k);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var h=new Image;h.src="images/textures.png";$(h).load(function(){c.bindTexture(c.TEXTURE_2D,
k);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,h);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST);c.generateMipmap(c.TEXTURE_2D)});c.enable(c.CULL_FACE);c.enable(c.DEPTH_TEST);c.enable(c.BLEND);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var g=BC.GL.loadShader(c,"vertex-shader",c.VERTEX_SHADER),n=BC.GL.loadShader(c,"fragment-shader",c.FRAGMENT_SHADER),q=BC.GL.createProgram(c,[g,n]);c.useProgram(q);
var r={positionLocation:c.getAttribLocation(q,"a_position"),textureCoordLocation:c.getAttribLocation(q,"a_textureCoord"),projectionMatrixLocation:d("u_projectionMatrix"),viewMatrixLocation:d("u_viewMatrix"),boardMatrixLocation:d("u_boardMatrix"),ringMatrixLocation:d("u_ringMatrix"),cellMatrixLocation:d("u_cellMatrix"),yellowBoostLocation:d("u_yellowBoost"),alphaLocation:d("u_alpha")};a();var s=b();$(window).resize(function(){a()&&(s=b())});g=l();c.uniformMatrix4fv(r.viewMatrixLocation,!1,g);for(var g=
{numRings:4,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},n=[],p=0;p<g.numRings;p++)n[p]=BC.Ring.make(p,g);var w=BC.Board.make(g,n),t=BC.Board.View.make(w,c,r),g=BC.Controller.make(f);g.setMoveLeftListener(function(){w.move(e.LEFT)});g.setMoveRightListener(function(){w.move(e.RIGHT)});g.setMoveUpListener(function(){w.move(e.UP)});g.setMoveDownListener(function(){w.move(e.DOWN)});g.setPrimaryActionListener(function(){w.swap()});var u=BC.StopWatch.make();m()}}};
return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var d=g.Math=g.Math||{};d.radians=function(a){return a*Math.PI/180};d.sliceRadians=function(a){return 2*Math.PI/a};d.randomInt=function(a){return Math.floor(Math.random()*a)};d.circlePoints=function(a,b,l){l=l||0;for(var d=2*Math.PI/b,e=[],f=0;f<b;f++)e[2*f]=a*Math.cos(l+f*d),e[2*f+1]=a*Math.sin(l+f*d);return e};d.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};d.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};d.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){var d=g.Board=g.Board||{};(d.View=d.View||{}).make=function(a,b,l){var d=l.boardMatrixLocation,e=l.ringMatrixLocation,f=l.cellMatrixLocation,c=BC.GL.textureTileSet(4,4,0.002),k=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(1,0),c.tile(1,1),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(3,0),c.tile(3,1)],c=c.tile(1,2),h=BC.Cell.View.make(b,a.metrics,k),g=BC.Selector.View.make(b,a.metrics,c);return{draw:function(){b.uniformMatrix4fv(d,!1,a.matrix);for(var c=a.rings,
k=0;2>k;k++)for(var r=0;r<c.length;r++){b.uniformMatrix4fv(e,!1,c[r].matrix);for(var s=c[r].cells,p=0;p<s.length;p++)b.uniformMatrix4fv(f,!1,s[p].matrix),0==k?h.drawOpaque(s[p],l):h.drawTransparent(s[p],l)}b.uniformMatrix4fv(d,!1,a.selector.matrix);b.uniformMatrix4fv(e,!1,BC.Matrix.identity);b.uniformMatrix4fv(f,!1,BC.Matrix.identity);g.draw(l)}}};return g}(BC||{});BC=function(g){var d=g.Cell=g.Cell||{};d.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_RECEIVING:4,BLOCK_CLEARING_MARKED:5,BLOCK_CLEARING_PREPARING:6,BLOCK_CLEARING_READY:7,BLOCK_CLEARING_IN_PROGRESS:8};d.make=function(a,b){function l(){var a=BC.Matrix.makeYRotation(h[1]),b=BC.Matrix.makeTranslation(g[0],g[1],g[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var d=BC.Cell.CellState,e=BC.Constants.Direction,f=BC.Math.randomInt(b.numBlockTypes),c=[],k=BC.Math.sliceRadians(b.numCells),
h=[0,a*k,0],g=[0,0,0],n={matrix:BC.Matrix.makeYRotation(h[1]),state:d.BLOCK,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){n.state=d.BLOCK_CLEARING_MARKED;0<c.length&&BC.Util.error("markBlock: pending animations: "+c.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){n.state=d.BLOCK_CLEARING_PREPARING},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=0}}),e=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=
b.numBlockTypes},finishCallback:function(){n.state=d.BLOCK_CLEARING_READY}});c.push(a,e)},clearBlock:function(){n.state=d.BLOCK_CLEARING_IN_PROGRESS;0<c.length&&BC.Util.error("clearBlock: pending animations: "+c.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=d.EMPTY_NO_DROP;n.alpha=1}});c.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=d.EMPTY_NO_SWAP;0<c.length&&BC.Util.error("sendBlock: pending animations: "+
c.length);c.push(BC.Animation.make({duration:a,finishCallback:function(){n.state=d.EMPTY}}));return b},receiveBlock:function(a,f,s){n.blockStyle=s;n.state=d.BLOCK_RECEIVING;switch(f){case e.LEFT:h[1]-=k;break;case e.RIGHT:h[1]+=k;break;case e.UP:g[1]=b.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+f)}l();0<c.length&&BC.Util.error("receiveBlock: pending animations: "+c.length);c.push(BC.Animation.make({duration:a,updateCallback:function(a){var c=k*a.deltaPercent;a=b.ringHeight*
a.deltaPercent;switch(f){case e.LEFT:return h[1]+=c,!0;case e.RIGHT:return h[1]-=c,!0;case e.UP:return g[1]-=a,!0;default:return!1}},finishCallback:function(){n.state=d.BLOCK}}))},isClearing:function(){return n.state===d.BLOCK_CLEARING_MARKED||n.state===d.BLOCK_CLEARING_PREPARING||n.state===d.BLOCK_CLEARING_READY||n.state===d.BLOCK_CLEARING_IN_PROGRESS},isDrawable:function(){return n.state!==d.EMPTY&&n.state!==d.EMPTY_NO_SWAP&&n.state!==d.EMPTY_NO_DROP},isTransparent:function(){return n.state===d.BLOCK_CLEARING_IN_PROGRESS},
update:function(a){BC.Animation.process(c,a)&&l()}};return n};return g}(BC||{});BC=function(g){var d=g.GL=g.GL||{};d.loadShader=function(a,b,d,g){g=g||BC.Util.error;var e=document.getElementById(b);if(!e)return g("** Error getting script element:"+b),null;b=a.createShader(d);a.shaderSource(b,e.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),g("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};d.createProgram=function(a,b,d,g){for(var e=a.createProgram(),f=0;f<b.length;f++)a.attachShader(e,b[f]);
if(d)for(f=0;f<d.length;f++)a.bindAttribLocation(e,g?g[f]:f,d[f]);a.linkProgram(e);return a.getProgramParameter(e,a.LINK_STATUS)?e:(lastError=a.getProgramInfoLog(e),error("Error in program linking: "+lastError),a.deleteProgram(e),null)};d.textureTileSet=function(a,b,d){var g=1/a,e=1/b;return{tile:function(a,b){var k=g*b,h=e*a;return{textureCoord:function(a,b){return[k+d+(g-2*d)*a,h+d+(e-2*d)*b]}}}}};return g}(BC||{});BC=function(g){var d=g.Selector=g.Selector||{};(d.View=d.View||{}).make=function(a,b,d){var g=-b.ringHeight/2,e=-g;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var f=b.length-2,c=[],k=0;c[k++]=b[f]+0.001;c[k++]=g;c[k++]=-b[f+1]-0.001;c[k++]=b[0]+0.001;c[k++]=g;c[k++]=-b[1]-0.001;c[k++]=b[0]+0.001;c[k++]=e;c[k++]=-b[1]-0.001;c[k++]=b[f]+0.001;c[k++]=e;c[k++]=-b[f+1]-0.001;c[k++]=b[0]+0.001;c[k++]=g;c[k++]=-b[1]-0.001;c[k++]=b[2]+0.001;c[k++]=g;c[k++]=-b[3]-0.001;c[k++]=b[2]+
0.001;c[k++]=e;c[k++]=-b[3]-0.001;c[k++]=b[0]+0.001;c[k++]=e;c[k++]=-b[1]-0.001;var h=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,h);a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW);g=d.textureCoord(0,0);e=d.textureCoord(1,0);b=d.textureCoord(1,1);d=d.textureCoord(0,1);d=new Float32Array([].concat(g,e,b,d,g,e,b,d));var v=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),q=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
q);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,h);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){var d=g.Util=g.Util||{};d.log=function(a){window.console&&window.console.log&&window.console.log(a)};d.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return g}(BC||{});BC=function(g){var d=g.Cell=g.Cell||{};(d.Drop=d.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,d=BC.Constants.Direction;return{update:function(g){for(var e=0;e<a.numRings;e++)for(var f=0;f<a.numCells;f++){var c=g,k=e,h=f,v=c.rings[k].cells[h];v.state===b.BLOCK&&(k+=1,k>=a.numRings||(c=c.rings[k].cells[h],v.state===b.BLOCK&&c.state==b.EMPTY&&(v=v.sendBlock(0.05),c.receiveBlock(0.05,d.UP,v))))}}}};return g}(BC||{});BC=function(g){(g.Controller=g.Controller||{}).make=function(d){var a=function(){},b=function(){},g=function(){},m=function(){},e=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:e.call();break;case 37:a.call();break;case 39:b.call();break;case 38:g.call();break;case 40:m.call()}return!1});var f=0,c=0;$(d).on("touchstart touchmove touchend",function(d){var h=d.originalEvent.changedTouches[0];switch(d.type){case "touchstart":f=h.pageX;c=h.pageY;break;case "touchend":d=h.pageX-
f,h=h.pageY-c,50<d?a.call():-50>d?b.call():50<h?m.call():-50>h?g.call():e.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){g=a},setMoveDownListener:function(a){m=a},setPrimaryActionListener:function(a){e=a}}};return g}(BC||{});BC=function(g){var d=g.Cell=g.Cell||{};(d.View=d.View||{}).make=function(a,b,d){function g(b,c){var d=c.positionLocation,e=c.textureCoordLocation,f=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,n[b.blockStyle]);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.drawElements(a.TRIANGLES,
r,a.UNSIGNED_SHORT,0)}var e=b.numCells,f=b.ringOuterRadius,c=b.ringHeight/2,k=-c,h=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,e,h);f=BC.Math.circlePoints(f,e,h);e=0;h=[];h[e++]=b[0];h[e++]=c;h[e++]=-b[1];h[e++]=f[0];h[e++]=c;h[e++]=-f[1];h[e++]=f[2];h[e++]=c;h[e++]=-f[3];h[e++]=b[2];h[e++]=c;h[e++]=-b[3];h[e++]=b[0];h[e++]=c;h[e++]=-b[1];h[e++]=b[0];h[e++]=k;h[e++]=-b[1];h[e++]=f[0];h[e++]=k;h[e++]=-f[1];h[e++]=f[0];h[e++]=c;h[e++]=-f[1];h[e++]=f[2];h[e++]=c;h[e++]=-f[3];h[e++]=f[2];h[e++]=
k;h[e++]=-f[3];h[e++]=b[2];h[e++]=k;h[e++]=-b[3];h[e++]=b[2];h[e++]=c;h[e++]=-b[3];h[e++]=f[0];h[e++]=c;h[e++]=-f[1];h[e++]=f[0];h[e++]=k;h[e++]=-f[1];h[e++]=f[2];h[e++]=k;h[e++]=-f[3];h[e++]=f[2];h[e++]=c;h[e++]=-f[3];h[e++]=b[2];h[e++]=c;h[e++]=-b[3];h[e++]=b[2];h[e++]=k;h[e++]=-b[3];h[e++]=b[0];h[e++]=k;h[e++]=-b[1];h[e++]=b[0];h[e++]=c;h[e++]=-b[1];var v=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);c=[];for(e=0;e<d.length;e++)for(k=
d[e],c[e]=[],f=b=0;5>b;b++)h=k.textureCoord(0,0),c[e][f++]=h[0],c[e][f++]=h[1],h=k.textureCoord(0,1),c[e][f++]=h[0],c[e][f++]=h[1],h=k.textureCoord(1,1),c[e][f++]=h[0],c[e][f++]=h[1],h=k.textureCoord(1,0),c[e][f++]=h[0],c[e][f++]=h[1];for(var n=[],e=0;e<d.length;e++)n[e]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,n[e]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(c[e]),a.STATIC_DRAW);d=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var q=a.createBuffer();
a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.bufferData(a.ELEMENT_ARRAY_BUFFER,d,a.STATIC_DRAW);var r=d.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&g(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),g(b,c),a.enable(a.CULL_FACE))}}};return g}(BC||{});BC=function(g){(g.StopWatch=g.StopWatch||{}).make=function(){var d={then:0.001*Date.now(),tick:function(){d.now=0.001*Date.now();d.deltaTime=d.now-d.then;d.then=d.now}};return d};return g}(BC||{});
