var BC=function(g){var e=g.Matrix=g.Matrix||{};e.makeLookAt=function(a,b,l){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));l=BC.Math.cross(l,b);var m=BC.Math.cross(b,l);return[l[0],l[1],l[2],0,m[0],m[1],m[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};e.makePerspective=function(a,b,l,m){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(l-m);return[a/b,0,0,0,0,a,0,0,0,0,(l+m)*d,-1,0,0,l*m*d*2,0]};e.makeTranslation=function(a,b,l){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,l,1]};e.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};e.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};e.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};e.makeScale=function(a,b,l){return[a,0,0,0,0,b,0,0,0,0,l,0,0,0,0,1]};e.identity=e.makeScale(1,1,1);e.makeInverse=function(a){var b=a[0],l=a[1],m=a[2],d=a[3],f=a[4],c=a[5],k=a[6],h=a[7],p=a[8],n=a[9],r=a[10],e=a[11],s=a[12],q=a[13],g=a[14];a=
a[15];var t=r*a,u=g*e,x=k*a,y=g*h,z=k*e,A=r*h,B=m*a,C=g*d,D=m*e,E=r*d,F=m*h,G=k*d,H=p*q,I=s*n,J=f*q,K=s*c,L=f*n,M=p*c,N=b*q,O=s*l,P=b*n,Q=p*l,R=b*c,S=f*l,T=t*c+y*n+z*q-(u*c+x*n+A*q),U=u*l+B*n+E*q-(t*l+C*n+D*q),q=x*l+C*c+F*q-(y*l+B*c+G*q),l=A*l+D*c+G*n-(z*l+E*c+F*n),c=1/(b*T+f*U+p*q+s*l);return[c*T,c*U,c*q,c*l,c*(u*f+x*p+A*s-(t*f+y*p+z*s)),c*(t*b+C*p+D*s-(u*b+B*p+E*s)),c*(y*b+B*f+G*s-(x*b+C*f+F*s)),c*(z*b+E*f+F*p-(A*b+D*f+G*p)),c*(H*h+K*e+L*a-(I*h+J*e+M*a)),c*(I*d+N*e+Q*a-(H*d+O*e+P*a)),c*(J*d+O*h+
R*a-(K*d+N*h+S*a)),c*(M*d+P*h+S*e-(L*d+Q*h+R*e)),c*(J*r+M*g+I*k-(L*g+H*k+K*r)),c*(P*g+H*m+O*r-(N*r+Q*g+I*m)),c*(N*k+S*g+K*m-(R*g+J*m+O*k)),c*(R*r+L*m+Q*k-(P*k+S*r+M*m))]};e.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){var e=g.Animation=g.Animation||{};e.make=function(a){var b=a.duration,l=a.startCallback||function(){},m=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},f=0,c=!1,k=!1;return{update:function(a){c||(c=!0,l());var e=a.deltaTime;f+e>b&&(e=b-f);f+=e;a=m({now:a.now,deltaTime:e,elapsedPercent:f/b,deltaPercent:e/b});f>=b&&(k=!0,d());return a},isDone:function(){return k}}};e.process=function(a,b){var l=!1;if(0<a.length){var m=a[0],l=l|m.update(b);m.isDone()&&a.shift()}return l};
return g}(BC||{});BC=function(g){var e=g.Cell=g.Cell||{},e=e.Chain=e.Chain||{};e.find=function(a){function b(b,c){return a.rings[b].cells[c]}function l(){for(var a=[],d=0;d<h;d++){var l;l=d;for(var f=0,m=b(l,f),g=0;g<k;g++){var t=b(l,f);if(m.state!==t.state||m.blockStyle!=t.blockStyle)break;f+=1;f=f===k?0:f}l=f;for(f=0;f<k;)if(g=(f+l)%k,t=b(d,g),t.state!==c.BLOCK)f++;else{for(var u=1,m=f+1;m<k;m++)if(g=(m+l)%k,g=b(d,g),t.state===g.state&&t.blockStyle==g.blockStyle)u++;else break;if(u>=e){for(t=[];f<m;f++)g=(f+l)%k,
u=b(d,g),t.push({cell:u,row:d,col:g});a.push(t)}f=m}}return a}function m(){for(var a=[],d=0;d<k;d++)for(var f=0;f<h;){var l=b(f,d);if(l.state!==c.BLOCK)f++;else{for(var m=1,g=f+1;g<h;g++){var t=b(g,d);if(l.state===t.state&&l.blockStyle==t.blockStyle)m++;else break}if(m>=e){for(l=[];f<g;f++)m=b(f,d),l.push({cell:m,row:f,col:d});a.push(l)}f=g}}return a}function d(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],f=0;f<b.length;f++){var l=b[f];if(d.blockStyle===l.blockStyle&&d.row===l.row&&d.col===l.col)return!0}return!1}
function f(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.blockStyle===b.blockStyle&&d.row===b.row&&d.col===b.col)return!0}return!1}var c=BC.Cell.CellState,k=a.rings[0].cells.length,h=a.rings.length,e=3;return function(){for(var a=[],b=l(),c=m();0<b.length;){var h=b.shift();for(a.push(h);;){for(var k=!1,e=0;e<c.length;e++)if(d(h,c[e])){for(k=0;k<c[e].length;k++)f(h,c[e][k])||h.push(c[e][k]);c.splice(e,1);k=!0}if(!k)break;k=!1;for(e=0;e<b.length;e++)if(d(h,b[e])){for(k=0;k<b[e].length;k++)f(h,b[e][k])||
h.push(b[e][k]);b.splice(e,1);k=!0}if(!k)break}}for(;0<c.length;)h=c.shift(),a.push(h);for(e=0;e<a.length;e++)a[e].sort(function(a,b){return a.row-b.row});return a}()};e.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(e){var d=BC.Cell.Chain.find(e);for(e=0;e<d.length;e++){var f=d[e];l.push(f);for(var c=0;c<f.length;c++){var k=f[c].cell;k.markBlock();b.push(k)}}if(0<b.length)switch(k=b[0],k.state){case a.MARKED_BLOCK:case a.FREEZING_BLOCK:break;case a.READY_TO_CLEAR_BLOCK:k.clearBlock();
break;case a.CLEARING_BLOCK:break;default:b.shift()}if(0<l.length){f=l[0];d=!0;for(e=0;e<f.length;e++)k=f[e].cell,d&=k.state===a.EMPTY_RESERVED;if(d){for(e=0;e<f.length;e++)k=f[e].cell,k.state=a.EMPTY;l.shift()}}}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(e,a){var b=BC.Cell.CellState,l=BC.Constants.Direction,m={rings:a,matrix:BC.Matrix.identity,metrics:e,move:function(a){switch(a){case l.LEFT:k.move(l.LEFT)&&(f--,0>f&&(f=e.numCells-1));break;case l.RIGHT:k.move(l.RIGHT)&&(f++,f>=e.numCells&&(f=0));break;case l.UP:0<d&&k.move(l.UP)&&d--;break;case l.DOWN:d+1<m.rings.length&&k.move(l.DOWN)&&d++}},rotate:function(a){c[1]+=a},swap:function(){var a=m.rings[d],c=a.cells[f],a=a.cells[(f+1)%a.cells.length],
h=c.blockStyle,k=a.blockStyle;BC.Util.log("swap: ("+c.state+", "+a.state+")");c.state===b.EMPTY&&a.state===b.BLOCK?(a.sendBlock(0.1,l.LEFT),c.receiveBlock(0.1,l.RIGHT,k)):c.state===b.BLOCK&&a.state===b.EMPTY?(c.sendBlock(0.1,l.RIGHT),a.receiveBlock(0.1,l.LEFT,h)):c.state===b.BLOCK&&a.state===b.BLOCK&&(c.receiveBlock(0.1,l.RIGHT,k),a.receiveBlock(0.1,l.LEFT,h))},update:function(a){for(var b=0;b<e.numRings;b++)for(var d=0;d<e.numCells;d++)m.rings[b].cells[d].update(a);h.update(m);g.update(m);k.update(a);
a=BC.Matrix.makeXRotation(c[0]);b=BC.Matrix.makeYRotation(c[1]);d=BC.Matrix.makeZRotation(c[2]);b=BC.Matrix.matrixMultiply(d,b);b=BC.Matrix.matrixMultiply(b,a);m.matrix=b}},d=0,f=e.numCells-1,c=[0,0,0],k=BC.Selector.make(e,m);m.selector=k;var h=BC.Cell.Chain.makeManager(),g=BC.Cell.Drop.makeManager(e);return m};return g}(BC||{});BC=function(g){(g.Ring=g.Ring||{}).make=function(e,a){for(var b=[],l=0;l<a.numCells;l++)b[l]=BC.Cell.make(l,a);l=BC.Matrix.makeTranslation(0,-e*a.ringHeight,0);return{cells:b,matrix:l}};return g}(BC||{});BC=function(g){(g.Selector=g.Selector||{}).make=function(e,a){function b(b){f=b;0<c.length&&BC.Util.error("startMoving: pending animations: "+c.length);c.push(BC.Animation.make({duration:g,updateCallback:function(b){var c=e.ringHeight*b.deltaPercent;b=h*b.deltaPercent;switch(f){case l.UP:return k[1]+=c,!0;case l.DOWN:return k[1]-=c,!0;case l.LEFT:return a.rotate(b),!0;case l.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){f=l.NONE}}))}var l=BC.Constants.Direction,g=0.025,
d={matrix:BC.Matrix.identity,move:function(a){switch(a){case l.LEFT:return f!==l.NONE?a=!1:(b(l.LEFT),a=!0),a;case l.RIGHT:return f!==l.NONE?a=!1:(b(l.RIGHT),a=!0),a;case l.UP:return f!==l.NONE?a=!1:(b(l.UP),a=!0),a;case l.DOWN:return f!==l.NONE?a=!1:(b(l.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(c,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(k[0],k[1],k[2]);d.matrix=
BC.Matrix.matrixMultiply(a,b)}},f=l.NONE,c=[],k=[0,0,0],h=BC.Math.sliceRadians(e.numCells);return d};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function e(a){return c.getUniformLocation(r,a)}function a(){return f.width!=f.clientWidth||f.height!=f.clientHeight?(f.width=f.clientWidth,f.height=f.clientHeight,!0):!1}function b(){var a=f.width/f.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.5,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function g(){c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);c.viewport(0,0,c.canvas.width,
c.canvas.height);c.uniformMatrix4fv(v.projectionMatrixLocation,!1,s);u.tick();w.update(u);t.draw();requestAnimationFrame(g)}var d=BC.Constants.Direction,f=document.getElementById("canvas");if(f){var c=f.getContext("webgl")||f.getContext("experimental-webgl");if(c){var k=c.createTexture();c.bindTexture(c.TEXTURE_2D,k);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var h=new Image;h.src="images/textures.png";$(h).load(function(){c.bindTexture(c.TEXTURE_2D,
k);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,h);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST);c.generateMipmap(c.TEXTURE_2D)});c.enable(c.CULL_FACE);c.enable(c.DEPTH_TEST);c.enable(c.BLEND);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var p=BC.GL.loadShader(c,"vertex-shader",c.VERTEX_SHADER),n=BC.GL.loadShader(c,"fragment-shader",c.FRAGMENT_SHADER),r=BC.GL.createProgram(c,[p,n]);c.useProgram(r);
var v={positionLocation:c.getAttribLocation(r,"a_position"),textureCoordLocation:c.getAttribLocation(r,"a_textureCoord"),projectionMatrixLocation:e("u_projectionMatrix"),viewMatrixLocation:e("u_viewMatrix"),boardMatrixLocation:e("u_boardMatrix"),ringMatrixLocation:e("u_ringMatrix"),cellMatrixLocation:e("u_cellMatrix"),yellowBoostLocation:e("u_yellowBoost"),alphaLocation:e("u_alpha")};a();var s=b();$(window).resize(function(){a()&&(s=b())});p=l();c.uniformMatrix4fv(v.viewMatrixLocation,!1,p);for(var p=
{numRings:4,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},n=[],q=0;q<p.numRings;q++)n[q]=BC.Ring.make(q,p);var w=BC.Board.make(p,n),t=BC.Board.View.make(w,c,v),p=BC.Controller.make(f);p.setMoveLeftListener(function(){w.move(d.LEFT)});p.setMoveRightListener(function(){w.move(d.RIGHT)});p.setMoveUpListener(function(){w.move(d.UP)});p.setMoveDownListener(function(){w.move(d.DOWN)});p.setPrimaryActionListener(function(){w.swap()});var u=BC.StopWatch.make();g()}}};
return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var e=g.Math=g.Math||{};e.radians=function(a){return a*Math.PI/180};e.sliceRadians=function(a){return 2*Math.PI/a};e.randomInt=function(a){return Math.floor(Math.random()*a)};e.circlePoints=function(a,b,l){l=l||0;for(var e=2*Math.PI/b,d=[],f=0;f<b;f++)d[2*f]=a*Math.cos(l+f*e),d[2*f+1]=a*Math.sin(l+f*e);return d};e.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};e.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};e.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){var e=g.Board=g.Board||{};(e.View=e.View||{}).make=function(a,b,l){var e=l.boardMatrixLocation,d=l.ringMatrixLocation,f=l.cellMatrixLocation,c=BC.GL.textureTileSet(4,4,0.002),k=[c.tile(0,0),c.tile(0,1),c.tile(0,2),c.tile(0,3),c.tile(1,0),c.tile(1,1),c.tile(2,0),c.tile(2,1),c.tile(2,2),c.tile(2,3),c.tile(3,0),c.tile(3,1)],c=c.tile(1,2),h=BC.Cell.View.make(b,a.metrics,k),g=BC.Selector.View.make(b,a.metrics,c);return{draw:function(){b.uniformMatrix4fv(e,!1,a.matrix);for(var c=a.rings,
k=0;2>k;k++)for(var v=0;v<c.length;v++){b.uniformMatrix4fv(d,!1,c[v].matrix);for(var s=c[v].cells,q=0;q<s.length;q++)b.uniformMatrix4fv(f,!1,s[q].matrix),0==k?h.drawOpaque(s[q],l):h.drawTransparent(s[q],l)}b.uniformMatrix4fv(e,!1,a.selector.matrix);b.uniformMatrix4fv(d,!1,BC.Matrix.identity);b.uniformMatrix4fv(f,!1,BC.Matrix.identity);g.draw(l)}}};return g}(BC||{});BC=function(g){var e=g.Cell=g.Cell||{};e.CellState={EMPTY:0,EMPTY_RESERVED:1,BLOCK:2,BLOCK_RECEIVING:3,MARKED_BLOCK:4,FREEZING_BLOCK:5,READY_TO_CLEAR_BLOCK:6,CLEARING_BLOCK:7};e.make=function(a,b){function l(){var a=BC.Matrix.makeYRotation(h[1]),b=BC.Matrix.makeTranslation(g[0],g[1],g[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var e=BC.Cell.CellState,d=BC.Constants.Direction,f=BC.Math.randomInt(b.numBlockTypes),c=[],k=BC.Math.sliceRadians(b.numCells),h=[0,a*k,0],g=[0,0,0],n={matrix:BC.Matrix.makeYRotation(h[1]),
state:e.BLOCK,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){n.state=e.MARKED_BLOCK;0<c.length&&BC.Util.error("markBlock: pending animations: "+c.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){n.state=e.FREEZING_BLOCK},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=0}}),d=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=b.numBlockTypes},finishCallback:function(){n.state=
e.READY_TO_CLEAR_BLOCK}});c.push(a,d)},clearBlock:function(){n.state=e.CLEARING_BLOCK;0<c.length&&BC.Util.error("clearBlock: pending animations: "+c.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=e.EMPTY_RESERVED;n.alpha=1}});c.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=e.EMPTY_RESERVED;0<c.length&&BC.Util.error("sendBlock: pending animations: "+c.length);c.push(BC.Animation.make({duration:a,
finishCallback:function(){n.state=e.EMPTY}}));return b},receiveBlock:function(a,f,s){n.blockStyle=s;n.state=e.BLOCK_RECEIVING;switch(f){case d.LEFT:h[1]-=k;break;case d.RIGHT:h[1]+=k;break;case d.UP:g[1]=b.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+f)}l();0<c.length&&BC.Util.error("receiveBlock: pending animations: "+c.length);c.push(BC.Animation.make({duration:a,updateCallback:function(a){var c=k*a.deltaPercent;a=b.ringHeight*a.deltaPercent;switch(f){case d.LEFT:return h[1]+=
c,!0;case d.RIGHT:return h[1]-=c,!0;case d.UP:return g[1]-=a,!0;default:return!1}},finishCallback:function(){n.state=e.BLOCK}}))},isEmpty:function(){return n.state===e.EMPTY||n.state===e.EMPTY_RESERVED},isTransparent:function(){return n.state===e.CLEARING_BLOCK},update:function(a){BC.Animation.process(c,a)&&l()}};return n};return g}(BC||{});BC=function(g){var e=g.GL=g.GL||{};e.loadShader=function(a,b,e,g){g=g||BC.Util.error;var d=document.getElementById(b);if(!d)return g("** Error getting script element:"+b),null;b=a.createShader(e);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),g("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};e.createProgram=function(a,b,e,g){for(var d=a.createProgram(),f=0;f<b.length;f++)a.attachShader(d,b[f]);
if(e)for(f=0;f<e.length;f++)a.bindAttribLocation(d,g?g[f]:f,e[f]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),error("Error in program linking: "+lastError),a.deleteProgram(d),null)};e.textureTileSet=function(a,b,e){var g=1/a,d=1/b;return{tile:function(a,b){var k=g*b,h=d*a;return{textureCoord:function(a,b){return[k+e+(g-2*e)*a,h+e+(d-2*e)*b]}}}}};return g}(BC||{});BC=function(g){var e=g.Selector=g.Selector||{};(e.View=e.View||{}).make=function(a,b,e){var g=-b.ringHeight/2,d=-g;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var f=b.length-2,c=[],k=0;c[k++]=b[f]+0.001;c[k++]=g;c[k++]=-b[f+1]-0.001;c[k++]=b[0]+0.001;c[k++]=g;c[k++]=-b[1]-0.001;c[k++]=b[0]+0.001;c[k++]=d;c[k++]=-b[1]-0.001;c[k++]=b[f]+0.001;c[k++]=d;c[k++]=-b[f+1]-0.001;c[k++]=b[0]+0.001;c[k++]=g;c[k++]=-b[1]-0.001;c[k++]=b[2]+0.001;c[k++]=g;c[k++]=-b[3]-0.001;c[k++]=b[2]+
0.001;c[k++]=d;c[k++]=-b[3]-0.001;c[k++]=b[0]+0.001;c[k++]=d;c[k++]=-b[1]-0.001;var h=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,h);a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW);g=e.textureCoord(0,0);d=e.textureCoord(1,0);b=e.textureCoord(1,1);e=e.textureCoord(0,1);e=new Float32Array([].concat(g,d,b,e,g,d,b,e));var p=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,p);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),r=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
r);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,h);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,p);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){var e=g.Util=g.Util||{};e.log=function(a){window.console&&window.console.log&&window.console.log(a)};e.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return g}(BC||{});BC=function(g){var e=g.Cell=g.Cell||{};(e.Drop=e.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,e=BC.Constants.Direction;return{update:function(g){for(var d=0;d<a.numRings;d++)for(var f=0;f<a.numCells;f++){var c=g,k=d,h=f,p=c.rings[k].cells[h];p.state===b.BLOCK&&(k+=1,k>=a.numRings||(c=c.rings[k].cells[h],p.state===b.BLOCK&&c.state==b.EMPTY&&(p=p.sendBlock(0.05),c.receiveBlock(0.05,e.UP,p))))}}}};return g}(BC||{});BC=function(g){(g.Controller=g.Controller||{}).make=function(e){var a=function(){},b=function(){},g=function(){},m=function(){},d=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:d.call();break;case 37:a.call();break;case 39:b.call();break;case 38:g.call();break;case 40:m.call()}return!1});var f=0,c=0;$(e).on("touchstart touchmove touchend",function(e){var h=e.originalEvent.changedTouches[0];switch(e.type){case "touchstart":f=h.pageX;c=h.pageY;break;case "touchend":e=h.pageX-
f,h=h.pageY-c,50<e?a.call():-50>e?b.call():50<h?m.call():-50>h?g.call():d.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){g=a},setMoveDownListener:function(a){m=a},setPrimaryActionListener:function(a){d=a}}};return g}(BC||{});BC=function(g){var e=g.Cell=g.Cell||{};(e.View=e.View||{}).make=function(a,b,e){function g(b,c){var d=c.positionLocation,e=c.textureCoordLocation,f=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,p);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,n[b.blockStyle]);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.drawElements(a.TRIANGLES,
v,a.UNSIGNED_SHORT,0)}var d=b.numCells,f=b.ringOuterRadius,c=b.ringHeight/2,k=-c,h=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,h);f=BC.Math.circlePoints(f,d,h);d=0;h=[];h[d++]=b[0];h[d++]=c;h[d++]=-b[1];h[d++]=f[0];h[d++]=c;h[d++]=-f[1];h[d++]=f[2];h[d++]=c;h[d++]=-f[3];h[d++]=b[2];h[d++]=c;h[d++]=-b[3];h[d++]=b[0];h[d++]=c;h[d++]=-b[1];h[d++]=b[0];h[d++]=k;h[d++]=-b[1];h[d++]=f[0];h[d++]=k;h[d++]=-f[1];h[d++]=f[0];h[d++]=c;h[d++]=-f[1];h[d++]=f[2];h[d++]=c;h[d++]=-f[3];h[d++]=f[2];h[d++]=
k;h[d++]=-f[3];h[d++]=b[2];h[d++]=k;h[d++]=-b[3];h[d++]=b[2];h[d++]=c;h[d++]=-b[3];h[d++]=f[0];h[d++]=c;h[d++]=-f[1];h[d++]=f[0];h[d++]=k;h[d++]=-f[1];h[d++]=f[2];h[d++]=k;h[d++]=-f[3];h[d++]=f[2];h[d++]=c;h[d++]=-f[3];h[d++]=b[2];h[d++]=c;h[d++]=-b[3];h[d++]=b[2];h[d++]=k;h[d++]=-b[3];h[d++]=b[0];h[d++]=k;h[d++]=-b[1];h[d++]=b[0];h[d++]=c;h[d++]=-b[1];var p=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,p);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);c=[];for(d=0;d<e.length;d++)for(k=
e[d],c[d]=[],f=b=0;5>b;b++)h=k.textureCoord(0,0),c[d][f++]=h[0],c[d][f++]=h[1],h=k.textureCoord(0,1),c[d][f++]=h[0],c[d][f++]=h[1],h=k.textureCoord(1,1),c[d][f++]=h[0],c[d][f++]=h[1],h=k.textureCoord(1,0),c[d][f++]=h[0],c[d][f++]=h[1];for(var n=[],d=0;d<e.length;d++)n[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,n[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(c[d]),a.STATIC_DRAW);e=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var r=a.createBuffer();
a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r);a.bufferData(a.ELEMENT_ARRAY_BUFFER,e,a.STATIC_DRAW);var v=e.length;return{drawOpaque:function(a,b){a.isEmpty()||a.isTransparent()||g(a,b)},drawTransparent:function(b,c){!b.isEmpty()&&b.isTransparent()&&(a.disable(a.CULL_FACE),g(b,c),a.enable(a.CULL_FACE))}}};return g}(BC||{});BC=function(g){(g.StopWatch=g.StopWatch||{}).make=function(){var e={then:0.001*Date.now(),tick:function(){e.now=0.001*Date.now();e.deltaTime=e.now-e.then;e.then=e.now}};return e};return g}(BC||{});
