var BC=function(g){var c=g.Matrix=g.Matrix||{};c.makeLookAt=function(a,b,f){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));f=BC.Math.cross(f,b);var c=BC.Math.cross(b,f);return[f[0],f[1],f[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,f,c){a=Math.tan(0.5*Math.PI-0.5*a);var h=1/(f-c);return[a/b,0,0,0,0,a,0,0,0,0,(f+c)*h,-1,0,0,f*c*h*2,0]};c.makeTranslation=function(a,b,f){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,f,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,f){return[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],f=a[1],c=a[2],h=a[3],e=a[4],d=a[5],r=a[6],k=a[7],q=a[8],g=a[9],t=a[10],n=a[11],u=a[12],p=a[13],m=a[14];a=
a[15];var v=t*a,s=m*n,x=r*a,y=m*k,z=r*n,A=t*k,B=c*a,C=m*h,D=c*n,E=t*h,F=c*k,G=r*h,H=q*p,I=u*g,J=e*p,K=u*d,L=e*g,M=q*d,N=b*p,O=u*f,P=b*g,Q=q*f,R=b*d,S=e*f,T=v*d+y*g+z*p-(s*d+x*g+A*p),U=s*f+B*g+E*p-(v*f+C*g+D*p),p=x*f+C*d+F*p-(y*f+B*d+G*p),f=A*f+D*d+G*g-(z*f+E*d+F*g),d=1/(b*T+e*U+q*p+u*f);return[d*T,d*U,d*p,d*f,d*(s*e+x*q+A*u-(v*e+y*q+z*u)),d*(v*b+C*q+D*u-(s*b+B*q+E*u)),d*(y*b+B*e+G*u-(x*b+C*e+F*u)),d*(z*b+E*e+F*q-(A*b+D*e+G*q)),d*(H*k+K*n+L*a-(I*k+J*n+M*a)),d*(I*h+N*n+Q*a-(H*h+O*n+P*a)),d*(J*h+O*k+
R*a-(K*h+N*k+S*a)),d*(M*h+P*k+S*n-(L*h+Q*k+R*n)),d*(J*t+M*m+I*r-(L*m+H*r+K*t)),d*(P*m+H*c+O*t-(N*t+Q*m+I*c)),d*(N*r+S*m+K*c-(R*m+J*c+O*r)),d*(R*t+L*c+Q*r-(P*r+S*t+M*c))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){(g.CellView=g.CellView||{}).make=function(c,a,b){var f=a.numRingCells,l=a.outerRingRadius,h=a.ringMaxY,e=a.ringMinY,d=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,f,d);l=BC.Math.circlePoints(l,f,d);f=0;d=[];d[f++]=a[0];d[f++]=h;d[f++]=-a[1];d[f++]=l[0];d[f++]=h;d[f++]=-l[1];d[f++]=l[2];d[f++]=h;d[f++]=-l[3];d[f++]=a[2];d[f++]=h;d[f++]=-a[3];d[f++]=a[0];d[f++]=h;d[f++]=-a[1];d[f++]=a[0];d[f++]=e;d[f++]=-a[1];d[f++]=l[0];d[f++]=e;d[f++]=-l[1];d[f++]=l[0];d[f++]=h;d[f++]=-l[1];
d[f++]=l[2];d[f++]=h;d[f++]=-l[3];d[f++]=l[2];d[f++]=e;d[f++]=-l[3];d[f++]=a[2];d[f++]=e;d[f++]=-a[3];d[f++]=a[2];d[f++]=h;d[f++]=-a[3];d[f++]=l[0];d[f++]=h;d[f++]=-l[1];d[f++]=l[0];d[f++]=e;d[f++]=-l[1];d[f++]=l[2];d[f++]=e;d[f++]=-l[3];d[f++]=l[2];d[f++]=h;d[f++]=-l[3];d[f++]=a[2];d[f++]=h;d[f++]=-a[3];d[f++]=a[2];d[f++]=e;d[f++]=-a[3];d[f++]=a[0];d[f++]=e;d[f++]=-a[1];d[f++]=a[0];d[f++]=h;d[f++]=-a[1];var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,new Float32Array(d),
c.STATIC_DRAW);h=[];for(f=0;f<b.length;f++)for(e=b[f],h[f]=[],l=a=0;5>a;a++)d=e.textureCoord(0,0),h[f][l++]=d[0],h[f][l++]=d[1],d=e.textureCoord(0,1),h[f][l++]=d[0],h[f][l++]=d[1],d=e.textureCoord(1,1),h[f][l++]=d[0],h[f][l++]=d[1],d=e.textureCoord(1,0),h[f][l++]=d[0],h[f][l++]=d[1];for(var k=[],f=0;f<b.length;f++)k[f]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,k[f]),c.bufferData(c.ARRAY_BUFFER,new Float32Array(h[f]),c.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,
14,12,14,15,16,17,18,16,18,19]);var q=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,q);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);var w=b.length;return{draw:function(a,b){var f=b.positionLocation,d=b.textureCoordLocation;c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(f);c.vertexAttribPointer(f,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,k[a.blockStyle]);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,q);c.drawElements(c.TRIANGLES,
w,c.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){(g.BoardView=g.BoardView||{}).make=function(c,a,b){var f=b.boardMatrixLocation,l=b.ringMatrixLocation,h=b.cellMatrixLocation,e=BC.GL.textureTileSet(4,4,0.002),d=[e.tile(0,0),e.tile(0,1),e.tile(0,2),e.tile(0,3),e.tile(1,0),e.tile(1,1)],e=e.tile(1,2),g=BC.CellView.make(a,c,d),k=BC.SelectorView.make(a,c,e);return{draw:function(){a.uniformMatrix4fv(f,!1,c.matrix);for(var d=c.rings,e=0;e<d.length;e++){a.uniformMatrix4fv(l,!1,d[e].matrix);for(var t=d[e].cells,n=0;n<t.length;n++)a.uniformMatrix4fv(h,
!1,t[n].matrix),g.draw(t[n],b)}a.uniformMatrix4fv(f,!1,c.selector.matrix);a.uniformMatrix4fv(l,!1,BC.Matrix.identity);a.uniformMatrix4fv(h,!1,BC.Matrix.identity);k.draw(b)}}};return g}(BC||{});BC=function(g){(g.Time=g.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return g}(BC||{});BC=function(g){(g.SelectorView=g.SelectorView||{}).make=function(c,a,b){var f=a.ringMinY,l=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var h=a.length-2,e=[],d=0;e[d++]=a[h]+0.001;e[d++]=f;e[d++]=-a[h+1]-0.001;e[d++]=a[0]+0.001;e[d++]=f;e[d++]=-a[1]-0.001;e[d++]=a[0]+0.001;e[d++]=l;e[d++]=-a[1]-0.001;e[d++]=a[h]+0.001;e[d++]=l;e[d++]=-a[h+1]-0.001;e[d++]=a[0]+0.001;e[d++]=f;e[d++]=-a[1]-0.001;e[d++]=a[2]+0.001;e[d++]=f;e[d++]=-a[3]-0.001;e[d++]=a[2]+0.001;e[d++]=
l;e[d++]=-a[3]-0.001;e[d++]=a[0]+0.001;e[d++]=l;e[d++]=-a[1]-0.001;var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,new Float32Array(e),c.STATIC_DRAW);f=b.textureCoord(0,0);l=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(f,l,a,b,f,l,a,b));var k=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,k);c.bufferData(c.ARRAY_BUFFER,b,c.STATIC_DRAW);var q=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),w=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
w);c.bufferData(c.ELEMENT_ARRAY_BUFFER,q,c.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation;a=a.textureCoordLocation;c.enable(c.BLEND);c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(b);c.vertexAttribPointer(b,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,k);c.enableVertexAttribArray(a);c.vertexAttribPointer(a,2,c.FLOAT,!1,0,0);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,w);c.drawElements(c.TRIANGLES,q.length,c.UNSIGNED_SHORT,0);c.disable(c.BLEND)}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(c){function a(a){for(var b=[],d=0;d<c.numRingCells;d++){var e=b,g=d,k=d,m=BC.Math.randomInt(c.numBlockStyles),k=[0,k*l,0],r=BC.Matrix.makeYRotation(k[1]);e[g]={matrix:r,state:f.NONE,blockStyle:m,elapsedSwapTime:0,rotation:k}}a=BC.Matrix.makeTranslation(0,-a*h,0);return{cells:b,matrix:a}}for(var b=BC.Constants.Direction,f={NONE:0,SWAP_LEFT:1,SWAP_RIGHT:2},l=2*Math.PI/c.numRingCells,h=c.ringMaxY-c.ringMinY,e=[],d=0;3>d;d++)e[d]=a(d);var g={matrix:BC.Matrix.identity,
direction:b.NONE,elapsedMovementTime:0,translation:[0,0,0]},k={rings:e,selector:g,matrix:BC.Matrix.identity,numRingCells:c.numRingCells,innerRingRadius:c.innerRingRadius,outerRingRadius:c.outerRingRadius,ringMaxY:c.ringMaxY,ringMinY:c.ringMinY,move:function(a){switch(a){case b.LEFT:g.direction===b.NONE&&(g.direction=b.LEFT,g.elapsedMovementTime=0,k.currentCell--,0>k.currentCell&&(k.currentCell=c.numRingCells-1));break;case b.RIGHT:g.direction===b.NONE&&(g.direction=b.RIGHT,g.elapsedMovementTime=0,
k.currentCell++,k.currentCell>=c.numRingCells&&(k.currentCell=0));break;case b.UP:g.direction===b.NONE&&0<k.currentRing&&(g.direction=b.UP,g.elapsedMovementTime=0,k.currentRing--);break;case b.DOWN:g.direction===b.NONE&&k.currentRing+1<k.rings.length&&(g.direction=b.DOWN,g.elapsedMovementTime=0,k.currentRing++)}},swap:function(){var a=k.rings[k.currentRing],b=a.cells[k.currentCell],a=a.cells[(k.currentCell+1)%a.cells.length],d=b.blockStyle;b.blockStyle=a.blockStyle;b.state=f.SWAP_RIGHT;b.rotation[1]+=
l;b.elapsedSwapTime=0;a.blockStyle=d;a.state=f.SWAP_LEFT;a.rotation[1]-=l;a.elapsedSwapTime=0},update:function(a,d){for(var c=k.rings,e=0;e<c.length;e++)for(var u=c[e].cells,p=0;p<u.length;p++){var m=u[p];if(m.state==f.SWAP_LEFT||m.state==f.SWAP_RIGHT){var v=a;0.125<m.elapsedSwapTime+a&&(v=0.125-m.elapsedSwapTime);var s=l*v/0.125;m.rotation[1]=m.state==f.SWAP_LEFT?m.rotation[1]+s:m.rotation[1]-s;m.matrix=BC.Matrix.makeYRotation(m.rotation[1]);m.elapsedSwapTime+=v;0.125<=m.elapsedSwapTime&&(m.state=
f.NONE,m.elapsedSwapTime=0)}}if(g.direction!==b.NONE){0.05<g.elapsedMovementTime+a&&(a=0.05-g.elapsedMovementTime);c=a*h/0.05;s=a*l/0.05;switch(g.direction){case b.UP:g.translation[1]+=c;break;case b.DOWN:g.translation[1]-=c;break;case b.LEFT:k.rotation[1]+=s;break;case b.RIGHT:k.rotation[1]-=s}g.elapsedMovementTime+=a;0.05<=g.elapsedMovementTime&&(g.direction=b.NONE,g.elapsedMovementTime=0)}s=BC.Matrix.makeXRotation(k.rotation[0]);c=BC.Matrix.makeYRotation(k.rotation[1]);e=BC.Matrix.makeZRotation(k.rotation[2]);
c=BC.Matrix.matrixMultiply(e,c);c=BC.Matrix.matrixMultiply(c,s);k.matrix=c;s=1+Math.abs(Math.sin(4*d))/25;s=BC.Matrix.makeScale(s,s,1);c=BC.Matrix.makeTranslation(g.translation[0],g.translation[1],g.translation[2]);k.selector.matrix=BC.Matrix.matrixMultiply(s,c)},currentRing:0,currentCell:c.numRingCells-1,rotation:[0,0,0]};return k};return g}(BC||{});BC=function(g){var c=g.GL=g.GL||{};c.loadShader=function(a,b,c,g){g=g||BC.Util.error;var h=document.getElementById(b);if(!h)return g("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,h.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),g("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,g){for(var h=a.createProgram(),e=0;e<b.length;e++)a.attachShader(h,b[e]);
if(c)for(e=0;e<c.length;e++)a.bindAttribLocation(h,g?g[e]:e,c[e]);a.linkProgram(h);return a.getProgramParameter(h,a.LINK_STATUS)?h:(lastError=a.getProgramInfoLog(h),error("Error in program linking: "+lastError),a.deleteProgram(h),null)};c.textureTileSet=function(a,b,c){var g=1/a,h=1/b;return{tile:function(a,b){var r=g*b,k=h*a;return{textureCoord:function(a,b){return[r+c+(g-2*c)*a,k+c+(h-2*c)*b]}}}}};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function c(){return h.width!=h.clientWidth||h.height!=h.clientHeight?(h.width=h.clientWidth,h.height=h.clientHeight,!0):!1}function a(){var a=h.width/h.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){var a=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function f(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);e.viewport(0,0,e.canvas.width,e.canvas.height);e.uniformMatrix4fv(w.projectionMatrixLocation,
!1,t);var a=BC.Time.getTimeInSeconds(),b=a-v;v=a;n.update(b,a);u.draw();requestAnimationFrame(f)}var g=BC.Constants.Direction,h=document.getElementById("canvas");if(h){var e=h.getContext("webgl")||h.getContext("experimental-webgl");if(e){var d=e.createTexture();e.bindTexture(e.TEXTURE_2D,d);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var r=new Image;r.src="images/textures.png";$(r).load(function(){e.bindTexture(e.TEXTURE_2D,d);e.texImage2D(e.TEXTURE_2D,
0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r);e.generateMipmap(e.TEXTURE_2D)});e.enable(e.CULL_FACE);e.enable(e.DEPTH_TEST);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);var k=BC.GL.loadShader(e,"vertex-shader",e.VERTEX_SHADER),q=BC.GL.loadShader(e,"fragment-shader",e.FRAGMENT_SHADER),k=BC.GL.createProgram(e,[k,q]);e.useProgram(k);var w={positionLocation:e.getAttribLocation(k,"a_position"),textureCoordLocation:e.getAttribLocation(k,"a_texcoord"),projectionMatrixLocation:e.getUniformLocation(k,"u_projectionMatrix"),
viewMatrixLocation:e.getUniformLocation(k,"u_viewMatrix"),boardMatrixLocation:e.getUniformLocation(k,"u_boardMatrix"),ringMatrixLocation:e.getUniformLocation(k,"u_ringMatrix"),cellMatrixLocation:e.getUniformLocation(k,"u_cellMatrix")};c();var t=a();$(window).resize(function(){c()&&(t=a())});k=b();e.uniformMatrix4fv(w.viewMatrixLocation,!1,k);var n=BC.Board.make({numRingCells:24,numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),u=BC.BoardView.make(n,e,w),p=0,m=
0;$(h).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":p=b.pageX;m=b.pageY;break;case "touchend":a=b.pageX-p,b=b.pageY-m,50<a?n.move(g.LEFT):-50>a?n.move(g.RIGHT):50<b?n.move(g.DOWN):-50>b?n.move(g.UP):n.swap()}return!1});$(document).keydown(function(a){switch(a.keyCode){case 32:n.swap();break;case 37:n.move(g.LEFT);break;case 39:n.move(g.RIGHT);break;case 38:n.move(g.UP);break;case 40:n.move(g.DOWN)}return!1});var v=BC.Time.getTimeInSeconds();
f()}}};return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var c=g.Math=g.Math||{};c.radians=function(a){return a*Math.PI/180};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var g=2*Math.PI/b,h=[],e=0;e<b;e++)h[2*e]=a*Math.cos(c+e*g),h[2*e+1]=a*Math.sin(c+e*g);return h};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){(g.Util=g.Util||{}).error=function(c){window.console&&(window.console.error?window.console.error(c):window.console.log&&window.console.log(c))};return g}(BC||{});
