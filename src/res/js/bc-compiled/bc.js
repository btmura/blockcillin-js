var BC=function(h){var c=h.Matrix=h.Matrix||{};c.makeLookAt=function(a,b,m){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));m=BC.Math.cross(m,b);var k=BC.Math.cross(b,m);return[m[0],m[1],m[2],0,k[0],k[1],k[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,m,k){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(m-k);return[a/b,0,0,0,0,a,0,0,0,0,(m+k)*d,-1,0,0,m*k*d*2,0]};c.makeTranslation=function(a,b,m){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,m,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,m){return[a,0,0,0,0,b,0,0,0,0,m,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],m=a[1],k=a[2],d=a[3],g=a[4],e=a[5],l=a[6],f=a[7],v=a[8],c=a[9],h=a[10],r=a[11],t=a[12],s=a[13],p=a[14];a=
a[15];var q=h*a,w=p*r,x=l*a,y=p*f,z=l*r,A=h*f,B=k*a,C=p*d,D=k*r,E=h*d,F=k*f,G=l*d,H=v*s,I=t*c,J=g*s,K=t*e,L=g*c,M=v*e,N=b*s,O=t*m,P=b*c,Q=v*m,R=b*e,S=g*m,T=q*e+y*c+z*s-(w*e+x*c+A*s),U=w*m+B*c+E*s-(q*m+C*c+D*s),s=x*m+C*e+F*s-(y*m+B*e+G*s),m=A*m+D*e+G*c-(z*m+E*e+F*c),e=1/(b*T+g*U+v*s+t*m);return[e*T,e*U,e*s,e*m,e*(w*g+x*v+A*t-(q*g+y*v+z*t)),e*(q*b+C*v+D*t-(w*b+B*v+E*t)),e*(y*b+B*g+G*t-(x*b+C*g+F*t)),e*(z*b+E*g+F*v-(A*b+D*g+G*v)),e*(H*f+K*r+L*a-(I*f+J*r+M*a)),e*(I*d+N*r+Q*a-(H*d+O*r+P*a)),e*(J*d+O*f+
R*a-(K*d+N*f+S*a)),e*(M*d+P*f+S*r-(L*d+Q*f+R*r)),e*(J*h+M*p+I*l-(L*p+H*l+K*h)),e*(P*p+H*k+O*h-(N*h+Q*p+I*k)),e*(N*l+S*p+K*k-(R*p+J*k+O*l)),e*(R*h+L*k+Q*l-(P*l+S*h+M*k))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return h}(BC||{});BC=function(h){var c=h.Animation=h.Animation||{};c.make=function(a){var b=a.duration,m=a.startCallback||function(){},k=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},g=0,e=!1,l=!1;return{update:function(a){e||(e=!0,m());var c=a.deltaTime;g+c>b&&(c=b-g);g+=c;a=k({now:a.now,deltaTime:c,elapsedPercent:g/b,deltaPercent:c/b});g>=b&&(l=!0,d());return a},isDone:function(){return l}}};c.process=function(a,b){var m=!1;if(0<a.length){var k=a[0],m=m|k.update(b);k.isDone()&&a.shift()}return m};
return h}(BC||{});BC=function(h){var c=h.Cell=h.Cell||{},c=c.Chain=c.Chain||{};c.find=function(a){function b(b,d){return a.rings[b].cells[d]}function m(){for(var d=a.rings.length,k=[],g=0;g<d;g++){var m;m=g;for(var c=0,h=b(m,c),p=0;p<l;p++){var q=b(m,c);if(h.state!==q.state||h.blockStyle!=q.blockStyle)break;c+=1;c=c===l?0:c}m=c;for(c=0;c<l;)if(p=(c+m)%l,q=b(g,p),q.state!==e.BLOCK)c++;else{for(var w=1,h=c+1;h<l;h++)if(p=(h+m)%l,p=b(g,p),q.state===p.state&&q.blockStyle==p.blockStyle)w++;else break;if(w>=f){for(q=[];c<
h;c++)p=(c+m)%l,w=b(g,p),q.push({cell:w,row:g,col:p});k.push(q)}c=h}}return k}function k(){for(var d=a.rings.length,k=[],g=0;g<l;g++)for(var c=0;c<d;){var m=b(c,g);if(m.state!==e.BLOCK)c++;else{for(var h=1,p=c+1;p<d;p++){var q=b(p,g);if(m.state===q.state&&m.blockStyle==q.blockStyle)h++;else break}if(h>=f){for(m=[];c<p;c++)h=b(c,g),m.push({cell:h,row:c,col:g});k.push(m)}c=p}}return k}function d(a,b){for(var d=0;d<a.length;d++)for(var e=a[d],c=0;c<b.length;c++){var g=b[c];if(e.blockStyle===g.blockStyle&&
e.row===g.row&&e.col===g.col)return!0}return!1}function g(a,b){for(var d=0;d<a.length;d++){var e=a[d];if(e.blockStyle===b.blockStyle&&e.row===b.row&&e.col===b.col)return!0}return!1}var e=BC.Cell.CellState,l=a.rings[0].cells.length,f=3;return function(){for(var a=[],b=m(),e=k();0<b.length;){var c=b.shift();for(a.push(c);;){for(var f=!1,l=0;l<e.length;l++)if(d(c,e[l])){for(f=0;f<e[l].length;f++)g(c,e[l][f])||c.push(e[l][f]);e.splice(l,1);f=!0}if(!f)break;f=!1;for(l=0;l<b.length;l++)if(d(c,b[l])){for(f=
0;f<b[l].length;f++)g(c,b[l][f])||c.push(b[l][f]);b.splice(l,1);f=!0}if(!f)break}}for(;0<e.length;)c=e.shift(),a.push(c);for(l=0;l<a.length;l++)a[l].sort(function(a,b){return a.row-b.row});return a}()};c.makeManager=function(){var a=BC.Cell.CellState,b=[],c=[];return{update:function(k){var d=BC.Cell.Chain.find(k);for(k=0;k<d.length;k++){var g=d[k];c.push(g);for(var e=0;e<g.length;e++){var l=g[e].cell;l.markBlock();b.push(l)}}if(0<b.length)switch(l=b[0],l.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:l.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<c.length){g=c[0];d=!0;for(k=0;k<g.length;k++)l=g[k].cell,d&=!l.isClearing();if(d){for(k=0;k<g.length;k++)l=g[k].cell,l.state===a.EMPTY_NO_DROP&&(l.state=a.EMPTY);c.shift()}}return 0<c.length}}};return h}(BC||{});BC=function(h){(h.Constants=h.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).make=function(c){function a(){var a=-c.ringHeight*s;t.push(a);a=BC.Ring.make(c,a);r.push(a);s++}function b(){q.translationMatrix=BC.Matrix.makeTranslation(n[0],n[1],n[2])}function m(){var a=BC.Matrix.makeXRotation(u[0]),b=BC.Matrix.makeYRotation(u[1]),d=BC.Matrix.makeZRotation(u[2]),b=BC.Matrix.matrixMultiply(d,b),b=BC.Matrix.matrixMultiply(b,a);q.rotationMatrix=b}for(var k=BC.Cell.CellState,d=BC.Constants.Direction,g=11*c.ringHeight,e=0,l=c.numCells-1,f=5.5*-c.ringHeight-
c.ringHeight/2,h=c.ringHeight*c.numRings,n=[0,f+h,0],u=[0,0,0],r=[],t=[],s=0,p=0;p<c.numRings;p++)a();var q={metrics:c,rings:r,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case d.LEFT:w.move(d.LEFT)&&(l--,0>l&&(l=c.numCells-1));break;case d.RIGHT:w.move(d.RIGHT)&&(l++,l>=c.numCells&&(l=0));break;case d.UP:0<e&&w.move(d.UP)&&e--;break;case d.DOWN:e+1<q.rings.length&&w.move(d.DOWN)&&e++}},rotate:function(a){u[1]+=a},swap:function(){var a=r[e].cells[l%
c.numCells],b=r[e].cells[(l+1)%c.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var f=a.blockStyle,g=b.blockStyle;a.state!==k.EMPTY&&a.state!==k.EMPTY_NO_DROP||b.state!==k.BLOCK?a.state!==k.BLOCK||b.state!==k.EMPTY&&b.state!==k.EMPTY_NO_DROP?a.state===k.BLOCK&&b.state===k.BLOCK&&(a.receiveBlock(0.1,d.RIGHT,g),b.receiveBlock(0.1,d.LEFT,f)):(a.sendBlock(0.1,d.RIGHT),b.receiveBlock(0.1,d.LEFT,f)):(b.sendBlock(0.1,d.LEFT),a.receiveBlock(0.1,d.RIGHT,g))},update:function(d){for(var f=0;f<r.length;f++)for(var l=
0;l<c.numCells;l++)r[f].cells[l%c.numCells].update(d);f=0|x.update(q);f|=y.update(q);f||(f=0.02*d.deltaTime,h+f>g&&(f=g-h),h+=f,n[1]+=f);w.update(d);b();for(m();0<r.length&&r[0].isEmpty();)r.shift(),t.shift(),h-=c.ringHeight,e--;d=Math.ceil((h-c.ringHeight*r.length)/c.ringHeight);for(f=0;f<d;f++)a();h>=g&&BC.Util.log("GAME OVER")}};b();m();var w=BC.Selector.make(c,q);q.selector=w;f=BC.Stage.make(c,f);q.stage=f;var x=BC.Cell.Chain.makeManager(),y=BC.Cell.Drop.makeManager(c);return q};return h}(BC||
{});BC=function(h){(h.Ring=h.Ring||{}).make=function(c,a){for(var b=BC.Math.sliceRadians(c.numCells),m=BC.Matrix.makeTranslation(0,a,0),k=[],d=0;d<c.numCells;d++)k[d]=BC.Cell.make(c,d*b);return{matrix:m,cells:k,isEmpty:function(){for(var a=0;a<k.length;a++)if(k[a].state!==BC.Cell.CellState.EMPTY)return!1;return!0}}};return h}(BC||{});BC=function(h){(h.Stage=h.Stage||{}).make=function(c,a){a+=c.ringHeight/2;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return h}(BC||{});BC=function(h){(h.Selector=h.Selector||{}).make=function(c,a){function b(b){g=b;0<e.length&&BC.Util.error("startMoving: pending animations: "+e.length);e.push(BC.Animation.make({duration:k,updateCallback:function(b){var d=c.ringHeight*b.deltaPercent;b=f*b.deltaPercent;switch(g){case m.UP:return l[1]+=d,!0;case m.DOWN:return l[1]-=d,!0;case m.LEFT:return a.rotate(b),!0;case m.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){g=m.NONE}}))}var m=BC.Constants.Direction,k=0.025,
d={matrix:BC.Matrix.identity,move:function(a){switch(a){case m.LEFT:return g!==m.NONE?a=!1:(b(m.LEFT),a=!0),a;case m.RIGHT:return g!==m.NONE?a=!1:(b(m.RIGHT),a=!0),a;case m.UP:return g!==m.NONE?a=!1:(b(m.UP),a=!0),a;case m.DOWN:return g!==m.NONE?a=!1:(b(m.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(e,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(l[0],l[1],l[2]);d.matrix=
BC.Matrix.matrixMultiply(a,b)}},g=m.NONE,e=[],l=[0,0,0],f=BC.Math.sliceRadians(c.numCells);return d};return h}(BC||{});BC=function(h){(h.Game=h.Game||{}).run=function(){function c(a){return e.getUniformLocation(u,a)}function a(){return g.width!=g.clientWidth||g.height!=g.clientHeight?(g.width=g.clientWidth,g.height=g.clientHeight,!0):!1}function b(){var a=g.width/g.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function m(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function k(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);e.viewport(0,0,e.canvas.width,
e.canvas.height);e.uniformMatrix4fv(r.projectionMatrixLocation,!1,t);q.tick();s.update(q);p.draw();requestAnimationFrame(k)}var d=BC.Constants.Direction,g=document.getElementById("canvas");if(g){var e=g.getContext("webgl")||g.getContext("experimental-webgl");if(e){var l=e.createTexture();e.bindTexture(e.TEXTURE_2D,l);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var f=new Image;f.src="images/textures.png";$(f).load(function(){e.bindTexture(e.TEXTURE_2D,
l);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST);e.generateMipmap(e.TEXTURE_2D)});e.enable(e.CULL_FACE);e.enable(e.DEPTH_TEST);e.enable(e.BLEND);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);var h=BC.GL.loadShader(e,"vertex-shader",e.VERTEX_SHADER),n=BC.GL.loadShader(e,"fragment-shader",e.FRAGMENT_SHADER),u=BC.GL.createProgram(e,[h,n]);e.useProgram(u);
var r={positionLocation:e.getAttribLocation(u,"a_position"),textureCoordLocation:e.getAttribLocation(u,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardRotationMatrixLocation:c("u_boardRotationMatrix"),boardTranslationMatrixLocation:c("u_boardTranslationMatrix"),selectorMatrixLocation:c("u_selectorMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};
a();var t=b();$(window).resize(function(){a()&&(t=b())});h=m();e.uniformMatrix4fv(r.viewMatrixLocation,!1,h);var s=BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),p=BC.Board.View.make(s,e,r),h=BC.Controller.make(g);h.setMoveLeftListener(function(){s.move(d.LEFT)});h.setMoveRightListener(function(){s.move(d.RIGHT)});h.setMoveUpListener(function(){s.move(d.UP)});h.setMoveDownListener(function(){s.move(d.DOWN)});h.setPrimaryActionListener(function(){s.swap()});
var q=BC.StopWatch.make();k()}}};return h}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(h){var c=h.Math=h.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var k=2*Math.PI/b,d=[],g=0;g<b;g++)d[2*g]=a*Math.cos(c+g*k),d[2*g+1]=a*Math.sin(c+g*k);return d};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return h}(BC||{});BC=function(h){var c=h.Board=h.Board||{};(c.View=c.View||{}).make=function(a,b,c){var k=c.boardRotationMatrixLocation,d=c.boardTranslationMatrixLocation,g=c.selectorMatrixLocation,e=c.ringMatrixLocation,l=c.cellMatrixLocation,f=BC.GL.textureTileSet(4,4,0.002),h=[f.tile(0,0),f.tile(0,1),f.tile(0,2),f.tile(0,3),f.tile(1,0),f.tile(1,1),f.tile(2,0),f.tile(2,1),f.tile(2,2),f.tile(2,3),f.tile(3,0),f.tile(3,1)],n=f.tile(1,2),f=f.tile(1,3),u=BC.Cell.View.make(b,a.metrics,h),r=BC.Selector.View.make(b,a.metrics,
n),t=BC.Stage.View.make(b,a.metrics,f);return{draw:function(){b.uniformMatrix4fv(k,!1,a.rotationMatrix);b.uniformMatrix4fv(d,!1,a.translationMatrix);b.uniformMatrix4fv(g,!1,BC.Matrix.identity);for(var f=a.rings,h=0;2>h;h++)for(var n=0;n<f.length;n++){b.uniformMatrix4fv(e,!1,f[n].matrix);for(var v=f[n].cells,x=0;x<v.length;x++)b.uniformMatrix4fv(l,!1,v[x].matrix),0==h?u.drawOpaque(v[x],c):u.drawTransparent(v[x],c)}b.uniformMatrix4fv(k,!1,BC.Matrix.identity);b.uniformMatrix4fv(d,!1,BC.Matrix.identity);
b.uniformMatrix4fv(g,!1,a.stage.matrix);b.uniformMatrix4fv(e,!1,BC.Matrix.identity);b.uniformMatrix4fv(l,!1,BC.Matrix.identity);t.draw(c);b.uniformMatrix4fv(k,!1,BC.Matrix.identity);b.uniformMatrix4fv(d,!1,a.translationMatrix);b.uniformMatrix4fv(g,!1,a.selector.matrix);b.uniformMatrix4fv(e,!1,BC.Matrix.identity);b.uniformMatrix4fv(l,!1,BC.Matrix.identity);r.draw(c)}}};return h}(BC||{});BC=function(h){var c=h.Cell=h.Cell||{};c.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_RECEIVING:4,BLOCK_CLEARING_MARKED:5,BLOCK_CLEARING_PREPARING:6,BLOCK_CLEARING_READY:7,BLOCK_CLEARING_IN_PROGRESS:8};c.make=function(a,b){function c(){var a=BC.Matrix.makeYRotation(f[1]),b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var k=BC.Cell.CellState,d=BC.Constants.Direction,g=BC.Math.sliceRadians(a.numCells),e=BC.Math.randomInt(a.numBlockTypes),l=[],
f=[0,b,0],h=[0,0,0],n={matrix:BC.Matrix.makeYRotation(f[1]),state:k.BLOCK,blockStyle:e,yellowBoost:0,alpha:1,markBlock:function(){n.state=k.BLOCK_CLEARING_MARKED;0<l.length&&BC.Util.error("markBlock: pending animations: "+l.length);var b=BC.Animation.make({duration:0.5,startCallback:function(){n.state=k.BLOCK_CLEARING_PREPARING},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=0}}),d=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=
a.numBlockTypes},finishCallback:function(){n.state=k.BLOCK_CLEARING_READY}});l.push(b,d)},clearBlock:function(){n.state=k.BLOCK_CLEARING_IN_PROGRESS;0<l.length&&BC.Util.error("clearBlock: pending animations: "+l.length);var a=BC.Animation.make({duration:0.25,updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=k.EMPTY_NO_DROP;n.alpha=1}});l.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=k.EMPTY_NO_SWAP;0<l.length&&BC.Util.error("sendBlock: pending animations: "+
l.length);l.push(BC.Animation.make({duration:a,finishCallback:function(){n.state=k.EMPTY}}));return b},receiveBlock:function(b,e,t){n.blockStyle=t;n.state=k.BLOCK_RECEIVING;switch(e){case d.LEFT:f[1]-=g;break;case d.RIGHT:f[1]+=g;break;case d.UP:h[1]=a.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+e)}c();0<l.length&&BC.Util.error("receiveBlock: pending animations: "+l.length);l.push(BC.Animation.make({duration:b,updateCallback:function(b){var c=g*b.deltaPercent;b=a.ringHeight*
b.deltaPercent;switch(e){case d.LEFT:return f[1]+=c,!0;case d.RIGHT:return f[1]-=c,!0;case d.UP:return h[1]-=b,!0;default:return!1}},finishCallback:function(){n.state=k.BLOCK}}))},isClearing:function(){return n.state===k.BLOCK_CLEARING_MARKED||n.state===k.BLOCK_CLEARING_PREPARING||n.state===k.BLOCK_CLEARING_READY||n.state===k.BLOCK_CLEARING_IN_PROGRESS},isDrawable:function(){return n.state!==k.EMPTY&&n.state!==k.EMPTY_NO_SWAP&&n.state!==k.EMPTY_NO_DROP},isTransparent:function(){return n.state===k.BLOCK_CLEARING_IN_PROGRESS},
update:function(a){BC.Animation.process(l,a)&&c()}};return n};return h}(BC||{});BC=function(h){var c=h.Stage=h.Stage||{};(c.View=c.View||{}).make=function(a,b,c){b=[];var k=0;b[k++]=-1;b[k++]=0;b[k++]=1;b[k++]=1;b[k++]=0;b[k++]=1;b[k++]=1;b[k++]=0;b[k++]=-1;b[k++]=-1;b[k++]=0;b[k++]=-1;b[k++]=-1;b[k++]=-1;b[k++]=1;b[k++]=1;b[k++]=-1;b[k++]=1;b[k++]=1;b[k++]=0;b[k++]=1;b[k++]=-1;b[k++]=0;b[k++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var k=c.textureCoord(1,0),g=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,k,g,c,b,k,g,c));var e=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,e);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var l=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),f=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.bufferData(a.ELEMENT_ARRAY_BUFFER,l,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,g=b.textureCoordLocation,k=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,e);a.enableVertexAttribArray(g);a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0);a.uniform1f(k,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.drawElements(a.TRIANGLES,l.length,a.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){var c=h.GL=h.GL||{};c.loadShader=function(a,b,c,k){k=k||BC.Util.error;var d=document.getElementById(b);if(!d)return k("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),k("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,k){for(var d=a.createProgram(),g=0;g<b.length;g++)a.attachShader(d,b[g]);
if(c)for(g=0;g<c.length;g++)a.bindAttribLocation(d,k?k[g]:g,c[g]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};c.textureTileSet=function(a,b,c){var k=1/a,d=1/b;return{tile:function(a,b){var l=k*b,f=d*a;return{textureCoord:function(a,b){return[l+c+(k-2*c)*a,f+c+(d-2*c)*b]}}}}};return h}(BC||{});BC=function(h){var c=h.Selector=h.Selector||{};(c.View=c.View||{}).make=function(a,b,c){var k=-b.ringHeight/2,d=-k;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var g=b.length-2,e=[],l=0;e[l++]=b[g]+0.001;e[l++]=k;e[l++]=-b[g+1]-0.001;e[l++]=b[0]+0.001;e[l++]=k;e[l++]=-b[1]-0.001;e[l++]=b[0]+0.001;e[l++]=d;e[l++]=-b[1]-0.001;e[l++]=b[g]+0.001;e[l++]=d;e[l++]=-b[g+1]-0.001;e[l++]=b[0]+0.001;e[l++]=k;e[l++]=-b[1]-0.001;e[l++]=b[2]+0.001;e[l++]=k;e[l++]=-b[3]-0.001;e[l++]=b[2]+
0.001;e[l++]=d;e[l++]=-b[3]-0.001;e[l++]=b[0]+0.001;e[l++]=d;e[l++]=-b[1]-0.001;var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,new Float32Array(e),a.STATIC_DRAW);k=c.textureCoord(0,0);d=c.textureCoord(1,0);b=c.textureCoord(1,1);c=c.textureCoord(0,1);c=new Float32Array([].concat(k,d,b,c,k,d,b,c));var h=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,h);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),u=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
u);a.bufferData(a.ELEMENT_ARRAY_BUFFER,n,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,d=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(c);a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,h);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.drawElements(a.TRIANGLES,n.length,a.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){var c=h.Util=h.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return h}(BC||{});BC=function(h){var c=h.Cell=h.Cell||{};(c.Drop=c.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,c=BC.Constants.Direction;return{update:function(k){for(var d=0;d<k.rings.length;d++)for(var g=0;g<a.numCells;g++){var e=k,l=d,f=g,h=e.rings[l].cells[f];h.state===b.BLOCK&&(l+=1,l>=e.rings.length||(e=e.rings[l].cells[f],h.state===b.BLOCK&&e.state==b.EMPTY&&(h=h.sendBlock(0.05),e.receiveBlock(0.05,c.UP,h))))}return!1}}};return h}(BC||{});BC=function(h){(h.Controller=h.Controller||{}).make=function(c){var a=function(){},b=function(){},h=function(){},k=function(){},d=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:d.call();break;case 37:a.call();break;case 39:b.call();break;case 38:h.call();break;case 40:k.call()}return!1});var g=0,e=0;$(c).on("touchstart touchmove touchend",function(c){var f=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":g=f.pageX;e=f.pageY;break;case "touchend":c=f.pageX-
g,f=f.pageY-e,50<c?a.call():-50>c?b.call():50<f?k.call():-50>f?h.call():d.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){h=a},setMoveDownListener:function(a){k=a},setPrimaryActionListener:function(a){d=a}}};return h}(BC||{});BC=function(h){var c=h.Cell=h.Cell||{};(c.View=c.View||{}).make=function(a,b,c){function h(b,c){var d=c.positionLocation,e=c.textureCoordLocation,f=c.yellowBoostLocation,g=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,v);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,n[b.blockStyle]);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(f,b.yellowBoost);a.uniform1f(g,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.drawElements(a.TRIANGLES,
r,a.UNSIGNED_SHORT,0)}var d=b.numCells,g=b.ringOuterRadius,e=b.ringHeight/2,l=-e,f=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,f);g=BC.Math.circlePoints(g,d,f);d=0;f=[];f[d++]=b[0];f[d++]=e;f[d++]=-b[1];f[d++]=g[0];f[d++]=e;f[d++]=-g[1];f[d++]=g[2];f[d++]=e;f[d++]=-g[3];f[d++]=b[2];f[d++]=e;f[d++]=-b[3];f[d++]=b[0];f[d++]=e;f[d++]=-b[1];f[d++]=b[0];f[d++]=l;f[d++]=-b[1];f[d++]=g[0];f[d++]=l;f[d++]=-g[1];f[d++]=g[0];f[d++]=e;f[d++]=-g[1];f[d++]=g[2];f[d++]=e;f[d++]=-g[3];f[d++]=g[2];f[d++]=
l;f[d++]=-g[3];f[d++]=b[2];f[d++]=l;f[d++]=-b[3];f[d++]=b[2];f[d++]=e;f[d++]=-b[3];f[d++]=g[0];f[d++]=e;f[d++]=-g[1];f[d++]=g[0];f[d++]=l;f[d++]=-g[1];f[d++]=g[2];f[d++]=l;f[d++]=-g[3];f[d++]=g[2];f[d++]=e;f[d++]=-g[3];f[d++]=b[2];f[d++]=e;f[d++]=-b[3];f[d++]=b[2];f[d++]=l;f[d++]=-b[3];f[d++]=b[0];f[d++]=l;f[d++]=-b[1];f[d++]=b[0];f[d++]=e;f[d++]=-b[1];var v=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);e=[];for(d=0;d<c.length;d++)for(l=
c[d],e[d]=[],g=b=0;5>b;b++)f=l.textureCoord(0,0),e[d][g++]=f[0],e[d][g++]=f[1],f=l.textureCoord(0,1),e[d][g++]=f[0],e[d][g++]=f[1],f=l.textureCoord(1,1),e[d][g++]=f[0],e[d][g++]=f[1],f=l.textureCoord(1,0),e[d][g++]=f[0],e[d][g++]=f[1];for(var n=[],d=0;d<c.length;d++)n[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,n[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(e[d]),a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var u=a.createBuffer();
a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var r=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&h(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),h(b,c),a.enable(a.CULL_FACE))}}};return h}(BC||{});BC=function(h){(h.StopWatch=h.StopWatch||{}).make=function(){var c={then:0.001*Date.now(),tick:function(){c.now=0.001*Date.now();c.deltaTime=c.now-c.then;c.then=c.now}};return c};return h}(BC||{});
