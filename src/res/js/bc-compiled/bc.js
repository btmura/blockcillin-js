var BC=function(g){var c=g.Matrix=g.Matrix||{};c.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var d=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,d[0],d[1],d[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,c,d){a=Math.tan(0.5*Math.PI-0.5*a);var l=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,(c+d)*l,-1,0,0,c*d*l*2,0]};c.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],c=a[1],d=a[2],l=a[3],e=a[4],f=a[5],h=a[6],g=a[7],k=a[8],s=a[9],p=a[10],q=a[11],r=a[12],n=a[13],t=a[14];a=
a[15];var v=p*a,w=t*q,x=h*a,y=t*g,z=h*q,A=p*g,B=d*a,C=t*l,D=d*q,E=p*l,F=d*g,G=h*l,H=k*n,I=r*s,J=e*n,K=r*f,L=e*s,M=k*f,N=b*n,O=r*c,P=b*s,Q=k*c,R=b*f,S=e*c,T=v*f+y*s+z*n-(w*f+x*s+A*n),U=w*c+B*s+E*n-(v*c+C*s+D*n),n=x*c+C*f+F*n-(y*c+B*f+G*n),c=A*c+D*f+G*s-(z*c+E*f+F*s),f=1/(b*T+e*U+k*n+r*c);return[f*T,f*U,f*n,f*c,f*(w*e+x*k+A*r-(v*e+y*k+z*r)),f*(v*b+C*k+D*r-(w*b+B*k+E*r)),f*(y*b+B*e+G*r-(x*b+C*e+F*r)),f*(z*b+E*e+F*k-(A*b+D*e+G*k)),f*(H*g+K*q+L*a-(I*g+J*q+M*a)),f*(I*l+N*q+Q*a-(H*l+O*q+P*a)),f*(J*l+O*g+
R*a-(K*l+N*g+S*a)),f*(M*l+P*g+S*q-(L*l+Q*g+R*q)),f*(J*p+M*t+I*h-(L*t+H*h+K*p)),f*(P*t+H*d+O*p-(N*p+Q*t+I*d)),f*(N*h+S*t+K*d-(R*t+J*d+O*h)),f*(R*p+L*d+Q*h-(P*h+S*p+M*d))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){(g.CellView=g.CellView||{}).make=function(c,a,b){function u(a,b){var h=b.positionLocation,d=b.textureCoordLocation,e=b.yellowBoostLocation,f=b.alphaLocation;c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(h);c.vertexAttribPointer(h,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,k[a.blockStyle]);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0);c.uniform1f(e,a.yellowBoost);c.uniform1f(f,a.alpha);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,s);c.drawElements(c.TRIANGLES,
p,c.UNSIGNED_SHORT,0)}var d=a.numCells,l=a.ringOuterRadius,e=a.ringHeight/2,f=-e,h=-Math.PI/2;a=BC.Math.circlePoints(a.ringInnerRadius,d,h);l=BC.Math.circlePoints(l,d,h);d=0;h=[];h[d++]=a[0];h[d++]=e;h[d++]=-a[1];h[d++]=l[0];h[d++]=e;h[d++]=-l[1];h[d++]=l[2];h[d++]=e;h[d++]=-l[3];h[d++]=a[2];h[d++]=e;h[d++]=-a[3];h[d++]=a[0];h[d++]=e;h[d++]=-a[1];h[d++]=a[0];h[d++]=f;h[d++]=-a[1];h[d++]=l[0];h[d++]=f;h[d++]=-l[1];h[d++]=l[0];h[d++]=e;h[d++]=-l[1];h[d++]=l[2];h[d++]=e;h[d++]=-l[3];h[d++]=l[2];h[d++]=
f;h[d++]=-l[3];h[d++]=a[2];h[d++]=f;h[d++]=-a[3];h[d++]=a[2];h[d++]=e;h[d++]=-a[3];h[d++]=l[0];h[d++]=e;h[d++]=-l[1];h[d++]=l[0];h[d++]=f;h[d++]=-l[1];h[d++]=l[2];h[d++]=f;h[d++]=-l[3];h[d++]=l[2];h[d++]=e;h[d++]=-l[3];h[d++]=a[2];h[d++]=e;h[d++]=-a[3];h[d++]=a[2];h[d++]=f;h[d++]=-a[3];h[d++]=a[0];h[d++]=f;h[d++]=-a[1];h[d++]=a[0];h[d++]=e;h[d++]=-a[1];var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,new Float32Array(h),c.STATIC_DRAW);e=[];for(d=0;d<b.length;d++)for(f=
b[d],e[d]=[],l=a=0;5>a;a++)h=f.textureCoord(0,0),e[d][l++]=h[0],e[d][l++]=h[1],h=f.textureCoord(0,1),e[d][l++]=h[0],e[d][l++]=h[1],h=f.textureCoord(1,1),e[d][l++]=h[0],e[d][l++]=h[1],h=f.textureCoord(1,0),e[d][l++]=h[0],e[d][l++]=h[1];for(var k=[],d=0;d<b.length;d++)k[d]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,k[d]),c.bufferData(c.ARRAY_BUFFER,new Float32Array(e[d]),c.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19]);var s=c.createBuffer();
c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,s);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);var p=b.length;return{drawOpaque:function(a,b){a.isEmpty()||a.isTransparent()||u(a,b)},drawTransparent:function(a,b){!a.isEmpty()&&a.isTransparent()&&(c.disable(c.CULL_FACE),u(a,b),c.enable(c.CULL_FACE))}}};return g}(BC||{});BC=function(g){var c=g.Animation=g.Animation||{};c.make=function(a){var b=a.duration,c=a.startCallback||function(){},d=a.updateCallback||function(){return!1},l=a.finishCallback||function(){},e=0,f=!1,h=!1;return{update:function(a){f||(f=!0,c());var k=a.deltaTime;e+k>b&&(k=b-e);e+=k;a=d({now:a.now,deltaTime:k,elapsedPercent:e/b,deltaPercent:k/b});e>=b&&(h=!0,l());return a},isDone:function(){return h}}};c.process=function(a,b){var c=!1;if(0<a.length){var d=a[0],c=c|d.update(b);d.isDone()&&a.shift()}return c};
return g}(BC||{});BC=function(g){(g.BoardView=g.BoardView||{}).make=function(c,a,b){var u=b.boardMatrixLocation,d=b.ringMatrixLocation,l=b.cellMatrixLocation,e=BC.GL.textureTileSet(4,4,0.002),f=[e.tile(0,0),e.tile(0,1),e.tile(0,2),e.tile(0,3),e.tile(1,0),e.tile(1,1),e.tile(2,0),e.tile(2,1),e.tile(2,2),e.tile(2,3),e.tile(3,0),e.tile(3,1)],e=e.tile(1,2),h=BC.CellView.make(a,c.metrics,f),g=BC.SelectorView.make(a,c.metrics,e);return{draw:function(){a.uniformMatrix4fv(u,!1,c.matrix);for(var e=c.rings,f=0;2>f;f++)for(var p=
0;p<e.length;p++){a.uniformMatrix4fv(d,!1,e[p].matrix);for(var q=e[p].cells,r=0;r<q.length;r++)a.uniformMatrix4fv(l,!1,q[r].matrix),0==f?h.drawOpaque(q[r],b):h.drawTransparent(q[r],b)}a.uniformMatrix4fv(u,!1,c.selector.matrix);a.uniformMatrix4fv(d,!1,BC.Matrix.identity);a.uniformMatrix4fv(l,!1,BC.Matrix.identity);g.draw(b)}}};return g}(BC||{});BC=function(g){(g.SelectorView=g.SelectorView||{}).make=function(c,a,b){var g=-a.ringHeight/2,d=-g;a=BC.Math.circlePoints(a.ringOuterRadius+0.01,a.numCells,-Math.PI/2);var l=a.length-2,e=[],f=0;e[f++]=a[l]+0.001;e[f++]=g;e[f++]=-a[l+1]-0.001;e[f++]=a[0]+0.001;e[f++]=g;e[f++]=-a[1]-0.001;e[f++]=a[0]+0.001;e[f++]=d;e[f++]=-a[1]-0.001;e[f++]=a[l]+0.001;e[f++]=d;e[f++]=-a[l+1]-0.001;e[f++]=a[0]+0.001;e[f++]=g;e[f++]=-a[1]-0.001;e[f++]=a[2]+0.001;e[f++]=g;e[f++]=-a[3]-0.001;e[f++]=a[2]+0.001;e[f++]=d;
e[f++]=-a[3]-0.001;e[f++]=a[0]+0.001;e[f++]=d;e[f++]=-a[1]-0.001;var h=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,h);c.bufferData(c.ARRAY_BUFFER,new Float32Array(e),c.STATIC_DRAW);g=b.textureCoord(0,0);d=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(g,d,a,b,g,d,a,b));var m=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,m);c.bufferData(c.ARRAY_BUFFER,b,c.STATIC_DRAW);var k=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),s=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
s);c.bufferData(c.ELEMENT_ARRAY_BUFFER,k,c.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation,d=a.textureCoordLocation;a=a.alphaLocation;c.bindBuffer(c.ARRAY_BUFFER,h);c.enableVertexAttribArray(b);c.vertexAttribPointer(b,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,m);c.enableVertexAttribArray(d);c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0);c.uniform1f(a,1);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,s);c.drawElements(c.TRIANGLES,k.length,c.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(c){function a(a,c){var d=l(a,c);if(d.state!==m.BLOCK)return[];var h=[],e=b(d.blockStyle,a,c);e.length+1>=k&&(h=h.concat(e));e=g(d.blockStyle,a,c);e.length+1>=k&&(h=h.concat(e));0<h.length&&(h.push({cell:d,row:a,col:0}),h.sort(function(a,b){return 0!=a.col-b.col?a.col-b.col:0!=a.row-b.row?a.row-b.row:0}));return h}function b(a,b,c){for(var h=[],g=0,k=e(c);k!=c;k=e(k)){var u=l(b,k);if(d(a,u))h.push({cell:u,row:b,col:--g});else break}g=0;for(k=f(c);k!=
c;k=f(k))if(u=l(b,k),d(a,u))h.push({cell:u,row:b,col:++g});else break;return h}function g(a,b,h){for(var e=[],f=b-1;0<=f;f--){var k=l(f,h);if(d(a,k))e.push({cell:k,row:f,col:0});else break}for(b+=1;b<c.numRings;b++)if(f=l(b,h),d(a,f))e.push({cell:f,row:b,col:0});else break;return e}function d(a,b){return(b.state===m.BLOCK||b.state===m.MARKED_BLOCK)&&b.blockStyle===a}function l(a,b){return q.rings[a].cells[b]}function e(a){a-=1;return 0>a?c.numCells-1:a}function f(a){a+=1;return a===c.numCells?0:a}
for(var h=BC.Constants.Direction,m=BC.Cell.CellState,k=3,s=[],p=0;p<c.numRings;p++)s[p]=BC.Ring.make(p,c);var q={rings:s,matrix:BC.Matrix.identity,metrics:c,move:function(a){switch(a){case h.LEFT:w.move(h.LEFT)&&(n--,0>n&&(n=c.numCells-1));break;case h.RIGHT:w.move(h.RIGHT)&&(n++,n>=c.numCells&&(n=0));break;case h.UP:0<r&&w.move(h.UP)&&r--;break;case h.DOWN:r+1<q.rings.length&&w.move(h.DOWN)&&r++}},rotate:function(a){v[1]+=a},swap:function(){var a=q.rings[r],b=a.cells[n],a=a.cells[(n+1)%a.cells.length],
c=b.blockStyle,d=a.blockStyle;BC.Util.log("swap: ("+b.state+", "+a.state+")");b.state===m.EMPTY&&a.state===m.BLOCK?(a.sendBlock(0.125,h.LEFT),b.receiveBlock(0.125,h.RIGHT,d)):b.state===m.BLOCK&&a.state===m.EMPTY?(b.sendBlock(0.125,h.RIGHT),a.receiveBlock(0.125,h.LEFT,c)):b.state===m.BLOCK&&a.state===m.BLOCK&&(b.receiveBlock(0.125,h.RIGHT,d),a.receiveBlock(0.125,h.LEFT,c))},update:function(b){for(var d=0;d<c.numRings;d++)for(var e=0;e<c.numCells;e++){var f=b;l(d,e).update(f)}for(d=0;d<c.numRings;d++)for(e=
0;e<c.numCells;e++){for(var k=d,f=e,g=a(k,f),u=0;u<g.length;u++){var s=g[u].cell;s.state!==m.MARKED_BLOCK&&(s.markBlock(),t.push(s))}g=f;0<t.length||(f=l(k,g),f.state===m.BLOCK&&(k+=1,k>=c.numRings||(k=l(k,g),f.state===m.BLOCK&&k.state==m.EMPTY&&(f=f.sendBlock(0.075),k.receiveBlock(0.075,h.UP,f)))))}if(0<t.length)switch(d=t[0],d.state){case m.MARKED_BLOCK:case m.FREEZING_BLOCK:break;case m.READY_TO_CLEAR_BLOCK:d.clearBlock();break;case m.CLEARING_BLOCK:break;default:t.shift()}w.update(b);b=BC.Matrix.makeXRotation(v[0]);
d=BC.Matrix.makeYRotation(v[1]);e=BC.Matrix.makeZRotation(v[2]);d=BC.Matrix.matrixMultiply(e,d);d=BC.Matrix.matrixMultiply(d,b);q.matrix=d}},r=0,n=c.numCells-1,t=[],v=[0,0,0],w=BC.Selector.make(c,q);q.selector=w;return q};return g}(BC||{});BC=function(g){(g.Ring=g.Ring||{}).make=function(c,a){for(var b=[],g=0;g<a.numCells;g++)b[g]=BC.Cell.make(g,a);g=BC.Matrix.makeTranslation(0,-c*a.ringHeight,0);return{cells:b,matrix:g}};return g}(BC||{});BC=function(g){(g.Selector=g.Selector||{}).make=function(c,a){function b(b){e=b;0<f.length&&BC.Util.error("startMoving: pending animations: "+f.length);f.push(BC.Animation.make({duration:d,updateCallback:function(b){var d=c.ringHeight*b.deltaPercent;b=m*b.deltaPercent;switch(e){case g.UP:return h[1]+=d,!0;case g.DOWN:return h[1]-=d,!0;case g.LEFT:return a.rotate(b),!0;case g.RIGHT:return a.rotate(-b),!0;default:return!1}},finishCallback:function(){e=g.NONE}}))}var g=BC.Constants.Direction,d=0.025,
l={matrix:BC.Matrix.identity,move:function(a){switch(a){case g.LEFT:return e!==g.NONE?a=!1:(b(g.LEFT),a=!0),a;case g.RIGHT:return e!==g.NONE?a=!1:(b(g.RIGHT),a=!0),a;case g.UP:return e!==g.NONE?a=!1:(b(g.UP),a=!0),a;case g.DOWN:return e!==g.NONE?a=!1:(b(g.DOWN),a=!0),a;default:return BC.Util.error("move: unsupported direction: "+a),!1}},update:function(a){BC.Animation.process(f,a);a=1+Math.abs(Math.sin(4*a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(h[0],h[1],h[2]);l.matrix=
BC.Matrix.matrixMultiply(a,b)}},e=g.NONE,f=[],h=[0,0,0],m=BC.Math.sliceRadians(c.numCells);return l};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function c(a){return f.getUniformLocation(p,a)}function a(){return e.width!=e.clientWidth||e.height!=e.clientHeight?(e.width=e.clientWidth,e.height=e.clientHeight,!0):!1}function b(){var a=e.width/e.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function g(){var a=BC.Matrix.makeLookAt([0,0.5,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function d(){f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);f.viewport(0,0,f.canvas.width,
f.canvas.height);f.uniformMatrix4fv(q.projectionMatrixLocation,!1,r);v.tick();n.update(v);t.draw();requestAnimationFrame(d)}var l=BC.Constants.Direction,e=document.getElementById("canvas");if(e){var f=e.getContext("webgl")||e.getContext("experimental-webgl");if(f){var h=f.createTexture();f.bindTexture(f.TEXTURE_2D,h);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var m=new Image;m.src="images/textures.png";$(m).load(function(){f.bindTexture(f.TEXTURE_2D,
h);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,m);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST);f.generateMipmap(f.TEXTURE_2D)});f.enable(f.CULL_FACE);f.enable(f.DEPTH_TEST);f.enable(f.BLEND);f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);var k=BC.GL.loadShader(f,"vertex-shader",f.VERTEX_SHADER),s=BC.GL.loadShader(f,"fragment-shader",f.FRAGMENT_SHADER),p=BC.GL.createProgram(f,[k,s]);f.useProgram(p);
var q={positionLocation:f.getAttribLocation(p,"a_position"),textureCoordLocation:f.getAttribLocation(p,"a_textureCoord"),projectionMatrixLocation:c("u_projectionMatrix"),viewMatrixLocation:c("u_viewMatrix"),boardMatrixLocation:c("u_boardMatrix"),ringMatrixLocation:c("u_ringMatrix"),cellMatrixLocation:c("u_cellMatrix"),yellowBoostLocation:c("u_yellowBoost"),alphaLocation:c("u_alpha")};a();var r=b();$(window).resize(function(){a()&&(r=b())});k=g();f.uniformMatrix4fv(q.viewMatrixLocation,!1,k);var n=
BC.Board.make({numRings:3,numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3}),t=BC.BoardView.make(n,f,q),k=BC.Controller.make(e);k.setMoveLeftListener(function(){n.move(l.LEFT)});k.setMoveRightListener(function(){n.move(l.RIGHT)});k.setMoveUpListener(function(){n.move(l.UP)});k.setMoveDownListener(function(){n.move(l.DOWN)});k.setPrimaryActionListener(function(){n.swap()});var v=BC.StopWatch.make();d()}}};return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var c=g.Math=g.Math||{};c.radians=function(a){return a*Math.PI/180};c.sliceRadians=function(a){return 2*Math.PI/a};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var d=2*Math.PI/b,g=[],e=0;e<b;e++)g[2*e]=a*Math.cos(c+e*d),g[2*e+1]=a*Math.sin(c+e*d);return g};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){var c=g.Cell=g.Cell||{};c.CellState={EMPTY:0,EMPTY_RESERVED:1,BLOCK:2,RECEIVING_BLOCK:3,MARKED_BLOCK:4,FREEZING_BLOCK:5,READY_TO_CLEAR_BLOCK:6,CLEARING_BLOCK:7};c.make=function(a,b){var c=BC.Cell.CellState,d=BC.Constants.Direction,g=BC.Math.randomInt(b.numBlockTypes),e=[],f=BC.Math.sliceRadians(b.numCells),h=[0,a*f,0],m=[0,0,0],k={matrix:BC.Matrix.makeYRotation(h[1]),state:c.BLOCK,blockStyle:g,yellowBoost:0,alpha:1,markBlock:function(){k.state=c.MARKED_BLOCK;0<e.length&&BC.Util.error("markBlock: pending animations: "+
e.length);var a=BC.Animation.make({duration:0.75,startCallback:function(){k.state=c.FREEZING_BLOCK},updateCallback:function(a){k.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){k.yellowBoost=0}}),d=BC.Animation.make({duration:0.25,startCallback:function(){k.blockStyle+=b.numBlockTypes},finishCallback:function(){k.state=c.READY_TO_CLEAR_BLOCK}});e.push(a,d)},clearBlock:function(){k.state=c.CLEARING_BLOCK;0<e.length&&BC.Util.error("clearBlock: pending animations: "+e.length);
var a=BC.Animation.make({duration:0.25,updateCallback:function(a){k.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){k.state=c.EMPTY;k.alpha=1}});e.push(a)},sendBlock:function(a){var b=k.blockStyle;k.blockStyle=0;k.state=c.EMPTY_RESERVED;0<e.length&&BC.Util.error("sendBlock: pending animations: "+e.length);e.push(BC.Animation.make({duration:a,finishCallback:function(){k.state=c.EMPTY}}));return b},receiveBlock:function(a,g,l){k.state=c.RECEIVING_BLOCK;k.blockStyle=l;switch(g){case d.LEFT:h[1]-=
f;break;case d.RIGHT:h[1]+=f;break;case d.UP:m[1]=b.ringHeight;break;default:BC.Util.error("receiveBlock: unsupport direction: "+g)}0<e.length&&BC.Util.error("receiveBlock: pending animations: "+e.length);e.push(BC.Animation.make({duration:a,updateCallback:function(a){var c=f*a.deltaPercent;a=b.ringHeight*a.deltaPercent;switch(g){case d.LEFT:return h[1]+=c,!0;case d.RIGHT:return h[1]-=c,!0;case d.UP:return m[1]-=a,!0;default:return!1}},finishCallback:function(){k.state=c.BLOCK}}))},isEmpty:function(){return k.state===
c.EMPTY||k.state===c.EMPTY_RESERVED},isTransparent:function(){return k.state===c.CLEARING_BLOCK},update:function(a){if(BC.Animation.process(e,a)){a=BC.Matrix.makeYRotation(h[1]);var b=BC.Matrix.makeTranslation(m[0],m[1],m[2]);k.matrix=BC.Matrix.matrixMultiply(a,b)}}};return k};return g}(BC||{});BC=function(g){var c=g.GL=g.GL||{};c.loadShader=function(a,b,c,d){d=d||BC.Util.error;var g=document.getElementById(b);if(!g)return d("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,g.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),d("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,c,d){for(var g=a.createProgram(),e=0;e<b.length;e++)a.attachShader(g,b[e]);
if(c)for(e=0;e<c.length;e++)a.bindAttribLocation(g,d?d[e]:e,c[e]);a.linkProgram(g);return a.getProgramParameter(g,a.LINK_STATUS)?g:(lastError=a.getProgramInfoLog(g),error("Error in program linking: "+lastError),a.deleteProgram(g),null)};c.textureTileSet=function(a,b,c){var d=1/a,g=1/b;return{tile:function(a,b){var h=d*b,m=g*a;return{textureCoord:function(a,b){return[h+c+(d-2*c)*a,m+c+(g-2*c)*b]}}}}};return g}(BC||{});BC=function(g){var c=g.Util=g.Util||{};c.log=function(a){window.console&&window.console.log&&window.console.log(a)};c.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return g}(BC||{});BC=function(g){(g.Controller=g.Controller||{}).make=function(c){var a=function(){},b=function(){},g=function(){},d=function(){},l=function(){};$(document).keydown(function(c){switch(c.keyCode){case 32:l.call();break;case 37:a.call();break;case 39:b.call();break;case 38:g.call();break;case 40:d.call()}return!1});var e=0,f=0;$(c).on("touchstart touchmove touchend",function(c){var m=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":e=m.pageX;f=m.pageY;break;case "touchend":c=m.pageX-
e,m=m.pageY-f,50<c?a.call():-50>c?b.call():50<m?d.call():-50>m?g.call():l.call()}return!1});return{setMoveLeftListener:function(b){a=b},setMoveRightListener:function(a){b=a},setMoveUpListener:function(a){g=a},setMoveDownListener:function(a){d=a},setPrimaryActionListener:function(a){l=a}}};return g}(BC||{});BC=function(g){(g.StopWatch=g.StopWatch||{}).make=function(){var c={then:0.001*Date.now(),tick:function(){c.now=0.001*Date.now();c.deltaTime=c.now-c.then;c.then=c.now}};return c};return g}(BC||{});
