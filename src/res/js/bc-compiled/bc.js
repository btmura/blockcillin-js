var BC=function(g){var c=g.Matrix=g.Matrix||{};c.makeLookAt=function(a,b,f){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));f=BC.Math.cross(f,b);var c=BC.Math.cross(b,f);return[f[0],f[1],f[2],0,c[0],c[1],c[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};c.makePerspective=function(a,b,f,c){a=Math.tan(0.5*Math.PI-0.5*a);var h=1/(f-c);return[a/b,0,0,0,0,a,0,0,0,0,(f+c)*h,-1,0,0,f*c*h*2,0]};c.makeTranslation=function(a,b,f){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,f,1]};c.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};c.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};c.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};c.makeScale=function(a,b,f){return[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1]};c.identity=c.makeScale(1,1,1);c.makeInverse=function(a){var b=a[0],f=a[1],c=a[2],h=a[3],d=a[4],e=a[5],r=a[6],k=a[7],q=a[8],g=a[9],t=a[10],n=a[11],u=a[12],p=a[13],m=a[14];a=
a[15];var v=t*a,s=m*n,x=r*a,y=m*k,z=r*n,A=t*k,B=c*a,C=m*h,D=c*n,E=t*h,F=c*k,G=r*h,H=q*p,I=u*g,J=d*p,K=u*e,L=d*g,M=q*e,N=b*p,O=u*f,P=b*g,Q=q*f,R=b*e,S=d*f,T=v*e+y*g+z*p-(s*e+x*g+A*p),U=s*f+B*g+E*p-(v*f+C*g+D*p),p=x*f+C*e+F*p-(y*f+B*e+G*p),f=A*f+D*e+G*g-(z*f+E*e+F*g),e=1/(b*T+d*U+q*p+u*f);return[e*T,e*U,e*p,e*f,e*(s*d+x*q+A*u-(v*d+y*q+z*u)),e*(v*b+C*q+D*u-(s*b+B*q+E*u)),e*(y*b+B*d+G*u-(x*b+C*d+F*u)),e*(z*b+E*d+F*q-(A*b+D*d+G*q)),e*(H*k+K*n+L*a-(I*k+J*n+M*a)),e*(I*h+N*n+Q*a-(H*h+O*n+P*a)),e*(J*h+O*k+
R*a-(K*h+N*k+S*a)),e*(M*h+P*k+S*n-(L*h+Q*k+R*n)),e*(J*t+M*m+I*r-(L*m+H*r+K*t)),e*(P*m+H*c+O*t-(N*t+Q*m+I*c)),e*(N*r+S*m+K*c-(R*m+J*c+O*r)),e*(R*t+L*c+Q*r-(P*r+S*t+M*c))]};c.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return g}(BC||{});BC=function(g){(g.CellView=g.CellView||{}).make=function(c,a,b){var f=a.numRingCells,l=a.outerRingRadius,h=a.ringMaxY,d=a.ringMinY,e=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,f,e);l=BC.Math.circlePoints(l,f,e);f=0;e=[];e[f++]=a[0];e[f++]=h;e[f++]=-a[1];e[f++]=l[0];e[f++]=h;e[f++]=-l[1];e[f++]=l[2];e[f++]=h;e[f++]=-l[3];e[f++]=a[2];e[f++]=h;e[f++]=-a[3];e[f++]=a[0];e[f++]=h;e[f++]=-a[1];e[f++]=a[0];e[f++]=d;e[f++]=-a[1];e[f++]=l[0];e[f++]=d;e[f++]=-l[1];e[f++]=l[0];e[f++]=h;e[f++]=-l[1];
e[f++]=l[2];e[f++]=h;e[f++]=-l[3];e[f++]=l[2];e[f++]=d;e[f++]=-l[3];e[f++]=a[2];e[f++]=d;e[f++]=-a[3];e[f++]=a[2];e[f++]=h;e[f++]=-a[3];e[f++]=l[0];e[f++]=h;e[f++]=-l[1];e[f++]=l[0];e[f++]=d;e[f++]=-l[1];e[f++]=l[2];e[f++]=d;e[f++]=-l[3];e[f++]=l[2];e[f++]=h;e[f++]=-l[3];e[f++]=a[2];e[f++]=h;e[f++]=-a[3];e[f++]=a[2];e[f++]=d;e[f++]=-a[3];e[f++]=a[0];e[f++]=d;e[f++]=-a[1];e[f++]=a[0];e[f++]=h;e[f++]=-a[1];var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,new Float32Array(e),
c.STATIC_DRAW);h=[];for(f=0;f<b.length;f++)for(d=b[f],h[f]=[],l=a=0;5>a;a++)e=d.textureCoord(0,0),h[f][l++]=e[0],h[f][l++]=e[1],e=d.textureCoord(0,1),h[f][l++]=e[0],h[f][l++]=e[1],e=d.textureCoord(1,1),h[f][l++]=e[0],h[f][l++]=e[1],e=d.textureCoord(1,0),h[f][l++]=e[0],h[f][l++]=e[1];for(var k=[],f=0;f<b.length;f++)k[f]=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,k[f]),c.bufferData(c.ARRAY_BUFFER,new Float32Array(h[f]),c.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,
14,12,14,15,16,17,18,16,18,19]);var q=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,q);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);var w=b.length;return{draw:function(a,b){var f=b.positionLocation,e=b.textureCoordLocation;c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(f);c.vertexAttribPointer(f,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,k[a.blockStyle]);c.enableVertexAttribArray(e);c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,q);c.drawElements(c.TRIANGLES,
w,c.UNSIGNED_SHORT,0)}}};return g}(BC||{});BC=function(g){(g.BoardView=g.BoardView||{}).make=function(c,a,b){var f=b.boardMatrixLocation,l=b.ringMatrixLocation,h=b.cellMatrixLocation,d=BC.GL.textureTileSet(4,4,0.002),e=[d.tile(0,0),d.tile(0,1),d.tile(0,2),d.tile(0,3),d.tile(1,0),d.tile(1,1)],d=d.tile(1,2),g=BC.CellView.make(a,c,e),k=BC.SelectorView.make(a,c,d);return{draw:function(){a.uniformMatrix4fv(f,!1,c.matrix);for(var e=c.rings,d=0;d<e.length;d++){a.uniformMatrix4fv(l,!1,e[d].matrix);for(var t=e[d].cells,n=0;n<t.length;n++)a.uniformMatrix4fv(h,
!1,t[n].matrix),g.draw(t[n],b)}a.uniformMatrix4fv(f,!1,c.selector.matrix);a.uniformMatrix4fv(l,!1,BC.Matrix.identity);a.uniformMatrix4fv(h,!1,BC.Matrix.identity);k.draw(b)}}};return g}(BC||{});BC=function(g){(g.Time=g.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return g}(BC||{});BC=function(g){(g.SelectorView=g.SelectorView||{}).make=function(c,a,b){var f=a.ringMinY,l=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var h=a.length-2,d=[],e=0;d[e++]=a[h]+0.001;d[e++]=f;d[e++]=-a[h+1]-0.001;d[e++]=a[0]+0.001;d[e++]=f;d[e++]=-a[1]-0.001;d[e++]=a[0]+0.001;d[e++]=l;d[e++]=-a[1]-0.001;d[e++]=a[h]+0.001;d[e++]=l;d[e++]=-a[h+1]-0.001;d[e++]=a[0]+0.001;d[e++]=f;d[e++]=-a[1]-0.001;d[e++]=a[2]+0.001;d[e++]=f;d[e++]=-a[3]-0.001;d[e++]=a[2]+0.001;d[e++]=
l;d[e++]=-a[3]-0.001;d[e++]=a[0]+0.001;d[e++]=l;d[e++]=-a[1]-0.001;var g=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g);c.bufferData(c.ARRAY_BUFFER,new Float32Array(d),c.STATIC_DRAW);f=b.textureCoord(0,0);l=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(f,l,a,b,f,l,a,b));var k=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,k);c.bufferData(c.ARRAY_BUFFER,b,c.STATIC_DRAW);var q=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),w=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
w);c.bufferData(c.ELEMENT_ARRAY_BUFFER,q,c.STATIC_DRAW);return{draw:function(a){var b=a.positionLocation;a=a.textureCoordLocation;c.enable(c.BLEND);c.bindBuffer(c.ARRAY_BUFFER,g);c.enableVertexAttribArray(b);c.vertexAttribPointer(b,3,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,k);c.enableVertexAttribArray(a);c.vertexAttribPointer(a,2,c.FLOAT,!1,0,0);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,w);c.drawElements(c.TRIANGLES,q.length,c.UNSIGNED_SHORT,0);c.disable(c.BLEND)}}};return g}(BC||{});BC=function(g){(g.Constants=g.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return g}(BC||{});BC=function(g){(g.Board=g.Board||{}).make=function(c){function a(a){for(var b=[],e=0;e<c.numRingCells;e++){var d=b,g=e,k=e,m=BC.Math.randomInt(c.numBlockStyles),k=[0,k*l,0],r=BC.Matrix.makeYRotation(k[1]);d[g]={matrix:r,state:f.NONE,blockStyle:m,elapsedSwapTime:0,rotation:k}}a=BC.Matrix.makeTranslation(0,-a*h,0);return{cells:b,matrix:a}}for(var b=BC.Constants.Direction,f={NONE:0,SWAP_LEFT:1,SWAP_RIGHT:2},l=2*Math.PI/c.numRingCells,h=c.ringMaxY-c.ringMinY,d=[],e=0;3>e;e++)d[e]=a(e);var g={matrix:BC.Matrix.identity,
direction:b.NONE,elapsedMovementTime:0,translation:[0,0,0]},k={rings:d,selector:g,matrix:BC.Matrix.identity,numRingCells:c.numRingCells,innerRingRadius:c.innerRingRadius,outerRingRadius:c.outerRingRadius,ringMaxY:c.ringMaxY,ringMinY:c.ringMinY,move:function(a){switch(a){case b.LEFT:g.direction===b.NONE&&(g.direction=b.LEFT,g.elapsedMovementTime=0,k.currentCell--,0>k.currentCell&&(k.currentCell=c.numRingCells-1));break;case b.RIGHT:g.direction===b.NONE&&(g.direction=b.RIGHT,g.elapsedMovementTime=0,
k.currentCell++,k.currentCell>=c.numRingCells&&(k.currentCell=0));break;case b.UP:g.direction===b.NONE&&0<k.currentRing&&(g.direction=b.UP,g.elapsedMovementTime=0,k.currentRing--);break;case b.DOWN:g.direction===b.NONE&&k.currentRing+1<k.rings.length&&(g.direction=b.DOWN,g.elapsedMovementTime=0,k.currentRing++)}},swap:function(){var a=k.rings[k.currentRing],b=a.cells[k.currentCell],a=a.cells[(k.currentCell+1)%a.cells.length],e=b.blockStyle;b.blockStyle=a.blockStyle;b.state=f.SWAP_RIGHT;b.rotation[1]+=
l;b.elapsedSwapTime=0;a.blockStyle=e;a.state=f.SWAP_LEFT;a.rotation[1]-=l;a.elapsedSwapTime=0},update:function(a,e){for(var d=k.rings,c=0;c<d.length;c++)for(var u=d[c].cells,p=0;p<u.length;p++){var m=u[p];if(m.state==f.SWAP_LEFT||m.state==f.SWAP_RIGHT){var v=a;0.125<m.elapsedSwapTime+a&&(v=0.125-m.elapsedSwapTime);var s=l*v/0.125;m.rotation[1]=m.state==f.SWAP_LEFT?m.rotation[1]+s:m.rotation[1]-s;m.matrix=BC.Matrix.makeYRotation(m.rotation[1]);m.elapsedSwapTime+=v;0.125<=m.elapsedSwapTime&&(m.state=
f.NONE,m.elapsedSwapTime=0)}}if(g.direction!==b.NONE){0.05<g.elapsedMovementTime+a&&(a=0.05-g.elapsedMovementTime);d=a*h/0.05;s=a*l/0.05;switch(g.direction){case b.UP:g.translation[1]+=d;break;case b.DOWN:g.translation[1]-=d;break;case b.LEFT:k.rotation[1]+=s;break;case b.RIGHT:k.rotation[1]-=s}g.elapsedMovementTime+=a;0.05<=g.elapsedMovementTime&&(g.direction=b.NONE,g.elapsedMovementTime=0)}s=BC.Matrix.makeXRotation(k.rotation[0]);d=BC.Matrix.makeYRotation(k.rotation[1]);c=BC.Matrix.makeZRotation(k.rotation[2]);
d=BC.Matrix.matrixMultiply(c,d);d=BC.Matrix.matrixMultiply(d,s);k.matrix=d;s=1+Math.abs(Math.sin(4*e))/25;s=BC.Matrix.makeScale(s,s,1);d=BC.Matrix.makeTranslation(g.translation[0],g.translation[1],g.translation[2]);k.selector.matrix=BC.Matrix.matrixMultiply(s,d)},currentRing:0,currentCell:c.numRingCells-1,rotation:[0,0,0]};return k};return g}(BC||{});BC=function(g){var c=g.GL=g.GL||{};c.loadShader=function(a,b,f,c){c=c||BC.Util.error;var g=document.getElementById(b);if(!g)return c("** Error getting script element:"+b),null;b=a.createShader(f);a.shaderSource(b,g.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),c("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};c.createProgram=function(a,b,f,c){for(var g=a.createProgram(),d=0;d<b.length;d++)a.attachShader(g,b[d]);
if(f)for(d=0;d<f.length;d++)a.bindAttribLocation(g,c?c[d]:d,f[d]);a.linkProgram(g);return a.getProgramParameter(g,a.LINK_STATUS)?g:(lastError=a.getProgramInfoLog(g),error("Error in program linking: "+lastError),a.deleteProgram(g),null)};c.textureTileSet=function(a,b,c){var g=1/a,h=1/b;return{tile:function(a,b){var r=g*b,k=h*a;return{textureCoord:function(a,b){return[r+c+(g-2*c)*a,k+c+(h-2*c)*b]}}}}};return g}(BC||{});BC=function(g){(g.Game=g.Game||{}).run=function(){function c(){return h.width!=h.clientWidth||h.height!=h.clientHeight?(h.width=h.clientWidth,h.height=h.clientHeight,!0):!1}function a(){var a=h.width/h.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){var a=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function f(){d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);d.viewport(0,0,d.canvas.width,d.canvas.height);d.uniformMatrix4fv(w.projectionMatrixLocation,
!1,t);var a=BC.Time.getTimeInSeconds(),b=a-v;v=a;n.update(b,a);u.draw();requestAnimationFrame(f)}var g=BC.Constants.Direction,h=document.getElementById("canvas");if(h){var d=h.getContext("webgl")||h.getContext("experimental-webgl");if(d){var e=d.createTexture();d.bindTexture(d.TEXTURE_2D,e);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,1,1,0,d.RGBA,d.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var r=new Image;r.src="images/textures.png";$(r).load(function(){d.bindTexture(d.TEXTURE_2D,e);d.texImage2D(d.TEXTURE_2D,
0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,r);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_NEAREST);d.generateMipmap(d.TEXTURE_2D)});d.enable(d.CULL_FACE);d.enable(d.DEPTH_TEST);d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);var k=BC.GL.loadShader(d,"vertex-shader",d.VERTEX_SHADER),q=BC.GL.loadShader(d,"fragment-shader",d.FRAGMENT_SHADER),k=BC.GL.createProgram(d,[k,q]);d.useProgram(k);var w={positionLocation:d.getAttribLocation(k,
"a_position"),textureCoordLocation:d.getAttribLocation(k,"a_texcoord"),projectionMatrixLocation:d.getUniformLocation(k,"u_projectionMatrix"),viewMatrixLocation:d.getUniformLocation(k,"u_viewMatrix"),boardMatrixLocation:d.getUniformLocation(k,"u_boardMatrix"),ringMatrixLocation:d.getUniformLocation(k,"u_ringMatrix"),cellMatrixLocation:d.getUniformLocation(k,"u_cellMatrix")};c();var t=a();$(window).resize(function(){c()&&(t=a())});k=b();d.uniformMatrix4fv(w.viewMatrixLocation,!1,k);var n=BC.Board.make({numRingCells:24,
numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),u=BC.BoardView.make(n,d,w),p=0,m=0;$(h).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":p=b.pageX;m=b.pageY;break;case "touchend":a=b.pageX-p,b=b.pageY-m,50<a?n.move(g.LEFT):-50>a?n.move(g.RIGHT):50<b?n.move(g.DOWN):-50>b?n.move(g.UP):n.swap()}return!1});$(document).keydown(function(a){switch(a.keyCode){case 32:n.swap();break;case 37:n.move(g.LEFT);
break;case 39:n.move(g.RIGHT);break;case 38:n.move(g.UP);break;case 40:n.move(g.DOWN)}return!1});var v=BC.Time.getTimeInSeconds();f()}}};return g}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(g){var c=g.Math=g.Math||{};c.radians=function(a){return a*Math.PI/180};c.randomInt=function(a){return Math.floor(Math.random()*a)};c.circlePoints=function(a,b,c){c=c||0;for(var g=2*Math.PI/b,h=[],d=0;d<b;d++)h[2*d]=a*Math.cos(c+d*g),h[2*d+1]=a*Math.sin(c+d*g);return h};c.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};c.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};c.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return g}(BC||{});BC=function(g){(g.Util=g.Util||{}).error=function(c){window.console&&(window.console.error?window.console.error(c):window.console.log&&window.console.log(c))};return g}(BC||{});
