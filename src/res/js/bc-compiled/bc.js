var BC=function(h){var e=h.Matrix=h.Matrix||{};e.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var f=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,f[0],f[1],f[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};e.makePerspective=function(a,b,c,f){a=Math.tan(0.5*Math.PI-0.5*a);var e=1/(c-f);return[a/b,0,0,0,0,a,0,0,0,0,(c+f)*e,-1,0,0,c*f*e*2,0]};e.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};e.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};e.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};e.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};e.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};e.makeInverse=function(a){var b=a[0],c=a[1],f=a[2],e=a[3],g=a[4],d=a[5],h=a[6],m=a[7],n=a[8],p=a[9],s=a[10],q=a[11],r=a[12],l=a[13],u=a[14];a=a[15];var t=s*a,w=u*q,x=h*a,y=
u*m,v=h*q,z=s*m,A=f*a,B=u*e,C=f*q,D=s*e,E=f*m,F=h*e,G=n*l,H=r*p,I=g*l,J=r*d,K=g*p,L=n*d,M=b*l,N=r*c,O=b*p,P=n*c,Q=b*d,R=g*c,S=t*d+y*p+v*l-(w*d+x*p+z*l),T=w*c+A*p+D*l-(t*c+B*p+C*l),l=x*c+B*d+E*l-(y*c+A*d+F*l),c=z*c+C*d+F*p-(v*c+D*d+E*p),d=1/(b*S+g*T+n*l+r*c);return[d*S,d*T,d*l,d*c,d*(w*g+x*n+z*r-(t*g+y*n+v*r)),d*(t*b+B*n+C*r-(w*b+A*n+D*r)),d*(y*b+A*g+F*r-(x*b+B*g+E*r)),d*(v*b+D*g+E*n-(z*b+C*g+F*n)),d*(G*m+J*q+K*a-(H*m+I*q+L*a)),d*(H*e+M*q+P*a-(G*e+N*q+O*a)),d*(I*e+N*m+Q*a-(J*e+M*m+R*a)),d*(L*e+O*m+
R*q-(K*e+P*m+Q*q)),d*(I*s+L*u+H*h-(K*u+G*h+J*s)),d*(O*u+G*f+N*s-(M*s+P*u+H*f)),d*(M*h+R*u+J*f-(Q*u+I*f+N*h)),d*(Q*s+K*f+P*h-(O*h+R*s+L*f))]};e.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*
b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return h}(BC||{});BC=function(h){(h.Time=h.Time||{}).getTimeInSeconds=function(){return 0.001*Date.now()};return h}(BC||{});BC=function(h){var e=h.GL=h.GL||{};e.loadShader=function(a,b,c,e){e=e||BC.Util.error;var k=document.getElementById(b);if(!k)return e("** Error getting script element:"+b),null;b=a.createShader(c);a.shaderSource(b,k.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),e("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};e.createProgram=function(a,b,c,e){for(var k=a.createProgram(),g=0;g<b.length;g++)a.attachShader(k,b[g]);
if(c)for(g=0;g<c.length;g++)a.bindAttribLocation(k,e?e[g]:g,c[g]);a.linkProgram(k);return a.getProgramParameter(k,a.LINK_STATUS)?k:(lastError=a.getProgramInfoLog(k),error("Error in program linking: "+lastError),a.deleteProgram(k),null)};e.textureTileSet=function(a,b,c){var e=1/a,k=1/b;return{tile:function(a,b){var h=e*b,m=k*a;return{textureCoord:function(a,b){return[h+c+(e-2*c)*a,m+c+(k-2*c)*b]}}}}};return h}(BC||{});BC=function(h){(h.Selector=h.Selector||{}).make=function(e,a,b){var c=a.ringMinY,f=a.ringMaxY;a=BC.Math.circlePoints(a.outerRingRadius+0.01,a.numRingCells,-Math.PI/2);var k=a.length-2,g=[],d=0;g[d++]=a[k]+0.001;g[d++]=c;g[d++]=-a[k+1]-0.001;g[d++]=a[0]+0.001;g[d++]=c;g[d++]=-a[1]-0.001;g[d++]=a[0]+0.001;g[d++]=f;g[d++]=-a[1]-0.001;g[d++]=a[k]+0.001;g[d++]=f;g[d++]=-a[k+1]-0.001;g[d++]=a[0]+0.001;g[d++]=c;g[d++]=-a[1]-0.001;g[d++]=a[2]+0.001;g[d++]=c;g[d++]=-a[3]-0.001;g[d++]=a[2]+0.001;g[d++]=f;g[d++]=
-a[3]-0.001;g[d++]=a[0]+0.001;g[d++]=f;g[d++]=-a[1]-0.001;var h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h);e.bufferData(e.ARRAY_BUFFER,new Float32Array(g),e.STATIC_DRAW);c=b.textureCoord(0,0);f=b.textureCoord(1,0);a=b.textureCoord(1,1);b=b.textureCoord(0,1);b=new Float32Array([].concat(c,f,a,b,c,f,a,b));var m=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,m);e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW);var n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),p=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,
p);e.bufferData(e.ELEMENT_ARRAY_BUFFER,n,e.STATIC_DRAW);return{draw:function(a,b){e.enable(e.BLEND);e.bindBuffer(e.ARRAY_BUFFER,h);e.enableVertexAttribArray(a);e.vertexAttribPointer(a,3,e.FLOAT,!1,0,0);e.bindBuffer(e.ARRAY_BUFFER,m);e.enableVertexAttribArray(b);e.vertexAttribPointer(b,2,e.FLOAT,!1,0,0);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,p);e.drawElements(e.TRIANGLES,n.length,e.UNSIGNED_SHORT,0);e.disable(e.BLEND)}}};return h}(BC||{});BC=function(h){(h.Game=h.Game||{}).run=function(){function e(){return c.width!=c.clientWidth||c.height!=c.clientHeight?(c.width=c.clientWidth,c.height=c.clientHeight,!0):!1}function a(){var a=c.width/c.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function b(){f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);f.viewport(0,0,f.canvas.width,f.canvas.height);var a=BC.Time.getTimeInSeconds(),c=a-y;y=a;f.uniformMatrix4fv(h,!1,r);f.uniformMatrix4fv(m,!1,p);l.update(c);u.draw();requestAnimationFrame(b)}
var c=document.getElementById("canvas");if(c){var f=c.getContext("webgl")||c.getContext("experimental-webgl");if(f){f.enable(f.CULL_FACE);f.enable(f.DEPTH_TEST);f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);var k=BC.GL.loadShader(f,"vertex-shader",f.VERTEX_SHADER),g=BC.GL.loadShader(f,"fragment-shader",f.FRAGMENT_SHADER),d=BC.GL.createProgram(f,[k,g]);f.useProgram(d);var k=f.getAttribLocation(d,"a_position"),g=f.getAttribLocation(d,"a_texcoord"),h=f.getUniformLocation(d,"u_projectionMatrix"),m=f.getUniformLocation(d,
"u_viewMatrix"),d=f.getUniformLocation(d,"u_matrix"),n=BC.Matrix.makeLookAt([0,0.75,2],[0,0,0],[0,1,0]),p=BC.Matrix.makeInverse(n),s=f.createTexture();f.bindTexture(f.TEXTURE_2D,s);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var q=new Image;q.src="images/textures.png";$(q).load(function(){f.bindTexture(f.TEXTURE_2D,s);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,q);f.generateMipmap(f.TEXTURE_2D)});e();var r=a();$(window).resize(function(){e()&&
(r=a())});var l=BC.Board.makeModel({numRingCells:24,numBlockStyles:6,innerRingRadius:0.75,outerRingRadius:1,ringMaxY:0.15,ringMinY:-0.15}),u=BC.Board.makeView(l,f,k,d,g),t=BC.Common.Direction,w=0,x=0;$(c).on("touchstart touchmove touchend",function(a){var b=a.originalEvent.changedTouches[0];switch(a.type){case "touchstart":w=b.pageX;x=b.pageY;break;case "touchend":a=b.pageX-w;var b=b.pageY-x,c=t.NONE;50<a?c=t.LEFT:-50>a?c=t.RIGHT:50<b?c=t.DOWN:-50>b&&(c=t.UP);l.move(c)}return!1});$(document).keydown(function(a){switch(a.keyCode){case 32:l.swap();
break;case 37:l.move(t.LEFT);break;case 39:l.move(t.RIGHT);break;case 38:l.move(t.UP);break;case 40:l.move(t.DOWN)}return!1});var y=BC.Time.getTimeInSeconds();b()}}};return h}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(h){var e=h.Math=h.Math||{};e.radians=function(a){return a*Math.PI/180};e.randomInt=function(a){return Math.floor(Math.random()*a)};e.circlePoints=function(a,b,c){c=c||0;for(var e=2*Math.PI/b,k=[],g=0;g<b;g++)k[2*g]=a*Math.cos(c+g*e),k[2*g+1]=a*Math.sin(c+g*e);return k};e.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};e.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};e.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+
a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return h}(BC||{});BC=function(h){(h.Cell=h.Cell||{}).make=function(e,a,b){var c=a.numRingCells,f=a.outerRingRadius,k=a.ringMaxY,g=a.ringMinY,d=-Math.PI/2;a=BC.Math.circlePoints(a.innerRingRadius,c,d);f=BC.Math.circlePoints(f,c,d);c=0;d=[];d[c++]=a[0];d[c++]=k;d[c++]=-a[1];d[c++]=f[0];d[c++]=k;d[c++]=-f[1];d[c++]=f[2];d[c++]=k;d[c++]=-f[3];d[c++]=a[2];d[c++]=k;d[c++]=-a[3];d[c++]=a[0];d[c++]=k;d[c++]=-a[1];d[c++]=a[0];d[c++]=g;d[c++]=-a[1];d[c++]=f[0];d[c++]=g;d[c++]=-f[1];d[c++]=f[0];d[c++]=k;d[c++]=-f[1];d[c++]=f[2];
d[c++]=k;d[c++]=-f[3];d[c++]=f[2];d[c++]=g;d[c++]=-f[3];d[c++]=a[2];d[c++]=g;d[c++]=-a[3];d[c++]=a[2];d[c++]=k;d[c++]=-a[3];d[c++]=f[0];d[c++]=k;d[c++]=-f[1];d[c++]=f[0];d[c++]=g;d[c++]=-f[1];d[c++]=f[2];d[c++]=g;d[c++]=-f[3];d[c++]=f[2];d[c++]=k;d[c++]=-f[3];d[c++]=a[2];d[c++]=k;d[c++]=-a[3];d[c++]=a[2];d[c++]=g;d[c++]=-a[3];d[c++]=a[0];d[c++]=g;d[c++]=-a[1];d[c++]=a[0];d[c++]=k;d[c++]=-a[1];var h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h);e.bufferData(e.ARRAY_BUFFER,new Float32Array(d),e.STATIC_DRAW);
k=[];for(c=0;c<b.length;c++)for(g=b[c],k[c]=[],f=a=0;5>a;a++)d=g.textureCoord(0,0),k[c][f++]=d[0],k[c][f++]=d[1],d=g.textureCoord(0,1),k[c][f++]=d[0],k[c][f++]=d[1],d=g.textureCoord(1,1),k[c][f++]=d[0],k[c][f++]=d[1],d=g.textureCoord(1,0),k[c][f++]=d[0],k[c][f++]=d[1];for(var m=[],c=0;c<b.length;c++)m[c]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,m[c]),e.bufferData(e.ARRAY_BUFFER,new Float32Array(k[c]),e.STATIC_DRAW);b=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,
17,18,16,18,19]);var n=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n);e.bufferData(e.ELEMENT_ARRAY_BUFFER,b,e.STATIC_DRAW);var p=b.length;return{draw:function(a,b,c){e.bindBuffer(e.ARRAY_BUFFER,h);e.enableVertexAttribArray(b);e.vertexAttribPointer(b,3,e.FLOAT,!1,0,0);e.bindBuffer(e.ARRAY_BUFFER,m[a.blockStyle]);e.enableVertexAttribArray(c);e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n);e.drawElements(e.TRIANGLES,p,e.UNSIGNED_SHORT,0)}}};return h}(BC||{});BC=function(h){(h.Util=h.Util||{}).error=function(e){window.console&&(window.console.error?window.console.error(e):window.console.log&&window.console.log(e))};return h}(BC||{});BC=function(h){(h.Common=h.Common||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).makeView=function(e,a,b,c,f){var k=BC.GL.textureTileSet(4,4,0.002),g=[k.tile(0,0),k.tile(0,1),k.tile(0,2),k.tile(0,3),k.tile(1,0),k.tile(1,1)],k=k.tile(1,2),d=BC.Cell.make(a,e,g),h=BC.Selector.make(a,e,k);return{draw:function(){for(var g=e.boardMatrix,k=e.rings,p=0;p<k.length;p++)for(var s=BC.Matrix.matrixMultiply(g,k[p].matrix),q=k[p].cells,r=0;r<q.length;r++){var l=BC.Matrix.matrixMultiply(s,q[r].matrix);a.uniformMatrix4fv(c,!1,l);d.draw(q[r],b,f)}a.uniformMatrix4fv(c,
!1,e.selectorMatrix);h.draw(b,f)}}};return h}(BC||{});BC=function(h){(h.Board=h.Board||{}).makeModel=function(e){function a(a){for(var b=[],d=0;d<e.numRingCells;d++){var f=b,g=d,h=d,k=BC.Math.randomInt(e.numBlockStyles),h=[0,h*p,0],m=BC.Matrix.makeYRotation(h[1]);f[g]={blockStyle:k,matrix:m,state:c.NONE,rotation:h,currentSwapTime:0}}a=BC.Matrix.makeTranslation(0,-a*s,0);return{cells:b,matrix:a}}for(var b=BC.Common.Direction,c={NONE:0,SWAP_LEFT:1,SWAP_RIGHT:2},f=[],k=0,g=e.numRingCells-1,d=b.NONE,h=0,m=[0,0,0],n=[0,0,0],p=2*Math.PI/e.numRingCells,s=e.ringMaxY-
e.ringMinY,q=BC.Matrix.makeScale(1,1,1),r={rings:f,boardMatrix:q,selectorMatrix:q,numRingCells:e.numRingCells,innerRingRadius:e.innerRingRadius,outerRingRadius:e.outerRingRadius,ringMaxY:e.ringMaxY,ringMinY:e.ringMinY,selectorTranslation:m,rotation:n,move:function(a){switch(a){case b.LEFT:d===b.NONE&&(d=b.LEFT,h=0,g--,0>g&&(g=e.numRingCells-1));break;case b.RIGHT:d===b.NONE&&(d=b.RIGHT,h=0,g++,g>=e.numRingCells&&(g=0));break;case b.UP:d===b.NONE&&0<k&&(d=b.UP,h=0,k--);break;case b.DOWN:d===b.NONE&&
k+1<f.length&&(d=b.DOWN,h=0,k++)}},swap:function(){console.log("ring: "+k+" cell: "+g);var a=f[k],b=a.cells[g],a=a.cells[(g+1)%a.cells.length],d=b.blockStyle;b.blockStyle=a.blockStyle;b.state=c.SWAP_RIGHT;b.rotation[1]+=p;b.currentSwapTime=0;a.blockStyle=d;a.state=c.SWAP_LEFT;a.rotation[1]-=p;a.currentSwapTime=0},update:function(a){for(var e=0;e<f.length;e++)for(var g=f[e].cells,k=0;k<g.length;k++){var l=g[k];if(l.state==c.SWAP_LEFT||l.state==c.SWAP_RIGHT){var v=a;0.1<l.currentSwapTime+a&&(v=0.1-
l.currentSwapTime);var z=p*v/0.1;l.rotation[1]=l.state==c.SWAP_LEFT?l.rotation[1]+z:l.rotation[1]-z;l.matrix=BC.Matrix.makeYRotation(l.rotation[1]);l.currentSwapTime+=v;0.1<=l.currentSwapTime&&(l.state=c.NONE,l.currentSwapTime=0)}}if(d!==b.NONE){0.05<h+a&&(a=0.05-h);e=a*s/0.05;g=a*p/0.05;switch(d){case b.UP:m[1]+=e;break;case b.DOWN:m[1]-=e;break;case b.LEFT:n[1]+=g;break;case b.RIGHT:n[1]-=g}h+=a;0.05<=h&&(d=b.NONE,h=0)}a=BC.Matrix.makeXRotation(n[0]);e=BC.Matrix.makeYRotation(n[1]);g=BC.Matrix.makeZRotation(n[2]);
g=BC.Matrix.matrixMultiply(q,g);g=BC.Matrix.matrixMultiply(g,e);g=BC.Matrix.matrixMultiply(g,a);r.boardMatrix=g;a=BC.Matrix.makeTranslation(m[0],m[1],m[2]);a=BC.Matrix.matrixMultiply(q,a);r.selectorMatrix=a}},l=0;3>l;l++)f[l]=a(l);return r};return h}(BC||{});
