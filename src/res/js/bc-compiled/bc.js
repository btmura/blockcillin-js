var BC=function(c){var e=c.Cell=c.Cell||{};e.CellState={EMPTY:0,EMPTY_NO_SWAP:1,EMPTY_NO_DROP:2,BLOCK:3,BLOCK_INCOMING:4,BLOCK_RECEIVING:5,BLOCK_CLEARING_MARKED:6,BLOCK_CLEARING_PREPARING:7,BLOCK_CLEARING_READY:8,BLOCK_CLEARING_IN_PROGRESS:9};e.make=function(a){function b(){var a=BC.Matrix.makeYRotation(t[1]),b=BC.Matrix.makeTranslation(r[0],r[1],r[2]);n.matrix=BC.Matrix.matrixMultiply(a,b)}var l=BC.Cell.CellState,g=BC.Constants.Direction,d=BC.Audio.Sound,h=a.metrics,k=a.rotationY,e=a.state,f=a.blockStyle,
c=a.audioPlayer,s=BC.Math.sliceRadians(h.numCells),q=[],u=!1,t=[0,k,0],r=[0,0,0],n={matrix:BC.Matrix.makeYRotation(t[1]),state:e,blockStyle:f,yellowBoost:0,alpha:1,markBlock:function(){n.state=l.BLOCK_CLEARING_MARKED;0<q.length&&BC.Util.error("markBlock: pending animations: "+q.length);var a=BC.Animation.make({duration:0.5,startCallback:function(){n.state=l.BLOCK_CLEARING_PREPARING},updateCallback:function(a){n.yellowBoost=Math.abs(Math.sin(50*a.now)/2);return!1},finishCallback:function(){n.yellowBoost=
0}}),b=BC.Animation.make({duration:0.25,startCallback:function(){n.blockStyle+=h.numBlockTypes},finishCallback:function(){n.state=l.BLOCK_CLEARING_READY}});q.push(a,b)},clearBlock:function(){n.state=l.BLOCK_CLEARING_IN_PROGRESS;0<q.length&&BC.Util.error("clearBlock: pending animations: "+q.length);var a=BC.Animation.make({duration:0.25,startCallback:function(){c.play(d.CELL_CLEAR)},updateCallback:function(a){n.alpha=1-a.elapsedPercent;return!1},finishCallback:function(){n.state=l.EMPTY_NO_DROP;n.alpha=
1}});q.push(a)},sendBlock:function(a){var b=n.blockStyle;n.blockStyle=0;n.state=l.EMPTY_NO_SWAP;0<q.length&&BC.Util.error("sendBlock: pending animations: "+q.length);q.push(BC.Animation.make({duration:a,finishCallback:function(){n.state=l.EMPTY}}));return b},receiveBlock:function(a,d,f){n.blockStyle=f;n.state=l.BLOCK_RECEIVING;switch(d){case g.LEFT:t[1]-=s;break;case g.RIGHT:t[1]+=s;break;case g.UP:r[1]=h.ringHeight;u=!0;break;default:BC.Util.error("receiveBlock: unsupport direction: "+d)}b();0<q.length&&
BC.Util.error("receiveBlock: pending animations: "+q.length);q.push(BC.Animation.make({duration:a,updateCallback:function(a){var b=s*a.deltaPercent;a=h.ringHeight*a.deltaPercent;switch(d){case g.LEFT:return t[1]+=b,!0;case g.RIGHT:return t[1]-=b,!0;case g.UP:return r[1]-=a,!0;default:return!1}},finishCallback:function(){n.state=l.BLOCK;u=!1}}))},isClearing:function(){return n.state===l.BLOCK_CLEARING_MARKED||n.state===l.BLOCK_CLEARING_PREPARING||n.state===l.BLOCK_CLEARING_READY||n.state===l.BLOCK_CLEARING_IN_PROGRESS},
isDrawable:function(){return n.state!==l.EMPTY&&n.state!==l.EMPTY_NO_SWAP&&n.state!==l.EMPTY_NO_DROP},isTransparent:function(){return n.state===l.BLOCK_CLEARING_IN_PROGRESS},hasDroppingBlock:function(){return u},update:function(a){BC.Animation.process(q,a)&&b()}};return n};return c}(BC||{});BC=function(c){(c.Ring=c.Ring||{}).make=function(e){var a=BC.Cell.CellState,b=e.metrics,l=e.translationY,g=e.selectable;e=e.audioPlayer;for(var d=BC.Math.sliceRadians(b.numCells),l=BC.Matrix.makeTranslation(0,l,0),a=g?a.BLOCK:a.BLOCK_INCOMING,h=[],k=0;k<b.numCells;k++){var m=k*d,f=BC.Math.randomInt(b.numBlockTypes);g||(f+=2*b.numBlockTypes);h[k]=BC.Cell.make({metrics:b,rotationY:m,state:a,blockStyle:f,audioPlayer:e})}return{matrix:l,cells:h,isEmpty:function(){for(var a=0;a<h.length;a++)if(h[a].state!==
BC.Cell.CellState.EMPTY)return!1;return!0},setSelectable:function(a){if(!g&&a)for(var d=0;d<h.length;d++)h[d].state===BC.Cell.CellState.BLOCK_INCOMING&&(h[d].state=BC.Cell.CellState.BLOCK,h[d].blockStyle-=2*b.numBlockTypes);g=a},isSelectable:function(){return g}}};return c}(BC||{});BC=function(c){var e=c.Board=c.Board||{};(e.View=e.View||{}).make=function(a){var b=a.board,l=a.gl,g=a.programLocations;a=a.resources;var d=g.boardRotationMatrixLocation,h=g.boardTranslationMatrixLocation,k=g.selectorMatrixLocation,e=g.ringMatrixLocation,f=g.cellMatrixLocation,c=BC.Cell.View.make(l,b.metrics,a.blockTextureTiles),s=BC.Selector.View.make(l,b.metrics,a.selectorTextureTile),q=BC.Stage.View.make(l,b.metrics,a.blackTextureTile);return{draw:function(){l.uniformMatrix4fv(d,!1,b.rotationMatrix);
l.uniformMatrix4fv(h,!1,b.translationMatrix);l.uniformMatrix4fv(k,!1,BC.Matrix.identity);for(var a=b.rings,t=0;2>t;t++)for(var r=0;r<a.length;r++){l.uniformMatrix4fv(e,!1,a[r].matrix);for(var n=a[r].cells,v=0;v<n.length;v++)l.uniformMatrix4fv(f,!1,n[v].matrix),0==t?c.drawOpaque(n[v],g):c.drawTransparent(n[v],g)}l.uniformMatrix4fv(d,!1,BC.Matrix.identity);l.uniformMatrix4fv(h,!1,BC.Matrix.identity);l.uniformMatrix4fv(k,!1,b.stage.matrix);l.uniformMatrix4fv(e,!1,BC.Matrix.identity);l.uniformMatrix4fv(f,
!1,BC.Matrix.identity);q.draw(g);l.uniformMatrix4fv(d,!1,BC.Matrix.identity);l.uniformMatrix4fv(h,!1,b.translationMatrix);l.uniformMatrix4fv(k,!1,b.selector.matrix);l.uniformMatrix4fv(e,!1,BC.Matrix.identity);l.uniformMatrix4fv(f,!1,BC.Matrix.identity);s.draw(g)}}};return c}(BC||{});BC=function(c){var e=c.Math=c.Math||{};e.radians=function(a){return a*Math.PI/180};e.sliceRadians=function(a){return 2*Math.PI/a};e.randomInt=function(a){return Math.floor(Math.random()*a)};e.circlePoints=function(a,b,l){l=l||0;for(var g=2*Math.PI/b,d=[],h=0;h<b;h++)d[2*h]=a*Math.cos(l+h*g),d[2*h+1]=a*Math.sin(l+h*g);return d};e.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};e.subtractVectors=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};e.normalize=
function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1E-5<b?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]};return c}(BC||{});BC=function(c){var e=c.GL=c.GL||{};e.loadShader=function(a,b,l,g){g=g||BC.Util.error;var d=document.getElementById(b);if(!d)return g("** Error getting script element:"+b),null;b=a.createShader(l);a.shaderSource(b,d.text);a.compileShader(b);return a.getShaderParameter(b,a.COMPILE_STATUS)?b:(lastError=a.getShaderInfoLog(b),g("*** Error compiling shader '"+b+"':"+lastError),a.deleteShader(b),null)};e.createProgram=function(a,b,l,g){for(var d=a.createProgram(),h=0;h<b.length;h++)a.attachShader(d,b[h]);
if(l)for(h=0;h<l.length;h++)a.bindAttribLocation(d,g?g[h]:h,l[h]);a.linkProgram(d);return a.getProgramParameter(d,a.LINK_STATUS)?d:(lastError=a.getProgramInfoLog(d),BC.Util.error("Error in program linking: "+lastError),a.deleteProgram(d),null)};e.textureTileSet=function(a,b,l){var g=1/a,d=1/b;return{tile:function(a,b){var e=g*b,f=d*a;return{textureCoord:function(a,b){return[e+l+(g-2*l)*a,f+l+(d-2*l)*b]}}}}};return c}(BC||{});BC=function(c){var e=c.Audio=c.Audio||{};(e.Player=e.Player||{}).make=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;var a=new AudioContext,b;(function(l){var g=new XMLHttpRequest;g.open("GET",l,!0);g.responseType="arraybuffer";g.onload=function(){a.decodeAudioData(g.response,function(a){b=a},function(){BC.Util.error("error decoding data for "+l)})};g.send()})("audio/sounds.ogg");return{play:function(l){if(b){var g=b,d=l.offset;l=l.duration;var h=a.createBufferSource();
h.buffer=g;h.connect(a.destination);h.start(0,d,l)}}}};return c}(BC||{});BC=function(c){function e(b){return{offset:b,duration:a}}var a=0.5;(c.Audio=c.Audio||{}).Sound={BUTTON_CLICK:e(0),SELECTOR_MOVEMENT:e(1),CELL_SWAP:e(2),CELL_CLEAR:e(3)};return c}(BC||{});BC=function(c){(c.Selector=c.Selector||{}).make=function(e){function a(a){f=a;0<c.length&&BC.Util.error("startMoving: pending animations: "+c.length);c.push(BC.Animation.make({duration:k,startCallback:function(){g.play(h.SELECTOR_MOVEMENT)},updateCallback:function(a){var g=b.ringHeight*a.deltaPercent;a=q*a.deltaPercent;switch(f){case d.UP:return s[1]+=g,!0;case d.DOWN:return s[1]-=g,!0;case d.LEFT:return l.rotate(a),!0;case d.RIGHT:return l.rotate(-a),!0;default:return!1}},finishCallback:function(){f=
d.NONE}}))}var b=e.metrics,l=e.board,g=e.audioPlayer,d=BC.Constants.Direction,h=BC.Audio.Sound,k=0.025,m={matrix:BC.Matrix.identity,move:function(b){switch(b){case d.LEFT:return f!==d.NONE?b=!1:(a(d.LEFT),b=!0),b;case d.RIGHT:return f!==d.NONE?b=!1:(a(d.RIGHT),b=!0),b;case d.UP:return f!==d.NONE?b=!1:(a(d.UP),b=!0),b;case d.DOWN:return f!==d.NONE?b=!1:(a(d.DOWN),b=!0),b;default:return BC.Util.error("move: unsupported direction: "+b),!1}},update:function(a){BC.Animation.process(c,a);a=1+Math.abs(Math.sin(4*
a.now))/25;a=BC.Matrix.makeScale(a,a,1);var b=BC.Matrix.makeTranslation(s[0],s[1],s[2]);m.matrix=BC.Matrix.matrixMultiply(a,b)}},f=d.NONE,c=[],s=[0,0,0],q=BC.Math.sliceRadians(b.numCells);return m};return c}(BC||{});BC=function(c){(c.Resources=c.Resources||{}).make=function(){var e=BC.GL.textureTileSet(8,8,0.002),a=[e.tile(0,0),e.tile(0,1),e.tile(0,2),e.tile(0,3),e.tile(0,4),e.tile(0,5),e.tile(2,0),e.tile(2,1),e.tile(2,2),e.tile(2,3),e.tile(2,4),e.tile(2,5),e.tile(1,0),e.tile(1,1),e.tile(1,2),e.tile(1,3),e.tile(1,4),e.tile(1,5)],b=e.tile(4,0),e=e.tile(4,1);return{blockTextureTiles:a,selectorTextureTile:b,blackTextureTile:e}};return c}(BC||{});BC=function(c){(c.Game=c.Game||{}).run=function(){function e(a){return p.getUniformLocation(E,a)}function a(){return x.width!=x.clientWidth||x.height!=x.clientHeight?(x.width=x.clientWidth,x.height=x.clientHeight,!0):!1}function b(){var a=x.width/x.height,b=BC.Math.radians(90);return BC.Matrix.makePerspective(b,a,1,2E3)}function l(){var a=BC.Matrix.makeLookAt([0,0.1,3],[0,0,0],[0,1,0]);return BC.Matrix.makeInverse(a)}function g(){console.log(t);L.play(t.BUTTON_CLICK)}function d(){r=!0;v=!1;A=BC.Board.make({metrics:O,
audioPlayer:L});G=BC.Board.View.make({board:A,gl:p,programLocations:H,resources:P});C.setMoveLeftListener(function(){A.move(u.LEFT)});C.setMoveRightListener(function(){A.move(u.RIGHT)});C.setMoveUpListener(function(){A.move(u.UP)});C.setMoveDownListener(function(){A.move(u.DOWN)});C.setPrimaryActionListener(function(){A.swap()});h()}function h(){n=!1;m(!1);I.reset();k()}function k(){p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.viewport(0,0,p.canvas.width,p.canvas.height);p.uniformMatrix4fv(H.projectionMatrixLocation,
!1,M);var a=!n&&!v&&A;a&&(I.tick(),v=A.update(I));G&&G.draw();a&&requestAnimationFrame(k);v&&(n=r=!1,m(!0))}function m(a){a?(z.text(v?s:n?c:f),a=D,r?a.show():a.hide(),y.fadeIn(q),F.fadeOut(q)):(y.fadeOut(q),F.fadeIn(q))}var f="b l o c k c i l l i n",c="P A U S E D",s="G A M E  O V E R",q="fast",u=BC.Constants.Direction,t=BC.Audio.Sound,r=!1,n=!1,v=!1,y=$("#main-menu"),z=$("#main-menu-title"),B=$("#new-game-button"),D=$("#continue-game-button"),F=$("#game-menu"),Q=$("#pause-button"),O={numRings:3,
numCells:24,numBlockTypes:6,ringInnerRadius:0.75,ringOuterRadius:1,ringHeight:0.3},P=BC.Resources.make(),I=BC.StopWatch.make(),L=BC.Audio.Player.make(),A,G,x=document.getElementById("canvas");if(x){var C=BC.Controller.make(x),p=x.getContext("webgl")||x.getContext("experimental-webgl");if(p){var N=p.createTexture();p.bindTexture(p.TEXTURE_2D,N);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,1,1,0,p.RGBA,p.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));var J=new Image;J.src="images/textures.png";$(J).load(function(){p.bindTexture(p.TEXTURE_2D,
N);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,J);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.LINEAR_MIPMAP_NEAREST);p.generateMipmap(p.TEXTURE_2D)});p.enable(p.CULL_FACE);p.enable(p.DEPTH_TEST);p.enable(p.BLEND);p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA);var K=BC.GL.loadShader(p,"vertex-shader",p.VERTEX_SHADER),R=BC.GL.loadShader(p,"fragment-shader",p.FRAGMENT_SHADER),E=BC.GL.createProgram(p,[K,R]);p.useProgram(E);
var H={positionLocation:p.getAttribLocation(E,"a_position"),textureCoordLocation:p.getAttribLocation(E,"a_textureCoord"),projectionMatrixLocation:e("u_projectionMatrix"),viewMatrixLocation:e("u_viewMatrix"),boardRotationMatrixLocation:e("u_boardRotationMatrix"),boardTranslationMatrixLocation:e("u_boardTranslationMatrix"),selectorMatrixLocation:e("u_selectorMatrix"),ringMatrixLocation:e("u_ringMatrix"),cellMatrixLocation:e("u_cellMatrix"),yellowBoostLocation:e("u_yellowBoost"),alphaLocation:e("u_alpha")};
a();var M=b();$(window).resize(function(){a()&&(M=b(),k())});K=l();p.uniformMatrix4fv(H.viewMatrixLocation,!1,K);m(!0);B.click(function(){g();d()});D.click(function(){g();h()});Q.click(function(){g();n=!0;m(!0)});C.setMenuActionListener(function(){n?h():(n=!0,m(!0))});document.addEventListener("visibilitychange",function(){document.hidden&&(n=!0,m(!0))})}}};return c}(BC||{});$(document).ready(function(){BC.Game.run()});BC=function(c){var e=c.Cell=c.Cell||{},e=e.Chain=e.Chain||{};e.find=function(a){function b(b,d){return a.rings[b].cells[d]}function l(){for(var d=a.rings.length,g=[],l=0;l<d;l++){var h;h=l;for(var c=0,r=b(h,c),n=0;n<e;n++){var v=b(h,c);if(r.state!==v.state||r.blockStyle!=v.blockStyle)break;c+=1;c=c===e?0:c}h=c;for(c=0;c<e;)if(n=(c+h)%e,v=b(l,n),v.state!==k.BLOCK)c++;else{for(var y=1,r=c+1;r<e;r++)if(n=(r+h)%e,n=b(l,n),v.state===n.state&&v.blockStyle==n.blockStyle)y++;else break;if(y>=f){for(v=[];c<
r;c++)n=(c+h)%e,y=b(l,n),v.push({cell:y,row:l,col:n});g.push(v)}c=r}}return g}function g(){for(var d=a.rings.length,g=[],l=0;l<e;l++)for(var h=0;h<d;){var c=b(h,l);if(c.state!==k.BLOCK)h++;else{for(var r=1,n=h+1;n<d;n++){var v=b(n,l);if(c.state===v.state&&c.blockStyle==v.blockStyle)r++;else break}if(r>=f){for(c=[];h<n;h++)r=b(h,l),c.push({cell:r,row:h,col:l});g.push(c)}h=n}}return g}function d(a,b){for(var d=0;d<a.length;d++)for(var g=a[d],f=0;f<b.length;f++){var l=b[f];if(g.blockStyle===l.blockStyle&&
g.row===l.row&&g.col===l.col)return!0}return!1}function h(a,b){for(var d=0;d<a.length;d++){var g=a[d];if(g.blockStyle===b.blockStyle&&g.row===b.row&&g.col===b.col)return!0}return!1}var k=BC.Cell.CellState,e=a.rings[0].cells.length,f=3;return function(){for(var a=[],b=l(),f=g();0<b.length;){var e=b.shift();for(a.push(e);;){for(var k=!1,c=0;c<f.length;c++)if(d(e,f[c])){for(k=0;k<f[c].length;k++)h(e,f[c][k])||e.push(f[c][k]);f.splice(c,1);k=!0}if(!k)break;k=!1;for(c=0;c<b.length;c++)if(d(e,b[c])){for(k=
0;k<b[c].length;k++)h(e,b[c][k])||e.push(b[c][k]);b.splice(c,1);k=!0}if(!k)break}}for(;0<f.length;)e=f.shift(),a.push(e);for(c=0;c<a.length;c++)a[c].sort(function(a,b){return a.row-b.row});return a}()};e.makeManager=function(){var a=BC.Cell.CellState,b=[],l=[];return{update:function(g){var d=BC.Cell.Chain.find(g);for(g=0;g<d.length;g++){var h=d[g];l.push(h);for(var c=0;c<h.length;c++){var e=h[c].cell;e.markBlock();b.push(e)}}if(0<b.length)switch(e=b[0],e.state){case a.BLOCK_CLEARING_MARKED:case a.BLOCK_CLEARING_PREPARING:break;
case a.BLOCK_CLEARING_READY:e.clearBlock();break;case a.BLOCK_CLEARING_IN_PROGRESS:break;default:b.shift()}if(0<l.length){h=l[0];d=!0;for(g=0;g<h.length;g++)e=h[g].cell,d&=!e.isClearing();if(d){for(g=0;g<h.length;g++)e=h[g].cell,e.state===a.EMPTY_NO_DROP&&(e.state=a.EMPTY);l.shift()}}return 0<l.length}}};return c}(BC||{});BC=function(c){(c.Stage=c.Stage||{}).make=function(e,a){a+=e.ringHeight/2-0.01;return{matrix:BC.Matrix.makeTranslation(0,a,0)}};return c}(BC||{});BC=function(c){var e=c.Util=c.Util||{};e.log=function(a){window.console&&window.console.log&&window.console.log(a)};e.error=function(a){window.console&&(window.console.error?window.console.error(a):window.console.log&&window.console.log(a))};return c}(BC||{});BC=function(c){var e=c.Selector=c.Selector||{};(e.View=e.View||{}).make=function(a,b,l){var g=-b.ringHeight/2,d=-g;b=BC.Math.circlePoints(b.ringOuterRadius+0.01,b.numCells,-Math.PI/2);var e=b.length-2,c=[],m=0;c[m++]=b[e]+0.001;c[m++]=g;c[m++]=-b[e+1]-0.001;c[m++]=b[0]+0.001;c[m++]=g;c[m++]=-b[1]-0.001;c[m++]=b[0]+0.001;c[m++]=d;c[m++]=-b[1]-0.001;c[m++]=b[e]+0.001;c[m++]=d;c[m++]=-b[e+1]-0.001;c[m++]=b[0]+0.001;c[m++]=g;c[m++]=-b[1]-0.001;c[m++]=b[2]+0.001;c[m++]=g;c[m++]=-b[3]-0.001;c[m++]=b[2]+
0.001;c[m++]=d;c[m++]=-b[3]-0.001;c[m++]=b[0]+0.001;c[m++]=d;c[m++]=-b[1]-0.001;var f=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW);g=l.textureCoord(0,0);d=l.textureCoord(1,0);b=l.textureCoord(1,1);l=l.textureCoord(0,1);l=new Float32Array([].concat(g,d,b,l,g,d,b,l));var w=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,w);a.bufferData(a.ARRAY_BUFFER,l,a.STATIC_DRAW);var s=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),q=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
q);a.bufferData(a.ELEMENT_ARRAY_BUFFER,s,a.STATIC_DRAW);return{draw:function(b){var d=b.positionLocation,g=b.textureCoordLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,f);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,w);a.enableVertexAttribArray(g);a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.drawElements(a.TRIANGLES,s.length,a.UNSIGNED_SHORT,0)}}};return c}(BC||{});BC=function(c){var e=c.Matrix=c.Matrix||{};e.makeLookAt=function(a,b,c){b=BC.Math.normalize(BC.Math.subtractVectors(a,b));c=BC.Math.cross(c,b);var g=BC.Math.cross(b,c);return[c[0],c[1],c[2],0,g[0],g[1],g[2],0,b[0],b[1],b[2],0,a[0],a[1],a[2],1]};e.makePerspective=function(a,b,c,g){a=Math.tan(0.5*Math.PI-0.5*a);var d=1/(c-g);return[a/b,0,0,0,0,a,0,0,0,0,(c+g)*d,-1,0,0,c*g*d*2,0]};e.makeTranslation=function(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]};e.makeXRotation=function(a){var b=Math.cos(a);
a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};e.makeYRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};e.makeZRotation=function(a){var b=Math.cos(a);a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};e.makeScale=function(a,b,c){return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]};e.identity=e.makeScale(1,1,1);e.makeInverse=function(a){var b=a[0],c=a[1],g=a[2],d=a[3],e=a[4],k=a[5],m=a[6],f=a[7],w=a[8],s=a[9],q=a[10],u=a[11],t=a[12],r=a[13],n=a[14];a=
a[15];var v=q*a,y=n*u,z=m*a,B=n*f,D=m*u,F=q*f,Q=g*a,O=n*d,P=g*u,I=q*d,L=g*f,A=m*d,G=w*r,x=t*s,C=e*r,p=t*k,N=e*s,J=w*k,K=b*r,R=t*c,E=b*s,H=w*c,M=b*k,S=e*c,T=v*k+B*s+D*r-(y*k+z*s+F*r),U=y*c+Q*s+I*r-(v*c+O*s+P*r),r=z*c+O*k+L*r-(B*c+Q*k+A*r),c=F*c+P*k+A*s-(D*c+I*k+L*s),k=1/(b*T+e*U+w*r+t*c);return[k*T,k*U,k*r,k*c,k*(y*e+z*w+F*t-(v*e+B*w+D*t)),k*(v*b+O*w+P*t-(y*b+Q*w+I*t)),k*(B*b+Q*e+A*t-(z*b+O*e+L*t)),k*(D*b+I*e+L*w-(F*b+P*e+A*w)),k*(G*f+p*u+N*a-(x*f+C*u+J*a)),k*(x*d+K*u+H*a-(G*d+R*u+E*a)),k*(C*d+R*f+
M*a-(p*d+K*f+S*a)),k*(J*d+E*f+S*u-(N*d+H*f+M*u)),k*(C*q+J*n+x*m-(N*n+G*m+p*q)),k*(E*n+G*g+R*q-(K*q+H*n+x*g)),k*(K*m+S*n+p*g-(M*n+C*g+R*m)),k*(M*q+N*g+H*m-(E*m+S*q+J*g))]};e.matrixMultiply=function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*
b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]};return c}(BC||{});BC=function(c){var e=c.Cell=c.Cell||{};(e.Drop=e.Drop||{}).makeManager=function(a){var b=BC.Cell.CellState,c=BC.Constants.Direction,g=[];return{update:function(d){for(var e=0;e<d.rings.length;e++)for(var k=0;k<a.numCells;k++){var m=d,f=e,w=k,s=m.rings[f].cells[w];s.state===b.BLOCK&&(f+=1,f>=m.rings.length||(m=m.rings[f].cells[w],s.state===b.BLOCK&&m.state==b.EMPTY&&(s=s.sendBlock(0.05),m.receiveBlock(0.05,c.UP,s),g.push(m))))}a:{for(;0<g.length;){if(g[0].hasDroppingBlock()){d=!0;break a}g.shift()}d=
!1}return d}}};return c}(BC||{});BC=function(c){(c.Constants=c.Constants||{}).Direction={NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4};return c}(BC||{});BC=function(c){var e=c.Animation=c.Animation||{};e.make=function(a){var b=a.duration,c=a.startCallback||function(){},g=a.updateCallback||function(){return!1},d=a.finishCallback||function(){},e=0,k=!1,m=!1;return{update:function(a){k||(k=!0,c());var w=a.deltaTime;e+w>b&&(w=b-e);e+=w;a=g({now:a.now,deltaTime:w,elapsedPercent:e/b,deltaPercent:w/b});e>=b&&(m=!0,d());return a},isDone:function(){return m}}};e.process=function(a,b){var c=!1;if(0<a.length){var e=a[0],c=c|e.update(b);e.isDone()&&a.shift()}return c};
return c}(BC||{});BC=function(c){var e=c.Stage=c.Stage||{};(e.View=e.View||{}).make=function(a,b,c){b=[];var e=0;b[e++]=-1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=0;b[e++]=-1;b[e++]=-1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=-1;b[e++]=1;b[e++]=1;b[e++]=0;b[e++]=1;b[e++]=-1;b[e++]=0;b[e++]=1;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);b=c.textureCoord(0,0);var e=c.textureCoord(1,0),h=c.textureCoord(1,
1);c=c.textureCoord(0,1);c=new Float32Array([].concat(b,e,h,c,b,e,h,c));var k=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,k);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);var m=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7]),f=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.bufferData(a.ELEMENT_ARRAY_BUFFER,m,a.STATIC_DRAW);return{draw:function(b){var c=b.positionLocation,e=b.textureCoordLocation,g=b.yellowBoostLocation;b=b.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,d);a.enableVertexAttribArray(c);
a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,k);a.enableVertexAttribArray(e);a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0);a.uniform1f(g,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.drawElements(a.TRIANGLES,m.length,a.UNSIGNED_SHORT,0)}}};return c}(BC||{});BC=function(c){(c.Board=c.Board||{}).make=function(c){function a(a){a=BC.Ring.make({metrics:g,translationY:-g.ringHeight*v,selectable:a,audioPlayer:d});n.push(a);v++}function b(){z.translationMatrix=BC.Matrix.makeTranslation(t[0],t[1],t[2])}function l(){var a=BC.Matrix.makeXRotation(r[0]),b=BC.Matrix.makeYRotation(r[1]),c=BC.Matrix.makeZRotation(r[2]),b=BC.Matrix.matrixMultiply(c,b),b=BC.Matrix.matrixMultiply(b,a);z.rotationMatrix=b}var g=c.metrics,d=c.audioPlayer,h=BC.Cell.CellState,k=BC.Constants.Direction,
m=BC.Audio.Sound,f=11*g.ringHeight,w=2*g.ringHeight,s=0,q=g.numCells-1;c=5.5*-g.ringHeight-g.ringHeight/2;for(var u=g.ringHeight*g.numRings,t=[0,c+u,0],r=[0,0,0],n=[],v=0,y=0;y<g.numRings;y++)a(!0);for(y=0;2>y;y++)a(!1);var z={metrics:g,rings:n,rotationMatrix:BC.Matrix.identity,translationMatrix:BC.Matrix.identity,move:function(a){switch(a){case k.LEFT:B.move(k.LEFT)&&(q--,0>q&&(q=g.numCells-1));break;case k.RIGHT:B.move(k.RIGHT)&&(q++,q>=g.numCells&&(q=0));break;case k.UP:0<s&&B.move(k.UP)&&s--;
break;case k.DOWN:s+1<z.rings.length&&n[s+1].isSelectable()&&B.move(k.DOWN)&&s++}},rotate:function(a){r[1]+=a},swap:function(){var a=n[s].cells[q%g.numCells],b=n[s].cells[(q+1)%g.numCells];BC.Util.log("swap: ("+a.state+", "+b.state+")");var c=a.blockStyle,e=b.blockStyle;a.state!==h.EMPTY&&a.state!==h.EMPTY_NO_DROP||b.state!==h.BLOCK?a.state!==h.BLOCK||b.state!==h.EMPTY&&b.state!==h.EMPTY_NO_DROP?a.state===h.BLOCK&&b.state===h.BLOCK&&(a.receiveBlock(0.1,k.RIGHT,e),b.receiveBlock(0.1,k.LEFT,c),d.play(m.CELL_SWAP)):
(a.sendBlock(0.1,k.RIGHT),b.receiveBlock(0.1,k.LEFT,c),d.play(m.CELL_SWAP)):(b.sendBlock(0.1,k.LEFT),a.receiveBlock(0.1,k.RIGHT,e),d.play(m.CELL_SWAP))},update:function(c){for(var d=0;d<n.length;d++)for(var e=0;e<g.numCells;e++)n[d].cells[e%g.numCells].update(c);d=0|F.update(z);d|=D.update(z);d||(d=0.02*c.deltaTime,u+d>f&&(d=f-u),u+=d,t[1]+=d);B.update(c);b();for(l();0<n.length&&n[0].isEmpty();)n.shift(),u-=g.ringHeight,s--;for(c=u-g.ringHeight*n.length;c>-w;)a(!1),c-=g.ringHeight;for(c=n.length-
1;0<=c&&!n[c].isSelectable();c--)0<=u-g.ringHeight*(c+1)&&n[c].setSelectable(!0);return u>=f}};b();l();var B=BC.Selector.make({metrics:g,board:z,audioPlayer:d});z.selector=B;c=BC.Stage.make(g,c);z.stage=c;var D=BC.Cell.Chain.makeManager(),F=BC.Cell.Drop.makeManager(g);return z};return c}(BC||{});BC=function(c){(c.Controller=c.Controller||{}).make=function(c){var a=0,b=0,l=function(){},g=function(){},d=function(){},h=function(){},k=function(){},m=function(){};$(document).keydown(function(a){switch(a.keyCode){case 37:l.call();break;case 39:g.call();break;case 38:d.call();break;case 40:h.call();break;case 32:k.call();break;case 27:m.call();break;default:console.log(a.keyCode)}return!1});$(c).on("touchstart touchmove touchend",function(c){var e=c.originalEvent.changedTouches[0];switch(c.type){case "touchstart":a=
e.pageX;b=e.pageY;break;case "touchend":var m=e.pageX-a,q=e.pageY-b,u=Math.abs(m),t=Math.abs(q);c=function(){return 20<t?(0<q?h.call():d.call(),!0):!1};e=function(){return 20<u?(0<m?l.call():g.call(),!0):!1};if(u>t){if(e()||c())break}else if(c()||e())break;k.call()}return!1});return{setMoveLeftListener:function(a){l=a},setMoveRightListener:function(a){g=a},setMoveUpListener:function(a){d=a},setMoveDownListener:function(a){h=a},setPrimaryActionListener:function(a){k=a},setMenuActionListener:function(a){m=
a}}};return c}(BC||{});BC=function(c){var e=c.Cell=c.Cell||{};(e.View=e.View||{}).make=function(a,b,c){function e(b,c){var d=c.positionLocation,f=c.textureCoordLocation,g=c.yellowBoostLocation,h=c.alphaLocation;a.bindBuffer(a.ARRAY_BUFFER,w);a.enableVertexAttribArray(d);a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,s[b.blockStyle]);a.enableVertexAttribArray(f);a.vertexAttribPointer(f,2,a.FLOAT,!1,0,0);a.uniform1f(g,b.yellowBoost);a.uniform1f(h,b.alpha);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.drawElements(a.TRIANGLES,
u,a.UNSIGNED_SHORT,0)}var d=b.numCells,h=b.ringOuterRadius,k=b.ringHeight/2,m=-k,f=-Math.PI/2;b=BC.Math.circlePoints(b.ringInnerRadius,d,f);h=BC.Math.circlePoints(h,d,f);d=0;f=[];f[d++]=b[0];f[d++]=k;f[d++]=-b[1];f[d++]=h[0];f[d++]=k;f[d++]=-h[1];f[d++]=h[2];f[d++]=k;f[d++]=-h[3];f[d++]=b[2];f[d++]=k;f[d++]=-b[3];f[d++]=h[0];f[d++]=m;f[d++]=-h[1];f[d++]=b[0];f[d++]=m;f[d++]=-b[1];f[d++]=b[2];f[d++]=m;f[d++]=-b[3];f[d++]=h[2];f[d++]=m;f[d++]=-h[3];f[d++]=b[0];f[d++]=k;f[d++]=-b[1];f[d++]=b[0];f[d++]=
m;f[d++]=-b[1];f[d++]=h[0];f[d++]=m;f[d++]=-h[1];f[d++]=h[0];f[d++]=k;f[d++]=-h[1];f[d++]=h[2];f[d++]=k;f[d++]=-h[3];f[d++]=h[2];f[d++]=m;f[d++]=-h[3];f[d++]=b[2];f[d++]=m;f[d++]=-b[3];f[d++]=b[2];f[d++]=k;f[d++]=-b[3];f[d++]=h[0];f[d++]=k;f[d++]=-h[1];f[d++]=h[0];f[d++]=m;f[d++]=-h[1];f[d++]=h[2];f[d++]=m;f[d++]=-h[3];f[d++]=h[2];f[d++]=k;f[d++]=-h[3];f[d++]=b[2];f[d++]=k;f[d++]=-b[3];f[d++]=b[2];f[d++]=m;f[d++]=-b[3];f[d++]=b[0];f[d++]=m;f[d++]=-b[1];f[d++]=b[0];f[d++]=k;f[d++]=-b[1];var w=a.createBuffer();
a.bindBuffer(a.ARRAY_BUFFER,w);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);k=[];for(d=0;d<c.length;d++)for(m=c[d],k[d]=[],h=b=0;6>b;b++)f=m.textureCoord(0,0),k[d][h++]=f[0],k[d][h++]=f[1],f=m.textureCoord(0,1),k[d][h++]=f[0],k[d][h++]=f[1],f=m.textureCoord(1,1),k[d][h++]=f[0],k[d][h++]=f[1],f=m.textureCoord(1,0),k[d][h++]=f[0],k[d][h++]=f[1];for(var s=[],d=0;d<c.length;d++)s[d]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,s[d]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(k[d]),
a.STATIC_DRAW);c=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var q=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,q);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);var u=c.length;return{drawOpaque:function(a,b){a.isDrawable()&&!a.isTransparent()&&e(a,b)},drawTransparent:function(b,c){b.isDrawable()&&b.isTransparent()&&(a.disable(a.CULL_FACE),e(b,c),a.enable(a.CULL_FACE))}}};return c}(BC||{});BC=function(c){(c.StopWatch=c.StopWatch||{}).make=function(){function c(){a.then=0.001*Date.now()}var a={reset:c,tick:function(){a.now=0.001*Date.now();a.deltaTime=a.now-a.then;a.then=a.now}};c();return a};return c}(BC||{});
